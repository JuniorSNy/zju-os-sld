
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://juniorsny.github.io/zju-os-sld/lab3/">
      
      
        <link rel="prev" href="../lab2/">
      
      
        <link rel="next" href="../lab4/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>实验指导三 - 浙江大学25年秋冬操作系统实验</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CCascadia:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Cascadia"}</style>
      
    
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:500,500i,600,600i&display=fallback">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-3-rv64" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="浙江大学25年秋冬操作系统实验" class="md-header__button md-logo" aria-label="浙江大学25年秋冬操作系统实验" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            浙江大学25年秋冬操作系统实验
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              实验指导三
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/JuniorSNy/zju-os-sld" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    JuniorSNy/zju-os-sld
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="浙江大学25年秋冬操作系统实验" class="md-nav__button md-logo" aria-label="浙江大学25年秋冬操作系统实验" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    浙江大学25年秋冬操作系统实验
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/JuniorSNy/zju-os-sld" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    JuniorSNy/zju-os-sld
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    首页
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验指导零
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验指导一
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验指导二
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    实验指导三
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    实验指导三
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      实验目的
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      实验环境
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      背景知识
    </span>
  </a>
  
    <nav class="md-nav" aria-label="背景知识">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      前言
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel" class="md-nav__link">
    <span class="md-ellipsis">
      Kernel 的虚拟内存布局
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#risc-v-sv39" class="md-nav__link">
    <span class="md-ellipsis">
      RISC-V Sv39 分页模式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RISC-V Sv39 分页模式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#satp" class="md-nav__link">
    <span class="md-ellipsis">
      satp 寄存器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sv39" class="md-nav__link">
    <span class="md-ellipsis">
      Sv39 虚拟地址和物理地址
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sv39_1" class="md-nav__link">
    <span class="md-ellipsis">
      Sv39 页表项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sv39_2" class="md-nav__link">
    <span class="md-ellipsis">
      Sv39 虚拟地址转换
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      实验步骤
    </span>
  </a>
  
    <nav class="md-nav" aria-label="实验步骤">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      准备工程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pie" class="md-nav__link">
    <span class="md-ellipsis">
      关于 PIE
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      开启虚拟内存映射
    </span>
  </a>
  
    <nav class="md-nav" aria-label="开启虚拟内存映射">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup_vm" class="md-nav__link">
    <span class="md-ellipsis">
      setup_vm 的实现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup_vm_final" class="md-nav__link">
    <span class="md-ellipsis">
      setup_vm_final 的实现
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      编译及测试
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      思考题
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      实验任务与要求
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验指导四
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验指导五
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验指导六
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../spike/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Spike 工具链使用
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    常见问题及解答
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      实验目的
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      实验环境
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      背景知识
    </span>
  </a>
  
    <nav class="md-nav" aria-label="背景知识">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      前言
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel" class="md-nav__link">
    <span class="md-ellipsis">
      Kernel 的虚拟内存布局
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#risc-v-sv39" class="md-nav__link">
    <span class="md-ellipsis">
      RISC-V Sv39 分页模式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RISC-V Sv39 分页模式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#satp" class="md-nav__link">
    <span class="md-ellipsis">
      satp 寄存器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sv39" class="md-nav__link">
    <span class="md-ellipsis">
      Sv39 虚拟地址和物理地址
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sv39_1" class="md-nav__link">
    <span class="md-ellipsis">
      Sv39 页表项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sv39_2" class="md-nav__link">
    <span class="md-ellipsis">
      Sv39 虚拟地址转换
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      实验步骤
    </span>
  </a>
  
    <nav class="md-nav" aria-label="实验步骤">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      准备工程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pie" class="md-nav__link">
    <span class="md-ellipsis">
      关于 PIE
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      开启虚拟内存映射
    </span>
  </a>
  
    <nav class="md-nav" aria-label="开启虚拟内存映射">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup_vm" class="md-nav__link">
    <span class="md-ellipsis">
      setup_vm 的实现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup_vm_final" class="md-nav__link">
    <span class="md-ellipsis">
      setup_vm_final 的实现
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      编译及测试
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      思考题
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      实验任务与要求
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/JuniorSNy/zju-os-sld/tree/main/docs/lab3.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75z"/></svg>
    </a>
  
  


<h1 id="lab-3-rv64">Lab 3: RV64 虚拟内存管理<a class="headerlink" href="#lab-3-rv64" title="Permanent link">&para;</a></h1>
<h2 id="_1">实验目的<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li>学习虚拟内存的相关知识，实现物理地址到虚拟地址的切换</li>
<li>了解 RISC-V 架构中 SV39 分页模式，实现虚拟地址到物理地址的映射，并对不同的段进行相应的权限设置</li>
</ul>
<h2 id="_2">实验环境<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<ul>
<li>Environment in previous labs</li>
</ul>
<h2 id="_3">背景知识<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">前言<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>在 Lab2 中我们赋予了操作系统对多个线程调度以及并发执行的能力，由于目前这些线程都是内核线程，因此他们可以共享运行空间，即运行不同线程对空间的修改是相互可见的。但是如果我们需要线程相互<strong>隔离</strong>，以及在多线程的情况下更加<strong>高效</strong>的使用内存，就必须引入<strong>虚拟内存</strong>这个概念。</p>
<p>虚拟内存可以为正在运行的进程提供独立的内存空间，制造一种每个进程的内存都是独立的假象。同时虚拟内存到物理内存的映射也包含了对内存的访问权限，方便内核完成权限检查。</p>
<p>在本次实验中，我们需要关注内核如何<strong>开启虚拟地址</strong>以及通过设置页表来实现<strong>地址映射</strong>和<strong>权限控制</strong>。</p>
<h3 id="kernel">Kernel 的虚拟内存布局<a class="headerlink" href="#kernel" title="Permanent link">&para;</a></h3>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>start_address             end_address
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    0x0                  0x3fffffffff
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>     │                        │
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>┌────┘                  ┌─────┘
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>↓        256G           ↓                                
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>┌───────────────────────┬──────────┬────────────────┐
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>│      User Space       │    ...   │  Kernel Space  │
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>└───────────────────────┴──────────┴────────────────┘
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>                                   ↑      256G      ↑
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>                      ┌────────────┘                │ 
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>                      │                             │
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>              0xffffffc000000000           0xffffffffffffffff
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>                start_address                  end_address
</code></pre></div>
通过上图我们可以看到 RV64 将 <code>0x0000004000000000</code> 以下的虚拟空间作为 <code>user space</code>。将 <code>0xffffffc000000000</code> 及以上的虚拟空间作为 <code>kernel space</code>。由于我们还未引入用户态程序，目前我们只需要关注 <code>kernel space</code>。</p>
<p>本次实验使用的虚拟内存布局为 RISC-V Linux Kernel v5.16 前 Sv39 的内存布局，具体的虚拟内存布局可以参考 <a href="https://elixir.bootlin.com/linux/v5.15/source/Documentation/riscv/vm-layout.rst">Linux v5.15 文档</a>。</p>
<div class="admonition note">
<p class="admonition-title">在 <code>RISC-V Linux Kernel Space</code> 中有一段虚拟地址空间中的区域被称为 <code>direct mapping area</code>，为了方便访问内存，内核会预先把所有物理内存都映射至这一块区域，这种映射也被称为 <code>linear mapping</code>，因为该映射方式就是在物理地址上添加一个偏移，使得 <code>VA = PA + PA2VA_OFFSET</code>。在 RISC-V Linux Kernel 中这一段区域为 <code>0xffffffe000000000 ~ 0xffffffff00000000</code>，共 124 GB</p>
</div>
<h3 id="risc-v-sv39">RISC-V Sv39 分页模式<a class="headerlink" href="#risc-v-sv39" title="Permanent link">&para;</a></h3>
<div class="admonition warning">
<p class="admonition-title">同 lab1，对于本部分知识的学习不可跳过阅读 sepc 这一步骤</p>
<p>RISC-V 虚拟内存相关的内容在 <a href="https://github.com/riscv/riscv-isa-manual/releases/download/20240411/priv-isa-asciidoc.pdf">RISC-V Privileged Spec</a> 中。</p>
<p>其中第 10.1.11 节介绍了 satp 寄存器，10.2.1 节中包括了本实验中会用到的一条新指令 sfence.vma 的介绍，10.3-10.6 节分别介绍了 Sv32、Sv39、Sv48、Sv57，其中 Sv32 为精讲，后三者均同理带过。所以需要同学们详细阅读第 10.1.11 节和第 10.3、10.4 节。</p>
</div>
<h4 id="satp"><code>satp</code> 寄存器<a class="headerlink" href="#satp" title="Permanent link">&para;</a></h4>
<p>satp（Supervisor Address Translation and Protection Register）是 RISC-V 中控制虚拟内存分页模式的寄存器，其结构如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a> 63      60 59                  44 43                                0
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>┌──────────┬──────────────────────┬───────────────────────────────────┐
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>│   MODE   │         ASID         │                PPN                │
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>└──────────┴──────────────────────┴───────────────────────────────────┘
</code></pre></div>
<ul>
<li>
<p>MODE 字段的取值如下图：
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>                        RV 64
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>┌─────────┬────────┬───────────────────────────────────────┐
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>│  Value  │  Name  │  Description                          │
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>├─────────┼────────┼───────────────────────────────────────┤
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>│    0    │ Bare   │ No translation or protection          │
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>│  1 - 7  │ ---    │ Reserved for standard use             │
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>│    8    │ Sv39   │ Page-based 39 bit virtual addressing  │ &lt;-- 我们使用的 mode
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>│    9    │ Sv48   │ Page-based 48 bit virtual addressing  │
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>│    10   │ Sv57   │ Page-based 57 bit virtual addressing  │
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>│    11   │ Sv64   │ Page-based 64 bit virtual addressing  │
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>│ 12 - 13 │ ---    │ Reserved for standard use             │
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>│ 14 - 15 │ ---    │ Reserved for standard use             │
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>└─────────┴────────┴───────────────────────────────────────┘
</code></pre></div></p>
</li>
<li>
<p>ASID (Address Space Identifier)：此次实验中直接置 0 即可</p>
</li>
<li>PPN (Physical Page Number)：顶级页表的物理页号。我们的物理页的大小为 4KB， <code>PA &gt;&gt; 12 == PPN</code></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">具体介绍请阅读 <a href="https://github.com/riscv/riscv-isa-manual/releases/download/20240411/priv-isa-asciidoc.pdf">RISC-V Privileged Spec</a> 的第 10.1.11 节</p>
</div>
<h4 id="sv39">Sv39 虚拟地址和物理地址<a class="headerlink" href="#sv39" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a> 38        30 29        21 20        12 11                           0
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>┌────────────┬────────────┬────────────┬──────────────────────────────┐
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>│   VPN[2]   │   VPN[1]   │   VPN[0]   │          page offset         │
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>└────────────┴────────────┴────────────┴──────────────────────────────┘
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>                        Sv39 virtual address
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a> 55                30 29        21 20        12 11                           0
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>┌────────────────────┬────────────┬────────────┬──────────────────────────────┐
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>│       PPN[2]       │   PPN[1]   │   PPN[0]   │          page offset         │
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>└────────────────────┴────────────┴────────────┴──────────────────────────────┘
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>                            Sv39 physical address
</code></pre></div>
<ul>
<li>Sv39 模式定义物理地址有 56 位，虚拟地址有 64 位<ul>
<li>虚拟地址的 64 位只有低 39 位有效，其 63-39 位为 0 时代表 user space address，为 1 时代表 kernel space address</li>
</ul>
</li>
<li>Sv39 支持三级页表结构，<code>VPN[2] VPN[1] VPN[0]</code> (Virtual Page Number) 分别代表每级页表的<strong>虚拟页号</strong>，<code>PPN[2] PPN[1] PPN[0]</code> (Physical Page Number) 分别代表每级页表的<strong>物理页号</strong>，物理地址和虚拟地址的低 12 位表示页内偏移（page offset）</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">具体介绍请阅读 <a href="https://github.com/riscv/riscv-isa-manual/releases/download/20240411/priv-isa-asciidoc.pdf">RISC-V Privileged Spec</a> 的第 10.4.1 节</p>
</div>
<h4 id="sv39_1">Sv39 页表项<a class="headerlink" href="#sv39_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a> 63      54 53        28 27        19 18        10 9   8 7 6 5 4 3 2 1 0
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>┌──────────┬────────────┬────────────┬────────────┬─────┬─┬─┬─┬─┬─┬─┬─┬─┐
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>│ Reserved │   PPN[2]   │   PPN[1]   │   PPN[0]   │ RSW │D│A│G│U│X│W│R│V│
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>└──────────┴────────────┴────────────┴────────────┴─────┴─┴─┴─┴─┴─┴─┴─┴─┘
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>                                                     │   │ │ │ │ │ │ │ │
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>                                                     │   │ │ │ │ │ │ │ └──── V - Valid
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>                                                     │   │ │ │ │ │ │ └────── R - Readable
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>                                                     │   │ │ │ │ │ └──────── W - Writable
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>                                                     │   │ │ │ │ └────────── X - Executable
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>                                                     │   │ │ │ └──────────── U - User
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>                                                     │   │ │ └────────────── G - Global
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>                                                     │   │ └──────────────── A - Accessed
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>                                                     │   └────────────────── D - Dirty (0 in page directory)
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>                                                     └────────────────────── Reserved for supervisor software
</code></pre></div>
<p>一些常用的位的含义如下：</p>
<ul>
<li>V：有效位，当 V = 0，访问该 PTE 会产生 Page Fault</li>
<li>R：R = 1 该页可读</li>
<li>W：W = 1 该页可写</li>
<li>X：X = 1 该页可执行</li>
<li>U，G，A，D，RSW 本次实验中设置为 0 即可</li>
</ul>
<p>此外，需要注意，当 RWX 三位均为 0 时，该页表项不为叶子节点，而是指向下一级页表的页表项。具体可见 <a href="https://github.com/riscv/riscv-isa-manual/releases/download/20240411/priv-isa-asciidoc.pdf">RISC-V Privileged Spec</a> 的第 10.3.1 节</p>
<div class="admonition tip">
<p class="admonition-title">具体介绍请阅读 <a href="https://github.com/riscv/riscv-isa-manual/releases/download/20240411/priv-isa-asciidoc.pdf">RISC-V Privileged Spec</a> 的第 10.4.1 节</p>
</div>
<div class="admonition warning">
<p class="admonition-title">如果你在使用 spike 工具链，由于 spike 对于页表项的检查更为严格，所以需要你仔细阅读 spec 的第 10.3.1 节完成对 A 和 D 两位的设置才能正常运行</p>
</div>
<h4 id="sv39_2">Sv39 虚拟地址转换<a class="headerlink" href="#sv39_2" title="Permanent link">&para;</a></h4>
<p>虚拟地址转化为物理地址流程图如下，具体描述见 <a href="https://github.com/riscv/riscv-isa-manual/releases/download/20240411/priv-isa-asciidoc.pdf">RISC-V Privileged Spec</a> 的第 10.3.2 节对于 Sv32 模式的描述并类推至 Sv39：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>                                Virtual Address                                     Physical Address
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>                          9             9            9              12          55        12 11       0
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>   ┌────────────────┬────────────┬────────────┬─────────────┬────────────────┐ ┌────────────┬──────────┐
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>   │                │   VPN[2]   │   VPN[1]   │   VPN[0]    │     OFFSET     │ │     PPN    │  OFFSET  │
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>   └────────────────┴────┬───────┴─────┬──────┴──────┬──────┴───────┬────────┘ └────────────┴──────────┘
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>                         │             │             │              │                 ▲          ▲
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>                         │             │             │              │                 │          │
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>                         │             │             │              │                 │          │
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>┌────────────────────────┘             │             │              │                 │          │
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>│                                      │             │              │                 │          │
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>│                                      │             │              └─────────────────│──────────┘
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>│    ┌─────────────────┐               │             │                                │
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>│511 │                 │  ┌────────────┘             │                                │
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>│    │                 │  │                          │                                │
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>│    │                 │  │     ┌─────────────────┐  │                                │
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>│    │                 │  │ 511 │                 │  │                                │
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>│    │                 │  │     │                 │  │                                │
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>│    │                 │  │     │                 │  │     ┌─────────────────┐        │
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>│    │   44       10   │  │     │                 │  │ 511 │                 │        │
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>│    ├────────┬────────┤  │     │                 │  │     │                 │        │
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>└───►│   PPN  │  flags │  │     │                 │  │     │                 │        │
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>     ├────┬───┴────────┤  │     │   44       10   │  │     │                 │        │
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>     │    │            │  │     ├────────┬────────┤  │     │                 │        │
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>     │    │            │  └────►│   PPN  │  flags │  │     │                 │        │
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>     │    │            │        ├────┬───┴────────┤  │     │   44       10   │        │
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>     │    │            │        │    │            │  │     ├────────┬────────┤        │
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>   1 │    │            │        │    │            │  └────►│   PPN  │  flags │        │
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>     │    │            │        │    │            │        ├────┬───┴────────┤        │
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>   0 │    │            │        │    │            │        │    │            │        │
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>     └────┼────────────┘      1 │    │            │        │    │            │        │
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>     ▲    │                     │    │            │        │    └────────────┼────────┘
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>     │    │                   0 │    │            │        │                 │
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>     │    └────────────────────►└────┼────────────┘      1 │                 │
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>     │                               │                     │                 │
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a> ┌───┴────┐                          │                   0 │                 │
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a> │  satp  │                          └────────────────────►└─────────────────┘
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a> └────────┘
</code></pre></div>
<h2 id="_5">实验步骤<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="_6">准备工程<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>此次实验基于 lab3 同学所实现的代码进行。</p>
<ul>
<li>需要修改 <code>defs.h</code>，在 <code>defs.h</code> <strong>添加</strong>如下内容：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="cp">#define OPENSBI_SIZE (0x200000)</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="cp">#define VM_START (0xffffffe000000000)</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="cp">#define VM_END (0xffffffff00000000)</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="cp">#define VM_SIZE (VM_END - VM_START)</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="cp">#define PA2VA_OFFSET (VM_START - PHY_START)</span>
</code></pre></div></li>
<li>从本仓库同步 <code>vmlinux.lds</code> 代码，并按照以下步骤将这些文件正确放置。
    <div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>.
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>└── arch
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    └── riscv
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>        └── kernel
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>            └── vmlinux.lds
</code></pre></div><ul>
<li>新的链接脚本中的 <code>ramv</code> 代表 <code>VMA</code> (Virtual Memory Address) 即虚拟地址，<code>ram</code> 则代表 <code>LMA</code> (Load Memory Address)，即我们 OS image 被 load 的地址，可以理解为物理地址</li>
<li>使用以上的 vmlinux.lds 进行编译之后，得到的 <code>System.map</code> 以及 <code>vmlinux</code> 中的符号采用的都是虚拟地址，方便之后 debug</li>
</ul>
</li>
</ul>
<h3 id="pie">关于 PIE<a class="headerlink" href="#pie" title="Permanent link">&para;</a></h3>
<p>在开始实验开启虚拟地址之前，我们还需要对 Makefile 进行一些修改来防止后面运行/调试出现问题。如果大家观察过之前的 lab 编译后再经过 objdump 反汇编的结果，你可能会发现 head.S 的第一句设置栈的汇编代码被翻译成了“奇怪”的东西：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="w">    </span><span class="nf">la</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">boot_stack_top</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="err">80200000:</span><span class="w">   </span><span class="err">00003117</span><span class="w">            </span><span class="nf">auipc</span><span class="w">   </span><span class="no">sp</span><span class="p">,</span><span class="mi">0x3</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="err">80200004:</span><span class="w">   </span><span class="err">02013103</span><span class="w">            </span><span class="nf">ld</span><span class="w">  </span><span class="no">sp</span><span class="p">,</span><span class="mi">32</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span><span class="w"> </span><span class="c1"># 80203020 &lt;_GLOBAL_OFFSET_TABLE_+0x18&gt;</span>
</code></pre></div>
<p>你可能好奇过这里为什么要吧 <code>boot_stack_top</code> 的地址 ld 出来，而且是从哪里 ld 出来的。答案 objdump 的注释已经给出了，是从一个叫 <code>_GLOBAL_OFFSET_TABLE_</code> 的地方取出来的，这也就是你可能听说过的 GOT 表（全局偏移表），有了它就可以实现 PIE（位置无关执行）了，在每次取地址的时候，只要通过 GOT 表来取，就可以使得即使代码被放在不同地址执行，也可以取到正确的地址。</p>
<p>当然，在我们实现 kernel 的时候，所有的地址都是不变的，代码也始终会被 load 到 0x80200000 的地方，因此这个 PIE 对我们并没有作用。相反，在本次试验中它还会有副作用，因为 GOT 表里的地址都是最终的虚拟地址，所以在 kernel 启用虚拟地址之前，一切从 GOT 表取出的地址都是错的，这种情况下需要手动给 <code>la</code> 得到的地址减去 <code>PA2VA_OFFSET</code> 才能得到正确的物理地址。</p>
<p>为了避免这种情况，我们可以直接关掉 PIE，只需要在 Makefile 的 <code>CF</code> 中加一个 <code>-fno-pie</code> 就可以强制不编译出 PIE 的代码。在这种情况下第一句的汇编代码会被编译成：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="w">    </span><span class="nf">la</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">boot_stack_top</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="err">80200000:</span><span class="w">   </span><span class="err">00005117</span><span class="w">            </span><span class="nf">auipc</span><span class="w">   </span><span class="no">sp</span><span class="p">,</span><span class="mi">0x5</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="err">80200004:</span><span class="w">   </span><span class="err">00010113</span><span class="w">            </span><span class="nf">mv</span><span class="w">  </span><span class="no">sp</span><span class="p">,</span><span class="no">sp</span>
</code></pre></div>
<p>它直接使用 <code>auipc</code> 根据目标基于当前 pc 的偏移就能计算出正确的地址，而且这种代码不管是否启用了虚拟地址，都是有效的。因此在实验开始前，请同学们在 Makefile 中加上 <code>-fno-pie</code>。</p>
<h3 id="_7">开启虚拟内存映射<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>在 RISC-V 中开启虚拟地址被分为了两步：<code>setup_vm</code> 以及 <code>setup_vm_final</code>，下面将介绍相关的具体实现。</p>
<h4 id="setup_vm"><code>setup_vm</code> 的实现<a class="headerlink" href="#setup_vm" title="Permanent link">&para;</a></h4>
<ul>
<li>将 0x80000000 开始的 1GB 区域进行两次映射，其中一次是等值映射（PA == VA），另一次是将其映射到 <code>direct mapping area</code>（使得 <code>PA + PV2VA_OFFSET == VA</code>），如下图所示：
  <div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>Physical Address
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>-------------------------------------------
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>                     | OpenSBI | Kernel |
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>-------------------------------------------
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>                     ↑
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>                0x80000000
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>                     ├───────────────────────────────────────────────────┐
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>                     |                                                   |
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>Virtual Address      ↓                                                   ↓
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>-----------------------------------------------------------------------------------------------
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>                     | OpenSBI | Kernel |                                | OpenSBI | Kernel |
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>-----------------------------------------------------------------------------------------------
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>                     ↑                                                   ↑
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>                0x80000000                                       0xffffffe000000000
</code></pre></div></li>
<li>完成上述映射之后，通过 <code>relocate</code> 函数，完成对 <code>satp</code> 的设置，以及跳转到对应的虚拟地址</li>
<li>至此我们已经完成了虚拟地址的开启，之后我们运行的代码也都将在虚拟地址上运行</li>
</ul>
<div class="highlight"><span class="filename">arch/riscv/kernel/vm.c</span><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="cm">/* early_pgtbl: 用于 setup_vm 进行 1GiB 的映射 */</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kt">uint64_t</span><span class="w"> </span><span class="n">early_pgtbl</span><span class="p">[</span><span class="mi">512</span><span class="p">]</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">__aligned__</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">)));</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">setup_vm</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="cm">/* </span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="cm">     * 1. 由于是进行 1GiB 的映射，这里不需要使用多级页表 </span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="cm">     * 2. 将 va 的 64bit 作为如下划分： | high bit | 9 bit | 30 bit |</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="cm">     *     high bit 可以忽略</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="cm">     *     中间 9 bit 作为 early_pgtbl 的 index</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="cm">     *     低 30 bit 作为页内偏移，这里注意到 30 = 9 + 9 + 12，即我们只使用根页表，根页表的每个 entry 都对应 1GiB 的区域</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="cm">     * 3. Page Table Entry 的权限 V | R | W | X 位设置为 1</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="cm">    **/</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="p">}</span>
</code></pre></div>
<div class="highlight"><span class="filename">arch/riscv/kernel/head.S</span><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nl">_start:</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="na">...</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">setup_vm</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">relocate</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="na">...</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="nl">relocate:</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">    </span><span class="c1"># set ra = ra + PA2VA_OFFSET</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="c1"># set sp = sp + PA2VA_OFFSET (If you have set the sp before)</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">    </span><span class="c1">###################### </span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">    </span><span class="c1">#   YOUR CODE HERE   #</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">    </span><span class="c1">######################</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">    </span><span class="c1"># need a fence to ensure the new translations are in use</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">    </span><span class="nf">sfence.vma</span><span class="w"> </span><span class="no">zero</span><span class="p">,</span><span class="w"> </span><span class="no">zero</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">    </span><span class="c1"># set satp with early_pgtbl</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="w">    </span><span class="c1">###################### </span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="w">    </span><span class="c1">#   YOUR CODE HERE   #</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="w">    </span><span class="c1">######################</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="w">    </span><span class="nf">ret</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="w">    </span><span class="na">.section</span><span class="w"> </span><span class="no">.bss.stack</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="w">    </span><span class="na">.globl</span><span class="w"> </span><span class="no">boot_stack</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="nl">boot_stack:</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a><span class="w">    </span><span class="na">...</span>
</code></pre></div>
<p>经过 <code>setup_vm</code> 设置了一级页表之后，整个 kernel 启动后应该可以直接运行在虚拟地址上了，不过在 <code>task_init</code> 中 <code>kalloc</code> 的时候可能会出现错误，因为 <code>mm_init</code> 中我们释放的内存是 <code>_ekernel ~ PHY_END</code>，在进入虚拟地址后 <code>PHY_END</code> 还是物理地址，会导致实际上没有内存被释放，<code>kalloc</code> 没有可用的空间。因此需要修改 <code>arch/riscv/kernel/mm.c</code> 的 <code>mm_init</code> 函数，将结束地址调整为虚拟地址，才能正常运行。</p>
<details class="note">
<summary>对 <code>sfence.vma</code> 和 <code>fence.i</code> 语义的详细说明</summary>
<p>在 10 月 30 日的 commit 中，去除了 <code>fence.i</code>，并调整了 <code>sfence.vma</code> 的顺序，与 Linux 内核源码保持一致，以避免同学们阅读内核源码时产生困惑。同学们可能会好奇其中的具体原理，这里简单说明一下。</p>
<p>首先看 RISC-V Privileged Spec 中对 <code>sfence.vma</code> 的描述：</p>
<blockquote>
<p>It is specified as <strong>a fence rather than a TLB flush</strong> to provide cleaner semantics with respect to which instructions are affected by the flush operation and to support a wider variety of dynamic caching structures and memory-management schemes.</p>
</blockquote>
<p>接下来看 <a href="https://elixir.bootlin.com/linux/v5.2.21/source/arch/riscv/kernel/head.S#L89">Linux 内核源码（v5.2.21）</a>：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="cm">/*</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="cm"> * Load trampoline page directory, which will cause us to trap to</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="cm"> * stvec if VA != PA, or simply fall through if VA == PA.  We need a</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="cm"> * full fence here because setup_vm() just wrote these PTEs and we need</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="cm"> * to ensure the new translations are in use.</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="cm"> */</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="nf">sfence.vma</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="nf">csrw</span><span class="w"> </span><span class="no">CSR_SATP</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span>
</code></pre></div>
<p>与实验指导的初版代码相比，这里有三个问题：为什么要在 <code>csrw satp</code> 之前加一个 <code>sfence.vma</code>？为什么后面不需要加 <code>sfence.vma</code>？为什么不需要 <code>fence.i</code>？</p>
<ol>
<li>第一个问题由上面代码段的注释解答：<code>csrw satp</code> <strong>前</strong>的 <code>sfence.vma</code> 主要是<strong>为了保证新的页表项生效</strong>而设置的一个 fence，而没有用到其刷新 TLB 的功能，毕竟这里才刚刚启用 MMU。那么为什么要保证页表项生效呢？这涉及思考题 2 的答案，在此按下不表。</li>
<li>
<p>第二个问题由 RISC-V Privileged Spec 10.3 节中的一段话解答：</p>
<blockquote>
<p>Changing <code>satp.MODE</code> <strong>from <code>Bare</code> to other modes and vice versa also takes effect immediately</strong>, without the need to execute an <code>sfence.vma</code> instruction.</p>
</blockquote>
<p>也就是说，启用或关闭分页模式时的操作立即生效，不需要额外的 <code>sfence.vma</code>。</p>
</li>
<li>
<p>第三个问题由 <a href="https://elixir.bootlin.com/linux/v5.2.21/source/arch/riscv/include/asm/tlbflush.h#L14">Linux 内核源码 <code>local_flush_tlb_all</code></a> 中的注释解答：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="cm">/*</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="cm">* Flush entire local TLB.  &#39;sfence.vma&#39; implicitly fences with the instruction</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="cm">* cache as well, so a &#39;fence.i&#39; is not necessary.</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="cm">*/</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">local_flush_tlb_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="p">{</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="n">__asm__</span><span class="w"> </span><span class="n">__volatile__</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;sfence.vma&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;memory&quot;</span><span class="p">);</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="p">}</span>
</code></pre></div>
<p>也就是说，<code>sfence.vma</code> 会<strong>隐式地刷新指令缓存</strong>，因此不需要额外的 <code>fence.i</code>。</p>
<p>你可能会好奇什么时候才会使用 <code>fence.i</code>。在 Linux 源码中搜索，可以发现主要用在进程调度。因为需要让新进程的指令替换掉旧进程的缓存，此时会显式使用 <code>fence.i</code>。</p>
</li>
</ol>
<p><a href="https://github.com/riscv/riscv-isa-manual/issues/226">SFENCE.VMA Before or After SATP Write · Issue #226 · riscv/riscv-isa-manual</a> 中 RISC-V 开发者对 <code>sfence.vma</code> 和 <code>csrw satp</code> 顺序做了一些讨论：</p>
<blockquote>
<ul>
<li><strong><code>sfence.vma</code> before <code>csrw satp</code> may be necessary</strong>: The concern is, what if the mapping for the instruction immediately after SFENCE.VMA has been modified? In the Linux kernel, this mapping is fixed (regardless of address space) so the concern does not apply.</li>
<li><strong><code>sfence.vma</code> after <code>csrw satp</code> is definitely necessary</strong>: In general, you need to SFENCE after you've recycled an ASID. Since we don't use ASIDs in the Linux kernel yet, every context switch is effectively an ASID reuse, <strong>hence the full TLB flush</strong>.</li>
</ul>
</blockquote>
<p>根据上述解释，在 <code>setup_vm_final</code> 中第二次切换 satp 时，其后必须要设置 <code>sfence.vma</code>，否则可能命中旧页表。但是你会发现，即使去掉 <code>sfence.vma</code>，实验依然可以正常运行。更进一步地，我们可以设计下面的代码：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">setup_vm_final</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="c1">// create old TLB entry</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;li t0, 0x80200000&quot;</span><span class="p">);</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;ld t1, 0(t0)&quot;</span><span class="p">);</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="c1">// set satp with swapper_pg_dir</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">    </span><span class="n">csr_write</span><span class="p">(</span><span class="n">satp</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span><span class="w"> </span><span class="c1">// your code</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="c1">// try to hit old TLB entry</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;li t0, 0x80200000&quot;</span><span class="p">);</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;ld t1, 0(t0)&quot;</span><span class="p">);</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="p">}</span>
</code></pre></div>
<p>第二个 <code>ld</code> 将失败，说明 TLB 已经被刷新了，并不符合预期。原因是 QEMU、spike 这类模拟器会在写 SATP 时立即刷新 TLB 来避免泄漏无效的缓存映射。不过 RISC-V 的标准中并未强制规定这一点，所以为了兼容性考虑，我们还是需要在写 <code>satp</code> 后使用 <code>sfence.vma</code> 来保证在任何平台上都可以正确运行。</p>
</details>
<div class="admonition tip">
<p class="admonition-title">调试小寄巧</p>
<ul>
<li>在设置好 <code>satp</code> 寄存器之前，我们只可以使用<strong>物理地址</strong>来打断点<ul>
<li>因为符号表、<code>vmlinux.lds</code> 里面记录的函数名的地址都是虚拟地址</li>
<li>在设置好 <code>satp</code> 之前，这样子打断点，会与真实的地址相差一个 <code>PA2VA_OFFSET</code></li>
<li>你可以在目录下编译生成的 <code>vmlinux.asm</code> 中找到所有代码的虚拟地址，然后将其转换成物理地址，再使用 <code>b *&lt;addr&gt;</code> 命令设置断点</li>
</ul>
</li>
<li>设置 satp 之后，才可以使用虚拟地址打断点，同时之前设置的物理地址断点也会失效，需要删除</li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">旧版本 QEMU（7.0 以前）对于指令缓存等处理有 bug，会导致刷新了缓存但实际上并没有作用，可能会导致调试过程中出现困惑，或者使得代码以灵车的方式跑了起来，因此请同学们务必保证自己使用的 QEMU 足够新（8.2.2 及以上），否则请参考 lab0/lab1 文档进行更新</p>
</div>
<h4 id="setup_vm_final"><code>setup_vm_final</code> 的实现<a class="headerlink" href="#setup_vm_final" title="Permanent link">&para;</a></h4>
<p>由于 <code>setup_vm_final</code> 中需要申请页面来建立多级页表，我们需要先调用 <code>mm_init</code> 来完成内存管理初始化，同时如上一节所讲，需要注意将 <code>mm_init</code> 中 <code>kfreerange</code> 的结束地址调整为虚拟地址。</p>
<p>接下来 <code>setup_vm_final</code> 需要完成对所有物理内存 (128M) 的映射，并设置正确的权限，具体的映射关系如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>Physical Address
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>     PHY_START                           PHY_END
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>         ↓                                  ↓
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>--------------------------------------------------------
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>         | OpenSBI | Kernel |               |
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>--------------------------------------------------------
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>         ↑                                  ↑
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>    0x80000000                              └────────────────────────┐
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>         └────────────────────────┐                                  |
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>                                  |                                  |
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>                               VM_START                              |
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>Virtual Address                   ↓                                  ↓
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>-------------------------------------------------------------------------
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>                                  |         | Kernel |               |
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>-------------------------------------------------------------------------
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>                                  ↑
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>                          0xffffffe000000000
</code></pre></div>
<ul>
<li>不再需要进行等值映射</li>
<li>不再需要为 OpenSBI 创建映射，因为 OpenSBI 运行在 M 态，直接使用物理地址</li>
<li>采用三级页表映射</li>
<li>在 head.S 中 适当的位置调用 <code>setup_vm_final</code></li>
<li><font color="#ff0000">请不要修改 create_mapping 的函数声明，并注意阅读下方对参数的描述。该函数会被用于测试实验的正确性。</font></li>
</ul>
<div class="highlight"><span class="filename">arch/riscv/kernel/vm.c</span><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="cm">/* swapper_pg_dir: kernel pagetable 根目录，在 setup_vm_final 进行映射 */</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kt">uint64_t</span><span class="w"> </span><span class="n">swapper_pg_dir</span><span class="p">[</span><span class="mi">512</span><span class="p">]</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">__aligned__</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">)));</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">setup_vm_final</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">swapper_pg_dir</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">    </span><span class="c1">// No OpenSBI mapping required</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">    </span><span class="c1">// mapping kernel text X|-|R|V</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">    </span><span class="n">create_mapping</span><span class="p">(...);</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">    </span><span class="c1">// mapping kernel rodata -|-|R|V</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w">    </span><span class="n">create_mapping</span><span class="p">(...);</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="w">    </span><span class="c1">// mapping other memory -|W|R|V</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="w">    </span><span class="n">create_mapping</span><span class="p">(...);</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="w">    </span><span class="c1">// set satp with swapper_pg_dir</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="w">    </span><span class="c1">// YOUR CODE HERE</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="w">    </span><span class="c1">// flush TLB</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;sfence.vma zero, zero&quot;</span><span class="p">);</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="p">}</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="cm">/* 创建多级页表映射关系 */</span>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="cm">/* 不要修改该接口的参数和返回值 */</span>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a><span class="kt">void</span><span class="w"> </span><span class="nf">create_mapping</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgtbl</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">sz</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a><span class="w">    </span><span class="cm">/*</span>
<a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a><span class="cm">     * pgtbl 为根页表的基地址</span>
<a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a><span class="cm">     * va, pa 为需要映射的虚拟地址、物理地址</span>
<a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a><span class="cm">     * sz 为映射的大小，单位为字节</span>
<a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a><span class="cm">     * perm 为映射的权限（即页表项的低 8 位）</span>
<a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a><span class="cm">     * </span>
<a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a><span class="cm">     * 创建多级页表的时候可以使用 kalloc() 来获取一页作为页表目录</span>
<a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a><span class="cm">     * 可以使用 V bit 来判断页表项是否存在</span>
<a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a><span class="cm">    **/</span>
<a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a><span class="p">}</span>
</code></pre></div>
<h3 id="_8">编译及测试<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>由于加入了一些新的 .c 文件，可能需要修改一些Makefile文件，请同学自己尝试修改，使项目可以编译并运行</p>
<details class="success">
<summary>输出示例</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>...mm_init<span class="w"> </span><span class="k">done</span>!
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>...task_init<span class="w"> </span><span class="k">done</span>!
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="m">2024</span><span class="w"> </span>ZJU<span class="w"> </span>Operating<span class="w"> </span>System
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>SET<span class="w"> </span><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">PRIORITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="nv">COUNTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="o">]</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>SET<span class="w"> </span><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="nv">PRIORITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="nv">COUNTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="o">]</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>SET<span class="w"> </span><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="nv">PRIORITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="nv">COUNTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="o">]</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>SET<span class="w"> </span><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="nv">PRIORITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">COUNTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">]</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>switch<span class="w"> </span>to<span class="w"> </span><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="nv">PRIORITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="nv">COUNTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="o">]</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">9</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>switch<span class="w"> </span>to<span class="w"> </span><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">PRIORITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="nv">COUNTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="o">]</span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>
<a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span>
<a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span>
<a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a>
<a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a>switch<span class="w"> </span>to<span class="w"> </span><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="nv">PRIORITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="nv">COUNTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="o">]</span>
<a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>
<a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>
<a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a>
<a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a>switch<span class="w"> </span>to<span class="w"> </span><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="nv">PRIORITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">COUNTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">]</span>
<a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>running.<span class="w"> </span><span class="nv">auto_inc_local_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a>
<a id="__codelineno-19-40" name="__codelineno-19-40" href="#__codelineno-19-40"></a>SET<span class="w"> </span><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">PRIORITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="nv">COUNTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="o">]</span>
<a id="__codelineno-19-41" name="__codelineno-19-41" href="#__codelineno-19-41"></a>SET<span class="w"> </span><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="nv">PRIORITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="nv">COUNTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="o">]</span>
<a id="__codelineno-19-42" name="__codelineno-19-42" href="#__codelineno-19-42"></a>SET<span class="w"> </span><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="nv">PRIORITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="nv">COUNTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="o">]</span>
<a id="__codelineno-19-43" name="__codelineno-19-43" href="#__codelineno-19-43"></a>SET<span class="w"> </span><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="nv">PRIORITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">COUNTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">]</span>
<a id="__codelineno-19-44" name="__codelineno-19-44" href="#__codelineno-19-44"></a>
<a id="__codelineno-19-45" name="__codelineno-19-45" href="#__codelineno-19-45"></a>switch<span class="w"> </span>to<span class="w"> </span><span class="o">[</span><span class="nv">PID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="nv">PRIORITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="nv">COUNTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="o">]</span>
<a id="__codelineno-19-46" name="__codelineno-19-46" href="#__codelineno-19-46"></a>...
</code></pre></div>
</details>
<h2 id="_9">思考题<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<ol>
<li>验证 <code>.text</code>，<code>.rodata</code> 段的属性是否成功设置，给出截图。</li>
<li>
<p>为什么我们在 <code>setup_vm</code> 中需要做等值映射？在 Linux 中，是不需要做等值映射的，请探索一下不在 <code>setup_vm</code> 中做等值映射的方法。你需要回答以下问题：</p>
<ul>
<li>本次实验中如果不做等值映射，会出现什么问题，原因是什么；</li>
<li>简要分析 <a href="https://elixir.bootlin.com/linux/v5.2.21/source">Linux v5.2.21</a> 或之后的版本中的内核启动部分（直至 <code>init/main.c</code> 中 <code>start_kernel</code> 开始之前），特别是设置 satp 切换页表附近的逻辑；</li>
<li>回答 Linux 为什么可以不进行等值映射，它是如何在无等值映射的情况下让 pc 从物理地址跳到虚拟地址；</li>
<li>Linux v5.2.21 中的 <code>trampoline_pg_dir</code> 和 <code>swapper_pg_dir</code> 有什么区别，它们分别是在哪里通过 satp 设为所使用的页表的；</li>
<li>尝试修改你的 kernel，使得其可以像 Linux 一样不需要等值映射。</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Hint</p>
<p>你需要特别关注 pc 的变化以及某些指令对于 pc 的影响等。</p>
<p>虽然 Linux 是一个非常庞大的项目，但是同学们也不需要有畏难情绪，启动部分的结构和我们自己实现的结构其实非常类似（arch/riscv/kernel/head.S 之类的），如果遇到完全没听说过的指令或者代码（比如 setup_vm 中的 pmd 相关的东西等）可以暂时跳过，不认识的地方对于我们要分析的主要逻辑也基本没有什么大影响。</p>
</div>
</li>
</ol>
<h2 id="_10">实验任务与要求<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<ul>
<li>请各位同学独立完成作业，任何抄袭行为都将使本次作业判为 0 分。</li>
<li>在学在浙大中提交：<ul>
<li>整个工程代码的压缩包（提交之前请使用 <code>make clean</code> 清除所有构建产物）</li>
<li>pdf 格式的实验报告：<ul>
<li>记录实验过程并截图（4.1-4.3），并对每一步的命令以及结果进行必要的解释；</li>
<li>记录遇到的问题和心得体会；</li>
<li>完成思考题。</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">关于实验报告内容要求，可见：<a href="../faq/#_2">常见问题及解答 - 实验提交要求</a></p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../lab2/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 实验指导二">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                实验指导二
              </div>
            </div>
          </a>
        
        
          
          <a href="../lab4/" class="md-footer__link md-footer__link--next" aria-label="Next: 实验指导四">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                实验指导四
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "content.code.annotate", "content.action.edit", "navigation.top", "navigation.footer", "navigation.tracking"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>