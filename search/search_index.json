{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"\u6d59\u6c5f\u5927\u5b6625\u5e74\u79cb\u51ac\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c","text":"<p>\u672c\u4ed3\u5e93\u662f\u6d59\u6c5f\u5927\u5b6625\u5e74\u79cb\u51ac\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u7684\u6559\u5b66\u4ed3\u5e93\uff0c\u5305\u542b\u5728\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u4e0a\u6240\u6709\u7684\u5b9e\u9a8c\u6587\u6863\u548c\u516c\u5f00\u4ee3\u7801\u3002\u4ed3\u5e93\u76ee\u5f55\u7ed3\u6784\uff1a</p> <pre><code>\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 docs/       # \u5b9e\u9a8c\u6587\u6863   \n\u251c\u2500\u2500 mkdocs.yml\n\u2514\u2500\u2500 src/        # \u516c\u5f00\u4ee3\u7801\n</code></pre> <p>\u5b9e\u9a8c\u6587\u6863\u5df2\u7ecf\u90e8\u7f72\u5728\u4e86GitHub Pages\u4e0a\uff0c\u65b9\u4fbf\u5927\u5bb6\u9605\u8bfb\u3002</p>"},{"location":"#_1","title":"\u672c\u5730\u6e32\u67d3\u6587\u6863","text":"<p>\u6587\u6863\u91c7\u7528\u4e86 mkdocs-material \u5de5\u5177\u6784\u5efa\u548c\u90e8\u7f72\u3002\u5982\u679c\u60f3\u5728\u672c\u5730\u6e32\u67d3\uff1a</p> <pre><code>$ pip3 install mkdocs-material mkdocs-heti-plugin==0.1.6   # \u5b89\u88c5 mkdocs \u53ca\u63d2\u4ef6\n$ git clone https://github.com/JuniorSNy/zju-os-sld        # clone \u672c repo\n$ mkdocs serve                                             # \u672c\u5730\u6e32\u67d3\nINFO     -  Building documentation...\nINFO     -  Cleaning site directory\n...\nINFO     -  [11:00:57] Serving on http://127.0.0.1:8000/os25fall-stu/\n</code></pre>"},{"location":"#_2","title":"\u81f4\u8c22","text":"<p>\u611f\u8c22\u4ee5\u4e0b\u5404\u4f4d\u8001\u5e08\u548c\u52a9\u6559\u7684\u8f9b\u52e4\u4ed8\u51fa\uff01</p> <p>\u7533\u6587\u535a\u3001\u5468\u4e9a\u91d1\u3001\u5f90\u91d1\u7131\u3001\u5468\u4fa0\u3001\u7ba1\u7ae0\u8f89\u3001\u5f20\u6587\u9f99\u3001\u5218\u5f3a\u3001\u5b59\u5bb6\u680b\u3001\u5468\u5929\u6631\u3001\u5e84\u963f\u5f97\u3001\u738b\u7428\u3001\u6c88\u97ec\u7acb\u3001\u738b\u661f\u5b87\u3001\u6731\u749f\u68ee\u3001\u8c22\u6d35\u3001\u6f58\u5b50\u66f0\u3001\u6731\u82e5\u51e1\u3001\u5b63\u9ad8\u5f3a\u3001\u90ed\u82e5\u5bb9\u3001\u675c\u4e91\u6f47\u3001\u5434\u9038\u98de\u3001\u674e\u7a0b\u6d69\u3001\u6731\u5bb6\u8fc5\u3001\u738b\u884c\u6977\u3001\u9648\u6de6\u8c6a\u3001\u8d75\u7d2b\u5bb8\u3001\u738b\u9e64\u7fd4\u3001\u8bb8\u660a\u745e\u3002</p>"},{"location":"aigc/","title":"AIGC\u4f7f\u7528\u6307\u5317","text":"<p>\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u6839\u636e\u672c\u6587\u6863\u81ea\u884c\u4f7f\u7528 spike \u5de5\u5177\u94fe\u8fd0\u884c RISC-V kernel</p> <p>\u672c\u8bfe\u7a0b\u6240\u6709\u5b9e\u9a8c\u7684\u7ed3\u679c\u6700\u540e\u4ecd\u4ee5 qemu \u4e3a\u51c6\uff0cspike \u4ec5\u4f9b\u6709\u5174\u8da3\u7684\u540c\u5b66\u5c1d\u8bd5</p>"},{"location":"aigc/#aigc_1","title":"\u5efa\u8bae\u4f7f\u7528AIGC\u7684\u573a\u666f","text":""},{"location":"aigc/#spike","title":"Spike","text":"<p>Spike \u662f\u4e00\u4e2a\u548c QEMU \u7c7b\u4f3c\u7684\u6307\u4ee4\u6a21\u62df\u5668\u3002\u867d\u7136\u5b83\u4e0d\u50cf QEMU \u90a3\u6837\u652f\u6301\u5404\u79cd\u6307\u4ee4\u96c6\u67b6\u6784\uff0c\u53ef\u4ee5\u6a21\u62df\u590d\u6742\u7684\u5916\u8bbe\uff0c\u4f46\u662f\u5728 RISC-V \u7684\u6a21\u62df\u548c\u652f\u6301\u4e0a\uff0cspike \u662f\u9010\u6761\u6307\u4ee4\u8fdb\u884c\u6a21\u62df\uff0c\u4e14\u4e25\u683c\u6309\u7167 RISC-V \u7684\u6307\u4ee4\u96c6\u624b\u518c\uff0c\u5bf9\u4e8e RISC-V \u7a0b\u5e8f\u7684\u68c0\u67e5\u66f4\u4e3a\u4e25\u8c28\u3002</p> <p>\u7279\u522b\u662f\u5728\u9875\u8868\u7684\u5b9e\u9a8c\u4e2d\uff0cspike \u4f1a\u4e25\u8c28\u5f97\u591a\uff0c\u63a8\u8350\u6709\u7cbe\u529b\u7684\u540c\u5b66\u989d\u5916\u7528 spike \u8fd0\u884c\u8fdb\u884c\u6d4b\u8bd5</p> <p>QEMU \u4e3a\u4e86\u8ffd\u6c42\u8fd0\u884c\u7684\u9ad8\u6548\uff0c\u5f80\u5f80\u4f1a\u5c06\u6307\u4ee4\u5206\u5757\u6253\u5305\u7f16\u8bd1\u4e3a\u5bbf\u4e3b\u673a\u6307\u4ee4\u9ad8\u6548\u8fd0\u884c\uff1b\u800c spike \u5219\u9009\u62e9\u4e86\u6839\u636e RISC-V \u6307\u4ee4\u96c6\u5145\u5206\u6a21\u62df RISC-V \u4f53\u7cfb\u7ed3\u6784\u7684\u5404\u79cd\u786c\u4ef6\uff0c\u7136\u540e\u9010\u6761\u8fd0\u884c\u6307\u4ee4\uff0c\u5e76\u4fee\u6539\u5404\u4e2a\u6a21\u62df\u786c\u4ef6\uff0c\u5f53\u7136\u8fd9\u4e5f\u4f1a\u5bfc\u81f4 spike \u8fd0\u884c\u901f\u5ea6\u6bd4 qemu \u6162\u4e00\u4e9b\u3002</p> <p>\u5982\u679c\u540c\u5b66\u4eec\u60f3\u8981\u4e86\u89e3\u4e00\u4e9b RISC-V \u673a\u5236\u7684\u5177\u4f53\u5b9e\u73b0\uff0c\u76f4\u63a5\u9605\u8bfb spike \u7684\u6e90\u7801\u4e5f\u662f\u4e0d\u9519\u7684\u9009\u62e9\u3002</p>"},{"location":"aigc/#openocd","title":"OpenOCD","text":"<p>OpenOCD \u662f\u4e00\u4e2a\u8c03\u8bd5\u7684\u4e2d\u95f4\u5de5\u5177\u3002\u4e00\u4e9b RISC-V \u82af\u7247\u4e3a\u4e86\u65b9\u4fbf\u786c\u4ef6\u8c03\u8bd5\u5185\u90e8\u7684\u4fe1\u606f\u4f1a\u5728\u5185\u90e8\u96c6\u6210\u4e00\u4e2a debug module\uff0c\u5e76\u5bf9\u5916\u66b4\u9732\u4e00\u4e2a JTAG \u63a5\u53e3\u3002\u8c03\u8bd5\u8005\u53ef\u4ee5\u7528 JTAG \u7ebf\u7684\u8f93\u5165\u7ebf\u5411 debug module \u8f93\u5165\u547d\u4ee4\uff0c\u5e76\u7528\u8f93\u51fa\u7ebf\u5f97\u5230\u9700\u8981\u8bfb\u53d6\u7684\u7ed3\u679c\u3002\u8fd9\u4e2a\u6307\u4ee4\u4f20\u8f93\u534f\u8bae\u662f\u590d\u6742\u7684\uff0c\u6211\u4eec\u672c\u80fd\u5730\u5e0c\u671b\u53ef\u4ee5\u6709\u4e00\u4e2a\u7b80\u5355\u7684\u547d\u4ee4\u5de5\u5177\uff0c\u6211\u4eec\u5411\u4ed6\u53d1\u9001\u8bf8\u5982 read\u3001write \u7684\u6307\u4ee4\uff0c\u5b83\u518d\u5e2e\u6211\u4eec\u8f6c\u6362\u4e3a\u6666\u6da9\u7684 DMI \u6307\u4ee4\u5e8f\u5217\uff0c\u8fd9\u4e2a\u5de5\u5177\u5c31\u662f OpenOCD\u3002</p> <p>Spike \u76f4\u63a5\u6a21\u62df\u7684\u662f\u786c\u4ef6\u8bbe\u5907\uff0c\u6240\u4ee5\u5b83\u4e5f\u76f4\u63a5\u6a21\u62df\u4e86\u4e00\u4e2a debug module\uff0c\u6307\u5b9a <code>--rbb-port</code> \u9009\u9879\u4e4b\u540e\uff0c\u5b83\u5c31\u53ef\u4ee5\u5f00\u653e\u5bf9\u5e94\u7684\u6a21\u62df JTAG \u7aef\u53e3\u7b49\u5f85\u88ab\u8fde\u63a5\u8c03\u8bd5\u3002OpenOCD \u8fde\u63a5\u8fd9\u4e2a\u7aef\u53e3\u7136\u540e\u5f00\u59cb\u8c03\u8bd5\uff0c\u4e0d\u8fc7\u5b83\u5e76\u4e0d\u77e5\u9053\u6211\u4eec\u7684 spike \u7684\u5e73\u53f0\u7c7b\u578b\u7684\u8fde\u63a5\u7c7b\u578b\uff0c\u56e0\u6b64\u9700\u8981\u6211\u4eec\u989d\u5916\u63d0\u4f9b openocd.cfg \u6587\u4ef6\uff0c\u53ea\u8981\u8fd0\u884c <code>openocd -f openocd.cfg</code>\uff0c\u5c31\u4f1a\u81ea\u52a8\u8fde\u63a5 9824 \u7aef\u53e3\uff0c\u5e76\u51c6\u5907\u8c03\u8bd5\u6211\u4eec\u7684 spike\u3002\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>adapter driver remote_bitbang\nremote_bitbang host localhost\nremote_bitbang port 9824\n\nset _CHIPNAME riscv\njtag newtap $_CHIPNAME cpu -irlen 5 \n\nset _TARGETNAME $_CHIPNAME.cpu\ntarget create $_TARGETNAME riscv -chain-position $_TARGETNAME\n\nbindto 0.0.0.0\ngdb_report_data_abort enable\n\ninit\nreset halt\n</code></pre> <p>\u5b83\u8fde\u63a5\u4e86 remote bitbang \u7684\u7aef\u53e3\uff0c\u7136\u540e\u521b\u5efa\u4e86\u4e00\u4e2a tap \u548c target\uff0c\u5f00\u542f\u4e86 gdb \u540e\u91cd\u7f6e\u7b49\u5f85\u8c03\u8bd5\u3002\u8fd9\u6837 OpenOCD \u4f1a\u9ed8\u8ba4\u5f00\u653e 3333 \u7aef\u53e3\u7ed9 gdb \u8fde\u63a5\uff0c\u901a\u8fc7 <code>target extended-remote localhost:3333</code> \u6216\u8005 <code>tar ext :3333</code> \u5c31\u53ef\u4ee5\u8fde\u63a5\u5230 OpenOCD\u3002</p> <p>\u4e4b\u540e OpenOCD \u53ef\u4ee5\u62c5\u5f53 gdb \u548c spike \u4e4b\u95f4\u7684\u6865\u6881\u3002gdb \u63a5\u6536\u5230\u7684\u6307\u4ee4\u4f1a\u53d1\u9001\u7ed9 OpenOCD\uff0cOpenOCD \u5c06\u5b83\u8f6c\u6362\u4e3a\u5bf9\u5e94\u7684 01 \u4e32\u53d1\u9001\u7ed9 spike \u8fdb\u884c\u8c03\u8bd5\uff0c\u53cd\u4e4b\u4ea6\u7136\u3002\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 gdb-OpenOCD-spike \u7684\u5de5\u5177\u94fe\u5b9e\u73b0\u539f\u6765 gdb-qemu \u7684\u6548\u679c\u3002</p>"},{"location":"aigc/#opensbi","title":"OpenSBI","text":"<p>OpenSBI \u5927\u5bb6\u5728 lab1 \u4e2d\u5e94\u8be5\u90fd\u6709\u6240\u4e86\u89e3\uff0c\u5c31\u4e0d\u4ecb\u7ecd\u5b83\u672c\u8eab\u4e86\u3002\u8fd9\u4e2a\u5de5\u5177\u94fe\u4e4b\u6240\u4ee5\u9700\u8981 OpenSBI\uff0c\u662f\u56e0\u4e3a spike \u6a21\u62df\u7684\u662f\u4e00\u53f0\u88f8\u673a\u3002\u6211\u4eec\u7684 kernel \u4e0d\u53ef\u4ee5\u76f4\u63a5\u5728\u88f8\u673a\u4e0a\u8fd0\u884c\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u989d\u5916\u7684 OpenSBI \u7684\u4ee3\u7801\u505a\u524d\u671f\u7684\u542f\u52a8\u3002\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e0b\u8f7d OpenSBI \u4ee3\u7801\u5e76\u5c06\u5b83\u7f16\u8bd1\u5f97\u5230 fw_jump.elf\uff0c\u4f5c\u4e3a M \u6001\u7684\u7ef4\u62a4\u4ee3\u7801\u3002</p>"},{"location":"aigc/#_1","title":"\u5de5\u5177\u94fe\u4f7f\u7528","text":""},{"location":"aigc/#_2","title":"\u7f16\u8bd1\u5b89\u88c5","text":""},{"location":"aigc/#spike_1","title":"Spike","text":"<p>Spike \u9700\u8981\u5927\u5bb6\u4ece\u6e90\u7801\u81ea\u884c\u7f16\u8bd1\u5b89\u88c5\uff1a</p> <pre><code>git clone https://github.com/riscv-software-src/riscv-isa-sim\ncd riscv-isa-sim\nsudo apt install device-tree-compiler libboost-regex-dev libboost-system-dev\nmkdir build\ncd build\n../configure\nmake -j$(nproc)\nsudo make install\n</code></pre>"},{"location":"aigc/#openocd_1","title":"OpenOCD","text":"<p>OpenOCD \u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 <code>sudo apt install openocd</code> \u6765\u5b89\u88c5\uff0c\u4e5f\u53ef\u4ee5\u4ece\u6e90\u7801\u7f16\u8bd1\uff1a</p> <pre><code>git clone https://github.com/openocd-org/openocd/\ncd openocd\nsudo apt install libtool\n./bootstrap\n./configure --enable-remote-bitbang\nmake\nsudo make install\n</code></pre>"},{"location":"aigc/#opensbi_1","title":"OpenSBI","text":"<p>\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u7f16\u8bd1\u597d\u7684 fw_jump.elf \u5728\u672c\u4ed3\u5e93 <code>src/spike/fw_jump.elf</code> \u4e2d\u3002</p> <p>\u5982\u679c\u9700\u8981\u81ea\u884c\u7f16\u8bd1\u7684\u8bdd\u9700\u8981\u5148\u901a\u8fc7 <code>make PLATFORM=generic menuconfig</code> \u6765\u5173\u6389 Utils and Drivers Support &gt; Serial Device Support &gt; Semihosting support \u8fd9\u4e00\u9009\u9879\u3002\u7136\u540e\u8fdb\u884c\u7f16\u8bd1\uff1a</p> <pre><code>git clone https://github.com/riscv-software-src/opensbi\ncd opensbi\nmkdir build\nmake O=build CROSS_COMPILE=riscv64-linux-gnu- PLATFORM=generic\n# output: build/platform/generic/firmware/fw_jump.elf\n</code></pre>"},{"location":"aigc/#_3","title":"\u8fd0\u884c","text":"<p>\u672c\u4ed3\u5e93 <code>src/spike</code> \u4e2d\u63d0\u4f9b\u4e86 <code>Makefile.extra</code>\uff0c\u9700\u8981\u5927\u5bb6\u5c06\u5176\u4e2d\u5185\u5bb9\u590d\u5236\u5230\u81ea\u5df1 kernel \u7684 <code>Makefile</code> \u4e2d\uff0c\u6ce8\u610f\u5176\u4e2d <code>SPIKE_CONFIG</code> \u76ee\u5f55\u7684\u5177\u4f53\u4f4d\u7f6e\u8981\u8fdb\u884c\u4fee\u6539\u3002</p> <p>\u7136\u540e\u6267\u884c <code>make spike_run</code> \u5c31\u53ef\u4ee5\u901a\u8fc7 spike \u8fd0\u884c kernel \u4e86\u3002</p>"},{"location":"aigc/#_4","title":"\u8c03\u8bd5","text":"<p>\u8c03\u8bd5\u7684\u8bdd\u4e00\u5171\u9700\u8981\u4e09\u4e2a\u7ec8\u7aef\u7a97\u53e3\uff0c\u4f9d\u6b21\u6267\u884c\uff1a</p> <ol> <li><code>make spike_debug</code>\uff1a\u542f\u52a8 spike \u5e76\u7b49\u5f85\u8c03\u8bd5</li> <li><code>make spike_bridge</code>\uff1a\u542f\u52a8 OpenOCD \u5e76\u8fde\u63a5 spike</li> <li><code>gdb-multiarch vmlinux</code>\uff1a\u542f\u52a8 gdb\uff0c\u7136\u540e\u6267\u884c\uff1a    - <code>tar ext :3333</code>\uff1a\u8fde\u63a5\u5230 OpenOCD    - \u5f00\u59cb\u8c03\u8bd5</li> </ol> <p>\u540e\u7eed\u7684\u8c03\u8bd5\u6d41\u7a0b\u548c qemu \u7c7b\u4f3c\uff0c\u4e0d\u518d\u8d58\u8ff0\u3002</p>"},{"location":"appendix/","title":"\u9644\u5f55","text":"<p>\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u6839\u636e\u672c\u6587\u6863\u81ea\u884c\u4f7f\u7528 spike \u5de5\u5177\u94fe\u8fd0\u884c RISC-V kernel</p> <p>\u672c\u8bfe\u7a0b\u6240\u6709\u5b9e\u9a8c\u7684\u7ed3\u679c\u6700\u540e\u4ecd\u4ee5 qemu \u4e3a\u51c6\uff0cspike \u4ec5\u4f9b\u6709\u5174\u8da3\u7684\u540c\u5b66\u5c1d\u8bd5</p>"},{"location":"appendix/#aigc","title":"\u5efa\u8bae\u4f7f\u7528AIGC\u7684\u573a\u666f","text":""},{"location":"appendix/#spike","title":"Spike","text":"<p>Spike \u662f\u4e00\u4e2a\u548c QEMU \u7c7b\u4f3c\u7684\u6307\u4ee4\u6a21\u62df\u5668\u3002\u867d\u7136\u5b83\u4e0d\u50cf QEMU \u90a3\u6837\u652f\u6301\u5404\u79cd\u6307\u4ee4\u96c6\u67b6\u6784\uff0c\u53ef\u4ee5\u6a21\u62df\u590d\u6742\u7684\u5916\u8bbe\uff0c\u4f46\u662f\u5728 RISC-V \u7684\u6a21\u62df\u548c\u652f\u6301\u4e0a\uff0cspike \u662f\u9010\u6761\u6307\u4ee4\u8fdb\u884c\u6a21\u62df\uff0c\u4e14\u4e25\u683c\u6309\u7167 RISC-V \u7684\u6307\u4ee4\u96c6\u624b\u518c\uff0c\u5bf9\u4e8e RISC-V \u7a0b\u5e8f\u7684\u68c0\u67e5\u66f4\u4e3a\u4e25\u8c28\u3002</p> <p>\u7279\u522b\u662f\u5728\u9875\u8868\u7684\u5b9e\u9a8c\u4e2d\uff0cspike \u4f1a\u4e25\u8c28\u5f97\u591a\uff0c\u63a8\u8350\u6709\u7cbe\u529b\u7684\u540c\u5b66\u989d\u5916\u7528 spike \u8fd0\u884c\u8fdb\u884c\u6d4b\u8bd5</p> <p>QEMU \u4e3a\u4e86\u8ffd\u6c42\u8fd0\u884c\u7684\u9ad8\u6548\uff0c\u5f80\u5f80\u4f1a\u5c06\u6307\u4ee4\u5206\u5757\u6253\u5305\u7f16\u8bd1\u4e3a\u5bbf\u4e3b\u673a\u6307\u4ee4\u9ad8\u6548\u8fd0\u884c\uff1b\u800c spike \u5219\u9009\u62e9\u4e86\u6839\u636e RISC-V \u6307\u4ee4\u96c6\u5145\u5206\u6a21\u62df RISC-V \u4f53\u7cfb\u7ed3\u6784\u7684\u5404\u79cd\u786c\u4ef6\uff0c\u7136\u540e\u9010\u6761\u8fd0\u884c\u6307\u4ee4\uff0c\u5e76\u4fee\u6539\u5404\u4e2a\u6a21\u62df\u786c\u4ef6\uff0c\u5f53\u7136\u8fd9\u4e5f\u4f1a\u5bfc\u81f4 spike \u8fd0\u884c\u901f\u5ea6\u6bd4 qemu \u6162\u4e00\u4e9b\u3002</p> <p>\u5982\u679c\u540c\u5b66\u4eec\u60f3\u8981\u4e86\u89e3\u4e00\u4e9b RISC-V \u673a\u5236\u7684\u5177\u4f53\u5b9e\u73b0\uff0c\u76f4\u63a5\u9605\u8bfb spike \u7684\u6e90\u7801\u4e5f\u662f\u4e0d\u9519\u7684\u9009\u62e9\u3002</p>"},{"location":"appendix/#openocd","title":"OpenOCD","text":"<p>OpenOCD \u662f\u4e00\u4e2a\u8c03\u8bd5\u7684\u4e2d\u95f4\u5de5\u5177\u3002\u4e00\u4e9b RISC-V \u82af\u7247\u4e3a\u4e86\u65b9\u4fbf\u786c\u4ef6\u8c03\u8bd5\u5185\u90e8\u7684\u4fe1\u606f\u4f1a\u5728\u5185\u90e8\u96c6\u6210\u4e00\u4e2a debug module\uff0c\u5e76\u5bf9\u5916\u66b4\u9732\u4e00\u4e2a JTAG \u63a5\u53e3\u3002\u8c03\u8bd5\u8005\u53ef\u4ee5\u7528 JTAG \u7ebf\u7684\u8f93\u5165\u7ebf\u5411 debug module \u8f93\u5165\u547d\u4ee4\uff0c\u5e76\u7528\u8f93\u51fa\u7ebf\u5f97\u5230\u9700\u8981\u8bfb\u53d6\u7684\u7ed3\u679c\u3002\u8fd9\u4e2a\u6307\u4ee4\u4f20\u8f93\u534f\u8bae\u662f\u590d\u6742\u7684\uff0c\u6211\u4eec\u672c\u80fd\u5730\u5e0c\u671b\u53ef\u4ee5\u6709\u4e00\u4e2a\u7b80\u5355\u7684\u547d\u4ee4\u5de5\u5177\uff0c\u6211\u4eec\u5411\u4ed6\u53d1\u9001\u8bf8\u5982 read\u3001write \u7684\u6307\u4ee4\uff0c\u5b83\u518d\u5e2e\u6211\u4eec\u8f6c\u6362\u4e3a\u6666\u6da9\u7684 DMI \u6307\u4ee4\u5e8f\u5217\uff0c\u8fd9\u4e2a\u5de5\u5177\u5c31\u662f OpenOCD\u3002</p> <p>Spike \u76f4\u63a5\u6a21\u62df\u7684\u662f\u786c\u4ef6\u8bbe\u5907\uff0c\u6240\u4ee5\u5b83\u4e5f\u76f4\u63a5\u6a21\u62df\u4e86\u4e00\u4e2a debug module\uff0c\u6307\u5b9a <code>--rbb-port</code> \u9009\u9879\u4e4b\u540e\uff0c\u5b83\u5c31\u53ef\u4ee5\u5f00\u653e\u5bf9\u5e94\u7684\u6a21\u62df JTAG \u7aef\u53e3\u7b49\u5f85\u88ab\u8fde\u63a5\u8c03\u8bd5\u3002OpenOCD \u8fde\u63a5\u8fd9\u4e2a\u7aef\u53e3\u7136\u540e\u5f00\u59cb\u8c03\u8bd5\uff0c\u4e0d\u8fc7\u5b83\u5e76\u4e0d\u77e5\u9053\u6211\u4eec\u7684 spike \u7684\u5e73\u53f0\u7c7b\u578b\u7684\u8fde\u63a5\u7c7b\u578b\uff0c\u56e0\u6b64\u9700\u8981\u6211\u4eec\u989d\u5916\u63d0\u4f9b openocd.cfg \u6587\u4ef6\uff0c\u53ea\u8981\u8fd0\u884c <code>openocd -f openocd.cfg</code>\uff0c\u5c31\u4f1a\u81ea\u52a8\u8fde\u63a5 9824 \u7aef\u53e3\uff0c\u5e76\u51c6\u5907\u8c03\u8bd5\u6211\u4eec\u7684 spike\u3002\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>adapter driver remote_bitbang\nremote_bitbang host localhost\nremote_bitbang port 9824\n\nset _CHIPNAME riscv\njtag newtap $_CHIPNAME cpu -irlen 5 \n\nset _TARGETNAME $_CHIPNAME.cpu\ntarget create $_TARGETNAME riscv -chain-position $_TARGETNAME\n\nbindto 0.0.0.0\ngdb_report_data_abort enable\n\ninit\nreset halt\n</code></pre> <p>\u5b83\u8fde\u63a5\u4e86 remote bitbang \u7684\u7aef\u53e3\uff0c\u7136\u540e\u521b\u5efa\u4e86\u4e00\u4e2a tap \u548c target\uff0c\u5f00\u542f\u4e86 gdb \u540e\u91cd\u7f6e\u7b49\u5f85\u8c03\u8bd5\u3002\u8fd9\u6837 OpenOCD \u4f1a\u9ed8\u8ba4\u5f00\u653e 3333 \u7aef\u53e3\u7ed9 gdb \u8fde\u63a5\uff0c\u901a\u8fc7 <code>target extended-remote localhost:3333</code> \u6216\u8005 <code>tar ext :3333</code> \u5c31\u53ef\u4ee5\u8fde\u63a5\u5230 OpenOCD\u3002</p> <p>\u4e4b\u540e OpenOCD \u53ef\u4ee5\u62c5\u5f53 gdb \u548c spike \u4e4b\u95f4\u7684\u6865\u6881\u3002gdb \u63a5\u6536\u5230\u7684\u6307\u4ee4\u4f1a\u53d1\u9001\u7ed9 OpenOCD\uff0cOpenOCD \u5c06\u5b83\u8f6c\u6362\u4e3a\u5bf9\u5e94\u7684 01 \u4e32\u53d1\u9001\u7ed9 spike \u8fdb\u884c\u8c03\u8bd5\uff0c\u53cd\u4e4b\u4ea6\u7136\u3002\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 gdb-OpenOCD-spike \u7684\u5de5\u5177\u94fe\u5b9e\u73b0\u539f\u6765 gdb-qemu \u7684\u6548\u679c\u3002</p>"},{"location":"appendix/#opensbi","title":"OpenSBI","text":"<p>OpenSBI \u5927\u5bb6\u5728 lab1 \u4e2d\u5e94\u8be5\u90fd\u6709\u6240\u4e86\u89e3\uff0c\u5c31\u4e0d\u4ecb\u7ecd\u5b83\u672c\u8eab\u4e86\u3002\u8fd9\u4e2a\u5de5\u5177\u94fe\u4e4b\u6240\u4ee5\u9700\u8981 OpenSBI\uff0c\u662f\u56e0\u4e3a spike \u6a21\u62df\u7684\u662f\u4e00\u53f0\u88f8\u673a\u3002\u6211\u4eec\u7684 kernel \u4e0d\u53ef\u4ee5\u76f4\u63a5\u5728\u88f8\u673a\u4e0a\u8fd0\u884c\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u989d\u5916\u7684 OpenSBI \u7684\u4ee3\u7801\u505a\u524d\u671f\u7684\u542f\u52a8\u3002\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e0b\u8f7d OpenSBI \u4ee3\u7801\u5e76\u5c06\u5b83\u7f16\u8bd1\u5f97\u5230 fw_jump.elf\uff0c\u4f5c\u4e3a M \u6001\u7684\u7ef4\u62a4\u4ee3\u7801\u3002</p>"},{"location":"appendix/#_2","title":"\u5de5\u5177\u94fe\u4f7f\u7528","text":""},{"location":"appendix/#_3","title":"\u7f16\u8bd1\u5b89\u88c5","text":""},{"location":"appendix/#spike_1","title":"Spike","text":"<p>Spike \u9700\u8981\u5927\u5bb6\u4ece\u6e90\u7801\u81ea\u884c\u7f16\u8bd1\u5b89\u88c5\uff1a</p> <pre><code>git clone https://github.com/riscv-software-src/riscv-isa-sim\ncd riscv-isa-sim\nsudo apt install device-tree-compiler libboost-regex-dev libboost-system-dev\nmkdir build\ncd build\n../configure\nmake -j$(nproc)\nsudo make install\n</code></pre>"},{"location":"appendix/#openocd_1","title":"OpenOCD","text":"<p>OpenOCD \u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 <code>sudo apt install openocd</code> \u6765\u5b89\u88c5\uff0c\u4e5f\u53ef\u4ee5\u4ece\u6e90\u7801\u7f16\u8bd1\uff1a</p> <pre><code>git clone https://github.com/openocd-org/openocd/\ncd openocd\nsudo apt install libtool\n./bootstrap\n./configure --enable-remote-bitbang\nmake\nsudo make install\n</code></pre>"},{"location":"appendix/#opensbi_1","title":"OpenSBI","text":"<p>\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u7f16\u8bd1\u597d\u7684 fw_jump.elf \u5728\u672c\u4ed3\u5e93 <code>src/spike/fw_jump.elf</code> \u4e2d\u3002</p> <p>\u5982\u679c\u9700\u8981\u81ea\u884c\u7f16\u8bd1\u7684\u8bdd\u9700\u8981\u5148\u901a\u8fc7 <code>make PLATFORM=generic menuconfig</code> \u6765\u5173\u6389 Utils and Drivers Support &gt; Serial Device Support &gt; Semihosting support \u8fd9\u4e00\u9009\u9879\u3002\u7136\u540e\u8fdb\u884c\u7f16\u8bd1\uff1a</p> <pre><code>git clone https://github.com/riscv-software-src/opensbi\ncd opensbi\nmkdir build\nmake O=build CROSS_COMPILE=riscv64-linux-gnu- PLATFORM=generic\n# output: build/platform/generic/firmware/fw_jump.elf\n</code></pre>"},{"location":"appendix/#_4","title":"\u8fd0\u884c","text":"<p>\u672c\u4ed3\u5e93 <code>src/spike</code> \u4e2d\u63d0\u4f9b\u4e86 <code>Makefile.extra</code>\uff0c\u9700\u8981\u5927\u5bb6\u5c06\u5176\u4e2d\u5185\u5bb9\u590d\u5236\u5230\u81ea\u5df1 kernel \u7684 <code>Makefile</code> \u4e2d\uff0c\u6ce8\u610f\u5176\u4e2d <code>SPIKE_CONFIG</code> \u76ee\u5f55\u7684\u5177\u4f53\u4f4d\u7f6e\u8981\u8fdb\u884c\u4fee\u6539\u3002</p> <p>\u7136\u540e\u6267\u884c <code>make spike_run</code> \u5c31\u53ef\u4ee5\u901a\u8fc7 spike \u8fd0\u884c kernel \u4e86\u3002</p>"},{"location":"appendix/#_5","title":"\u8c03\u8bd5","text":"<p>\u8c03\u8bd5\u7684\u8bdd\u4e00\u5171\u9700\u8981\u4e09\u4e2a\u7ec8\u7aef\u7a97\u53e3\uff0c\u4f9d\u6b21\u6267\u884c\uff1a</p> <ol> <li><code>make spike_debug</code>\uff1a\u542f\u52a8 spike \u5e76\u7b49\u5f85\u8c03\u8bd5</li> <li><code>make spike_bridge</code>\uff1a\u542f\u52a8 OpenOCD \u5e76\u8fde\u63a5 spike</li> <li><code>gdb-multiarch vmlinux</code>\uff1a\u542f\u52a8 gdb\uff0c\u7136\u540e\u6267\u884c\uff1a    - <code>tar ext :3333</code>\uff1a\u8fde\u63a5\u5230 OpenOCD    - \u5f00\u59cb\u8c03\u8bd5</li> </ol> <p>\u540e\u7eed\u7684\u8c03\u8bd5\u6d41\u7a0b\u548c qemu \u7c7b\u4f3c\uff0c\u4e0d\u518d\u8d58\u8ff0\u3002</p>"},{"location":"faq/","title":"\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54","text":"<p>\u9996\u5148\u9700\u8981\u660e\u786e\u7684\u662f\uff0c\u672c\u6b21\u5b9e\u9a8c\u4e2d\u7684\u6240\u6709\u64cd\u4f5c\u90fd\u4e0d\u5e94\u8be5\u7ecf\u7531 Windows \u4e2d\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u8bf7\u76f4\u63a5\u5728\u865a\u62df\u673a\u6216 Linux \u7269\u7406\u673a\u4e2d\u76f4\u63a5\u5b8c\u6210\u3002</p> <p>\u7981\u6b62\u76f4\u63a5 fork \u672c\u8bfe\u7a0b\u7684 github \u4ed3\u5e93</p> <p>\u672c\u8bfe\u7a0b\u8981\u6c42\u540c\u5b66\u4eec\u4e25\u683c\u9075\u5faa\u8bda\u4fe1\u5b88\u5219\uff0c\u7981\u6b62\u540c\u5b66\u4e4b\u95f4\u4e92\u76f8\u6284\u88ad\u5b9e\u9a8c\u4ee3\u7801\u3002\u5982\u9700\u5efa\u7acb\u79c1\u4eba github \u4ed3\u5e93\uff0c\u8bf7\u5c06\u672c\u8bfe\u7a0b\u4ed3\u5e93 clone \u5230\u672c\u5730\u4e4b\u540e\uff0c\u4e0a\u4f20\u5230\u81ea\u5df1\u7684 private repo\u3002\u7981\u6b62\u76f4\u63a5 fork \u672c\u8bfe\u7a0b\u7684 github \u4ed3\u5e93\u6216\u76f4\u63a5\u5c06\u672c\u8bfe\u7a0b\u5b9e\u9a8c\u76f8\u5173\u5185\u5bb9\u4e0a\u4f20\u5230\u4efb\u4f55 public repo\u3002</p>"},{"location":"faq/#_2","title":"\u5b9e\u9a8c\u63d0\u4ea4\u8981\u6c42","text":"<p>\u5b9e\u9a8c\u63d0\u4ea4\u65f6\u9700\u8981\u540c\u65f6\u63d0\u4ea4\u4ee3\u7801\u538b\u7f29\u5305\u548c\u5b9e\u9a8c\u62a5\u544a\u4e24\u4e2a\u6587\u4ef6\u3002</p> <p>\u5b9e\u9a8c\u62a5\u544a\u8981\u6c42\u4e0a\u4f20 pdf \u6587\u4ef6\uff0c\u5176\u4e2d\u9700\u8981\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <ul> <li>\u5b9e\u9a8c\u5185\u5bb9\u53ca\u7b80\u8981\u539f\u7406\u4ecb\u7ecd</li> <li>\u5b9e\u9a8c\u5177\u4f53\u8fc7\u7a0b\u4e0e\u4ee3\u7801\u5b9e\u73b0</li> <li>\u5b9e\u9a8c\u7ed3\u679c\u4e0e\u5206\u6790</li> <li>\u5b9e\u9a8c\u4e2d\u9047\u5230\u7684\u95ee\u9898\u53ca\u89e3\u51b3\u65b9\u6cd5</li> <li>\u601d\u8003\u9898\u4e0e\u5fc3\u5f97\u4f53\u4f1a</li> <li>\u5bf9\u5b9e\u9a8c\u6307\u5bfc\u7684\u5efa\u8bae\uff08\u53ef\u9009\uff09</li> </ul> <p>Tip</p> <ul> <li>\u5728\u4ee3\u7801\u5b9e\u73b0\u90e8\u5206\u91cd\u70b9\u5c55\u793a\u8bbe\u8ba1\u601d\u8def\u548c\u6838\u5fc3\u90e8\u5206\u4ee3\u7801\u5373\u53ef\uff0c\u4e0d\u9700\u8981\u5927\u6bb5\u7c98\u8d34\u4ee3\u7801<ul> <li>\u5982\u8981\u5c55\u793a\u4ee3\u7801\uff0c\u9700\u4ee5\u975e\u7eaf\u6587\u672c\u7684\u5f62\u5f0f\u5c55\u793a\uff08\u9700\u8981\u4f7f\u7528\u4ee3\u7801\u5757\uff09</li> </ul> </li> <li>\u601d\u8003\u9898\u5360\u6709\u4e00\u5b9a\u7684\u5206\u503c\uff0c\u9700\u8981\u8ba4\u771f\u56de\u7b54</li> <li>\u8bf7\u4fdd\u6301\u5b9e\u9a8c\u62a5\u544a\u6e05\u6670\u3001\u7b80\u6d01</li> </ul>"},{"location":"faq/#linux-wsl2-mnt","title":"\u4e3a\u4ec0\u4e48\u6211\u628a Linux \u6e90\u7801\u653e\u5728\u5171\u4eab\u6587\u4ef6\u5939\u6216 wsl2 \u7684 <code>/mnt</code> \u4e0b\u7f16\u8bd1\u4e0d\u51fa\u6765\uff1f","text":"<p>\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cLinux \u5728\u4f7f\u7528 Windows \u4e0a\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u8bf7\u4f7f\u7528 <code>wget</code> \u7b49\u5de5\u5177\u5c06 Linux \u6e90\u7801\u4e0b\u8f7d\u81f3\u5bb9\u5668\u5185\u76ee\u5f55\u800c\u975e\u5171\u4eab\u76ee\u5f55\u6216 <code>/mnt</code> \u76ee\u5f55\u4e0b\u7684\u4efb\u4f55\u4f4d\u7f6e\uff0c\u7136\u540e\u6267\u884c\u7f16\u8bd1\u3002</p>"},{"location":"faq/#qemu-gdb-si","title":"\u4e3a\u4ec0\u4e48 QEMU &amp; GDB \u4f7f\u7528 <code>si</code> \u5355\u6307\u4ee4\u8c03\u8bd5\u9047\u5230\u6a21\u5f0f\u5207\u6362\u65f6\u65e0\u6cd5\u6b63\u5e38\u6267\u884c\uff1f","text":"<p>\u5728\u9047\u5230\u8bf8\u5982 <code>mret</code>, <code>sret</code> \u7b49\u6307\u4ee4\u9020\u6210\u7684\u6a21\u5f0f\u5207\u6362\u65f6\uff0c<code>si</code> \u6307\u4ee4\u4f1a\u5931\u6548\uff0c\u53ef\u80fd\u8868\u73b0\u4e3a\u7a0b\u5e8f\u5f00\u59cb\u4e0d\u505c\u8dd1\uff0c\u5f71\u54cd\u5bf9\u7a0b\u5e8f\u8fd0\u884c\u884c\u4e3a\u7684\u5224\u65ad\u3002</p> <p>\u4e00\u4e2a\u89e3\u51b3\u65b9\u6cd5\u662f\u5728\u7a0b\u5e8f\u9884\u671f\u8df3\u8f6c\u7684\u4f4d\u7f6e\u6253\u4e0a\u65ad\u70b9\uff0c\u65ad\u70b9\u4e0d\u4f1a\u53d7\u5230\u6a21\u5f0f\u5207\u6362\u7684\u5f71\u54cd\uff0c\u6bd4\u5982\uff1a</p> <pre><code>(gdb) i r sepc    \nsepc        0x8000babe\n(gdb) b * 0x8000babe\nBreakpoint 1 at 0x8000babe\n(gdb) si    # \u6216\u8005\u4f7f\u7528 c\nBreakpoint 1, 0x000000008000babe in _never_gonna_give_you_up ()\n...\n</code></pre> <p>\u8fd9\u6837\u5c31\u53ef\u4ee5\u770b\u5230\u65ad\u70b9\u88ab\u89e6\u53d1\uff0c\u53ef\u4ee5\u7ee7\u7eed\u8c03\u8bd5\u4e86\u3002</p>"},{"location":"faq/#gdb-next-finish","title":"\u4e3a\u4ec0\u4e48\u6211\u4e0d\u80fd\u5728 GDB \u4e2d\u4f7f\u7528 <code>next</code> \u6216\u8005 <code>finish</code> ?","text":"<p>\u8fd9\u4e24\u6761\u547d\u4ee4\u90fd\u4f9d\u8d56\u5728\u5185\u6838\u4e2d\u6dfb\u52a0\u7684\u8c03\u8bd5\u4fe1\u606f\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>menuconfig</code> \u8fdb\u884c\u914d\u7f6e\u6dfb\u52a0\u3002\u6211\u4eec\u5728\u5b9e\u9a8c\u4e2d\u6ca1\u6709\u5bf9\u8fd9\u90e8\u5206\u5185\u5bb9\u4f5c\u8981\u6c42\uff0c\u53ef\u4ee5\u81ea\u884c Google \u63a2\u7d22\u3002</p>"},{"location":"faq/#debug-next-finish","title":"\u4e3a\u4ec0\u4e48\u6211\u5728\u5185\u6838\u4e2d\u6dfb\u52a0\u4e86 debug \u4fe1\u606f\uff0c\u4f46\u662f\u8fd8\u662f\u6ca1\u6cd5\u4f7f\u7528 <code>next</code> \u6216\u8005 <code>finish</code> ?","text":"<p>\u53ef\u80fd\u4f60\u5728\u914d\u7f6e\u5185\u6838\u65f6\u5df2\u7ecf\u6dfb\u52a0\u4e86\u8c03\u8bd5\u4fe1\u606f\uff0c\u4f46\u662f\u5e76\u6ca1\u6709\u5728QEMU\u8fd0\u884c\u7684\u5176\u4ed6\u90e8\u5206\u6dfb\u52a0\u3002\u4f8b\u5982 SRAM \u4e2d\u5bf9 <code>march</code> \u8fdb\u884c\u914d\u7f6e\u7684\u8fc7\u7a0b\uff0c\u4ee5\u53ca opensbi \u4e2d\u7684\u6240\u6709\u90e8\u5206\uff0c\u90fd\u7f3a\u5c11\u8c03\u8bd5\u4fe1\u606f\u3002\u6240\u4ee5\u624d\u65e0\u6cd5\u6309\u7167\u51fd\u6570\u7684\u5c42\u7ea7\u8fdb\u884c\u8c03\u8bd5\u3002\u6211\u4eec\u5728\u5b9e\u9a8c\u4e2d\u6ca1\u6709\u5bf9\u8fd9\u90e8\u5206\u5185\u5bb9\u4f5c\u8981\u6c42\uff0c\u53ef\u4ee5\u81ea\u884c Google \u63a2\u7d22\u3002</p>"},{"location":"faq/#lab1-c","title":"\u4e3a\u4ec0\u4e48 Lab1 \u4e2d\u6211\u7684 C \u8bed\u8a00\u51fd\u6570\u7684\u53c2\u6570\u65e0\u6cd5\u6b63\u786e\u4f20\u5165\uff1f","text":"<p>\u786e\u8ba4\u81ea\u5df1\u662f\u5426\u5728 <code>head.S</code> \u91cc\u7684 <code>_start</code> \u51fd\u6570\u4e2d\u6b63\u786e\u8bbe\u7f6e\u4e86 <code>sp</code>\uff0c\u6b63\u5e38\u60c5\u51b5\u4e0b\u5b83\u7684\u503c\u5e94\u8be5\u662f <code>0x8020XXXX</code>\u3002\u672a\u8bbe\u7f6e\u6216\u8bbe\u7f6e\u9519 <code>sp</code> \u4f1a\u4f7f\u6808\u4e0a\u7684\u503c\u4e0d\u6b63\u786e\u4e14\u65e0\u6cd5\u5199\u5165\u3002</p> <p>Tip</p> <p>\u6ce8\u610f\u68c0\u67e5\u662f\u5426\u5c06 <code>head.S</code> \u91cc\u7684 <code>.section</code> \u6539\u4e3a <code>.text.init</code>\uff0c\u5982\u679c\u4e0d\u6539\u7684\u8bdd <code>_traps</code> \u548c <code>_start</code> \u90fd\u5728 <code>.text.entry</code> \u6bb5\uff0c\u6b64\u65f6 <code>_traps</code> \u4f1a\u88ab\u653e\u7f6e\u5230 <code>0x80200000</code> \u5904\uff0c\u5bfc\u81f4\u5176\u5148\u4e8e <code>_start</code> \u6267\u884c\uff1b\u800c\u6b64\u65f6\u8fd8\u672a\u8bbe\u7f6e <code>sp</code>\uff0c\u6545\u4f20\u53c2\u65f6\u4f1a\u51fa\u73b0\u6df7\u4e71\uff08\u5177\u4f53\u8868\u73b0\u4e3a <code>trap_handler</code> \u7684\u6240\u6709\u53c2\u6570\u5747\u663e\u793a <code>2^64-1</code>\uff09\u3002</p>"},{"location":"faq/#lab1-syscall-table","title":"\u4e0d\u4f1a\u627e Lab1 \u7684 syscall table \u600e\u4e48\u529e\uff1f","text":"<p>\u4e3b\u8981\u6709\u4e24\u79cd\u65b9\u6cd5\uff0c\u4e00\u79cd\u662f\u5b89\u88c5\u8be5\u67b6\u6784\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u5e76\u7f16\u8bd1\u5f97\u5230\u9884\u5904\u7406\u4ea7\u7269\uff0c\u53e6\u4e00\u79cd\u5219\u662f\u5728\u67d0\u4e9b\u6587\u4ef6\u4e2d\u76f4\u63a5\u5c31\u6709\u73b0\u6210\u7684 syscall table. \u65e0\u8bba\u9009\u7528\u54ea\u79cd\u65b9\u6cd5\u90fd\u8981\u5584\u7528\u641c\u7d22\uff0c\u67e5\u627e\u7cfb\u7edf\u8c03\u7528\u5177\u4f53\u653e\u5728\u54ea\u4e2a\u6587\u4ef6\u4e2d\u3002\u53ef\u4ee5\u53c2\u8003\u8fd9\u7bc7\u6587\u7ae0\u3002</p> <p>Tip</p> <p>\u6216\u8bb8\u53ef\u4ee5\u76f4\u63a5\u53bb <code>arch</code> \u5bf9\u5e94\u67b6\u6784\u6587\u4ef6\u5939\u4e0b\u641c\u7d22\u5173\u952e\u8bcd\uff1f</p>"},{"location":"faq/#ubuntu-2404","title":"\u5982\u4f55\u5347\u7ea7\u5230 Ubuntu 24.04","text":"<p>\u8bf7\u6309\u7167 How to upgrade - Ubuntu \u6216 DebianUpgrade - Debian Wiki \u7684\u8bf4\u660e\u8fdb\u884c\u5347\u7ea7\uff0c\u6240\u9700\u547d\u4ee4\u6982\u62ec\u5982\u4e0b\uff08\u4f7f\u7528\u4e24\u79cd\u65b9\u5f0f\u4e4b\u4e00\u5373\u53ef\uff09\uff1a</p> <ul> <li> <p>\u4f7f\u7528 Ubuntu \u7279\u6709\u7684 <code>do-release-upgrade</code> \u547d\u4ee4\uff1a</p> <pre><code>sudo apt update\nsudo apt upgrade\nsudo apt full-upgrade\nsudo do-release-upgrade\n</code></pre> </li> <li> <p>\u4f7f\u7528 Debian \u6807\u51c6\u7684\u5347\u7ea7\u6d41\u7a0b\uff1a</p> <pre><code>sudo apt-get update\nsudo apt-get upgrade\nsudo apt-get full-upgrade\n# \u4fee\u6539 APT \u6e90\nsudo apt-get clean\nsudo apt-get update\nsudo apt-get upgrade\nsudo apt-get full-upgrade\nsudo apt-get autoremove\n</code></pre> </li> </ul> <p>\u5347\u7ea7\u5b8c\u6210\u540e\uff0c\u52a1\u5fc5\u5c3d\u5feb\u91cd\u542f\uff0c\u4e0d\u8bba\u662f\u7269\u7406\u673a\u8fd8\u662f\u865a\u62df\u673a\uff08WSL\u3001Docker\uff09\u3002</p>"},{"location":"faq/#lab3-va-sz","title":"\u4e0d\u77e5\u9053\u5982\u4f55\u8ba1\u7b97 Lab3 \u5efa\u7acb\u6620\u5c04\u65f6\u6240\u9700\u7684\u865a\u62df\u5730\u5740 <code>va</code> \u548c\u5927\u5c0f <code>sz</code>\uff1f","text":"<p>\u5728 <code>vmlinux.lds</code> \u4e2d\u6709 <code>_stext</code>, <code>_srodata</code> \u7b49\u7b26\u53f7\uff0c\u53ef\u4ee5\u5728\u4ee3\u7801\u91cc\u8fd9\u6837\u6765\u58f0\u660e\u5b83\uff1a<code>extern char _stext[]</code>\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u901a\u8fc7 <code>_stext</code> \u83b7\u5f97\u5176\u6240\u5728\u865a\u62df\u5730\u5740 <code>va</code>\uff0c\u5e76\u4e14\u53ef\u4ee5\u901a\u8fc7\u4e24\u4e2a\u6bb5\u7684\u5f00\u5934\u7b26\u53f7\u505a\u51cf\u6cd5\u83b7\u5f97\u6bb5\u7684\u5927\u5c0f <code>sz</code>\u3002</p>"},{"location":"lab0/","title":"Lab 0: GDB &amp; QEMU \u8c03\u8bd5 64 \u4f4d RISC-V LINUX","text":""},{"location":"lab0/#_1","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<ul> <li>\u4f7f\u7528\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177, \u5b8c\u6210Linux\u5185\u6838\u4ee3\u7801\u7f16\u8bd1</li> <li>\u4f7f\u7528QEMU\u8fd0\u884c\u5185\u6838</li> <li>\u719f\u6089GDB\u548cQEMU\u8054\u5408\u8c03\u8bd5</li> </ul>"},{"location":"lab0/#_2","title":"\u5b9e\u9a8c\u73af\u5883","text":"<p>\u5b9e\u9a8c\u6587\u6863\u5df2\u5728 Ubuntu 24.04\uff08\u5305\u62ec x86-64 \u548c arm64\uff09\u4e0a\u6d4b\u8bd5\u901a\u8fc7\uff0c\u5efa\u8bae\u540c\u5b66\u4eec\u4f7f\u7528 Ubuntu 24.04\uff08noble\uff09\u4f5c\u4e3a\u5b9e\u9a8c\u73af\u5883\u3002</p> <p>\u5347\u7ea7\u5230 Ubuntu 24.04</p> <p>\u5df2\u7ecf\u5b89\u88c5 Ubuntu 22.04 \u6216\u66f4\u65e7\u7248\u672c\u7684\u540c\u5b66\u53ef\u4ee5\u9009\u62e9\u53c2\u8003\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54 - \u5982\u4f55\u5347\u7ea7\u5230 Ubuntu 24.04 \u8fdb\u884c\u5347\u7ea7\u3002</p> <p>\u5347\u7ea7\u540e\uff0cAPT \u4f1a\u81ea\u52a8\u5c06 QEMU \u7b49\u8f6f\u4ef6\u5305\u5347\u7ea7\u5230\u4ed3\u5e93\u4e2d\u8f83\u65b0\u7684\u7248\u672c\u3002</p> <ul> <li>Ubuntu 24.04 LTS - Ubuntu</li> <li>Ubuntu 24.04 LTS - ZJU Mirror</li> <li>Ubuntu 24.04 LTS Windows Subsystem for Linux 2 - Microsoft Store</li> <li>Ubuntu 24.04 - Docker</li> </ul> <p>\u66f4\u6362 ZJU Mirror \u955c\u50cf\u6e90</p> <p>\u4e3a\u4e86\u52a0\u5feb APT \u66f4\u65b0\u901f\u5ea6\uff0c\u5efa\u8bae\u540c\u5b66\u4eec\u5c06 APT \u955c\u50cf\u6e90\u66f4\u6362\u5230 ZJU Mirror\u3002\u64cd\u4f5c\u8fc7\u7a0b\u89c1\u76f8\u5e94\u9875\u9762\u7684\u6307\u5357\u3002</p> <p>\u6bd5\u7adf\u662f\u4ea4\u53c9\u7f16\u8bd1+\u4f7f\u7528 qemu\uff0c\u6240\u4ee5\u53ea\u8981\u4f60\u914d\u5f97\u8d77\u6765\u8dd1\u5f97\u8d77\u6765\uff0c\u4efb\u4f55\u73af\u5883\u90fd\u53ef\u4ee5\uff0c\u53ea\u4e0d\u8fc7\u6211\u4eec\u4e0d\u63d0\u4f9b\u73af\u5883\u4e0a\u7684\u6280\u672f\u652f\u6301</p>"},{"location":"lab0/#_3","title":"\u5b9e\u9a8c\u57fa\u7840\u77e5\u8bc6\u4ecb\u7ecd","text":""},{"location":"lab0/#linux","title":"Linux \u4f7f\u7528\u57fa\u7840","text":"<p>\u5728 Linux \u73af\u5883\u4e0b\uff0c\u4eba\u4eec\u901a\u5e38\u4f7f\u7528\u547d\u4ee4\u884c\u63a5\u53e3\u6765\u5b8c\u6210\u4e0e\u8ba1\u7b97\u673a\u7684\u4ea4\u4e92\u3002\u7ec8\u7aef\uff08Terminal\uff09\u662f\u7528\u4e8e\u5904\u7406\u8be5\u8fc7\u7a0b\u7684\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\uff0c\u901a\u8fc7\u7ec8\u7aef\u4f60\u53ef\u4ee5\u8fd0\u884c\u5404\u79cd\u7a0b\u5e8f\u4ee5\u53ca\u5728\u81ea\u5df1\u7684\u8ba1\u7b97\u673a\u4e0a\u5904\u7406\u6587\u4ef6\u3002\u5728\u7c7b Unix \u7684\u64cd\u4f5c\u7cfb\u7edf\u4e0a\uff0c\u7ec8\u7aef\u53ef\u4ee5\u4e3a\u4f60\u5b8c\u6210\u4e00\u5207\u4f60\u6240\u9700\u8981\u7684\u64cd\u4f5c\u3002\u4e0b\u9762\u6211\u4eec\u4ec5\u5bf9\u5b9e\u9a8c\u4e2d\u6d89\u53ca\u7684\u4e00\u4e9b\u6982\u5ff5\u8fdb\u884c\u4ecb\u7ecd\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u94fe\u63a5\u6765\u5bf9\u547d\u4ee4\u884c\u7684\u4f7f\u7528\u8fdb\u884c\u5b66\u4e60\uff1a</p> <ol> <li>The Missing Semester of Your CS Education&gt;&gt;Video&lt;&lt;</li> <li>GNU/Linux Command-Line Tools Summary</li> <li>Basics of UNIX</li> <li>lec1: Shell \u57fa\u7840\u53ca CLI \u5de5\u5177\u63a8\u8350 - \u5b9e\u7528\u6280\u80fd\u62fe\u9057&gt;&gt;Video&lt;&lt;</li> </ol>"},{"location":"lab0/#qemu","title":"QEMU \u4f7f\u7528\u57fa\u7840","text":""},{"location":"lab0/#qemu_1","title":"\u4ec0\u4e48\u662f QEMU","text":"<p>QEMU \u662f\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u6a21\u62df\u5668\uff0c\u53ef\u4ee5\u5728 x86 \u5e73\u53f0\u4e0a\u6267\u884c\u4e0d\u540c\u67b6\u6784\u4e0b\u7684\u7a0b\u5e8f\u3002\u6211\u4eec\u5b9e\u9a8c\u4e2d\u91c7\u7528 QEMU \u6765\u5b8c\u6210 RISC-V \u67b6\u6784\u7684\u7a0b\u5e8f\u7684\u6a21\u62df\u3002</p>"},{"location":"lab0/#qemu_2","title":"\u5982\u4f55\u4f7f\u7528 QEMU\uff08\u5e38\u89c1\u53c2\u6570\u4ecb\u7ecd\uff09","text":"<p>\u4ee5\u4ee5\u4e0b\u547d\u4ee4\u4e3a\u4f8b\uff0c\u6211\u4eec\u7b80\u5355\u4ecb\u7ecd QEMU \u7684\u53c2\u6570\u6240\u4ee3\u8868\u7684\u542b\u4e49</p> <pre><code>$ qemu-system-riscv64 \\\n    -nographic \\\n    -machine virt \\\n    -kernel path/to/linux/arch/riscv/boot/Image \\\n    -device virtio-blk-device,drive=hd0 \\\n    -append \"root=/dev/vda ro console=ttyS0\" \\\n    -bios default \\\n    -drive file=rootfs.img,format=raw,id=hd0 \\\n    -S -s\n</code></pre> <ul> <li><code>-nographic</code>\uff1a\u4e0d\u4f7f\u7528\u56fe\u5f62\u7a97\u53e3\uff0c\u4f7f\u7528\u547d\u4ee4\u884c</li> <li><code>-machine</code>\uff1a\u6307\u5b9a\u8981 emulate \u7684\u673a\u5668\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 <code>qemu-system-riscv64 -machine help</code> \u67e5\u770b\u53ef\u9009\u62e9\u7684\u673a\u5668\u9009\u9879</li> <li><code>-kernel</code>\uff1a\u6307\u5b9a\u5185\u6838 image</li> <li><code>-append cmdline</code>\uff1a\u4f7f\u7528cmdline\u4f5c\u4e3a\u5185\u6838\u7684\u547d\u4ee4\u884c</li> <li><code>-device</code>\uff1a\u6307\u5b9a\u8981\u6a21\u62df\u7684\u8bbe\u5907\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 <code>qemu-system-riscv64 -device help</code> \u67e5\u770b\u53ef\u9009\u62e9\u7684\u8bbe\u5907\uff0c\u901a\u8fc7\u547d\u4ee4 <code>qemu-system-riscv64 -device &lt;\u5177\u4f53\u7684\u8bbe\u5907&gt;,help</code> \u67e5\u770b\u67d0\u4e2a\u8bbe\u5907\u7684\u547d\u4ee4\u9009\u9879</li> <li><code>-drive, file=&lt;file_name&gt;</code>\uff1a\u4f7f\u7528 <code>file_name</code> \u4f5c\u4e3a\u6587\u4ef6\u7cfb\u7edf</li> <li><code>-S</code>\uff1a\u542f\u52a8\u65f6\u6682\u505cCPU\u6267\u884c</li> <li><code>-s</code>\uff1a<code>-gdb tcp::1234</code> \u7684\u7b80\u5199</li> <li><code>-bios default</code>\uff1a\u4f7f\u7528\u9ed8\u8ba4\u7684 OpenSBI firmware \u4f5c\u4e3a bootloader</li> </ul> <p>\u66f4\u591a\u53c2\u6570\u4fe1\u606f\u53ef\u4ee5\u53c2\u8003 qemu \u5b98\u65b9\u6587\u6863\u3002</p>"},{"location":"lab0/#gdb","title":"GDB \u4f7f\u7528\u57fa\u7840","text":""},{"location":"lab0/#gdb_1","title":"\u4ec0\u4e48\u662f GDB","text":"<p>GNU \u8c03\u8bd5\u5668\uff08\u82f1\u8bed\uff1aGNU Debugger\uff0c\u7f29\u5199\uff1agdb\uff09\u662f\u4e00\u4e2a\u7531 GNU \u5f00\u6e90\u7ec4\u7ec7\u53d1\u5e03\u7684\u3001UNIX/LINUX \u64cd\u4f5c\u7cfb\u7edf\u4e0b\u7684\u3001\u57fa\u4e8e\u547d\u4ee4\u884c\u7684\u3001\u529f\u80fd\u5f3a\u5927\u7684\u7a0b\u5e8f\u8c03\u8bd5\u5de5\u5177\u3002\u501f\u52a9\u8c03\u8bd5\u5668\uff0c\u6211\u4eec\u80fd\u591f\u67e5\u770b\u53e6\u4e00\u4e2a\u7a0b\u5e8f\u5728\u6267\u884c\u65f6\u5b9e\u9645\u5728\u505a\u4ec0\u4e48\uff08\u6bd4\u5982\u8bbf\u95ee\u54ea\u4e9b\u5185\u5b58\u3001\u5bc4\u5b58\u5668\uff09\uff0c\u5728\u5176\u4ed6\u7a0b\u5e8f\u5d29\u6e83\u7684\u65f6\u5019\u53ef\u4ee5\u6bd4\u8f83\u5feb\u901f\u5730\u4e86\u89e3\u5bfc\u81f4\u7a0b\u5e8f\u5d29\u6e83\u7684\u539f\u56e0\u3002</p> <p>\u88ab\u8c03\u8bd5\u7684\u7a0b\u5e8f\u53ef\u4ee5\u548c GDB \u8fd0\u884c\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\uff0c\u5e76\u7531 GDB \u63a7\u5236\uff08\u672c\u5730\u8c03\u8bd5 native debug\uff09\u3002\u4e5f\u53ef\u4ee5\u53ea\u548c <code>gdb-server</code> \u8fd0\u884c\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\uff0c\u7531\u8fde\u63a5\u7740 <code>gdb-server</code> \u7684 GDB \u8fdb\u884c\u63a7\u5236\uff08\u8fdc\u7a0b\u8c03\u8bd5 remote debug\uff09\u3002</p> <p>GDB \u7684\u529f\u80fd\u5341\u5206\u5f3a\u5927\uff0c\u6211\u4eec\u7ecf\u5e38\u5728\u8c03\u8bd5\u4e2d\u7528\u5230\u7684\u6709:</p> <ul> <li>\u542f\u52a8\u7a0b\u5e8f\uff0c\u5e76\u6307\u5b9a\u53ef\u80fd\u5f71\u54cd\u5176\u884c\u4e3a\u7684\u6240\u6709\u5185\u5bb9</li> <li>\u4f7f\u7a0b\u5e8f\u5728\u6307\u5b9a\u6761\u4ef6\u4e0b\u505c\u6b62</li> <li>\u68c0\u67e5\u7a0b\u5e8f\u505c\u6b62\u65f6\u53d1\u751f\u4e86\u4ec0\u4e48</li> <li>\u66f4\u6539\u7a0b\u5e8f\u4e2d\u7684\u5185\u5bb9\uff0c\u4ee5\u4fbf\u7ea0\u6b63\u4e00\u4e2abug\u7684\u5f71\u54cd</li> </ul>"},{"location":"lab0/#gdb_2","title":"GDB \u57fa\u672c\u547d\u4ee4\u4ecb\u7ecd","text":"<ul> <li><code>(gdb) layout asm</code>\uff1a\u663e\u793a\u6c47\u7f16\u4ee3\u7801</li> <li><code>(gdb) start</code>\uff1a\u5355\u6b65\u6267\u884c\uff0c\u8fd0\u884c\u7a0b\u5e8f\uff0c\u505c\u5728\u7b2c\u4e00\u6267\u884c\u8bed\u53e5</li> <li><code>(gdb) continue</code>\uff1a\u4ece\u65ad\u70b9\u540e\u7ee7\u7eed\u6267\u884c\uff0c\u7b80\u5199 <code>c</code></li> <li><code>(gdb) next</code>\uff1a\u5355\u6b65\u8c03\u8bd5\uff08\u9010\u8fc7\u7a0b\uff0c\u51fd\u6570\u76f4\u63a5\u6267\u884c\uff09\uff0c\u7b80\u5199 <code>n</code></li> <li><code>(gdb) stepi</code>\uff1a\u6267\u884c\u5355\u6761\u6307\u4ee4\uff0c\u7b80\u5199 <code>si</code></li> <li><code>(gdb) run</code>\uff1a\u91cd\u65b0\u5f00\u59cb\u8fd0\u884c\u6587\u4ef6\uff08run-text\uff1a\u52a0\u8f7d\u6587\u672c\u6587\u4ef6\uff0crun-bin\uff1a\u52a0\u8f7d\u4e8c\u8fdb\u5236\u6587\u4ef6\uff09\uff0c\u7b80\u5199 <code>r</code></li> <li><code>(gdb) backtrace</code>\uff1a\u67e5\u770b\u51fd\u6570\u7684\u8c03\u7528\u7684\u6808\u5e27\u548c\u5c42\u7ea7\u5173\u7cfb\uff0c\u7b80\u5199 <code>bt</code></li> <li><code>(gdb) break</code> \u8bbe\u7f6e\u65ad\u70b9\uff0c\u7b80\u5199 <code>b</code><ul> <li>\u65ad\u5728 <code>foo</code> \u51fd\u6570\uff1a<code>b foo</code></li> <li>\u65ad\u5728\u67d0\u5730\u5740\uff1a<code>b * 0x80200000</code></li> </ul> </li> <li><code>(gdb) finish</code>\uff1a\u7ed3\u675f\u5f53\u524d\u51fd\u6570\uff0c\u8fd4\u56de\u5230\u51fd\u6570\u8c03\u7528\u70b9</li> <li><code>(gdb) frame</code>\uff1a\u5207\u6362\u51fd\u6570\u7684\u6808\u5e27\uff0c\u7b80\u5199 <code>f</code></li> <li><code>(gdb) print</code>\uff1a\u6253\u5370\u503c\u53ca\u5730\u5740\uff0c\u7b80\u5199 <code>p</code></li> <li><code>(gdb) info</code>\uff1a\u67e5\u770b\u51fd\u6570\u5185\u90e8\u5c40\u90e8\u53d8\u91cf\u7684\u6570\u503c\uff0c\u7b80\u5199 <code>i</code><ul> <li>\u67e5\u770b\u5bc4\u5b58\u5668 ra \u7684\u503c\uff1a<code>i r ra</code></li> </ul> </li> <li><code>(gdb) display</code>\uff1a\u8ffd\u8e2a\u67e5\u770b\u5177\u4f53\u53d8\u91cf\u503c</li> <li><code>(gdb) x/4x &lt;addr&gt;</code>\uff1a\u4ee5 16 \u8fdb\u5236\u6253\u5370 <code>&lt;addr&gt;</code> \u5904\u5f00\u59cb\u7684 16 Bytes \u5185\u5bb9</li> </ul> <p>\u66f4\u591a\u547d\u4ee4\u53ef\u4ee5\u53c2\u8003100\u4e2agdb\u5c0f\u6280\u5de7\uff0c\u6216\u8005 TonyCrane \u7684\u7b14\u8bb0\u672c\u3002</p>"},{"location":"lab0/#gdb_3","title":"\u5173\u4e8e GDB \u63d2\u4ef6","text":"<p>\u4e3a\u4e86\u66f4\u65b9\u4fbf\u66f4\u76f4\u89c2\u5730\u8fdb\u884c gdb \u8c03\u8bd5\uff0c\u53ef\u4ee5\u81ea\u884c\u5b89\u88c5\u4e00\u4e9b gdb \u63d2\u4ef6\u3002\u5728 RISC-V \u67b6\u6784\u4e0a\u53ef\u4ee5\u4f7f\u7528 gdb-dashboard\uff0c\u53ef\u4ee5\u5b9e\u65f6\u89c2\u5bdf\u6c47\u7f16\u3001\u6e90\u7801\u3001\u5bc4\u5b58\u5668\u503c\u4e0e\u53d8\u5316\u3001\u65ad\u70b9\u4fe1\u606f\u7b49\u7b49\u3002</p> <p>Tip</p> <p>\u4e0d\u8fc7\u5728\u9875\u8868\u7b49\u5b9e\u9a8c\u4e2d\u5982\u679c\u4f7f\u7528\u63d2\u4ef6\u6709\u53ef\u80fd\u4f1a\u56e0\u4e3a\u989d\u5916\u9690\u5f0f\u7684\u8bbf\u5b58\u5bfc\u81f4\u51fa\u73b0\u9519\u8bef\u5361\u4f4f\uff0c\u5982\u679c\u6709\u9047\u5230\u7684\u8bdd\u53ef\u4ee5\u5c1d\u8bd5\u5173\u95ed\u63d2\u4ef6\uff0c\u6216\u8005\u8bbe\u7f6e\u65ad\u70b9\u8df3\u8fc7\u51fa\u95ee\u9898\u7684\u90e8\u5206\u3002</p>"},{"location":"lab0/#linux_1","title":"Linux \u5185\u6838\u7f16\u8bd1\u57fa\u7840","text":""},{"location":"lab0/#_4","title":"\u4ea4\u53c9\u7f16\u8bd1","text":"<p>\u4ea4\u53c9\u7f16\u8bd1\u6307\u7684\u662f\u5728\u4e00\u4e2a\u5e73\u53f0\u4e0a\u7f16\u8bd1\u53ef\u4ee5\u5728\u53e6\u4e00\u4e2a\u67b6\u6784\u8fd0\u884c\u7684\u7a0b\u5e8f\u3002\u4f8b\u5982\u5728 x86 \u673a\u5668\u4e0a\u7f16\u8bd1\u53ef\u4ee5\u5728 RISC-V \u67b6\u6784\u8fd0\u884c\u7684\u7a0b\u5e8f\uff0c\u4ea4\u53c9\u7f16\u8bd1\u9700\u8981\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u7684\u652f\u6301\uff0c\u5728\u6211\u4eec\u7684\u5b9e\u9a8c\u4e2d\u6240\u7528\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u5c31\u662f riscv-gnu-toolchain\u3002</p>"},{"location":"lab0/#_5","title":"\u5185\u6838\u914d\u7f6e","text":"<p>\u5185\u6838\u914d\u7f6e\u662f\u7528\u4e8e\u914d\u7f6e\u662f\u5426\u542f\u7528\u5185\u6838\u7684\u5404\u9879\u7279\u6027\uff0c\u5185\u6838\u4f1a\u63d0\u4f9b\u4e00\u4e2a\u540d\u4e3a <code>defconfig</code>\uff08\u5373default configuration\uff09\u7684\u9ed8\u8ba4\u914d\u7f6e\uff0c\u8be5\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e\u5404\u4e2a\u67b6\u6784\u76ee\u5f55\u7684 <code>configs</code> \u6587\u4ef6\u5939\u4e0b\uff0c\u4f8b\u5982\u5bf9\u4e8eRISC-V\u800c\u8a00\uff0c\u5176\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u4e3a <code>arch/riscv/configs/defconfig</code>\u3002\u4f7f\u7528 <code>make ARCH=riscv defconfig</code> \u547d\u4ee4\u53ef\u4ee5\u5728\u5185\u6838\u6839\u76ee\u5f55\u4e0b\u751f\u6210\u4e00\u4e2a\u540d\u4e3a <code>.config</code> \u7684\u6587\u4ef6\uff0c\u5305\u542b\u4e86\u5185\u6838\u5b8c\u6574\u7684\u914d\u7f6e\uff0c\u5185\u6838\u5728\u7f16\u8bd1\u65f6\u4f1a\u6839\u636e <code>.config</code> \u8fdb\u884c\u7f16\u8bd1\u3002</p> <p>\u914d\u7f6e\u4e4b\u95f4\u5b58\u5728\u76f8\u4e92\u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u76f4\u63a5\u4fee\u6539defconfig\u6587\u4ef6\u6216\u8005 <code>.config</code> \u6709\u65f6\u5019\u5e76\u4e0d\u80fd\u8fbe\u5230\u60f3\u8981\u7684\u6548\u679c\uff0c\u6216\u662f\u7ed9\u8fdb\u4e00\u6b65\u5185\u6838\u914d\u7f6e\u5e26\u6765\u540c\u6b65\u95ee\u9898\u3002\u56e0\u6b64\u5982\u679c\u9700\u8981\u4fee\u6539\u914d\u7f6e\u4e00\u822c\u91c7\u7528 <code>make ARCH=riscv menuconfig</code> \u7684\u65b9\u5f0f\u5bf9\u5185\u6838\u8fdb\u884c\u914d\u7f6e\u3002</p>"},{"location":"lab0/#_6","title":"\u7f16\u8bd1\u5de5\u5177","text":"<p><code>make</code> \u662f\u7528\u4e8e\u7a0b\u5e8f\u6784\u5efa\u7684\u91cd\u8981\u5de5\u5177\uff0c\u5b83\u7684\u884c\u4e3a\u7531\u5f53\u524d\u76ee\u5f55\u6216 <code>make -C</code> \u6307\u5b9a\u76ee\u5f55\u4e0b\u7684 <code>Makefile</code> \u6765\u51b3\u5b9a\u3002\u66f4\u591a\u6709\u5173 <code>Makefile</code> \u7684\u5185\u5bb9\u53ef\u4ee5\u53c2\u8003 Learn Makefiles With the tastiest examples\u3002\u4e0b\u9762\u7528\u672c\u6b21\u5b9e\u9a8c\u4e2d\u53ef\u80fd\u7528\u5230\u7684\u7528\u4e8e\u7f16\u8bd1 Linux \u5185\u6838\u7684\u7f16\u8bd1\u547d\u4ee4\u4f5c\u4e3a\u793a\u4f8b\uff1a</p> <pre><code>$ make help             # \u67e5\u770bmake\u547d\u4ee4\u7684\u5404\u79cd\u53c2\u6570\u89e3\u91ca\n\n$ make &lt;target-name&gt;    # \u7f16\u8bd1\u540d\u4e3a &lt;target-name&gt; \u7684\u76ee\u6807\u6587\u4ef6\u6216\u76ee\u6807\u4efb\u52a1 \n$ make defconfig        # \u4f7f\u7528\u5f53\u524d\u5e73\u53f0\u7684\u9ed8\u8ba4\u914d\u7f6e\uff0c\u5728x86\u673a\u5668\u4e0a\u4f1a\u4f7f\u7528x86\u7684\u9ed8\u8ba4\u914d\u7f6e\n$ make clean            # \u6e05\u9664\u6240\u6709\u7f16\u8bd1\u597d\u7684 object \u6587\u4ef6\n$ make mrproper         # \u5220\u9664\u6240\u6709\u7f16\u8bd1\u4ea7\u7269\u548c\u914d\u7f6e\u6587\u4ef6\n\n$ make -j&lt;thread-count&gt; # \u4f7f\u7528 &lt;thread-count&gt; \u4e2a\u7269\u7406\u7ebf\u7a0b\u6765\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1 \n$ make -j4              # \u7f16\u8bd1\u5f53\u524d\u5e73\u53f0\u7684\u5185\u6838\uff0c-j4 \u4e3a\u4f7f\u7528 4 \u7ebf\u7a0b\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1\n$ make -j$(nproc)       # \u7f16\u8bd1\u5f53\u524d\u5e73\u53f0\u7684\u5185\u6838\uff0c-j$(nproc) \u4e3a\u4ee5\u5168\u90e8\u673a\u5668\u786c\u4ef6\u7ebf\u7a0b\u6570\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1\n\n$ make &lt;var-name&gt;=&lt;var-value&gt;                       # \u5728\u7f16\u8bd1\u8fc7\u7a0b\u4e2d\u5c06 &lt;var-name&gt; \u53d8\u91cf\u7684\u503c\u624b\u52a8\u8bbe\u7f6e\u4e3a &lt;val-value&gt;\n$ make ARCH=riscv defconfig                         # \u4f7f\u7528 RISC-V \u5e73\u53f0\u7684\u9ed8\u8ba4\u914d\u7f6e\n$ make ARCH=riscv CROSS_COMPILE=riscv64-linux-gnu-  # \u7f16\u8bd1 RISC-V \u5e73\u53f0\u5185\u6838\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u624b\u52a8\u4e3a <code>make</code> \u6307\u5b9a\u53d8\u91cf\u7684\u503c\uff0c\u672c\u6b21\u5b9e\u9a8c\u4e2d\u7528\u5230\u7684\u5982\u4e0b\uff1a</p> <ul> <li><code>ARCH</code> \u6307\u5b9a\u67b6\u6784\uff0c\u53ef\u9009\u7684\u503c\u5305\u62ec arch \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u5939\u540d\uff0c\u5982 x86\u3001arm\u3001arm64 \u7b49\uff0c\u4e0d\u540c\u4e8e arm \u548c arm64\uff0c32 \u4f4d\u548c 64 \u4f4d\u7684RISC-V\u5171\u7528 <code>arch/riscv</code> \u76ee\u5f55\uff0c\u901a\u8fc7\u4f7f\u7528\u4e0d\u540c\u7684 config \u53ef\u4ee5\u7f16\u8bd1 32 \u4f4d\u6216 64 \u4f4d\u7684\u5185\u6838\u3002</li> <li><code>CROSS_COMPILE</code> \u6307\u5b9a\u4f7f\u7528\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\uff0c\u4f8b\u5982\u6307\u5b9a <code>CROSS_COMPILE=riscv64-linux-gnu-</code>\uff0c\u5219\u7f16\u8bd1\u65f6\u4f1a\u91c7\u7528 <code>riscv64-linux-gnu-gcc</code> \u4f5c\u4e3a\u7f16\u8bd1\u5668\uff0c\u7f16\u8bd1\u5728 RISC-V 64 \u4f4d\u5e73\u53f0\u4e0a\u8fd0\u884c\u7684 Linux \u5185\u6838\u3002</li> </ul>"},{"location":"lab0/#_7","title":"\u5b9e\u9a8c\u6b65\u9aa4","text":"<p>\u5728\u6267\u884c\u6bcf\u4e00\u6761\u547d\u4ee4\u524d\uff0c\u8bf7\u4f60\u5bf9\u5c06\u8981\u8fdb\u884c\u7684\u64cd\u4f5c\u8fdb\u884c\u601d\u8003\uff0c\u7ed9\u51fa\u7684\u547d\u4ee4\u4e0d\u9700\u8981\u5168\u90e8\u6267\u884c\uff0c\u5e76\u4e14\u4e0d\u662f\u6240\u6709\u7684\u547d\u4ee4\u90fd\u53ef\u4ee5\u65e0\u6761\u4ef6\u6267\u884c\uff0c\u8bf7\u4e0d\u8981\u76f4\u63a5\u590d\u5236\u7c98\u8d34\u547d\u4ee4\u53bb\u6267\u884c\u3002</p>"},{"location":"lab0/#_8","title":"\u642d\u5efa\u5b9e\u9a8c\u73af\u5883\u73af\u5883","text":"<p>\u5173\u4e8e Apple Silicon</p> <p>\u5982\u679c\u4f60\u5728\u4f7f\u7528 Mac with Apple Silicon\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 Docker Desktop \u8fdb\u884c\u8bfe\u7a0b\u5b9e\u9a8c\u3002</p> <p>Docker Desktop \u7684\u5b89\u88c5\u53ef\u4ee5\u53c2\u8003 Docker Desktop for Apple silicon\u3002</p> <p>\u4e4b\u540e\u4f7f\u7528 <code>docker pull ubuntu:noble &amp;&amp; docker run -it --name &lt;some-name&gt; ubuntu:noble bash</code> \u6765\u542f\u52a8\u4e00\u4e2a\u8fd0\u884c\u5728\u865a\u62df\u673a\u4e0a\u7684 Ubuntu for ARM \u5bb9\u5668\uff0c\u5e76\u5c06\u8fd9\u4e2a Ubuntu \u4f5c\u4e3a\u5b9e\u9a8c\u73af\u5883\u3002</p> <p>\u5173\u4e8e docker \u6e90</p> <p>\u7531\u4e8e dockerhub \u5b98\u65b9\u6e90\u5728\u56fd\u5185\u5df2\u65e0\u6cd5\u8bbf\u95ee\uff0c\u9700\u8981\u4f7f\u7528 docker \u7684\u540c\u5b66\u53ef\u4ee5\u81ea\u884c\u901a\u8fc7\u4ee3\u7406\u89e3\u51b3\uff0c\u6216\u8005\u53c2\u8003 CF-Workers-docker.io \u4f7f\u7528\u4e00\u4e9b\u7b2c\u4e09\u65b9\u955c\u50cf\u6e90\u3002</p> <p>\u9996\u5148\u66f4\u65b0\u8f6f\u4ef6\u5305\u5217\u8868\u4ee5\u786e\u4fdd\u5b89\u88c5\u6700\u65b0\u7684\u8f6f\u4ef6\u5305\uff1a</p> <pre><code>$ sudo apt update\n</code></pre> <p>\u5b89\u88c5\u7f16\u8bd1\u5185\u6838\u6240\u9700\u8981\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u548c\u7528\u4e8e\u6784\u5efa\u7a0b\u5e8f\u7684\u8f6f\u4ef6\u5305\uff1a</p> <pre><code>$ sudo apt install  gcc-riscv64-linux-gnu\n$ sudo apt install  autoconf automake autotools-dev curl libmpc-dev libmpfr-dev libgmp-dev \\\n                    gawk build-essential bison flex texinfo gperf libtool patchutils bc \\\n                    zlib1g-dev libexpat-dev git\n</code></pre> <p>\u63a5\u7740\u662f\u7528\u4e8e\u542f\u52a8 riscv64 \u5e73\u53f0\u4e0a\u7684\u5185\u6838\u7684\u6a21\u62df\u5668 <code>qemu</code>\uff1a</p> <pre><code>$ sudo apt install qemu-system-misc\n</code></pre> <p>Ubuntu 22.04 \u53ef\u80fd\u9047\u5230\u517c\u5bb9\u6027\u95ee\u9898</p> <p>\u7531\u4e8e Ubuntu 22.04 apt \u4e2d\u7684 qemu \u53ea\u6709 6.2 \u7248\u672c\uff0c\u800c\u8fd9\u4e2a\u7248\u672c\u4e0b\u7684 OpenSBI \u4e5f\u5f88\u8001\uff0c\u800c\u4e14\u5728\u540e\u7eed\u9875\u8868\u7b49\u5b9e\u9a8c\u4e2d\u4e5f\u4f1a\u6709\u4e25\u91cd\u7684\u6f5c\u5728 bug\uff0c\u6240\u4ee5\u8bf7\u540c\u5b66\u4eec\u901a\u8fc7 <code>qemu-system-riscv64 --version</code> \u81ea\u67e5 qemu \u7248\u672c\uff0c\u4fdd\u8bc1\u5176\u5728 8.2.2 \u53ca\u4ee5\u4e0a\uff08Ubuntu 24.04 apt \u4e2d qemu \u4e3a 8.2.2\uff09\u3002\u5982\u679c\u7248\u672c\u8fc7\u4f4e\uff0c\u8bf7\u53c2\u8003 QEMU Wiki \u81ea\u884c\u7f16\u8bd1\u65b0\u7248 qemu\uff1a</p> <pre><code>git clone https://github.com/qemu/qemu.git\ncd qemu\nsudo apt-get install git libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev ninja-build\n./configure --target-list=riscv64-softmmu\nmake -j$(nproc)\n</code></pre> <p>\u5982\u679c\u4f60\u770b\u5230\u8fd9\u6761\u5185\u5bb9\u7684\u65f6\u5019\u8fd8\u6ca1\u6709\u6267\u884c <code>sudo apt install qemu-system-misc</code> \u800c\u4e14\u6b63\u5728\u4f7f\u7528 Ubuntu 22.04\uff0c\u8bf7\u76f4\u63a5\u901a\u8fc7\u4e0a\u8ff0\u65b9\u5f0f\u624b\u52a8\u7f16\u8bd1 qemu\u3002</p> <p>\u6211\u4eec\u8fd8\u9700\u8981\u7528 <code>gdb</code> \u6765\u5bf9\u5728 <code>qemu</code> \u4e0a\u8fd0\u884c\u7684 Linux \u5185\u6838\u8fdb\u884c\u8c03\u8bd5\uff1a</p> <pre><code>$ sudo apt install gdb-multiarch\n</code></pre> <p><code>gdb-multiarch</code> \u662f\u7f16\u8bd1\u597d\u7684\u591a\u67b6\u6784 gdb\uff0c\u53ef\u4ee5\u7528\u4e8e\u8c03\u8bd5\u591a\u79cd\u67b6\u6784\u7684\u7a0b\u5e8f\u3002\u5982\u679c\u4f60\u672c\u5730\u7684 gdb \u5df2\u7ecf\u652f\u6301 riscv \u67b6\u6784\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 <code>gdb</code> \u547d\u4ee4\u3002</p>"},{"location":"lab0/#linux_2","title":"\u83b7\u53d6 Linux \u6e90\u7801\u548c\u5df2\u7ecf\u7f16\u8bd1\u597d\u7684\u6587\u4ef6\u7cfb\u7edf","text":"<p>\u4ece https://www.kernel.org \u4e0b\u8f7d\u6700\u65b0\u7684 Linux \u6e90\u7801\u3002</p> <p>\u622a\u81f3\u5199\u4f5c\u65f6\uff0c\u6700\u65b0\u7684 Linux \u5185\u6838\u7248\u672c\u662f 6.11-rc6.</p> <p>\u5e76\u4e14\u4f7f\u7528 git \u5de5\u5177 clone \u672c\u4ed3\u5e93\u3002\u5176\u4e2d\u5df2\u7ecf\u51c6\u5907\u597d\u4e86\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u955c\u50cf\u3002</p> <p>\u6839\u6587\u4ef6\u7cfb\u7edf\u4e3a Linux Kernel \u63d0\u4f9b\u4e86\u57fa\u7840\u7684\u6587\u4ef6\u670d\u52a1\uff0c\u5728\u542f\u52a8 Linux Kernel \u65f6\u662f\u5fc5\u8981\u7684\u3002</p> <pre><code>$ git clone https://github.com/ZJU-SEC/os24fall-stu.git\n$ cd os24fall-stu/src/lab0\n$ ls\nrootfs.img  # \u5df2\u7ecf\u6784\u5efa\u5b8c\u6210\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u955c\u50cf\n</code></pre>"},{"location":"lab0/#linux_3","title":"\u7f16\u8bd1 Linux \u5185\u6838","text":"<pre><code>$ cd path/to/linux                                              # \u4fee\u6539\u4e3a\u5b9e\u9645\u8def\u5f84\n$ make ARCH=riscv CROSS_COMPILE=riscv64-linux-gnu- defconfig    # \u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e\n$ make ARCH=riscv CROSS_COMPILE=riscv64-linux-gnu- -j$(nproc)   # \u7f16\u8bd1\n</code></pre> <p>\u4f7f\u7528\u591a\u7ebf\u7a0b\u7f16\u8bd1\u4e00\u822c\u4f1a\u8017\u8d39\u5927\u91cf\u5185\u5b58\uff0c\u5982\u679c <code>-j</code> \u9009\u9879\u5bfc\u81f4\u5185\u5b58\u8017\u5c3d (out of memory)\uff0c\u8bf7\u5c1d\u8bd5\u8c03\u4f4e\u7ebf\u7a0b\u6570\uff0c\u6bd4\u5982 <code>-j4</code>, <code>-j8</code> \u7b49\u3002</p>"},{"location":"lab0/#qemu_3","title":"\u4f7f\u7528 QEMU \u8fd0\u884c\u5185\u6838","text":"<p><pre><code>$ qemu-system-riscv64 -nographic -machine virt -kernel path/to/linux/arch/riscv/boot/Image \\\n    -device virtio-blk-device,drive=hd0 -append \"root=/dev/vda ro console=ttyS0\" \\\n    -bios default -drive file=path/to/rootfs.img,format=raw,id=hd0\n</code></pre> \u9000\u51fa QEMU \u7684\u65b9\u6cd5\u4e3a\uff1a\u4f7f\u7528 Ctrl+A\uff08mac \u4e0a\u4e3a control+A\uff09\uff0c\u677e\u5f00\u540e\u518d\u6309\u4e0b X \u952e\u5373\u53ef\u9000\u51fa QEMU\u3002</p>"},{"location":"lab0/#gdb_4","title":"\u4f7f\u7528 GDB \u5bf9\u5185\u6838\u8fdb\u884c\u8c03\u8bd5","text":"<p>\u8fd9\u4e00\u6b65\u9700\u8981\u5f00\u542f\u4e24\u4e2a Terminal Session\uff0c\u4e00\u4e2a Terminal \u4f7f\u7528 QEMU \u542f\u52a8 Linux\uff0c\u53e6\u4e00\u4e2a Terminal \u4f7f\u7528 GDB \u4e0e QEMU \u8fdc\u7a0b\u901a\u4fe1\uff08\u4f7f\u7528 tcp::1234 \u7aef\u53e3\uff09\u8fdb\u884c\u8c03\u8bd5\u3002</p> <pre><code># Terminal 1\n$ qemu-system-riscv64 -nographic -machine virt -kernel path/to/linux/arch/riscv/boot/Image \\\n    -device virtio-blk-device,drive=hd0 -append \"root=/dev/vda ro console=ttyS0\" \\\n    -bios default -drive file=path/to/rootfs.img,format=raw,id=hd0 -S -s\n\n# Terminal 2\n$ gdb-multiarch path/to/linux/vmlinux\n(gdb) target remote :1234   # \u8fde\u63a5 qemu\n(gdb) b start_kernel        # \u8bbe\u7f6e\u65ad\u70b9\n(gdb) continue              # \u7ee7\u7eed\u6267\u884c\n(gdb) quit                  # \u9000\u51fa gdb\n</code></pre>"},{"location":"lab0/#_9","title":"\u5b9e\u9a8c\u4efb\u52a1\u4e0e\u8981\u6c42","text":"<ul> <li>\u8bf7\u5404\u4f4d\u540c\u5b66\u72ec\u7acb\u5b8c\u6210\u4f5c\u4e1a\uff0c\u4efb\u4f55\u6284\u88ad\u884c\u4e3a\u90fd\u5c06\u4f7f\u672c\u6b21\u4f5c\u4e1a\u5224\u4e3a0\u5206\u3002</li> <li>\u7f16\u8bd1\u5185\u6838\uff0c\u4f7f\u7528 QEMU \u542f\u52a8\u540e\uff0c\u8fdc\u7a0b\u8fde\u63a5 GDB \u8fdb\u884c\u8c03\u8bd5\uff0c\u5e76\u5c1d\u8bd5\u4f7f\u7528 GDB \u7684\u5404\u9879\u547d\u4ee4\uff08\u5982 <code>backtrace</code>, <code>finish</code>, <code>frame</code>, <code>info</code>, <code>break</code>, <code>display</code>, <code>next</code>, <code>layout</code> \u7b49\uff09\u3002</li> <li>\u5728\u5b66\u5728\u6d59\u5927\u4e2d\u63d0\u4ea4 pdf \u683c\u5f0f\u7684\u5b9e\u9a8c\u62a5\u544a\uff1a<ul> <li>\u8bb0\u5f55\u5b9e\u9a8c\u8fc7\u7a0b\u5e76\u622a\u56fe\uff084.1-4.5\uff09\uff0c\u5e76\u5bf9\u6bcf\u4e00\u6b65\u7684\u547d\u4ee4\u4ee5\u53ca\u7ed3\u679c\u8fdb\u884c\u5fc5\u8981\u7684\u89e3\u91ca\uff1b</li> <li>\u8bb0\u5f55\u9047\u5230\u7684\u95ee\u9898\u548c\u5fc3\u5f97\u4f53\u4f1a\uff1b</li> <li>\u5b8c\u6210\u601d\u8003\u9898\u3002</li> </ul> </li> </ul> <p>\u5173\u4e8e\u5b9e\u9a8c\u62a5\u544a\u5185\u5bb9\u8981\u6c42\uff0c\u53ef\u89c1\uff1a\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54 - \u5b9e\u9a8c\u63d0\u4ea4\u8981\u6c42</p>"},{"location":"lab0/#_10","title":"\u601d\u8003\u9898","text":"<ol> <li>\u4f7f\u7528 <code>riscv64-linux-gnu-gcc</code> \u7f16\u8bd1\u5355\u4e2a <code>.c</code> \u6587\u4ef6</li> <li>\u4f7f\u7528 <code>riscv64-linux-gnu-objdump</code> \u53cd\u6c47\u7f16 1 \u4e2d\u5f97\u5230\u7684\u7f16\u8bd1\u4ea7\u7269</li> <li>\u8c03\u8bd5 Linux \u65f6:<ol> <li>\u5728 GDB \u4e2d\u67e5\u770b\u6c47\u7f16\u4ee3\u7801\uff08\u4e0d\u4f7f\u7528\u4efb\u4f55\u63d2\u4ef6\u7684\u60c5\u51b5\u4e0b\uff09</li> <li>\u5728 <code>0x80000000</code> \u5904\u4e0b\u65ad\u70b9</li> <li>\u67e5\u770b\u6240\u6709\u5df2\u4e0b\u7684\u65ad\u70b9</li> <li>\u5728 <code>0x80200000</code> \u5904\u4e0b\u65ad\u70b9</li> <li>\u6e05\u9664 <code>0x80000000</code> \u5904\u7684\u65ad\u70b9</li> <li>\u7ee7\u7eed\u8fd0\u884c\u76f4\u5230\u89e6\u53d1 <code>0x80200000</code> \u5904\u7684\u65ad\u70b9</li> <li>\u5355\u6b65\u8c03\u8bd5\u4e00\u6b21</li> <li>\u9000\u51fa QEMU</li> </ol> </li> <li>\u4f7f\u7528 <code>make</code> \u5de5\u5177\u6e05\u9664 Linux \u7684\u6784\u5efa\u4ea7\u7269</li> <li><code>vmlinux</code> \u548c <code>Image</code> \u7684\u5173\u7cfb\u548c\u533a\u522b\u662f\u4ec0\u4e48\uff1f</li> </ol>"},{"location":"lab1/","title":"Lab 1: RV64 \u5185\u6838\u5f15\u5bfc\u4e0e\u65f6\u949f\u4e2d\u65ad\u5904\u7406","text":""},{"location":"lab1/#_1","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<ul> <li>\u5b66\u4e60 RISC-V \u6c47\u7f16\uff0c\u7f16\u5199 head.S \u5b9e\u73b0\u8df3\u8f6c\u5230\u5185\u6838\u8fd0\u884c\u7684\u7b2c\u4e00\u4e2a C \u51fd\u6570\uff1b</li> <li>\u5b66\u4e60 OpenSBI\uff0c\u7406\u89e3 OpenSBI \u5728\u5b9e\u9a8c\u4e2d\u6240\u8d77\u5230\u7684\u4f5c\u7528\uff0c\u5e76\u8c03\u7528 OpenSBI \u63d0\u4f9b\u7684\u63a5\u53e3\u5b8c\u6210\u5b57\u7b26\u7684\u8f93\u51fa\uff1b</li> <li>\u5b66\u4e60 Makefile \u76f8\u5173\u77e5\u8bc6\uff0c\u8865\u5145\u9879\u76ee\u4e2d\u7684 Makefile \u6587\u4ef6\uff0c\u6765\u5b8c\u6210\u5bf9\u6574\u4e2a\u5de5\u7a0b\u7684\u7ba1\u7406\uff1b</li> <li>\u5b66\u4e60 RISC-V \u7684 trap \u5904\u7406\u76f8\u5173\u5bc4\u5b58\u5668\u4e0e\u6307\u4ee4\uff0c\u5b8c\u6210\u5bf9 trap \u5904\u7406\u7684\u521d\u59cb\u5316\uff1b</li> <li>\u7406\u89e3 CPU \u4e0a\u4e0b\u6587\u5207\u6362\u673a\u5236\uff0c\u5e76\u6b63\u786e\u5b9e\u73b0\u4e0a\u4e0b\u6587\u5207\u6362\u529f\u80fd\uff1b</li> <li>\u7f16\u5199 trap \u5904\u7406\u51fd\u6570\uff0c\u5b8c\u6210\u5bf9\u7279\u5b9a trap \u7684\u5904\u7406\uff1b</li> <li>\u8c03\u7528 OpenSBI \u63d0\u4f9b\u7684\u63a5\u53e3\uff0c\u5b8c\u6210\u5bf9\u65f6\u949f\u4e2d\u65ad\u4e8b\u4ef6\u7684\u8bbe\u7f6e\u3002</li> </ul>"},{"location":"lab1/#_2","title":"\u5b9e\u9a8c\u73af\u5883","text":"<ul> <li>Environment in Lab0</li> </ul> <p>Ubuntu 22.04 \u53ef\u80fd\u9047\u5230\u517c\u5bb9\u6027\u95ee\u9898</p> <p>\u7531\u4e8e Ubuntu 22.04 apt \u4e2d\u7684 qemu \u53ea\u6709 6.2 \u7248\u672c\uff0c\u800c\u8fd9\u4e2a\u7248\u672c\u4e0b\u7684 OpenSBI \u4e5f\u5f88\u8001\uff0c\u800c\u4e14\u5728\u540e\u7eed\u9875\u8868\u7b49\u5b9e\u9a8c\u4e2d\u4e5f\u4f1a\u6709\u4e25\u91cd\u7684\u6f5c\u5728 bug\uff0c\u6240\u4ee5\u8bf7\u540c\u5b66\u4eec\u901a\u8fc7 <code>qemu-system-riscv64 --version</code> \u81ea\u67e5 qemu \u7248\u672c\uff0c\u4fdd\u8bc1\u5176\u5728 8.2.2 \u53ca\u4ee5\u4e0a\uff08Ubuntu 24.04 apt \u4e2d qemu \u4e3a 8.2.2\uff09\u3002\u5982\u679c\u7248\u672c\u8fc7\u4f4e\uff0c\u8bf7\u53c2\u8003 QEMU Wiki \u81ea\u884c\u7f16\u8bd1\u65b0\u7248 qemu\uff1a</p> <pre><code>git clone https://github.com/qemu/qemu.git\ncd qemu\nsudo apt-get install git libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev ninja-build\n./configure --target-list=riscv64-softmmu\nmake -j$(nproc)\n</code></pre> <p>\u5347\u7ea7\u5230 Ubuntu 24.04</p> <p>\u5df2\u7ecf\u5b89\u88c5 Ubuntu 22.04 \u6216\u66f4\u65e7\u7248\u672c\u7684\u540c\u5b66\u53ef\u4ee5\u9009\u62e9\u53c2\u8003\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54 - \u5982\u4f55\u5347\u7ea7\u5230 Ubuntu 24.04 \u8fdb\u884c\u5347\u7ea7\u3002</p> <p>\u5347\u7ea7\u540e\uff0cAPT \u4f1a\u81ea\u52a8\u5c06 QEMU \u7b49\u8f6f\u4ef6\u5305\u5347\u7ea7\u5230\u8f6f\u4ef6\u4ed3\u5e93\u4e2d\u8f83\u65b0\u7684\u7248\u672c\u3002</p>"},{"location":"lab1/#_3","title":"\u5b9e\u9a8c\u57fa\u7840\u77e5\u8bc6\u4ecb\u7ecd","text":""},{"location":"lab1/#rv64","title":"RV64 \u5185\u6838\u5f15\u5bfc","text":""},{"location":"lab1/#risc-v","title":"RISC-V \u624b\u518c","text":"<p>\u4e3a\u4e86\u987a\u5229\u5b8c\u6210 OS \u5b9e\u9a8c\uff0c\u6211\u4eec\u9700\u8981\u5f88\u591a RISC-V \u6307\u4ee4\u96c6\u7684\u57fa\u7840\u77e5\u8bc6\uff0c\u8fd9\u4e9b\u8bfe\u5802\u4e0a\u5927\u90e8\u5206\u4e0d\u4f1a\u8bb2\u6388\uff0c\u8bf7\u540c\u5b66\u4eec\u901a\u8fc7\u9605\u8bfb\u4ee5\u4e0b\u51e0\u4efd\u624b\u518c\u6587\u6863\u8fdb\u884c\u81ea\u5b66\uff1a</p> <ul> <li>RISC-V Assembly Programmer's Manual</li> <li>RISC-V Unprivileged Spec</li> <li>RISC-V Privileged Spec</li> <li>RISC-V Supervisor Binary Interface Specification\uff08SBI\uff09</li> </ul> <p>\u6307\u4ee4\u901f\u67e5\u4ee5\u53ca\u5feb\u901f\u5b66\u4e60\u53ef\u4ee5\u53c2\u8003 https://note.tonycrane.cc/cs/pl/riscv/</p> <p>\u4e00\u5207\u5747\u4ee5 spec \u4e3a\u51c6\uff0c\u4e0d\u53ef\u8df3\u8fc7\u9605\u8bfb spec \u8fd9\u4e00\u6b65\u9aa4\uff1b\u4e2d\u6587\u7248 RISC-V \u624b\u518c\u8d28\u91cf\u826f\u83a0\u4e0d\u9f50\uff0c\u8bf7\u8c28\u614e\u53c2\u8003\u5e76\u4ee5\u82f1\u6587\u7248\u5185\u5bb9\u4e3a\u51c6\u3002</p> <p>\u5173\u4e8e\u624b\u518c\u7248\u672c</p> <p>RISC-V ISA \u7684\u624b\u518c\u5df2\u7ecf\u66f4\u65b0\u5230\u5f53\u524d\u6700\u65b0\u7684 ratified \u7248\u672c\uff0c\u5373 20240411 \u7248\u672c\u3002\u8fc7\u53bb\u7684\u8001\u7248\u672c\u4e3a 20191213 \u7684\u975e\u7279\u6743\u7ea7 ISA \u548c 20211203 \u7684\u7279\u6743\u7ea7 ISA\uff0c\u76f8\u6bd4\u4e4b\u4e0b\u5f53\u524d\u7684\u6587\u6863\u6837\u5f0f\u548c\u5185\u5bb9\u4e0a\u90fd\u6709\u6240\u6539\u53d8\uff0c\u4e00\u5207\u4ee5\u6700\u65b0 ratified spec \u4e3a\u51c6\u3002</p> <p>\u9664\u53bb RISC-V ISA \u7684\u624b\u518c\u5916\uff0c\u5176\u4ed6 RISC-V \u7684\u6280\u672f\u89c4\u8303\u4e5f\u53ef\u4ee5\u5728 RISC-V Wiki - RISC-V Tecnical Specifications \u4e2d\u627e\u5230\uff0c\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u81ea\u884c\u67e5\u9605\u3002</p>"},{"location":"lab1/#risc-v_1","title":"RISC-V \u7684\u4e09\u79cd\u7279\u6743\u6a21\u5f0f","text":"<p>RISC-V \u6709\u4e09\u4e2a\u7279\u6743\u6a21\u5f0f\uff1aU\uff08user\uff09\u6a21\u5f0f\u3001S\uff08supervisor\uff09\u6a21\u5f0f\u548c M\uff08machine\uff09\u6a21\u5f0f\u3002</p> Level Encoding Name Abbreviation 0 00 User/Application U 1 01 Supervisor S 2 10 3 11 Machine M <p>\u5176\u4e2d\uff1a</p> <ul> <li>M \u6a21\u5f0f\u662f\u5bf9\u786c\u4ef6\u64cd\u4f5c\u7684\u62bd\u8c61\uff0c\u6709\u6700\u9ad8\u7ea7\u522b\u7684\u6743\u9650\uff1b</li> <li>S \u6a21\u5f0f\u4ecb\u4e8e M \u6a21\u5f0f\u548c U \u6a21\u5f0f\u4e4b\u95f4\uff0c\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u5bf9\u5e94\u4e8e\u5185\u6838\u6001\uff08kernel\uff09\u3002\u5f53\u7528\u6237\u9700\u8981\u5185\u6838\u8d44\u6e90\u65f6\uff0c\u5411\u5185\u6838\u7533\u8bf7\uff0c\u5e76\u5207\u6362\u5230\u5185\u6838\u6001\u8fdb\u884c\u5904\u7406\uff1b</li> <li>U \u6a21\u5f0f\u7528\u4e8e\u6267\u884c\u7528\u6237\u7a0b\u5e8f\uff0c\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u5bf9\u5e94\u4e8e\u7528\u6237\u6001\uff0c\u6709\u6700\u4f4e\u7ea7\u522b\u7684\u6743\u9650\u3002</li> </ul>"},{"location":"lab1/#os","title":"\u4ece\u8ba1\u7b97\u673a\u4e0a\u7535\u5230 OS \u8fd0\u884c","text":"<p>\u6211\u4eec\u4ee5\u6700\u57fa\u7840\u7684\u5d4c\u5165\u5f0f\u7cfb\u7edf\u4e3a\u4f8b\uff0c\u8ba1\u7b97\u673a\u4e0a\u7535\u540e\uff0c\u9996\u5148\u786c\u4ef6\u8fdb\u884c\u4e00\u4e9b\u57fa\u7840\u7684\u521d\u59cb\u5316\u540e\uff0c\u5c06 CPU \u7684 Program Counter \u79fb\u52a8\u5230\u5185\u5b58\u4e2d bootloader \u7684\u8d77\u59cb\u5730\u5740\u3002</p> <p>Bootloader \u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u8fd0\u884c\u4e4b\u524d\uff0c\u7528\u4e8e\u521d\u59cb\u5316\u786c\u4ef6\uff0c\u52a0\u8f7d\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u3002</p> <p>\u5728 RISC-V \u67b6\u6784\u91cc\uff0cbootloader \u8fd0\u884c\u5728 M \u6a21\u5f0f\u4e0b\u3002Bootloader \u8fd0\u884c\u5b8c\u6bd5\u540e\u5c31\u4f1a\u628a\u5f53\u524d\u6a21\u5f0f\u5207\u6362\u5230 S \u6a21\u5f0f\u4e0b\uff0c\u673a\u5668\u968f\u540e\u5f00\u59cb\u8fd0\u884c kernel\u3002</p> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u7b80\u5355\u800c\u8a00\u5c31\u662f\u8fd9\u6837\uff1a</p> <pre><code>   Hardware             RISC-V M Mode           RISC-V S Mode \n+------------+         +--------------+         +----------+\n|  Power On  |  ----&gt;  |  Bootloader  |  ----&gt;  |  Kernel  |\n+------------+         +--------------+         +----------+\n</code></pre>"},{"location":"lab1/#sbi-opensbi","title":"SBI \u4e0e OpenSBI","text":"<p>SBI\uff08Supervisor Binary Interface\uff09\u662f S-mode \u7684 Kernel \u548c M-mode \u6267\u884c\u73af\u5883\u4e4b\u95f4\u7684\u63a5\u53e3\u89c4\u8303\uff0c\u800c OpenSBI \u662f\u4e00\u4e2a RISC-V SBI \u89c4\u8303\u7684\u5f00\u6e90\u5b9e\u73b0\u3002RISC-V \u5e73\u53f0\u548c SoC \u4f9b\u5e94\u5546\u53ef\u4ee5\u81ea\u4e3b\u6269\u5c55 OpenSBI \u5b9e\u73b0\uff0c\u4ee5\u9002\u5e94\u7279\u5b9a\u7684\u786c\u4ef6\u914d\u7f6e\u3002</p> <p>\u7b80\u5355\u7684\u8bf4\uff0c\u4e3a\u4e86\u4f7f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u9002\u914d\u4e0d\u540c\u786c\u4ef6\uff0cOpenSBI \u63d0\u51fa\u4e86\u4e00\u7cfb\u5217\u89c4\u8303\u5bf9 M-mode \u4e0b\u7684\u786c\u4ef6\u8fdb\u884c\u4e86\u7edf\u4e00\u5b9a\u4e49\uff0c\u8fd0\u884c\u5728 S-mode \u4e0b\u7684\u5185\u6838\u53ef\u4ee5\u6309\u7167\u8fd9\u4e9b\u89c4\u8303\u5bf9\u4e0d\u540c\u786c\u4ef6\u8fdb\u884c\u64cd\u4f5c\u3002</p> <p></p> <p>\u4e3a\u964d\u4f4e\u5b9e\u9a8c\u96be\u5ea6\uff0c\u6211\u4eec\u9009\u62e9 OpenSBI \u4f5c\u4e3a bootloader \u6765\u5b8c\u6210\u673a\u5668\u542f\u52a8\u65f6 M-mode \u4e0b\u7684\u786c\u4ef6\u521d\u59cb\u5316\u4e0e\u5bc4\u5b58\u5668\u8bbe\u7f6e\uff0c\u5e76\u4f7f\u7528 OpenSBI \u6240\u63d0\u4f9b\u7684\u63a5\u53e3\u5b8c\u6210\u8bf8\u5982\u5b57\u7b26\u6253\u5370\u7684\u64cd\u4f5c\u3002</p> <p>\u5728\u5b9e\u9a8c\u4e2d\uff0cQEMU \u5df2\u7ecf\u5185\u7f6e\u4e86 OpenSBI \u4f5c\u4e3a bootloader\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>-bios default</code> \u542f\u7528\u3002\u5982\u679c\u542f\u7528\uff0cQEMU \u4f1a\u5c06 OpenSBI \u4ee3\u7801\u52a0\u8f7d\u5230 <code>0x80000000</code> \u8d77\u59cb\u5904\u3002OpenSBI \u521d\u59cb\u5316\u5b8c\u6210\u540e\uff0c\u4f1a\u8df3\u8f6c\u5230 <code>0x80200000</code> \u5904\uff08\u4e5f\u5c31\u662f kernel \u7684\u8d77\u59cb\u5730\u5740\uff09\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u6240\u7f16\u8bd1\u7684\u4ee3\u7801\u9700\u8981\u653e\u5230 <code>0x80200000</code> \u5904\u3002</p> <p>\u5982\u679c\u4f60\u5bf9 RISC-V \u67b6\u6784\u7684 boot \u6d41\u7a0b\u6709\u66f4\u591a\u7684\u597d\u5947\uff0c\u53ef\u4ee5\u53c2\u8003\u8fd9\u4efd bootflow</p>"},{"location":"lab1/#gnu-make","title":"GNU Make","text":"<p>GNU Make \u662f\u4e00\u4e2a\u7528\u4e8e\u81ea\u52a8\u5316\u7f16\u8bd1\u7684\u5de5\u5177\uff0c\u5b83\u901a\u8fc7\u8bfb\u53d6 Makefile \u6587\u4ef6\u4e2d\u7684\u89c4\u5219\u6765\u6267\u884c\u7f16\u8bd1\u8fc7\u7a0b\u3002Makefile \u6587\u4ef6\u4e2d\u5305\u542b\u4e86\u4e00\u7cfb\u5217\u7684\u89c4\u5219\uff0c\u63cf\u8ff0\u4e86\u6e90\u6587\u4ef6\u4e4b\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u4ee5\u53ca\u5982\u4f55\u7f16\u8bd1\u548c\u94fe\u63a5\u8fd9\u4e9b\u6e90\u6587\u4ef6\u3002\u5728\u9605\u8bfb\u4e86 Makefile \u4ecb\u7ecd\u8fd9\u4e00\u7ae0\u8282\u540e\uff0c\u540c\u5b66\u4eec\u53ef\u4ee5\u6839\u636e\u5de5\u7a0b\u6587\u4ef6\u5939\u91cc Makefile \u7684\u4ee3\u7801\u6765\u638c\u63e1\u4e00\u4e9b\u57fa\u672c\u7684\u4f7f\u7528\u6280\u5de7\u3002</p>"},{"location":"lab1/#_4","title":"\u5185\u8054\u6c47\u7f16","text":"<p>\u5185\u8054\u6c47\u7f16\uff08\u901a\u5e38\u7531 <code>asm</code> \u6216\u8005 <code>__asm__</code> \u5173\u952e\u5b57\u5f15\u5165\uff09\u63d0\u4f9b\u4e86\u5c06\u6c47\u7f16\u8bed\u8a00\u6e90\u4ee3\u7801\u5d4c\u5165 C \u7a0b\u5e8f\u7684\u80fd\u529b\u3002</p> <p>\u5185\u8054\u6c47\u7f16\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u53c2\u8003 Assembler Instructions with C Expression Operands \u3002</p> <p>\u4e0b\u9762\u7b80\u8981\u4ecb\u7ecd\u4e00\u4e0b\u8fd9\u6b21\u5b9e\u9a8c\u4f1a\u7528\u5230\u7684\u4e00\u4e9b\u5185\u8054\u6c47\u7f16\u77e5\u8bc6\uff0c\u5185\u8054\u6c47\u7f16\u57fa\u672c\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>    __asm__ volatile (\n        \"instruction1\\n\"\n        \"instruction2\\n\"\n        ......\n        ......\n        \"instruction3\\n\"\n        : [out1] \"=r\" (v1),[out2] \"=r\" (v2)\n        : [in1] \"r\" (v1), [in2] \"r\" (v2)\n        : \"memory\"\n    );\n</code></pre> <p>\u5176\u4e2d\uff0c\u4e09\u4e2a <code>:</code> \u5c06\u6c47\u7f16\u90e8\u5206\u5206\u6210\u4e86\u56db\u90e8\u5206\uff1a</p> <ul> <li>\u7b2c\u4e00\u90e8\u5206\u662f\u6c47\u7f16\u6307\u4ee4\uff0c\u6307\u4ee4\u672b\u5c3e\u9700\u8981\u6dfb\u52a0 <code>\\n</code>\uff1b</li> <li>\u7b2c\u4e8c\u90e8\u5206\u662f\u8f93\u51fa\u64cd\u4f5c\u6570\u90e8\u5206\uff1b</li> <li>\u7b2c\u4e09\u90e8\u5206\u662f\u8f93\u5165\u64cd\u4f5c\u6570\u90e8\u5206\uff1b</li> <li>\u7b2c\u56db\u90e8\u5206\u662f\u53ef\u80fd\u5f71\u54cd\u7684\u5bc4\u5b58\u5668\u6216\u5b58\u50a8\u5668\uff0c\u7528\u4e8e\u544a\u77e5\u7f16\u8bd1\u5668\u5f53\u524d\u5185\u8054\u6c47\u7f16\u8bed\u53e5\u53ef\u80fd\u4f1a\u5bf9\u67d0\u4e9b\u5bc4\u5b58\u5668\u6216\u5185\u5b58\u8fdb\u884c\u4fee\u6539\uff0c\u4f7f\u5f97\u7f16\u8bd1\u5668\u5728\u4f18\u5316\u65f6\u5c06\u5176\u56e0\u7d20\u8003\u8651\u8fdb\u53bb\u3002</li> </ul> <p>\u8fd9\u56db\u90e8\u5206\u4e2d\u540e\u4e09\u90e8\u5206\u4e0d\u662f\u5fc5\u987b\u7684\u3002</p> \u793a\u4f8b\u4e00 <p><pre><code>unsigned long long s_example(unsigned long long type, unsigned long long arg0) {\n    unsigned long long ret_val;\n    asm volatile (\n        \"mv x10, %[type]\\n\"\n        \"mv x11, %[arg0]\\n\"\n        \"mv %[ret_val], x12\"\n        : [ret_val] \"=r\" (ret_val)\n        : [type] \"r\" (type), [arg0] \"r\" (arg0)\n        : \"memory\"\n    );\n    return ret_val;\n}\n</code></pre> \u793a\u4f8b\u4e00\u4e2d\u6307\u4ee4\u90e8\u5206\uff0c<code>%[type]</code>\u3001<code>%[arg0]</code> \u4ee5\u53ca <code>%[ret_val]</code> \u4ee3\u8868\u7740\u7279\u5b9a\u7684\u5bc4\u5b58\u5668\u6216\u662f\u5185\u5b58\u3002</p> <p>\u8f93\u5165\u8f93\u51fa\u90e8\u5206\u4e2d\uff0c<code>[type] \"r\" (type)</code>\u4ee3\u8868\u7740\u5c06 <code>()</code> \u4e2d\u7684\u53d8\u91cf <code>type</code> \u653e\u5165\u5bc4\u5b58\u5668\u4e2d\uff08<code>\"r\"</code> \u6307\u653e\u5165\u5bc4\u5b58\u5668\uff0c\u5982\u679c\u662f <code>\"m\"</code> \u5219\u4e3a\u653e\u5165\u5185\u5b58\uff09\uff0c\u5e76\u4e14\u7ed1\u5b9a\u5230 <code>[]</code> \u4e2d\u547d\u540d\u7684\u7b26\u53f7\u4e2d\u53bb\u3002<code>[ret_val] \"=r\" (ret_val)</code> \u4ee3\u8868\u7740\u5c06\u6c47\u7f16\u6307\u4ee4\u4e2d <code>%[ret_val]</code> \u7684\u503c\u66f4\u65b0\u5230\u53d8\u91cf <code>ret_val</code>\u4e2d\u3002</p> \u793a\u4f8b\u4e8c <pre><code>#define write_csr(reg, val) ({ asm volatile (\"csrw \" #reg \", %0\" :: \"r\"(val)); })\n</code></pre> <p>\u793a\u4f8b\u4e8c\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5b8f\uff0c\u5176\u4e2d <code>%0</code> \u4ee3\u8868\u7740\u8f93\u51fa\u8f93\u5165\u90e8\u5206\u7684\u7b2c\u4e00\u4e2a\u7b26\u53f7\uff0c\u5373 <code>val</code>\u3002</p> <p><code>#reg</code> \u662fc\u8bed\u8a00\u7684\u4e00\u4e2a\u7279\u6b8a\u5b8f\u5b9a\u4e49\u8bed\u6cd5\uff0c\u76f8\u5f53\u4e8e\u5c06reg\u8fdb\u884c\u5b8f\u66ff\u6362\u5e76\u7528\u53cc\u5f15\u53f7\u5305\u88f9\u8d77\u6765\u3002</p> <p>\u4f8b\u5982 <code>write_csr(sstatus,val)</code> \u7ecf\u5b8f\u5c55\u5f00\u4f1a\u5f97\u5230\uff1a</p> <pre><code>({ asm volatile (\"csrw \" \"sstatus\" \", %0\" :: \"r\"(val)); })\n</code></pre> <p>\u6b64\u5916\uff0c\u8fd9\u4e2a\u793a\u4f8b\u4e2d\u7684 <code>({...})</code> \u8fd8\u6d89\u53ca\u4e86\u4e00\u4e2a GNU \u5bf9 C \u7684\u6269\u5c55\uff0c\u7528\u4e8e\u5c06\u4e00\u6bb5\u4ee3\u7801\u5757\u4f5c\u4e3a\u4e00\u4e2a\u8868\u8fbe\u5f0f\u6765\u4f7f\u7528\uff0c\u53ef\u4ee5\u53c2\u8003 Statements and Declarations in Expressions\u3002\u6bd4\u5982\u4ee5\u4e0b\u4ee3\u7801\uff1a</p> <pre><code>#define max(a, b)            \\\n({                         \\\n    __typeof__(a) __a = (a); \\\n    __typeof__(b) __b = (b); \\\n    __a &gt; __b ? __a : __b;   \\\n})\n\nint c = max(x++, y++);\n</code></pre> <p>\u5728\u5b8f\u5c55\u5f00\u4e4b\u540e\u5c31\u53d8\u6210\u4e86\uff1a</p> <pre><code>int c = ({\n__typeof__(x++) __a = (x++);\n__typeof__(y++) __b = (y++);\n__a &gt; __b ? __a : __b;\n});\n</code></pre> <p>\u8fd9\u6837\u7684\u5199\u6cd5\u53ef\u4ee5\u907f\u514d\u5b8f\u5c55\u5f00\u540e\u7684\u526f\u4f5c\u7528\uff0c\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d <code>x++</code> \u548c <code>y++</code> \u53ea\u4f1a\u88ab\u6267\u884c\u4e00\u6b21\uff0c\u540c\u5b66\u4eec\u53ef\u4ee5\u81ea\u884c\u6bd4\u8f83\u5176\u4e0e <code>#define max(a, b) ((a) &gt; (b) ? (a) : (b))</code> \u7684\u533a\u522b\u3002</p>"},{"location":"lab1/#_5","title":"\u7f16\u8bd1\u76f8\u5173\u77e5\u8bc6\u4ecb\u7ecd","text":""},{"location":"lab1/#vmlinuxlds","title":"vmlinux.lds","text":"<p>GNU ld \u5373\u94fe\u63a5\u5668\uff0c\u7528\u4e8e\u5c06 <code>*.o</code> \u6587\u4ef6\uff08\u548c\u5e93\u6587\u4ef6\uff09\u94fe\u63a5\u6210\u53ef\u6267\u884c\u6587\u4ef6\u3002\u5728\u64cd\u4f5c\u7cfb\u7edf\u5f00\u53d1\u4e2d\uff0c\u4e3a\u4e86\u6307\u5b9a\u7a0b\u5e8f\u7684\u5185\u5b58\u5e03\u5c40\uff0cld \u4f7f\u7528\u94fe\u63a5\u811a\u672c\uff08Linker Script\uff09\u6765\u63a7\u5236\uff0c\u5728 Linux kernel \u4e2d\u94fe\u63a5\u811a\u672c\u88ab\u547d\u540d\u4e3a vmlinux.lds\u3002\u66f4\u591a\u5173\u4e8e ld \u7684\u4ecb\u7ecd\u53ef\u4ee5\u4f7f\u7528 <code>man ld</code> \u547d\u4ee4\u3002</p> <p>\u4e0b\u9762\u7ed9\u51fa\u4e00\u4e2a <code>vmlinux.lds</code> \u7684\u4f8b\u5b50\uff1a</p> <pre><code>/* \u76ee\u6807\u67b6\u6784 */\nOUTPUT_ARCH(\"riscv\")\n\n/* \u7a0b\u5e8f\u5165\u53e3 */\nENTRY(_start)\n\n/* kernel \u4ee3\u7801\u8d77\u59cb\u4f4d\u7f6e */\nBASE_ADDR = 0x80200000;\n\nSECTIONS {\n    /* . \u4ee3\u8868\u5f53\u524d\u5730\u5740 */\n    . = BASE_ADDR;\n\n    /* \u8bb0\u5f55 kernel \u4ee3\u7801\u7684\u8d77\u59cb\u5730\u5740 */\n    _skernel = .;\n\n    /* ALIGN(0x1000) \u8868\u793a 4KiB \u5bf9\u9f50 */\n    /* _stext, _etext \u5206\u522b\u8bb0\u5f55\u4e86 text \u6bb5\u7684\u8d77\u59cb\u4e0e\u7ed3\u675f\u5730\u5740 */\n    .text : ALIGN(0x1000) {\n        _stext = .;\n\n        *(.text.entry)\n        *(.text .text.*)\n\n        _etext = .;\n    }\n\n    .rodata : ALIGN(0x1000) {\n        _srodata = .;\n\n        *(.rodata .rodata.*)\n\n        _erodata = .;\n    }\n\n    .data : ALIGN(0x1000) {\n        _sdata = .;\n\n        *(.data .data.*)\n\n        _edata = .;\n    }\n\n    .bss : ALIGN(0x1000) {\n        _sbss = .;\n\n        *(.bss.stack)\n        sbss = .;\n        *(.bss .bss.*)\n\n        _ebss = .;\n    }\n\n    /* \u8bb0\u5f55 kernel \u4ee3\u7801\u7684\u7ed3\u675f\u5730\u5740 */\n    _ekernel = .;\n}\n</code></pre> <ul> <li><code>OUTPUT_ARCH</code> \u6307\u5b9a\u4e86\u67b6\u6784\u4e3a RISC-V\uff1b</li> <li><code>ENTRY</code> \u6307\u5b9a\u7a0b\u5e8f\u5165\u53e3\u70b9\u4e3a <code>_start</code> \u51fd\u6570\uff0c\u7a0b\u5e8f\u5165\u53e3\u70b9\u5373\u7a0b\u5e8f\u542f\u52a8\u65f6\u8fd0\u884c\u7684\u51fd\u6570\uff0c\u7ecf\u8fc7\u8fd9\u6837\u7684\u6307\u5b9a\u540e\u5728 head.S \u4e2d\u9700\u8981\u7f16\u5199 <code>_start</code> \u51fd\u6570\uff0c\u7a0b\u5e8f\u624d\u80fd\u6b63\u5e38\u8fd0\u884c\uff1b</li> <li>\u94fe\u63a5\u811a\u672c\u4e2d\u6709 <code>.</code> <code>*</code> \u4e24\u4e2a\u91cd\u8981\u7684\u7b26\u53f7\uff1a<ul> <li>\u5355\u72ec\u7684 <code>.</code> \u5728\u94fe\u63a5\u811a\u672c\u4ee3\u8868\u5f53\u524d\u5730\u5740\uff0c\u5b83\u6709\u8d4b\u503c\u3001\u88ab\u8d4b\u503c\u3001\u81ea\u589e\u7b49\u64cd\u4f5c\uff1b</li> <li><code>*</code> \u6709\u4e24\u79cd\u7528\u6cd5\uff0c\u5176\u4e00\u662f <code>*()</code> \u5728\u5927\u62ec\u53f7\u4e2d\u8868\u793a\u5c06\u6240\u6709\u6587\u4ef6\u4e2d\u7b26\u5408\u62ec\u53f7\u5185\u8981\u6c42\u7684\u6bb5\u653e\u7f6e\u5728\u5f53\u524d\u4f4d\u7f6e\uff0c\u5176\u4e8c\u662f\u4f5c\u4e3a\u901a\u914d\u7b26\uff1b</li> </ul> </li> <li> <p>\u94fe\u63a5\u811a\u672c\u7684\u4e3b\u4f53\u662f <code>SECTIONS</code> \u90e8\u5206\uff0c\u5728\u8fd9\u91cc\u94fe\u63a5\u811a\u672c\u7684\u5de5\u4f5c\u662f\u5c06\u7a0b\u5e8f\u7684\u5404\u4e2a\u6bb5\u6309\u987a\u5e8f\u653e\u5728\u5404\u4e2a\u5730\u5740\u4e0a\uff1b</p> <ul> <li>\u5728\u4f8b\u5b50\u4e2d\u5c31\u662f\u4ece <code>0x80200000</code> \u5730\u5740\u5f00\u59cb\u653e\u7f6e\u4e86 <code>.text</code>\u3001<code>.rodata</code>\u3001<code>.data</code> \u548c <code>.bss</code> \u6bb5\uff0c\u5404\u4e2a\u6bb5\u7684\u4f5c\u7528\u53ef\u4ee5\u7b80\u8981\u6982\u62ec\u6210\uff1a</li> </ul> \u6bb5\u540d \u4e3b\u8981\u4f5c\u7528 <code>.text</code> \u901a\u5e38\u5b58\u653e\u7a0b\u5e8f\u6267\u884c\u4ee3\u7801 <code>.rodata</code> \u901a\u5e38\u5b58\u653e\u5e38\u91cf\u7b49\u53ea\u8bfb\u6570\u636e <code>.data</code> \u901a\u5e38\u5b58\u653e\u5df2\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\u3001\u9759\u6001\u53d8\u91cf <code>.bss</code> \u901a\u5e38\u5b58\u653e\u672a\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\u3001\u9759\u6001\u53d8\u91cf </li> <li> <p>\u5728\u94fe\u63a5\u811a\u672c\u4e2d\u53ef\u4ee5\u81ea\u5b9a\u4e49\u7b26\u53f7\uff0c\u4f8b\u5982\u4ee5\u4e0a\u6240\u6709 <code>_s</code> \u4e0e <code>_e</code> \u5f00\u5934\u7684\u7b26\u53f7\u90fd\u662f\u6211\u4eec\u81ea\u5df1\u5b9a\u4e49\u7684\u3002</p> </li> </ul> <p>\u66f4\u591a\u6709\u5173\u94fe\u63a5\u811a\u672c\u8bed\u6cd5\u53ef\u4ee5\u53c2\u8003 ld script \u6587\u6863</p>"},{"location":"lab1/#vmlinux","title":"vmlinux","text":"<p>vmlinux \u901a\u5e38\u6307 Linux kernel \u7f16\u8bd1\u51fa\u7684\u53ef\u6267\u884c\u6587\u4ef6\uff08Executable and Linkable Format\uff0cELF\uff09\uff0c\u7279\u70b9\u662f\u672a\u538b\u7f29\u7684\uff0c\u5e26\u8c03\u8bd5\u4fe1\u606f\u548c\u7b26\u53f7\u8868\u7684\u3002\u5728\u6574\u5957 OS \u5b9e\u9a8c\u4e2d\uff0cvmlinux \u901a\u5e38\u6307\u5c06\u4f60\u7684\u4ee3\u7801\u8fdb\u884c\u7f16\u8bd1\uff0c\u94fe\u63a5\u540e\u751f\u6210\u7684\u53ef\u4f9b QEMU \u8fd0\u884c\u7684 RV64 \u67b6\u6784\u7a0b\u5e8f\u3002\u5982\u679c\u5bf9 vmlinux \u4f7f\u7528 <code>file</code> \u547d\u4ee4\uff0c\u4f60\u5c06\u770b\u5230\u5982\u4e0b\u4fe1\u606f\uff1a</p> <pre><code>$ file vmlinux \nvmlinux: ELF 64-bit LSB executable, UCB RISC-V, version 1 (SYSV), statically linked, not stripped\n</code></pre>"},{"location":"lab1/#systemmap","title":"System.map","text":"<p>System.map \u662f\u5185\u6838\u7b26\u53f7\u8868\uff08Kernel Symbol Table\uff09\u6587\u4ef6\uff0c\u662f\u5b58\u50a8\u4e86\u6240\u6709\u5185\u6838\u7b26\u53f7\u53ca\u5176\u5730\u5740\u7684\u4e00\u4e2a\u5217\u8868\u3002\u201c\u7b26\u53f7\u201d\u901a\u5e38\u6307\u7684\u662f\u51fd\u6570\u540d\uff0c\u5168\u5c40\u53d8\u91cf\u540d\u7b49\u7b49\u3002\u4f7f\u7528 <code>nm vmlinux</code> \u547d\u4ee4\u5373\u53ef\u6253\u5370 vmlinux \u7684\u7b26\u53f7\u8868\uff0c\u7b26\u53f7\u8868\u7684\u6837\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>0000000000000800 A __vdso_rt_sigreturn\nffffffe000000000 T __init_begin\nffffffe000000000 T _sinittext\nffffffe000000000 T _start\nffffffe000000040 T _start_kernel\nffffffe000000076 t clear_bss\nffffffe000000080 t clear_bss_done\nffffffe0000000c0 t relocate\nffffffe00000017c t set_reset_devices\nffffffe000000190 t debug_kernel\n</code></pre> <p>\u4f7f\u7528 System.map \u53ef\u4ee5\u65b9\u4fbf\u5730\u8bfb\u51fa\u51fd\u6570\u6216\u53d8\u91cf\u7684\u5730\u5740\uff0c\u4e3a debug \u63d0\u4f9b\u4e86\u65b9\u4fbf\u3002</p>"},{"location":"lab1/#rv64_1","title":"RV64 \u65f6\u949f\u4e2d\u65ad\u5904\u7406","text":"<p>Warning</p> <p>\u672c 3.1 \u8282\u6d89\u53ca\u5230\u5f88\u591a RISC-V \u7279\u6743\u7ea7\u6307\u4ee4\u7684\u77e5\u8bc6\uff0c\u5728\u5b66\u4e60\u4e2d\u8bf7\u540c\u65f6\u53c2\u8003 RISC-V Privileged Spec \u9605\u8bfb\u8be6\u7ec6\u4fe1\u606f\uff0c\u5982\u679c\u672c\u6587\u6863\u548c spec \u4e2d\u6709\u4efb\u4f55\u51fa\u5165\u7684\u5730\u65b9\uff0c\u8bf7\u4ee5 spec \u4e3a\u51c6\uff0c\u5e76\u53ca\u65f6\u5411\u52a9\u6559\u53cd\u9988\u3002</p> <p>\u5173\u4e8e RISC-V \u7279\u6743\u7ea7 ISA\uff0c\u4e5f\u53ef\u4ee5\u53c2\u8003 https://note.tonycrane.cc/cs/pl/riscv/privileged/\u3002</p> <p>\u5982\u679c\u5b8c\u6210\u4e86 3.1 \u4e2d\u7684 RV64 \u5185\u6838\u5f15\u5bfc\uff0c\u6211\u4eec\u80fd\u6210\u529f\u5730\u5c06\u4e00\u4e2a\u6700\u7b80\u5355\u7684 OS \u542f\u52a8\u8d77\u6765\uff0c\u4f46\u8fd8\u6ca1\u6709\u529e\u6cd5\u4e0e\u4e4b\u4ea4\u4e92\u3002\u6211\u4eec\u5728\u8bfe\u7a0b\u4e2d\u8bb2\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u4e4b\u540e\u7531\u4e8b\u4ef6\uff08event\uff09\u9a71\u52a8\uff0c\u5728\u672c\u6b21\u5b9e\u9a8c\u7684\u540e\u534a\u90e8\u5206\u4e2d\uff0c\u6211\u4eec\u5c06\u5f15\u5165\u4e00\u79cd\u91cd\u8981\u7684\u4e8b\u4ef6 trap\u3002</p> <p>trap \u7ed9\u4e86 OS \u4e0e\u786c\u4ef6\u3001\u8f6f\u4ef6\u4ea4\u4e92\u7684\u80fd\u529b\u3002\u5728 3.1 \u4e2d\u6211\u4eec\u4ecb\u7ecd\u4e86\u5728 RISC-V \u4e2d\u6709\u4e09\u79cd\u7279\u6743\u7ea7\uff08M \u6001\u3001S \u6001\u3001U \u6001\uff09\uff0c\u5728 boot \u9636\u6bb5\uff0cOpenSBI \u5df2\u7ecf\u5e2e\u6211\u4eec\u5c06 M \u6001\u7684 trap \u5904\u7406\u8fdb\u884c\u4e86\u521d\u59cb\u5316\uff0c\u8fd9\u4e00\u90e8\u5206\u4e0d\u9700\u8981\u6211\u4eec\u518d\u53bb\u5b9e\u73b0\uff0c\u56e0\u6b64\u540e\u7eed\u6211\u4eec\u91cd\u70b9\u5173\u6ce8 S \u6001\u7684 trap \u5904\u7406\u3002</p>"},{"location":"lab1/#risc-v-interrupt-exception","title":"RISC-V \u4e2d\u7684 interrupt \u548c exception","text":""},{"location":"lab1/#interrupt-exception","title":"\u4ec0\u4e48\u662f interrupt \u548c exception","text":"<p>RISC-V Unprivileged Spec 1.6 \u8282\u4e2d\u5bf9\u4e8e trap\u3001interrupt \u4e0e exception \u7684\u63cf\u8ff0</p> <p>We use the term exception to refer to an unusual condition occurring at run time associated with an instruction in the current RISC-V hart. We use the term interrupt to refer to an external asynchronous event that may cause a RISC-V hart to experience an unexpected transfer of control. We use the term trap to refer to the transfer of control to a trap handler caused by either an exception or an interrupt.</p> <p>\u603b\u7ed3\u8d77\u6765 interrupt \u4e0e exception \u7684\u4e3b\u8981\u533a\u522b\u5982\u4e0b\u8868\uff1a</p> Interrupt Exception Hardware generate Software generate These are asynchronous external requests for service (like keyboard or printer needs service). These are synchronous internal requests for service based upon abnormal events (think of illegal instructions, illegal address, overflow etc). These are normal events and shouldn\u2019t interfere with the normal running of a computer. These are abnormal events and often result in the termination of a program <p>\u4e0a\u6587\u4e2d\u7684 trap \u63cf\u8ff0\u7684\u662f\u4e00\u79cd\u63a7\u5236\u8f6c\u79fb\u7684\u8fc7\u7a0b\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u662f\u7531 interrupt \u6216\u8005 exception \u5f15\u8d77\u7684\u3002\u8fd9\u91cc\u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0c\u6211\u4eec\u5728\u8fd9\u91cc\u7ea6\u5b9a trap \u4e3a interrput \u4e0e exception \u7684\u603b\u79f0\u3002</p>"},{"location":"lab1/#_6","title":"\u76f8\u5173\u5bc4\u5b58\u5668","text":"<p>\u9664\u4e86 32 \u4e2a\u901a\u7528\u5bc4\u5b58\u5668\u4e4b\u5916\uff0cRISC-V \u67b6\u6784\u8fd8\u6709\u5927\u91cf\u7684\u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668\uff08Control and Status Registers\uff0cCSRs\uff09\uff0c\u4e0b\u9762\u5c06\u4ecb\u7ecd\u51e0\u4e2a\u548c trap \u673a\u5236\u76f8\u5173\u7684\u91cd\u8981\u5bc4\u5b58\u5668\u3002</p> <p>Supervisor Mode \u4e0b trap \u76f8\u5173\u5bc4\u5b58\u5668:</p> <ul> <li><code>sstatus</code>\uff08Supervisor Status Register\uff09\u4e2d\u5b58\u5728\u4e00\u4e2a <code>SIE</code>\uff08Supervisor Interrupt Enable\uff09\u6bd4\u7279\u4f4d\uff0c\u5f53\u8be5\u6bd4\u7279\u4f4d\u8bbe\u7f6e\u4e3a 1 \u65f6\uff0c\u4f1a\u54cd\u5e94\u6240\u6709\u7684 S \u6001 trap\uff0c\u5426\u5219\u5c06\u4f1a\u7981\u7528\u6240\u6709 S \u6001 trap\u3002</li> <li><code>sie</code>\uff08Supervisor Interrupt Enable Register\uff09\uff0c\u5728 RISC-V \u4e2d\uff0cinterrupt \u88ab\u5212\u5206\u4e3a\u4e09\u7c7b software interrupt\u3001timer interrupt\u3001external interrupt\u3002\u5728\u5f00\u542f\u4e86 <code>sstatus[SIE]</code> \u4e4b\u540e\uff0c\u7cfb\u7edf\u4f1a\u6839\u636e <code>sie</code> \u4e2d\u7684\u76f8\u5173\u6bd4\u7279\u4f4d\u6765\u51b3\u5b9a\u662f\u5426\u5bf9\u8be5 interrupt \u8fdb\u884c\u5904\u7406\u3002</li> <li><code>stvec</code>\uff08Supervisor Trap Vector Base Address Register\uff09\u5373\u6240\u8c13\u7684\u201c\u4e2d\u65ad\u5411\u91cf\u8868\u57fa\u5740\u201d\u3002<code>stvec</code> \u6709\u4e24\u79cd\u6a21\u5f0f\uff1a<ul> <li>Direct \u6a21\u5f0f\uff0c\u9002\u7528\u4e8e\u7cfb\u7edf\u4e2d\u53ea\u6709\u4e00\u4e2a\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\uff0c\u5176\u6307\u5411\u4e2d\u65ad\u5904\u7406\u5165\u53e3\u51fd\u6570\uff08\u672c\u6b21\u5b9e\u9a8c\u4e2d\u6211\u4eec\u6240\u7528\u7684\u6a21\u5f0f\uff09\u3002</li> <li>Vectored \u6a21\u5f0f\uff0c\u6307\u5411\u4e2d\u65ad\u5411\u91cf\u8868\uff0c\u9002\u7528\u4e8e\u7cfb\u7edf\u4e2d\u6709\u591a\u4e2a\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\uff08\u8be5\u6a21\u5f0f\u53ef\u4ee5\u53c2\u8003 RISC-V \u5185\u6838\u6e90\u7801\uff09\u3002</li> </ul> </li> <li><code>scause</code>\uff08Supervisor Cause Register\uff09\uff0c\u4f1a\u8bb0\u5f55 trap \u53d1\u751f\u7684\u539f\u56e0\uff0c\u8fd8\u4f1a\u8bb0\u5f55\u8be5 trap \u662f interrupt \u8fd8\u662f exception\u3002</li> <li><code>sepc</code>\uff08Supervisor Exception Program Counter\uff09\uff0c\u4f1a\u8bb0\u5f55\u89e6\u53d1 exception \u7684\u90a3\u6761\u6307\u4ee4\u7684\u5730\u5740\u3002</li> </ul> <p>Machine Mode \u5f02\u5e38\u76f8\u5173\u5bc4\u5b58\u5668:</p> <ul> <li>\u7c7b\u4f3c\u4e8e Supervisor Mode\uff0cMachine Mode \u4e5f\u6709\u76f8\u5bf9\u5e94\u7684\u5bc4\u5b58\u5668\uff0c\u4f46\u7531\u4e8e\u672c\u5b9e\u9a8c\u540c\u5b66\u4e0d\u9700\u8981\u64cd\u4f5c\u8fd9\u4e9b\u5bc4\u5b58\u5668\uff0c\u6545\u4e0d\u5728\u6b64\u4f5c\u4ecb\u7ecd\u3002</li> </ul>"},{"location":"lab1/#_7","title":"\u76f8\u5173\u7279\u6743\u6307\u4ee4","text":"<ul> <li><code>ecall</code>\uff08Environment Call\uff09\uff1a<ul> <li>\u5f53\u6211\u4eec\u5728 S \u6001\u6267\u884c\u8fd9\u6761\u6307\u4ee4\u65f6\uff0c\u4f1a\u89e6\u53d1\u4e00\u4e2a <code>ecall-from-s-mode-exception</code>\uff0c\u4ece\u800c\u8fdb\u5165 M Mode \u4e0b\u7684\u5904\u7406\u6d41\u7a0b\uff08\u5982\u8bbe\u7f6e\u5b9a\u65f6\u5668\u7b49\uff09</li> <li>\u5f53\u6211\u4eec\u5728 U \u6001\u6267\u884c\u8fd9\u6761\u6307\u4ee4\u65f6\uff0c\u4f1a\u89e6\u53d1\u4e00\u4e2a <code>ecall-from-u-mode-exception</code>\uff0c\u4ece\u800c\u8fdb\u5165 S Mode \u4e0b\u7684\u5904\u7406\u6d41\u7a0b\uff08\u5e38\u7528\u6765\u8fdb\u884c\u7cfb\u7edf\u8c03\u7528\uff09\uff1b</li> </ul> </li> <li><code>sret</code> \u7528\u4e8e S \u6001 trap \u8fd4\u56de\uff0c\u901a\u8fc7 <code>sepc</code> \u6765\u8bbe\u7f6e <code>pc</code> \u7684\u503c\uff0c\u8fd4\u56de\u5230\u4e4b\u524d\u7a0b\u5e8f\u7ee7\u7eed\u8fd0\u884c\u3002</li> </ul>"},{"location":"lab1/#_8","title":"\u4e0a\u4e0b\u6587\u5904\u7406","text":"<p>\u7531\u4e8e\u5728\u5904\u7406 trap \u65f6\uff0c\u6709\u53ef\u80fd\u4f1a\u6539\u53d8\u7cfb\u7edf\u7684\u72b6\u6001\u3002\u6240\u4ee5\u5728\u771f\u6b63\u5904\u7406 trap \u4e4b\u524d\uff0c\u6211\u4eec\u6709\u5fc5\u8981\u5bf9\u7cfb\u7edf\u7684\u5f53\u524d\u72b6\u6001\u8fdb\u884c\u4fdd\u5b58\uff0c\u5728\u5904\u7406\u5b8c\u6210\u4e4b\u540e\uff0c\u6211\u4eec\u518d\u5c06\u7cfb\u7edf\u6062\u590d\u81f3\u539f\u5148\u7684\u72b6\u6001\uff0c\u5c31\u53ef\u4ee5\u786e\u4fdd\u4e4b\u524d\u7684\u7a0b\u5e8f\u7ee7\u7eed\u6b63\u5e38\u8fd0\u884c\u3002\u8fd9\u91cc\u7684\u7cfb\u7edf\u72b6\u6001\u901a\u5e38\u662f\u6307\u5bc4\u5b58\u5668\uff0c\u8fd9\u4e9b\u5bc4\u5b58\u5668\u4e5f\u53eb\u505a CPU \u7684\u4e0a\u4e0b\u6587\uff08Context\uff09\u3002</p>"},{"location":"lab1/#trap","title":"trap \u5904\u7406\u7a0b\u5e8f","text":"<p>trap \u5904\u7406\u7a0b\u5e8f\u6839\u636e <code>scause</code> \u7684\u503c\uff0c\u8fdb\u5165\u4e0d\u540c\u7684\u5904\u7406\u903b\u8f91\uff0c\u5728\u672c\u6b21\u8bd5\u9a8c\u4e2d\u6211\u4eec\u9700\u8981\u5173\u5fc3\u7684\u53ea\u6709 Superviosr Timer Interrupt\u3002</p>"},{"location":"lab1/#_9","title":"\u65f6\u949f\u4e2d\u65ad","text":"<p>\u65f6\u949f\u4e2d\u65ad\u9700\u8981 CPU \u786c\u4ef6\u7684\u652f\u6301\u3002CPU \u4ee5\u201c\u65f6\u949f\u5468\u671f\u201d\u4e3a\u5de5\u4f5c\u7684\u57fa\u672c\u65f6\u95f4\u5355\u4f4d\uff0c\u5bf9\u903b\u8f91\u95e8\u7684\u65f6\u5e8f\u7535\u8def\u8fdb\u884c\u540c\u6b65\u3002\u800c\u65f6\u949f\u4e2d\u65ad\u5b9e\u9645\u4e0a\u5c31\u662f\u201c\u6bcf\u9694\u82e5\u5e72\u4e2a\u65f6\u949f\u5468\u671f\u6267\u884c\u4e00\u6b21\u7684\u7a0b\u5e8f\u201d\u3002\u4e0b\u9762\u4ecb\u7ecd\u4e0e\u65f6\u949f\u4e2d\u65ad\u76f8\u5173\u7684\u5bc4\u5b58\u5668\u4ee5\u53ca\u5982\u4f55\u4ea7\u751f\u65f6\u949f\u4e2d\u65ad\u3002</p> <ul> <li><code>mtime</code> \u4e0e <code>mtimecmp</code>\uff08Machine Timer Register\uff09\uff1a<ul> <li><code>mtime</code> \u662f\u4e00\u4e2a\u5b9e\u65f6\u8ba1\u65f6\u5668\uff0c\u7531\u786c\u4ef6\u4ee5\u6052\u5b9a\u7684\u9891\u7387\u81ea\u589e</li> <li><code>mtimecmp</code> \u4e2d\u4fdd\u5b58\u7740\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u53d1\u751f\u7684\u65f6\u95f4\u70b9\uff0c\u5f53 <code>mtime</code> \u7684\u503c\u5927\u4e8e\u6216\u7b49\u4e8e <code>mtimecmp</code> \u7684\u503c\uff0c\u7cfb\u7edf\u5c31\u4f1a\u89e6\u53d1\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad</li> <li>\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u8981\u66f4\u65b0 <code>mtimecmp</code> \u4e2d\u7684\u503c\uff0c\u5c31\u53ef\u4ee5\u8bbe\u7f6e\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u7684\u89e6\u53d1\u70b9\u3002OpenSBI \u5df2\u7ecf\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u65b0 <code>mtimecmp</code> \u7684\u63a5\u53e3 <code>sbi_set_timer</code>\uff08\u89c1 <code>lab1</code> 4.2.3 \u8282\uff09\u3002</li> </ul> </li> <li><code>mcounteren</code>\uff08Counter-Enable Registers\uff09\uff1a<ul> <li>\u7531\u4e8e <code>mtime</code> \u662f\u5c5e\u4e8e M \u6001\u7684\u5bc4\u5b58\u5668\uff0c\u6211\u4eec\u5728 S \u6001\u65e0\u6cd5\u76f4\u63a5\u5bf9\u5176\u8bfb\u5199\uff0c\u5e78\u8fd0\u7684\u662f OpenSBI \u5728 M \u6001\u5df2\u7ecf\u901a\u8fc7\u8bbe\u7f6e <code>mcounteren</code> \u5bc4\u5b58\u5668\u7684 <code>TM</code> \u6bd4\u7279\u4f4d\uff0c\u8ba9\u6211\u4eec\u53ef\u4ee5\u5728 S \u6001\u4e2d\u53ef\u4ee5\u901a\u8fc7 <code>time</code> \u8fd9\u4e2a\u53ea\u8bfb\u5bc4\u5b58\u5668\u8bfb\u53d6\u5230 <code>mtime</code> \u7684\u5f53\u524d\u503c\uff0c\u76f8\u5173\u6c47\u7f16\u6307\u4ee4\u662f <code>rdtime</code>\u3002</li> </ul> </li> </ul> \u4e3a\u4ec0\u4e48\u4e0d\u8981\u76f4\u63a5\u8bfb\u5199 <code>mtimecmp</code>\uff1f <p>\u540c\u5b66\u4eec\u5728\u81ea\u5df1\u5c1d\u8bd5\u6216\u9605\u8bfb\u8d44\u6599\uff08\u5982 RISC-V Bytes: Timer Interrupts \u00b7 Daniel Mangum \u548c RISC-V Assembly Programmer's Manual#Control and Status Registers\uff09\u65f6\u53ef\u80fd\u4f1a\u76f4\u63a5\u8bfb\u5199 <code>mtimecmp</code> \u5bc4\u5b58\u5668\u6765\u8bbe\u7f6e\u65f6\u949f\u4e2d\u65ad\u7684\u65b9\u6cd5\u3002\u7136\u800c\u6807\u51c6\u89c4\u5b9a <code>mtime</code> \u548c <code>mtimecmp</code> \u662f M \u6a21\u5f0f\u4e0b\u8bfb\u5199\u7684\u5185\u5b58\u6620\u5c04\u7684\u5bc4\u5b58\u5668\uff1a</p> <p>Platforms provide a real-time counter, exposed as a memory-mapped machine-mode read-write register, <code>mtime</code>.</p> <p>Platforms provide a 64-bit memory-mapped machine-mode timer compare register (<code>mtimecmp</code>).</p> <p>From The RISC-V Instruction Set Manual: Volume II 3.2.1</p> <p>\u73b0\u5728\u6211\u4eec\u5728 S \u6a21\u5f0f\uff0c\u662f\u65e0\u6cd5\u8bfb\u5199\u8fd9\u4e24\u4e2a\u5bc4\u5b58\u5668\u7684\u3002\u5982\u679c\u53bb\u8bfb\u5199\uff0c\u5c31\u4f1a\u89e6\u53d1 Store/AMO Access Fault \u5f02\u5e38\u3002\u56e0\u6b64\u53ea\u80fd\u901a\u8fc7 ecall \u4ea4\u7ed9 <code>sbi_set_timer</code> \u6765\u8bbe\u7f6e <code>mtimecmp</code> \u7684\u503c\uff0c\u4ece\u800c\u5b9e\u73b0\u65f6\u949f\u4e2d\u65ad\u7684\u8bbe\u7f6e\u3002</p> <code>sbi_set_timer</code> \u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff1f <p>\u4f46\u5982\u679c\u53bb\u8bfb OpenSBI \u6e90\u7801\uff0c\u53c8\u4f1a\u53d1\u73b0\u5b83\u4e5f\u4e0d\u662f\u76f4\u63a5\u5199 <code>mtimecmp</code> \u7684\uff0c\u800c\u662f\u5199\u5165\u4e86 <code>stimecmp</code>\uff1a</p> opensbi/lib/sbi/sbi_timer.c<pre><code>void sbi_timer_event_start(u64 next_event)\n{\n    sbi_pmu_ctr_incr_fw(SBI_PMU_FW_SET_TIMER);\n\n    /**\n    * Update the stimecmp directly if available. This allows\n    * the older software to leverage sstc extension on newer hardware.\n    */\n    if (sbi_hart_has_extension(sbi_scratch_thishart_ptr(), SBI_HART_EXT_SSTC)) {\n# if __riscv_xlen == 32\n        csr_write(CSR_STIMECMP, next_event &amp; 0xFFFFFFFF);\n        csr_write(CSR_STIMECMPH, next_event &gt;&gt; 32);\n# else\n        csr_write(CSR_STIMECMP, next_event);\n# endif\n    } else if (timer_dev &amp;&amp; timer_dev-&gt;timer_event_start) {\n        timer_dev-&gt;timer_event_start(next_event);\n        csr_clear(CSR_MIP, MIP_STIP);\n    }\n    csr_set(CSR_MIE, MIP_MTIP);\n}\n</code></pre> <p>\u8fd9\u662f\u56e0\u4e3a RISC-V SSTC \u6269\u5c55\uff0c\u8be5\u6269\u5c55\u7684\u7b80\u4ecb\u4e5f\u9610\u660e\u4e86 RISC-V \u5404\u4e2a\u6a21\u5f0f\u7684\u65f6\u949f\u4e2d\u65ad\u5904\u7406\u673a\u5236\uff1a</p> <p>The current Privileged arch specification only defines a hardware mechanism for generating machine-mode timer interrupts (based on the mtime and mtimecmp registers). With the resultant requirement that timer services for S-mode/HS-mode (and for VS-mode) have to all be provided by M-mode - via SBI calls from S/HS-mode up to M-mode (or VS-mode calls to HS-mode and then to M-mode).</p> <p>This extension serves to provide supervisor mode with its own CSR-based timer interrupt facility that it can directly manage to provide its own timer service (in the form of having its own stimecmp register) - thus eliminating the large overheads for emulating S/HS-mode timers and timer interrupt generation up in M-mode. Further, this extension adds a similar facility to the Hypervisor extension for VS-mode.</p> <p>\u603b\u7ed3\uff1a\u5728\u5f53\u524d RISC-V \u7279\u6743\u67b6\u6784\u4e2d\uff0cS \u6a21\u5f0f\u548c HS \u6a21\u5f0f\u7684\u5b9a\u65f6\u5668\u670d\u52a1\u9700\u8981\u4f9d\u8d56 M \u6a21\u5f0f\u63d0\u4f9b\uff0c\u8fd9\u5bfc\u81f4\u4e86\u989d\u5916\u7684\u5f00\u9500\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u8be5\u6269\u5c55\u5f15\u5165\u4e86 S \u6a21\u5f0f\u7684\u72ec\u7acb\u5b9a\u65f6\u5668\u4e2d\u65ad\u673a\u5236\uff0c\u5141\u8bb8 S \u6a21\u5f0f\u76f4\u63a5\u7ba1\u7406\u81ea\u5df1\u7684\u5b9a\u65f6\u5668\uff0c\u964d\u4f4e\u4e86\u5bf9 M \u6a21\u5f0f\u7684\u4f9d\u8d56\u3002\u6b64\u5916\uff0cVS \u6a21\u5f0f\u4e5f\u83b7\u5f97\u4e86\u7c7b\u4f3c\u7684\u529f\u80fd\uff0c\u7b80\u5316\u4e86\u5b9a\u65f6\u5668\u7684\u7ba1\u7406\u548c\u4e2d\u65ad\u751f\u6210\u3002</p> <p>\u76ee\u524d\uff0cQEMU \u7684 RISC-V \u6a21\u62df\u5668\u5df2\u7ecf\u652f\u6301\u4e86 SSTC \u6269\u5c55\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 <code>stimecmp</code> \u6765\u8bbe\u7f6e\u65f6\u949f\u4e2d\u65ad\u3002\u4f46\u4e3a\u4e86\u517c\u5bb9\u6027\u8003\u8651\uff0c\u4ecd\u5e94\u5f53\u4f7f\u7528 <code>sbi_set_timer</code> \u6765\u8bbe\u7f6e\u65f6\u949f\u4e2d\u65ad\uff0c\u8fd9\u6837\u5728 SSTC \u6269\u5c55\u4e0d\u88ab\u652f\u6301\u7684\u60c5\u51b5\u4e0b\uff0c\u5c06 fallback \u5230 M \u6a21\u5f0f\u4e0b\u7684\u65f6\u949f\u4e2d\u65ad\u5904\u7406\u673a\u5236\u3002</p>"},{"location":"lab1/#_10","title":"\u5b9e\u9a8c\u6b65\u9aa4","text":""},{"location":"lab1/#_11","title":"\u51c6\u5907\u5de5\u7a0b","text":"<p>\u4ece repo \u540c\u6b65\u5b9e\u9a8c\u4ee3\u7801\u6846\u67b6\u3002\u4e3a\u4e86\u51cf\u5c11\u5927\u5bb6\u7684\u5de5\u4f5c\u91cf\uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u63d0\u4f9b\u4e86\u7cfb\u7edf\u4e8c\u52a9\u6559 45gfg9 \u7f16\u5199\u7684 <code>printk</code> \u6765\u8f93\u51fa\u683c\u5f0f\u5316\u5b57\u7b26\u4e32\u3002</p> <p>printk \u548c\u4e4b\u524d\u5927\u5bb6\u7528\u8fc7\u7684 printf \u7528\u6cd5\u4e00\u81f4\uff0c\u9047\u5230\u4ec0\u4e48\u8f93\u51fa\u4e0a\u7684 bug \u8bf7\u53ca\u65f6\u8054\u7cfb\u52a9\u6559</p> <pre><code>\u251c\u2500\u2500 arch\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 riscv\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 include\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u251c\u2500\u2500 defs.h\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u2514\u2500\u2500 sbi.h\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 kernel\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u251c\u2500\u2500 head.S\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u251c\u2500\u2500 Makefile\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u251c\u2500\u2500 sbi.c\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u2514\u2500\u2500 vmlinux.lds\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 Makefile\n\u251c\u2500\u2500 include\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 printk.h\n\u2502   \u251c\u2500\u2500 stddef.h\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 stdint.h\n\u251c\u2500\u2500 init\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 main.c\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 Makefile\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 test.c\n\u251c\u2500\u2500 lib\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 Makefile\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 printk.c\n\u2514\u2500\u2500 Makefile\n</code></pre> <p>\u5b8c\u6210 RV64 \u5185\u6838\u5f15\u5bfc\uff0c\u9700\u8981\u5b8c\u5584\u4ee5\u4e0b\u6587\u4ef6\uff0c\u5220\u9664 Unimplemented \u7684\u63d0\u793a\u5e76\u5b8c\u6210\u4ee3\u7801\uff1a</p> <ul> <li><code>lib/Makefile</code></li> <li><code>arch/riscv/kernel/head.S</code></li> <li><code>arch/riscv/kernel/sbi.c</code></li> <li><code>arch/riscv/include/defs.h</code></li> </ul> <p>\u5b8c\u6210 RV64 \u65f6\u949f\u4e2d\u65ad\u5904\u7406\uff0c\u9700\u8981\u5b8c\u5584 / \u6dfb\u52a0\u4ee5\u4e0b\u6587\u4ef6\uff1a</p> <ul> <li><code>arch/riscv/kernel/head.S</code></li> <li><code>arch/riscv/kernel/entry.S</code></li> <li><code>arch/riscv/kernel/trap.c</code></li> <li><code>arch/riscv/kernel/clock.c</code></li> <li><code>arch/riscv/include/clock.h</code></li> <li><code>arch/riscv/kernel/sbi.c</code></li> </ul>"},{"location":"lab1/#rv64_2","title":"RV64 \u5185\u6838\u5f15\u5bfc","text":""},{"location":"lab1/#makefile","title":"\u5b8c\u5584 Makefile \u811a\u672c","text":"<p>\u9605\u8bfb\u6587\u6863\u4e2d\u5173\u4e8e GNU Make \u7684\u7ae0\u8282\uff0c\u4ee5\u53ca\u5de5\u7a0b\u6587\u4ef6\u4e2d\u7684 Makefile \u6587\u4ef6\uff0c\u6839\u636e\u6ce8\u91ca\u5b66\u4f1a Makefile \u7684\u4f7f\u7528\u89c4\u5219\u540e\uff0c\u8865\u5145 <code>lib/Makefile</code>\uff0c\u4f7f\u5de5\u7a0b\u5f97\u4ee5\u7f16\u8bd1\u3002</p> <p>\u53ef\u53c2\u8003\u5176\u4ed6\u6587\u4ef6\u5939\u7684 Makefile</p> <p>\u5b8c\u6210\u6b64\u6b65\u540e\u5728\u5de5\u7a0b\u6839\u6587\u4ef6\u5939\u6267\u884c make\uff0c\u53ef\u4ee5\u770b\u5230\u4e0d\u4f1a\u518d\u63d0\u793a Makefile \u7684\u9519\u8bef\uff0c\u800c\u662f C \u6216\u6c47\u7f16\u4ee3\u7801\u4e2d\u7684 <code>#error</code> \u9519\u8bef\u3002</p>"},{"location":"lab1/#heads","title":"\u7f16\u5199 head.S","text":"<p>\u5b66\u4e60 RISC-V \u6c47\u7f16\uff0c\u5e76\u5b8c\u6210 <code>arch/riscv/kernel/head.S</code>\u3002</p> <p>\u6211\u4eec\u9996\u5148\u4e3a\u5373\u5c06\u8fd0\u884c\u7684\u7b2c\u4e00\u4e2a C \u51fd\u6570\u8bbe\u7f6e\u7a0b\u5e8f\u6808\uff08\u6808\u7684\u5927\u5c0f\u53ef\u4ee5\u8bbe\u7f6e\u4e3a 4KiB\uff09\uff0c\u5e76\u5c06\u8be5\u6808\u653e\u7f6e\u5728 <code>.bss.stack</code> \u6bb5\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u53ea\u9700\u8981\u901a\u8fc7\u8df3\u8f6c\u6307\u4ee4\uff0c\u8df3\u8f6c\u81f3 main.c \u4e2d\u7684 <code>start_kernel</code> \u51fd\u6570\u5373\u53ef\u3002</p>"},{"location":"lab1/#sbic","title":"\u8865\u5145 sbi.c","text":"<p>OpenSBI \u5728 M \u6001\uff0c\u4e3a S \u6001\u63d0\u4f9b\u4e86\u591a\u79cd\u63a5\u53e3\uff0c\u6bd4\u5982\u5b57\u7b26\u4e32\u8f93\u5165\u8f93\u51fa\u3002\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5b9e\u73b0\u8c03\u7528 OpenSBI \u63a5\u53e3\u7684\u529f\u80fd\u3002\u7ed9\u51fa\u51fd\u6570\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>struct sbiret {\n    uint64_t error;\n    uint64_t value;\n};\n\nstruct sbiret sbi_ecall(uint64_t eid, uint64_t fid,\n                        uint64_t arg0, uint64_t arg1, uint64_t arg2,\n                        uint64_t arg3, uint64_t arg4, uint64_t arg5);\n</code></pre> <p><code>sbi_ecall</code> \u51fd\u6570\u4e2d\uff0c\u9700\u8981\u5b8c\u6210\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <ol> <li>\u5c06 <code>eid</code>\uff08Extension ID\uff09\u653e\u5165\u5bc4\u5b58\u5668 <code>a7</code> \u4e2d\uff0c<code>fid</code>\uff08Function ID\uff09\u653e\u5165\u5bc4\u5b58\u5668 <code>a6</code> \u4e2d\uff0c\u5c06 <code>arg[0-5]</code> \u653e\u5165\u5bc4\u5b58\u5668 <code>a[0-5]</code> \u4e2d\u3002</li> <li>\u4f7f\u7528 <code>ecall</code> \u6307\u4ee4\u3002<code>ecall</code> \u4e4b\u540e\u7cfb\u7edf\u4f1a\u8fdb\u5165 M \u6a21\u5f0f\uff0c\u4e4b\u540e OpenSBI \u4f1a\u5b8c\u6210\u76f8\u5173\u64cd\u4f5c\u3002</li> <li>OpenSBI \u7684\u8fd4\u56de\u7ed3\u679c\u4f1a\u5b58\u653e\u5728\u5bc4\u5b58\u5668 <code>a0</code>\uff0c<code>a1</code> \u4e2d\uff0c\u5176\u4e2d <code>a0</code> \u4e3a error code\uff0c<code>a1</code> \u4e3a\u8fd4\u56de\u503c\uff0c\u6211\u4eec\u7528 <code>sbiret</code> \u6765\u63a5\u53d7\u8fd9\u4e24\u4e2a\u8fd4\u56de\u503c\u3002</li> </ol> <p>\u540c\u5b66\u4eec\u53ef\u4ee5\u53c2\u7167\u5185\u8054\u6c47\u7f16\u7684\u793a\u4f8b\u4e00\u5b8c\u6210\u8be5\u51fd\u6570\u7684\u7f16\u5199\u3002</p> Example <p>\u7f16\u5199\u6210\u529f\u540e\uff0c\u8c03\u7528 <code>sbi_ecall(0x4442434E, 0x2, 0x30, 0, 0, 0, 0, 0)</code> \u5c06\u4f1a\u8f93\u51fa\u5b57\u7b26 <code>'0'</code>\uff0c\u5176\u4e2d\uff1a</p> <ul> <li><code>0x4442434E</code> \u4ee3\u8868 Debug Console Extension \u7684 Extension ID\uff08<code>DBCN</code>\uff09</li> <li><code>0x2</code> \u4ee3\u8868 Console Write Byte \u7684 FunctionID</li> <li><code>0x30</code> \u4ee3\u8868 '0' \u7684 ascii \u503c</li> <li>\u5176\u4f59\u53c2\u6570\u586b 0</li> </ul> <p>\u8bf7\u5728 <code>arch/riscv/kernel/sbi.c</code> \u4e2d\u8865\u5145 <code>sbi_ecall()</code>\u3002</p> <p>\u4e0b\u9762\u5217\u51fa\u4e86\u4e00\u4e9b\u5728\u540e\u7eed\u7684\u5b9e\u9a8c\u4e2d\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u7684\u529f\u80fd\uff0c\u4e5f\u53ef\u4ee5\u5728 <code>sbi.c</code> \u53ca <code>sbi.h</code> \u4e2d\u4e00\u5e76\u5b9e\u73b0\uff1a</p> Function Name Description Extension ID Function ID <code>sbi_set_timer</code> \u8bbe\u7f6e\u65f6\u949f\u76f8\u5173\u5bc4\u5b58\u5668 0x54494d45 0 <code>sbi_debug_console_write</code> \u5411\u7ec8\u7aef\u5199\u5165\u6570\u636e 0x4442434e 0 <code>sbi_debug_console_read</code> \u4ece\u7ec8\u7aef\u8bfb\u53d6\u6570\u636e 0x4442434e 1 <code>sbi_debug_console_write_byte</code> \u5411\u7ec8\u7aef\u5199\u5165\u5355\u4e2a\u5b57\u7b26 0x4442434e 2 <code>sbi_system_reset</code> \u91cd\u7f6e\u7cfb\u7edf\uff08\u5173\u673a\u6216\u91cd\u542f\uff09 0x53525354 0 <p>\u5173\u4e8e OpenSBI \u7684\u66f4\u591a\u63a5\u53e3\uff0c\u8bf7\u53c2\u8003 RISC-V SBI v2.0 Specification\u3002</p> <p><code>printk</code> \u4f1a\u8c03\u7528 <code>putc</code> \u6765\u8f93\u51fa\u5355\u4e2a\u5b57\u7b26\uff0c\u800c\u5176\u4e2d\u8c03\u7528\u4e86 <code>sbi_debug_console_write_byte</code>\uff0c\u6240\u4ee5\u4e3a\u4e86\u4f7f\u7528 <code>printk</code> \u8bf7\u5728 <code>sbi.c</code> \u4e2d\u6b63\u786e\u5229\u7528 <code>sbi_ecall</code> \u5b9e\u73b0\u8fd9\u4e2a\u51fd\u6570\u3002</p> <p><code>test.c</code> \u4e2d\u5728 kernel \u8fd0\u884c\u7684\u7ed3\u5c3e\u4f1a\u8c03\u7528 <code>sbi_system_reset(0, 0)</code> \u6765 shutdown\uff0c\u6240\u4ee5\u4f60\u4e5f\u9700\u8981\u5728 <code>sbi.c</code> \u4e2d\u6b63\u786e\u5b9e\u73b0 <code>sbi_system_reset</code>\u3002</p> \u5173\u4e8e SBI \u7248\u672c\u95ee\u9898 <p>\u66fe\u7ecf\u7684\u5b9e\u9a8c\u6587\u6863\u4e2d\u4f7f\u7528 <code>sbi_ecall(0x1, 0x0, 0x30, 0, 0, 0, 0, 0)</code> \u8fbe\u5230\u4e86\u548c <code>sbi_ecall(0x4442434E, 0x2, 0x30, 0, 0, 0, 0, 0)</code> \u4e00\u6837\u7684\u6548\u679c\uff0c\u5e76\u4e14 <code>sbi_set_timer</code> \u7b49\u51fd\u6570\u7684 EID \u90fd\u5f88\u5c0f\uff080x00 - 0x0F\uff09\uff0c\u8fd9\u4e9b\u5b9e\u9645\u4e0a\u90fd\u662f v0.1 \u7684\u65e7\u7248 SBI \u89c4\u8303\uff0c\u76ee\u524d\u79f0\u4e3a Legacy Extensions\uff0c\u5df2\u7ecf\u5f03\u7528\u5f88\u4e45\u4e86\u3002\u5177\u4f53\u53ef\u89c1 RISC-V Supervisor Binary Interface Specification \u7684 Chapter 5\u3002\u56e0\u6b64\u63a8\u8350\u5927\u5bb6\u5747\u6309\u7167\u672c\u6587\u6863\u8981\u6c42\u4f7f\u7528\u65b0\u7248 SBI \u89c4\u8303\u3002</p> <p><code>sbi_ecall</code> \u6b63\u786e\u6267\u884c\u4f46\u4ecd\u6ca1\u6709\u8f93\u51fa\u7684\u95ee\u9898\u5904\u7406</p> <p>\u5982\u679c\u4f60\u7684 <code>sbi_ecall</code> \u51fd\u6570\u6b63\u786e\u6267\u884c\u4e86\uff0c\u4f46\u662f\u6ca1\u6709\u4efb\u4f55\u6548\u679c\uff0c\u53ef\u80fd\u662f\u4f7f\u7528\u7684 OpenSBI \u7248\u672c\u8fc7\u4f4e\u3002\u5982\u679c\u4f60\u8fd8\u5728\u4f7f\u7528\u4ece Ubuntu 22.04 apt \u76f4\u63a5\u5b89\u88c5\u7684 qemu \u7684\u8bdd\u5f88\u53ef\u80fd\u662f\u8fd9\u4e2a\u95ee\u9898\u3002OpenSBI v1.3 \u53ca\u4ee5\u4e0a\u624d\u5f00\u59cb\u652f\u6301\u8fd9\u4e9b SBI \u8c03\u7528\uff0c\u6240\u4ee5\u4f60\u53ef\u4ee5\u5728 <code>make run</code> \u540e\u89c2\u5bdf OpenSBI banner \u524d\u7684\u7248\u672c\u53f7\u6765\u81ea\u67e5\uff0c\u5982\u679c\u5c0f\u4e8e v1.3 \u7684\u8bdd\uff0c\u90a3\u4e48\u4f60\u5c31\u9700\u8981\u66f4\u65b0 qemu \u6216\u8005 opensbi \u4e86\u3002</p> <p>\u6700\u597d\u7684\u89e3\u51b3\u529e\u6cd5\u662f\u6839\u636e\u672c\u9875\u5b9e\u9a8c\u73af\u5883\u90e8\u5206\u624b\u52a8\u7f16\u8bd1\u6700\u65b0\u7248 qemu\uff0c\u65b0\u7248 qemu \u7684 default bios \u5c31\u662f\u8f83\u65b0\u7248\u672c\u7684 OpenSBI\uff08\u76ee\u524d\u662f v1.5.1\uff09\uff0c\u800c\u4e14\u66f4\u65b0 qemu \u4e5f\u4f1a\u6d88\u9664\u6389\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7684\u5f88\u591a\u6f5c\u5728 bug\u3002</p> <p>\u5982\u679c\u4f60\u5b9e\u5728\u4e0d\u60f3\u66f4\u65b0 qemu\uff0c\u4e5f\u53ef\u4ee5\u5c1d\u8bd5\u66f4\u65b0 OpenSBI\uff0c\u5373\u4e0d\u4f7f\u7528 <code>-bios default</code>\uff0c\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a v1.5 \u7684 OpenSBI \u5728 <code>src/lab1/fw_jump.bin</code>\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u5c06 <code>-bios default</code> \u66ff\u6362\u4e3a <code>-bios fw_jump.bin</code> \u6765\u4f7f\u7528\u5b83\u3002\u4f60\u4e5f\u53ef\u4ee5\u901a\u8fc7 OpenSBI README \u7684\u6307\u5bfc\u6765\u81ea\u884c\u7f16\u8bd1\u51fa\u8fd9\u4e2a <code>fw_jump.bin</code>\u3002</p>"},{"location":"lab1/#defs","title":"\u4fee\u6539 defs","text":"<p>\u5b66\u4e60\u4e86\u89e3\u4e86\u5185\u8054\u6c47\u7f16\u7684\u76f8\u5173\u77e5\u8bc6\u540e\uff0c\u8865\u5145 <code>arch/riscv/include/defs.h</code> \u4e2d\u7684\u4ee3\u7801\uff0c\u5b8c\u6210 <code>read_csr</code> \u7684\u5b8f\u5b9a\u4e49\u3002</p> <p>\u5b8c\u6210\u4ee5\u4e0a\u5185\u5bb9\u540e\u518d\u6b21\u6267\u884c <code>make</code>\uff0c\u53ef\u4ee5\u770b\u5230\u5728\u6839\u76ee\u5f55\u4e0b\u6210\u529f\u751f\u6210\u4e86 <code>vmlinux</code>\u3002</p> <p>\u8fd0\u884c <code>make run</code> \u5373\u53ef\u6267\u884c\uff0c\u68c0\u6d4b\u4f60\u7684\u7a0b\u5e8f\u662f\u5426\u6b63\u786e\u5730\u6253\u5370\u51fa\u4e86\u6b22\u8fce\u4fe1\u606f <code>2024 ZJU Operating System</code> \u5e76\u6b63\u5e38\u9000\u51fa\u3002</p>"},{"location":"lab1/#rv64_3","title":"RV64 \u65f6\u949f\u4e2d\u65ad\u5904\u7406","text":"<ul> <li> <p>\u51c6\u5907\u5de5\u4f5c\uff0c\u5148\u4fee\u6539 <code>vmlinux.lds</code> \u4ee5\u53ca <code>head.S</code> (diff) arch/riscv/kernel/vmlinux.lds<pre><code>      .text : ALIGN(0x1000) {\n          _stext = .;\n\n+         *(.text.init)         &lt;- \u6dfb\u52a0 .text.init \u6bb5\n          *(.text.entry)        &lt;- \u540e\u7eed\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u5728 .text.entry \u6bb5\n          *(.text .text.*)\n</code></pre></p> (diff) arch/riscv/kernel/head.S<pre><code>      .extern start_kernel\n!     .section .text.init       &lt;- .text.entry \u6539\u4e3a .text.init\n      .globl _start\n  _start:\n</code></pre> </li> </ul>"},{"location":"lab1/#trap_1","title":"\u5f00\u542f trap \u5904\u7406","text":"<p>\u5728\u8fd0\u884c <code>start_kernel</code> \u4e4b\u524d\uff0c\u6211\u4eec\u8981\u5bf9\u4e0a\u9762\u63d0\u5230\u7684 CSR \u8fdb\u884c\u521d\u59cb\u5316\uff0c\u521d\u59cb\u5316\u5305\u62ec\u4ee5\u4e0b\u51e0\u4e2a\u6b65\u9aa4\uff1a</p> <ol> <li>\u8bbe\u7f6e <code>stvec</code><ul> <li>\u5c06 <code>_traps</code>\uff08<code>_traps</code> \u5728 4.3.2 \u4e2d\u5b9e\u73b0\uff09\u6240\u8868\u793a\u7684\u5730\u5740\u5199\u5165 <code>stvec</code></li> <li>\u8fd9\u91cc\u6211\u4eec\u91c7\u7528 Direct \u6a21\u5f0f\uff0c\u800c <code>_traps</code> \u5219\u662f trap \u5904\u7406\u5165\u53e3\u51fd\u6570\u7684\u57fa\u5730\u5740\u3002</li> </ul> <p>\u53ef\u4ee5\u4f7f\u7528 <code>la</code> \u6307\u4ee4\u4ee5\u53ca\u521a\u624d\u5199\u8fc7\u7684 CSR \u8bfb\u5199\u6307\u4ee4</p> </li> <li>\u5f00\u542f\u65f6\u949f\u4e2d\u65ad\uff0c\u5c06 <code>sie[STIE]</code> \u7f6e 1</li> <li> <p>\u8bbe\u7f6e\u7b2c\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\uff0c\u53c2\u8003 <code>clock_set_next_event()</code>\uff08<code>clock_set_next_event()</code> \u5728 4.3.4 \u4e2d\u4ecb\u7ecd\uff09\u4e2d\u7684\u903b\u8f91\u7528\u6c47\u7f16\u5b9e\u73b0</p> <p>\u53ef\u901a\u8fc7 <code>rdtime</code> \u6307\u4ee4\u83b7\u53d6\u65f6\u95f4\uff0c<code>sbi_set_timer</code> \u8bbe\u7f6e\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad</p> </li> <li> <p>\u5f00\u542f S \u6001\u4e0b\u7684\u4e2d\u65ad\u54cd\u5e94\uff0c\u5c06 <code>sstatus[SIE]</code> \u7f6e 1</p> </li> </ol> <p>\u6309\u7167\u4e0b\u65b9\u6a21\u7248\u4fee\u6539 <code>arch/riscv/kernel/head.S</code>\uff0c\u5e76\u8865\u5168 <code>_start</code> \u4e2d\u7684\u903b\u8f91:</p> arch/riscv/kernel/head.S<pre><code>    .extern start_kernel\n    .section .text.init\n    .globl _start\n_start:\n    # (previous) initialize stack\n\n    # set stvec = _traps\n    # set sie[STIE] = 1\n    # set first time interrupt\n    # set sstatus[SIE] = 1\n\n    # (previous) jump to start_kernel\n    ...\n</code></pre> <p>Debug \u63d0\u793a</p> <p>\u53ef\u4ee5\u5148\u4e0d\u5b9e\u73b0 <code>stvec</code> \u548c first time interrupt\uff0c\u5148\u5173\u6ce8 <code>sie</code> \u548c <code>sstatus</code> \u662f\u5426\u8bbe\u7f6e\u6b63\u786e\u3002</p> <p>\u5982\u679c\u5728\u8fd9\u90e8\u5206\u8fc7\u7a0b\u4e2d\u8c03\u7528\u4e86\u989d\u5916\u7684\u51fd\u6570\uff0c\u4f8b\u5982 <code>sbi_set_timer</code>\uff0c\u5219\u4f60\u9700\u8981\u4fdd\u8bc1\u5728\u8fd9\u4e4b\u524d\u5df2\u7ecf\u8bbe\u7f6e\u597d\u4e86 <code>sp</code>\uff0c\u5426\u5219\u6d89\u53ca\u5230\u51fd\u6570\u8c03\u7528\u5219\u4f1a\u76f4\u63a5\u51fa\u73b0\u5f02\u5e38\u3002</p>"},{"location":"lab1/#_12","title":"\u5b9e\u73b0\u4e0a\u4e0b\u6587\u5207\u6362","text":"<p>\u6211\u4eec\u8981\u4f7f\u7528\u6c47\u7f16\u5b9e\u73b0\u4e0a\u4e0b\u6587\u5207\u6362\u673a\u5236\uff0c\u5305\u542b\u4ee5\u4e0b\u51e0\u4e2a\u6b65\u9aa4\uff1a</p> <ol> <li>\u5728 <code>arch/riscv/kernel/</code> \u76ee\u5f55\u4e0b\u6dfb\u52a0 <code>entry.S</code> \u6587\u4ef6</li> <li>\u4fdd\u5b58 CPU \u7684\u5bc4\u5b58\u5668\uff08\u4e0a\u4e0b\u6587\uff09\u5230\u5185\u5b58\u4e2d\uff08\u6808\u4e0a\uff09</li> <li>\u5c06 <code>scause</code> \u548c <code>sepc</code> \u4e2d\u7684\u503c\u4f20\u5165 trap \u5904\u7406\u51fd\u6570 <code>trap_handler</code>\uff08<code>trap_handler</code> \u5728 4.3.3 \u4e2d\u4ecb\u7ecd\uff09\uff0c\u6211\u4eec\u5c06\u4f1a\u5728 <code>trap_handler</code> \u4e2d\u5b9e\u73b0\u5bf9 trap \u7684\u5904\u7406</li> <li>\u5728\u5b8c\u6210\u5bf9 trap \u7684\u5904\u7406\u4e4b\u540e\uff0c\u6211\u4eec\u4ece\u5185\u5b58\u4e2d\uff08\u6808\u4e0a\uff09\u6062\u590d CPU \u7684\u5bc4\u5b58\u5668\uff08\u4e0a\u4e0b\u6587\uff09</li> <li>\u4ece trap \u4e2d\u8fd4\u56de</li> </ol> <p>\u6309\u7167\u4e0b\u65b9\u6a21\u7248\u4fee\u6539 <code>arch/riscv/kernel/entry.S</code>\uff0c\u5e76\u8865\u5168 <code>_traps</code> \u4e2d\u7684\u903b\u8f91\uff1a</p> arch/riscv/kernel/entry.S<pre><code>    .extern trap_handler\n    .section .text.entry\n    .align 2\n    .globl _traps \n_traps:\n    #error Unimplemented\n\n    # 1. save 32 registers and sepc to stack\n    # 2. call trap_handler\n    # 3. restore sepc and 32 registers (x2(sp) should be restore last) from stack\n    # 4. return from trap\n</code></pre> <p>Debug \u63d0\u793a</p> <p>\u53ef\u4ee5\u5148\u4e0d\u5b9e\u73b0 call trap_handler\uff0c\u5148\u5b9e\u73b0\u4e0a\u4e0b\u6587\u5207\u6362\u903b\u8f91\u3002\u901a\u8fc7 gdb \u8ddf\u8e2a\u5404\u4e2a\u5bc4\u5b58\u5668\uff0c\u786e\u4fdd\u4e0a\u4e0b\u6587\u7684 save \u4e0e restore \u6b63\u786e\u5b9e\u73b0\u5e76\u6b63\u786e\u8fd4\u56de\u3002</p>"},{"location":"lab1/#trap_2","title":"\u5b9e\u73b0 trap \u5904\u7406\u51fd\u6570","text":"<ol> <li>\u5728 <code>arch/riscv/kernel/</code> \u76ee\u5f55\u4e0b\u6dfb\u52a0 <code>trap.c</code> \u6587\u4ef6</li> <li>\u5728 <code>trap.c</code> \u4e2d\u5b9e\u73b0 trap \u5904\u7406\u51fd\u6570 <code>trap_handler()</code>\uff0c\u5176\u63a5\u6536\u7684\u4e24\u4e2a\u53c2\u6570\u5206\u522b\u662f <code>scause</code> \u548c <code>sepc</code> \u4e24\u4e2a\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u3002</li> </ol> arch/riscv/kernel/trap.c<pre><code>#include \"stdint.h\"\n\nvoid trap_handler(uint64_t scause, uint64_t sepc) {\n    // \u901a\u8fc7 `scause` \u5224\u65ad trap \u7c7b\u578b\n    // \u5982\u679c\u662f interrupt \u5224\u65ad\u662f\u5426\u662f timer interrupt\n    // \u5982\u679c\u662f timer interrupt \u5219\u6253\u5370\u8f93\u51fa\u76f8\u5173\u4fe1\u606f\uff0c\u5e76\u901a\u8fc7 `clock_set_next_event()` \u8bbe\u7f6e\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\n    // `clock_set_next_event()` \u89c1 4.3.4 \u8282\n    // \u5176\u4ed6 interrupt / exception \u53ef\u4ee5\u76f4\u63a5\u5ffd\u7565\uff0c\u63a8\u8350\u6253\u5370\u51fa\u6765\u4f9b\u4ee5\u540e\u8c03\u8bd5\n\n    #error Unimplemented\n}\n</code></pre>"},{"location":"lab1/#_13","title":"\u5b9e\u73b0\u65f6\u949f\u4e2d\u65ad\u76f8\u5173\u51fd\u6570","text":"<ol> <li>\u5728 <code>arch/riscv/kernel/</code> \u76ee\u5f55\u4e0b\u6dfb\u52a0 <code>clock.c</code> \u6587\u4ef6</li> <li>\u5728 <code>clock.c</code> \u4e2d\u5b9e\u73b0 <code>get_cycles()</code><ul> <li>\u4f7f\u7528 <code>rdtime</code> \u6c47\u7f16\u6307\u4ee4\u83b7\u5f97\u5f53\u524d <code>time</code> \u5bc4\u5b58\u5668\u4e2d\u7684\u503c</li> </ul> </li> <li>\u5728 <code>clock.c</code> \u4e2d\u5b9e\u73b0 <code>clock_set_next_event()</code><ul> <li>\u8c03\u7528 <code>sbi_set_timer</code>\uff0c\u8bbe\u7f6e\u4e0b\u4e00\u4e2a\u65f6\u949f\u4e2d\u65ad\u4e8b\u4ef6</li> </ul> </li> </ol> arch/riscv/kernel/clock.c<pre><code>#include \"stdint.h\"\n\n// QEMU \u4e2d\u65f6\u949f\u7684\u9891\u7387\u662f 10MHz\uff0c\u4e5f\u5c31\u662f 1 \u79d2\u949f\u76f8\u5f53\u4e8e 10000000 \u4e2a\u65f6\u949f\u5468\u671f\nuint64_t TIMECLOCK = 10000000;\n\nuint64_t get_cycles() {\n    // \u7f16\u5199\u5185\u8054\u6c47\u7f16\uff0c\u4f7f\u7528 rdtime \u83b7\u53d6 time \u5bc4\u5b58\u5668\u4e2d\uff08\u4e5f\u5c31\u662f mtime \u5bc4\u5b58\u5668\uff09\u7684\u503c\u5e76\u8fd4\u56de\n    #error Unimplemented\n}\n\nvoid clock_set_next_event() {\n    // \u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u7684\u65f6\u95f4\u70b9\n    uint64_t next = get_cycles() + TIMECLOCK;\n\n    // \u4f7f\u7528 sbi_set_timer \u6765\u5b8c\u6210\u5bf9\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u7684\u8bbe\u7f6e\n    #error Unimplemented\n} \n</code></pre>"},{"location":"lab1/#test","title":"\u4fee\u6539 test \u51fd\u6570","text":"<p>\u4e3a\u4e86\u8ba9 kernel \u6301\u7eed\u8fd0\u884c\uff0c\u5e76\u4f7f\u4e2d\u65ad\u66f4\u5bb9\u6613\u89c2\u5bdf\uff0c\u5c06 <code>test.c</code> \u4e2d\u7684 <code>test()</code> \u51fd\u6570\u4fee\u6539\u4e3a\u5982\u4e0b\u5185\u5bb9\uff1a</p> init/test.c<pre><code>#include \"printk.h\"\n\nvoid test() {\n    int i = 0;\n    while (1) {\n        if ((++i) % 100000000 == 0) {\n            printk(\"kernel is running!\\n\");\n            i = 0;\n        }\n    }\n}\n</code></pre>"},{"location":"lab1/#_14","title":"\u7f16\u8bd1\u53ca\u6d4b\u8bd5","text":"<p>\u7531\u4e8e\u52a0\u5165\u4e86\u4e00\u4e9b\u65b0\u7684 <code>.c</code> \u6587\u4ef6\uff0c\u53ef\u80fd\u9700\u8981\u4fee\u6539\u4e00\u4e9b Makefile \u6587\u4ef6\uff0c\u8bf7\u540c\u5b66\u81ea\u5df1\u5c1d\u8bd5\u4fee\u6539\uff0c\u4f7f\u9879\u76ee\u53ef\u4ee5\u7f16\u8bd1\u5e76\u8fd0\u884c\u3002</p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u6b63\u786e\u5b9e\u73b0\u7684\u8f93\u51fa\u6837\u4f8b\u3002\uff08\u4ec5\u4f9b\u53c2\u8003\uff0c\u5b9e\u9645\u60c5\u51b5\u53ef\u80fd\u7565\u6709\u4e0d\u540c\uff0c\u65f6\u949f\u4e2d\u65ad\u8f93\u51fa\u4f4d\u7f6e\u4e0d\u4e00\u6837\u65e0\u6240\u8c13\uff0c\u4e5f\u53ef\u4ee5\u9002\u5f53\u8c03\u6574\u4e0a\u9762 <code>test()</code> \u51fd\u6570\u4e2d\u7684\u8f93\u51fa\u6761\u4ef6\uff09\uff1a</p> <pre><code>2024 ZJU Operating System\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\n</code></pre>"},{"location":"lab1/#aarch64","title":"\u5176\u4ed6\u67b6\u6784\u7684\u4ea4\u53c9\u7f16\u8bd1\u2014\u2014\u4ee5 Aarch64 \u4e3a\u4f8b","text":""},{"location":"lab1/#_15","title":"\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u7684\u5b89\u88c5","text":"<p>\u90a3\u4e48\u5982\u4f55\u5b89\u88c5\u4e0d\u540c\u67b6\u6784\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u5462\uff1f\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u7528 Ubuntu \u81ea\u5e26\u7684\u8f6f\u4ef6\u5305\u7ba1\u7406\u5668 <code>apt</code>\uff0c\u5148\u627e\u5230\u6709\u4ec0\u4e48\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u53ef\u4ee5\u88c5\uff1a</p> <pre><code># \u641c\u7d22\u5305\u542b aarch64 \u7684\u8f6f\u4ef6\u5305\uff0c\u4e00\u822c\u662f\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\napt-cache search aarch64\n...\n# \u641c\u7d22\u7ed3\u679c\u4e2d\u5982\u679c\u6709 gcc-xxx-linux-gnu\uff0c\u4e00\u822c\u9700\u6c42\u4e0b\u88c5\u5b83\u5c31\u884c\u4e86\uff08\u5177\u4f53\u60c5\u51b5\u5177\u4f53\u5206\u6790\u54c8\uff09\nsudo apt install gcc-aarch64-linux-gnu\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u6709 aarch64 \u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u4e86\uff0c\u5f00\u59cb\u7f16\u8bd1\u5427\uff01</p>"},{"location":"lab1/#_16","title":"\u600e\u4e48\u83b7\u5f97\u7f16\u8bd1\u8fc7\u7a0b\u7684\u4e2d\u95f4\u4ea7\u7269","text":"<p>\u6ce8\u610f\u8fd9\u91cc\u8bf4\u7684\u201c\u7f16\u8bd1\u8fc7\u7a0b\u201d\u5305\u62ec\u9884\u5904\u7406\u3001\u7f16\u8bd1\u3001\u6c47\u7f16\u3001\u94fe\u63a5</p> <p>\u5bf9\u4e8e Linux kernel\uff0c\u7f16\u8bd1\u547d\u4ee4\u548c\u9009\u9879\u5728\u4e0d\u540c\u67b6\u6784\u4e4b\u95f4\u90fd\u5927\u540c\u5c0f\u5f02\uff0c\u4e00\u822c\u9075\u5faa\u4ee5\u4e0b\u5f62\u5f0f\uff08\u7c7b\u6bd4 lab0 \u505a\u8fc7\u7684 riscv64 \u5373\u53ef\uff09</p> <pre><code>make ARCH=xxx CROSS_COMPILE=some-certain-arch- &lt;options&gt; &lt;files&gt;\n</code></pre> <p>\u6bd4\u5982\uff0c\u60f3\u83b7\u5f97 kernel \u4e2d <code>xxx.c</code> \u7684\u9884\u5904\u7406\u4ea7\u7269\uff08\u56de\u5fc6\u4e00\u4e0b\u9884\u5904\u7406\u505a\u4e86\u4ec0\u4e48\uff09<code>xxx.i</code>\uff0c\u6211\u4eec\u53ef\u4ee5\uff1a</p> <pre><code># \u5148 config\uff08\u6839\u636e\u5b9e\u9645\u9700\u6c42\uff0c\u8fd9\u91cc\u4e0d\u4e00\u5b9a\u662f defconfig\uff0c\u53ef\u9009\u7684 config \u53ef\u4ee5\u5728 `arch/&lt;ARCH&gt;/configs` \u4e0b\u627e\u5230\uff09\nmake ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig\n\n# \u7136\u540e\u6307\u5b9a\u8981\u751f\u6210\u7684\u6587\u4ef6\nmake ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- &lt;path/to/file(no suffix)&gt;.i\n</code></pre> <p>\u8bfe\u4ef6\u91cc\u4e5f\u7ed9\u51fa\u4e86 <code>make</code> \u5de5\u5177\u3002</p>"},{"location":"lab1/#_17","title":"\u601d\u8003\u9898","text":"<ol> <li>\u8bf7\u603b\u7ed3\u4e00\u4e0b RISC-V \u7684 calling convention\uff0c\u5e76\u89e3\u91ca Caller / Callee Saved Register \u6709\u4ec0\u4e48\u533a\u522b\uff1f</li> <li>\u7f16\u8bd1\u4e4b\u540e\uff0c\u901a\u8fc7 System.map \u67e5\u770b vmlinux.lds \u4e2d\u81ea\u5b9a\u4e49\u7b26\u53f7\u7684\u503c\u5e76\u622a\u56fe\u3002</li> <li>\u7528 <code>csr_read</code> \u5b8f\u8bfb\u53d6 <code>sstatus</code> \u5bc4\u5b58\u5668\u7684\u503c\uff0c\u5bf9\u7167 RISC-V \u624b\u518c\u89e3\u91ca\u5176\u542b\u4e49\u5e76\u622a\u56fe\u3002</li> <li>\u7528 <code>csr_write</code> \u5b8f\u5411 <code>sscratch</code> \u5bc4\u5b58\u5668\u5199\u5165\u6570\u636e\uff0c\u5e76\u9a8c\u8bc1\u662f\u5426\u5199\u5165\u6210\u529f\u5e76\u622a\u56fe\u3002</li> <li>\u8be6\u7ec6\u63cf\u8ff0\u4f60\u53ef\u4ee5\u901a\u8fc7\u4ec0\u4e48\u6b65\u9aa4\u6765\u5f97\u5230 <code>arch/arm64/kernel/sys.i</code>\uff0c\u7ed9\u51fa\u8fc7\u7a0b\u4ee5\u53ca\u622a\u56fe\u3002</li> <li>\u5bfb\u627e Linux v6.0 \u4e2d ARM32 RV32 RV64 x86_64 \u67b6\u6784\u7684\u7cfb\u7edf\u8c03\u7528\u8868\uff1b<ul> <li>\u8bf7\u5217\u51fa\u6e90\u4ee3\u7801\u6587\u4ef6\uff0c\u5c55\u793a\u5b8c\u6574\u7684\u7cfb\u7edf\u8c03\u7528\u8868\uff08\u5b8f\u5c55\u5f00\u540e\uff09\uff0c\u6bcf\u4e00\u6b65\u90fd\u9700\u8981\u622a\u56fe\u3002</li> </ul> </li> <li>\u9610\u8ff0\u4ec0\u4e48\u662f ELF \u6587\u4ef6\uff1f\u5c1d\u8bd5\u4f7f\u7528 readelf \u548c objdump \u6765\u67e5\u770b ELF \u6587\u4ef6\uff0c\u5e76\u7ed9\u51fa\u89e3\u91ca\u548c\u622a\u56fe\u3002<ul> <li>\u8fd0\u884c\u4e00\u4e2a ELF \u6587\u4ef6\uff0c\u7136\u540e\u901a\u8fc7 <code>cat /proc/PID/maps</code> \u6765\u7ed9\u51fa\u5176\u5185\u5b58\u5e03\u5c40\u5e76\u622a\u56fe\u3002</li> </ul> </li> <li>\u5728\u6211\u4eec\u4f7f\u7528 make run \u65f6\uff0cOpenSBI \u4f1a\u4ea7\u751f\u5982\u4e0b\u8f93\u51fa\uff1a     <pre><code>    OpenSBI v1.5.1\n     ____                    _____ ____ _____\n    / __ \\                  / ____|  _ \\_   _|\n   | |  | |_ __   ___ _ __ | (___ | |_) || |\n   | |  | | '_ \\ / _ \\ '_ \\ \\___ \\|  _ &lt; | |\n   | |__| | |_) |  __/ | | |____) | |_) || |_\n    \\____/| .__/ \\___|_| |_|_____/|____/_____|\n          | |\n          |_|\n\n    ......\n\n    Boot HART MIDELEG         : 0x0000000000000222\n    Boot HART MEDELEG         : 0x000000000000b109\n\n    ......\n</code></pre><ul> <li>\u901a\u8fc7\u67e5\u770b RISC-V Privileged Spec \u4e2d\u7684 <code>medeleg</code> \u548c <code>mideleg</code> \u90e8\u5206\uff0c\u89e3\u91ca\u4e0a\u9762 <code>MIDELEG</code> \u548c <code>MEDELEG</code> \u503c\u7684\u542b\u4e49\u3002</li> </ul> </li> </ol>"},{"location":"lab1/#_18","title":"\u5b9e\u9a8c\u4efb\u52a1\u4e0e\u8981\u6c42","text":"<ul> <li>\u8bf7\u5404\u4f4d\u540c\u5b66\u72ec\u7acb\u5b8c\u6210\u4f5c\u4e1a\uff0c\u4efb\u4f55\u6284\u88ad\u884c\u4e3a\u90fd\u5c06\u4f7f\u672c\u6b21\u4f5c\u4e1a\u5224\u4e3a 0 \u5206\u3002</li> <li>\u5728\u5b66\u5728\u6d59\u5927\u4e2d\u63d0\u4ea4\uff1a<ul> <li>\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u7684\u538b\u7f29\u5305\uff08\u63d0\u4ea4\u4e4b\u524d\u8bf7\u4f7f\u7528 <code>make clean</code> \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\uff09</li> <li>pdf \u683c\u5f0f\u7684\u5b9e\u9a8c\u62a5\u544a\uff1a<ul> <li>\u8bb0\u5f55\u5b9e\u9a8c\u8fc7\u7a0b\u5e76\u622a\u56fe\uff084.1-4.3\uff09\uff0c\u5e76\u5bf9\u6bcf\u4e00\u6b65\u7684\u547d\u4ee4\u4ee5\u53ca\u7ed3\u679c\u8fdb\u884c\u5fc5\u8981\u7684\u89e3\u91ca\uff1b</li> <li>\u8bb0\u5f55\u9047\u5230\u7684\u95ee\u9898\u548c\u5fc3\u5f97\u4f53\u4f1a\uff1b</li> <li>\u5b8c\u6210\u601d\u8003\u9898\u3002</li> </ul> </li> </ul> </li> </ul> <p>\u5173\u4e8e\u5b9e\u9a8c\u62a5\u544a\u5185\u5bb9\u8981\u6c42\uff0c\u53ef\u89c1\uff1a\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54 - \u5b9e\u9a8c\u63d0\u4ea4\u8981\u6c42</p>"},{"location":"lab2/","title":"Lab 2: RV64 \u5185\u6838\u7ebf\u7a0b\u8c03\u5ea6","text":""},{"location":"lab2/#_1","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<ul> <li>\u4e86\u89e3\u7ebf\u7a0b\u6982\u5ff5\uff0c\u5e76\u5b66\u4e60\u7ebf\u7a0b\u76f8\u5173\u7ed3\u6784\u4f53\uff0c\u5e76\u5b9e\u73b0\u7ebf\u7a0b\u7684\u521d\u59cb\u5316\u529f\u80fd</li> <li>\u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u65f6\u949f\u4e2d\u65ad\u6765\u5b9e\u73b0\u7ebf\u7a0b\u7684\u8c03\u5ea6</li> <li>\u4e86\u89e3\u7ebf\u7a0b\u5207\u6362\u539f\u7406\uff0c\u5e76\u5b9e\u73b0\u7ebf\u7a0b\u7684\u5207\u6362</li> <li>\u638c\u63e1\u7b80\u5355\u7684\u7ebf\u7a0b\u8c03\u5ea6\u7b97\u6cd5\uff0c\u5e76\u5b8c\u6210\u7b80\u5355\u8c03\u5ea6\u7b97\u6cd5\u7684\u5b9e\u73b0</li> </ul>"},{"location":"lab2/#_2","title":"\u5b9e\u9a8c\u73af\u5883","text":"<ul> <li>Environment in previous labs</li> </ul>"},{"location":"lab2/#_3","title":"\u80cc\u666f\u77e5\u8bc6","text":""},{"location":"lab2/#_4","title":"\u524d\u8a00","text":"<p>\u5728 lab1 \u4e2d\uff0c\u6211\u4eec\u5229\u7528 trap \u8d4b\u4e88\u4e86 OS \u4e0e\u8f6f\u4ef6\uff0c\u786c\u4ef6\u7684\u4ea4\u4e92\u80fd\u529b\u3002\u4f46\u662f\u76ee\u524d\u6211\u4eec\u7684 OS \u8fd8\u4e0d\u5177\u5907\u591a\u8fdb\u7a0b\u8c03\u5ea6\u4ee5\u53ca\u5e76\u53d1\u6267\u884c\u7684\u80fd\u529b\u3002\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5229\u7528\u65f6\u949f\u4e2d\u65ad\uff0c\u6765\u5b9e\u73b0\u591a\u8fdb\u7a0b\u7684\u8c03\u5ea6\u4ee5\u4f7f\u5f97\u591a\u4e2a\u8fdb\u7a0b/\u7ebf\u7a0b\u5e76\u53d1\u6267\u884c\u3002</p>"},{"location":"lab2/#_5","title":"\u8fdb\u7a0b\u4e0e\u7ebf\u7a0b","text":"<p>\u6e90\u4ee3\u7801\u7ecf\u7f16\u8bd1\u5668\u4e00\u7cfb\u5217\u5904\u7406\uff08\u7f16\u8bd1\u3001\u94fe\u63a5\u3001\u4f18\u5316\u7b49\uff09\u540e\u5f97\u5230\u7684\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a\u7a0b\u5e8f\uff08Program\uff09\u3002\u800c\u901a\u4fd7\u5730\u8bf4\uff0c\u8fdb\u7a0b\u5c31\u662f\u6b63\u5728\u8fd0\u884c\u5e76\u4f7f\u7528\u8ba1\u7b97\u673a\u8d44\u6e90\u7684\u7a0b\u5e8f\u3002\u8fdb\u7a0b\u4e0e\u7a0b\u5e8f\u7684\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\uff0c\u8fdb\u7a0b\u662f\u4e00\u4e2a\u52a8\u6001\u7684\u6982\u5ff5\uff0c\u5176\u4e0d\u4ec5\u9700\u8981\u5c06\u5176\u8fd0\u884c\u7684\u7a0b\u5e8f\u7684\u4ee3\u7801/\u6570\u636e\u7b49\u52a0\u8f7d\u5230\u5185\u5b58\u7a7a\u95f4\u4e2d\uff0c\u8fd8\u9700\u8981\u62e5\u6709\u81ea\u5df1\u7684\u8fd0\u884c\u6808\u3002\u540c\u65f6\u4e00\u4e2a\u8fdb\u7a0b\u53ef\u4ee5\u5bf9\u5e94\u4e00\u4e2a\u6216\u591a\u4e2a\u7ebf\u7a0b\uff0c\u7ebf\u7a0b\u4e4b\u95f4\u5f80\u5f80\u5177\u6709\u76f8\u540c\u7684\u4ee3\u7801\uff0c\u5171\u4eab\u4e00\u5757\u5185\u5b58\uff0c\u4f46\u662f\u5374\u6709\u4e0d\u540c\u7684 CPU \u6267\u884c\u72b6\u6001\u3002</p> <p>\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u4e3a\u4e86\u7b80\u5355\u8d77\u89c1\uff0c\u6211\u4eec\u91c7\u7528 single-threaded process \u6a21\u578b\uff0c\u5373\u4e00\u4e2a\u8fdb\u7a0b\u5bf9\u5e94\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u8fdb\u7a0b\u4e0e\u7ebf\u7a0b\u4e0d\u505a\u660e\u663e\u533a\u5206</p>"},{"location":"lab2/#_6","title":"\u7ebf\u7a0b\u76f8\u5173\u5c5e\u6027","text":"<p>\u5728\u4e0d\u540c\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u4e3a\u6bcf\u4e2a\u7ebf\u7a0b\u6240\u4fdd\u5b58\u7684\u4fe1\u606f\u90fd\u4e0d\u540c\u3002\u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u63d0\u4f9b\u4e00\u79cd\u57fa\u7840\u7684\u5b9e\u73b0\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u4f1a\u5305\u62ec\uff1a</p> <ul> <li>\u7ebf\u7a0b ID\uff1a\u7528\u4e8e\u552f\u4e00\u786e\u8ba4\u4e00\u4e2a\u7ebf\u7a0b\uff1b</li> <li>\u8fd0\u884c\u6808\uff1a\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u5fc5\u987b\u6709\u4e00\u4e2a\u72ec\u7acb\u7684\u8fd0\u884c\u6808\uff0c\u4fdd\u5b58\u8fd0\u884c\u65f6\u7684\u6570\u636e\uff1b</li> <li>\u6267\u884c\u4e0a\u4e0b\u6587\uff1a\u5f53\u7ebf\u7a0b\u4e0d\u5728\u6267\u884c\u72b6\u6001\u65f6\uff0c\u6211\u4eec\u9700\u8981\u4fdd\u5b58\u5176\u4e0a\u4e0b\u6587\uff08\u5176\u5b9e\u5c31\u662f\u72b6\u6001\u5bc4\u5b58\u5668\u7684\u503c\uff09\uff0c\u8fd9\u6837\u4e4b\u540e\u624d\u80fd\u591f\u5c06\u5176\u6062\u590d\uff0c\u7ee7\u7eed\u8fd0\u884c\uff1b</li> <li>\u8fd0\u884c\u65f6\u95f4\u7247\uff1a\u4e3a\u6bcf\u4e2a\u7ebf\u7a0b\u5206\u914d\u7684\u8fd0\u884c\u65f6\u95f4\uff1b</li> <li>\u4f18\u5148\u7ea7\uff1a\u5728\u4f18\u5148\u7ea7\u76f8\u5173\u8c03\u5ea6\u65f6\uff0c\u914d\u5408\u8c03\u5ea6\u7b97\u6cd5\uff0c\u6765\u9009\u51fa\u4e0b\u4e00\u4e2a\u6267\u884c\u7684\u7ebf\u7a0b\u3002</li> </ul>"},{"location":"lab2/#_7","title":"\u7ebf\u7a0b\u5207\u6362\u6d41\u7a0b\u56fe","text":"<pre><code>           Process 1         Operating System            Process 2\n               +\n               |                                            X\n P1 executing  |                                            X\n               |                                            X\n               v Timer Interrupt Trap                       X\n               +----------------------&gt;                     X\n                                      +                     X\n               X                  do_timer()                X\n               X                      +                     X\n               X                  schedule()                X\n               X                      +                     X\n               X              save state to PCB1            X\n               X                      +                     X\n               X           restore state from PCB2          X\n               X                      +                     X\n               X                      |                     X\n               X                      v Timer Interrupt Ret\n               X                      +---------------------&gt;\n               X                                            |\n               X                                            |  P2 executing\n               X                                            |\n               X                       Timer Interrupt Trap v\n               X                      &lt;---------------------+\n               X                      +\n               X                  do_timer()\n               X                      +\n               X                  schedule()\n               X                      +\n               X              save state to PCB2\n               X                      +\n               X           restore state from PCB1\n               X                      +\n               X                      |\n                 Timer Interrupt Ret  v\n               &lt;----------------------+\n               |\n P1 executing  |\n               |\n               v\n</code></pre> <ul> <li>\u5728\u6bcf\u6b21\u5904\u7406\u65f6\u949f\u4e2d\u65ad\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u9996\u5148\u4f1a\u5c06\u5f53\u524d\u7ebf\u7a0b\u7684\u8fd0\u884c\u5269\u4f59\u65f6\u95f4\u51cf\u5c11\u4e00\u4e2a\u5355\u4f4d\uff0c\u4e4b\u540e\u6839\u636e\u8c03\u5ea6\u7b97\u6cd5\u6765\u786e\u5b9a\u662f\u7ee7\u7eed\u8fd0\u884c\u8fd8\u662f\u8c03\u5ea6\u5176\u4ed6\u7ebf\u7a0b\u6765\u6267\u884c\uff1b</li> <li>\u5728\u8fdb\u7a0b\u8c03\u5ea6\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u904d\u5386\u6240\u6709\u53ef\u8fd0\u884c\u7684\u7ebf\u7a0b\uff0c\u6309\u7167\u4e00\u5b9a\u7684\u8c03\u5ea6\u7b97\u6cd5\u9009\u51fa\u4e0b\u4e00\u4e2a\u6267\u884c\u7684\u7ebf\u7a0b\uff0c\u6700\u7ec8\u5c06\u9009\u62e9\u5f97\u5230\u7684\u7ebf\u7a0b\u4e0e\u5f53\u524d\u7ebf\u7a0b\u5207\u6362\uff1b</li> <li>\u5728\u5207\u6362\u7684\u8fc7\u7a0b\u4e2d\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u4fdd\u5b58\u5f53\u524d\u7ebf\u7a0b\u7684\u6267\u884c\u4e0a\u4e0b\u6587\uff0c\u518d\u5c06\u5c06\u8981\u6267\u884c\u7ebf\u7a0b\u7684\u4e0a\u4e0b\u6587\u8f7d\u5165\u5230\u76f8\u5173\u5bc4\u5b58\u5668\u4e2d\uff0c\u81f3\u6b64\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u7ebf\u7a0b\u7684\u8c03\u5ea6\u4e0e\u5207\u6362\u3002</li> </ul>"},{"location":"lab2/#_8","title":"\u5b9e\u9a8c\u6b65\u9aa4","text":""},{"location":"lab2/#_9","title":"\u51c6\u5907\u5de5\u7a0b","text":"<p>\u6b64\u6b21\u5b9e\u9a8c\u57fa\u4e8e lab1 \u540c\u5b66\u6240\u5b9e\u73b0\u7684\u4ee3\u7801\u8fdb\u884c\u3002</p> <p>\u6bcf\u6b21 lab \u90fd\u8981\u8bb0\u5f97\u7559\u5b58\u8be5\u6b21\u7684\u4ee3\u7801\u4f5c\u4e3a\u5907\u4efd\uff0c\u5efa\u8bae\u4f7f\u7528 git \u8fdb\u884c\u672c\u5730\u7ba1\u7406\uff08\u6ce8\u610f\u4e0d\u8981\u4e0a\u4f20\u5230\u516c\u5f00 repo\uff09</p> <ul> <li> <p>\u4ece\u672c\u4ed3\u5e93 src/lab2 \u540c\u6b65\u4ee5\u4e0b\u4ee3\u7801\uff1a</p> <pre><code>.\n\u251c\u2500\u2500 arch\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 riscv\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 include\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u251c\u2500\u2500 mm.h\n\u2502       \u2502   \u2514\u2500\u2500 proc.h\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 kernel\n\u2502\u00a0\u00a0      \u00a0\u00a0 \u251c\u2500\u2500 mm.c        # \u4e00\u4e2a\u7b80\u5355\u7684\u7269\u7406\u5185\u5b58\u7ba1\u7406\u63a5\u53e3\n\u2502           \u2514\u2500\u2500 proc.c      # \u672c\u6b21\u5b9e\u9a8c\u7684\u91cd\u70b9\u90e8\u5206\uff0c\u8fdb\u884c\u7ebf\u7a0b\u7684\u7ba1\u7406\n\u251c\u2500\u2500 include\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 stdlib.h            # rand \u53ca srand \u5728\u8fd9\u91cc\uff08\u4e0e C \u8bed\u8a00 stdlib.h \u4e00\u81f4\uff09\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 string.h            # memset \u5728\u8fd9\u91cc\uff08\u4e0e C \u8bed\u8a00 string.h \u4e00\u81f4\uff09\n\u2514\u2500\u2500 lib\n \u00a0  \u251c\u2500\u2500 rand.c              # rand \u548c srand \u7684\u5b9e\u73b0\uff08\u53c2\u8003 musl libc\uff09\n \u00a0  \u2514\u2500\u2500 string.c            # memset \u7684\u5b9e\u73b0\n</code></pre> </li> <li> <p><code>arch/riscv/include/defs.h</code> \u4e0e <code>arch/riscv/kernel/head.S</code> \u7684\u4fee\u6539\uff1a</p> <ul> <li>\u672c\u5b9e\u9a8c\u4e2d\u4e2d\u6211\u4eec\u9700\u8981\u4e00\u4e9b\u7269\u7406\u5185\u5b58\u7ba1\u7406\u7684\u63a5\u53e3\uff0c\u5728\u6b64\u6211\u4eec\u63d0\u4f9b\u4e86 <code>kalloc</code> \u63a5\u53e3\uff08\u89c1<code>mm.c</code>\uff09\u7ed9\u5927\u5bb6\uff0c\u8c03\u7528 <code>kalloc</code> \u5373\u53ef\u7533\u8bf7\u4e00\u4e2a 4KiB \u7684\u7269\u7406\u9875\uff1b</li> <li>\u7531\u4e8e\u5f15\u5165\u4e86\u7b80\u5355\u7684\u7269\u7406\u5185\u5b58\u7ba1\u7406\uff0c\u9700\u8981\u5728 <code>_start</code> \u7684\u9002\u5f53\u4f4d\u7f6e\u8c03\u7528 <code>mm_init</code> \u51fd\u6570\u6765\u521d\u59cb\u5316\u5185\u5b58\u7ba1\u7406\u7cfb\u7edf\uff1b</li> <li>\u5728\u521d\u59cb\u5316\u65f6\u9700\u8981\u7528\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7684\u5b8f\uff0c\u56e0\u6b64\u9700\u8981\u5728 <code>defs.h</code> \u4e2d\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a     <pre><code>#define PHY_START 0x0000000080000000\n#define PHY_SIZE 128 * 1024 * 1024 // 128 MiB\uff0cQEMU \u9ed8\u8ba4\u5185\u5b58\u5927\u5c0f\n#define PHY_END (PHY_START + PHY_SIZE)\n\n#define PGSIZE 0x1000 // 4 KiB\n#define PGROUNDUP(addr) ((addr + PGSIZE - 1) &amp; (~(PGSIZE - 1)))\n#define PGROUNDDOWN(addr) (addr &amp; (~(PGSIZE - 1)))\n</code></pre></li> <li>\u6dfb\u52a0/\u4fee\u6539\u4e0a\u8ff0\u6587\u4ef6\u4ee3\u7801\u4e4b\u540e\uff0c\u5148\u8fd0\u884c\u4e00\u4e0b\u786e\u4fdd\u5de5\u7a0b\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\uff0c\u4e4b\u540e\u518d\u5f00\u59cb\u8fdb\u884c\u672c\u6b21\u8bd5\u9a8c\uff1b</li> </ul> </li> <li>\u672c\u6b21\u8bd5\u9a8c\u4e2d\u4e2d\u9700\u8981\u540c\u5b66\u9700\u8981\u4fee\u6539\u5e76\u5b8c\u5584\u4ee5\u4e0b\u6587\u4ef6\uff1a<ul> <li><code>arch/riscv/kernel/proc.c</code></li> <li><code>arch/riscv/kernel/head.S</code></li> <li><code>arch/riscv/kernel/entry.S</code></li> <li><code>arch/riscv/kernel/trap.c</code></li> <li><code>Makefile</code></li> </ul> </li> </ul>"},{"location":"lab2/#proch","title":"<code>proc.h</code> \u6570\u636e\u7ed3\u6784\u5b9a\u4e49","text":"arch/riscv/include/proc.h<pre><code>#include \"stdint.h\"\n\n#ifdef TEST_SCHED\n#define NR_TASKS (1 + 4)    // \u6d4b\u8bd5\u65f6\u7ebf\u7a0b\u6570\u91cf\n#else\n#define NR_TASKS (1 + 31)   // \u7528\u4e8e\u63a7\u5236\u6700\u5927\u7ebf\u7a0b\u6570\u91cf\uff08idle \u7ebf\u7a0b + 31 \u5185\u6838\u7ebf\u7a0b\uff09\n#endif\n\n#define TASK_RUNNING 0      // \u4e3a\u4e86\u7b80\u5316\u5b9e\u9a8c\uff0c\u6240\u6709\u7684\u7ebf\u7a0b\u90fd\u53ea\u6709\u4e00\u79cd\u72b6\u6001\n\n#define PRIORITY_MIN 1\n#define PRIORITY_MAX 10\n\n/* \u7ebf\u7a0b\u72b6\u6001\u6bb5\u6570\u636e\u7ed3\u6784 */\nstruct thread_struct {\n    uint64_t ra;\n    uint64_t sp;\n    uint64_t s[12];\n};\n\n/* \u7ebf\u7a0b\u6570\u636e\u7ed3\u6784 */\nstruct task_struct {\n    uint64_t state;     // \u7ebf\u7a0b\u72b6\u6001\n    uint64_t counter;   // \u8fd0\u884c\u5269\u4f59\u65f6\u95f4\n    uint64_t priority;  // \u8fd0\u884c\u4f18\u5148\u7ea7 1 \u6700\u4f4e 10 \u6700\u9ad8\n    uint64_t pid;       // \u7ebf\u7a0b id\n\n    struct thread_struct thread;\n};\n\n/* \u7ebf\u7a0b\u521d\u59cb\u5316\uff0c\u521b\u5efa NR_TASKS \u4e2a\u7ebf\u7a0b */\nvoid task_init();\n\n/* \u5728\u65f6\u949f\u4e2d\u65ad\u5904\u7406\u4e2d\u88ab\u8c03\u7528\uff0c\u7528\u4e8e\u5224\u65ad\u662f\u5426\u9700\u8981\u8fdb\u884c\u8c03\u5ea6 */\nvoid do_timer();\n\n/* \u8c03\u5ea6\u7a0b\u5e8f\uff0c\u9009\u62e9\u51fa\u4e0b\u4e00\u4e2a\u8fd0\u884c\u7684\u7ebf\u7a0b */\nvoid schedule();\n\n/* \u7ebf\u7a0b\u5207\u6362\u5165\u53e3\u51fd\u6570 */\nvoid switch_to(struct task_struct *next);\n\n/* dummy funciton: \u4e00\u4e2a\u5faa\u73af\u7a0b\u5e8f\uff0c\u5faa\u73af\u8f93\u51fa\u81ea\u5df1\u7684 pid \u4ee5\u53ca\u4e00\u4e2a\u81ea\u589e\u7684\u5c40\u90e8\u53d8\u91cf */\nvoid dummy();\n</code></pre>"},{"location":"lab2/#_10","title":"\u7ebf\u7a0b\u8c03\u5ea6\u529f\u80fd\u5b9e\u73b0","text":""},{"location":"lab2/#_11","title":"\u7ebf\u7a0b\u521d\u59cb\u5316","text":"<ul> <li>\u5728\u521d\u59cb\u5316\u7ebf\u7a0b\u7684\u65f6\u5019\uff0c\u6211\u4eec\u53c2\u8003 Linux v0.11 \u4e2d\u7684\u5b9e\u73b0\u4e3a\u6bcf\u4e2a\u7ebf\u7a0b\u5206\u914d\u4e00\u4e2a 4 KiB \u7684\u7269\u7406\u9875\uff0c\u6211\u4eec\u5c06 <code>task_struct</code> \u5b58\u653e\u5728\u8be5\u9875\u7684\u4f4e\u5730\u5740\u90e8\u5206\uff0c\u5c06\u7ebf\u7a0b\u7684\u6808\u6307\u9488 <code>sp</code> \u6307\u5411\u8be5\u9875\u7684\u9ad8\u5730\u5740\u3002\u5177\u4f53\u5185\u5b58\u5e03\u5c40\u5982\u4e0b\u56fe\u6240\u793a\uff1a     <pre><code>                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u25c4\u2500\u2500\u2500 High Address\n                    \u2502             \u2502\n                    \u2502    stack    \u2502\n                    \u2502             \u2502\n                    \u2502             \u2502\n              sp \u2500\u2500\u25ba\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n                    \u2502      \u2502      \u2502\n                    \u2502      \u25bc      \u2502\n                    \u2502             \u2502\n                    \u2502             \u2502\n                    \u2502             \u2502\n                    \u2502             \u2502\n    4KiB Page       \u2502             \u2502\n                    \u2502             \u2502\n                    \u2502             \u2502\n                    \u2502             \u2502\n                    \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n                    \u2502             \u2502\n                    \u2502             \u2502\n                    \u2502 task_struct \u2502\n                    \u2502             \u2502\n                    \u2502             \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\u25c4\u2500\u2500\u2500 Low Address\n</code></pre></li> <li>\u5f53\u6211\u4eec\u7684 OS \u8fd0\u884c\u8d77\u6765\u7684\u65f6\u5019\uff0c\u5176\u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u7ebf\u7a0b\uff08idle \u7ebf\u7a0b\uff09\uff0c\u4f46\u662f\u6211\u4eec\u5e76\u6ca1\u6709\u4e3a\u5b83\u8bbe\u8ba1\u597d <code>task_struct</code>\uff0c\u6240\u4ee5\u7b2c\u4e00\u6b65\u6211\u4eec\u8981\uff1a<ul> <li>\u4e3a <code>idle</code> \u8bbe\u7f6e\u597d <code>task_struct</code> \u7684\u5185\u5bb9\uff1b</li> <li>\u5c06 <code>current</code>\uff0c<code>task[0]</code> \u90fd\u6307\u5411 <code>idle</code>\uff1b</li> </ul> </li> <li> <p>\u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0c\u6211\u4eec\u5c06 <code>task[1]</code> ~ <code>task[NR_TASKS - 1]</code> \u5168\u90e8\u521d\u59cb\u5316\uff0c\u8fd9\u91cc\u548c <code>idle</code> \u8bbe\u7f6e\u7684\u533a\u522b\u5728\u4e8e\u8981\u4e3a\u8fd9\u4e9b\u7ebf\u7a0b\u8bbe\u7f6e <code>thread_struct</code> \u4e2d\u7684 <code>ra</code> \u548c <code>sp</code>\uff0c\u5177\u4f53\u89c1\u4ee3\u7801\uff1a     arch/riscv/kernel/proc.c<pre><code>extern void __dummy();\n\nstruct task_struct *idle;           // idle process\nstruct task_struct *current;        // \u6307\u5411\u5f53\u524d\u8fd0\u884c\u7ebf\u7a0b\u7684 task_struct\nstruct task_struct *task[NR_TASKS]; // \u7ebf\u7a0b\u6570\u7ec4\uff0c\u6240\u6709\u7684\u7ebf\u7a0b\u90fd\u4fdd\u5b58\u5728\u6b64\n\nvoid task_init() {\n    srand(2024);\n\n    // 1. \u8c03\u7528 kalloc() \u4e3a idle \u5206\u914d\u4e00\u4e2a\u7269\u7406\u9875\n    // 2. \u8bbe\u7f6e state \u4e3a TASK_RUNNING;\n    // 3. \u7531\u4e8e idle \u4e0d\u53c2\u4e0e\u8c03\u5ea6\uff0c\u53ef\u4ee5\u5c06\u5176 counter / priority \u8bbe\u7f6e\u4e3a 0\n    // 4. \u8bbe\u7f6e idle \u7684 pid \u4e3a 0\n    // 5. \u5c06 current \u548c task[0] \u6307\u5411 idle\n\n    /* YOUR CODE HERE */\n\n    // 1. \u53c2\u8003 idle \u7684\u8bbe\u7f6e\uff0c\u4e3a task[1] ~ task[NR_TASKS - 1] \u8fdb\u884c\u521d\u59cb\u5316\n    // 2. \u5176\u4e2d\u6bcf\u4e2a\u7ebf\u7a0b\u7684 state \u4e3a TASK_RUNNING, \u6b64\u5916\uff0ccounter \u548c priority \u8fdb\u884c\u5982\u4e0b\u8d4b\u503c\uff1a\n    //     - counter  = 0;\n    //     - priority = rand() \u4ea7\u751f\u7684\u968f\u673a\u6570\uff08\u63a7\u5236\u8303\u56f4\u5728 [PRIORITY_MIN, PRIORITY_MAX] \u4e4b\u95f4\uff09\n    // 3. \u4e3a task[1] ~ task[NR_TASKS - 1] \u8bbe\u7f6e thread_struct \u4e2d\u7684 ra \u548c sp\n    //     - ra \u8bbe\u7f6e\u4e3a __dummy\uff08\u89c1 4.2.2\uff09\u7684\u5730\u5740\n    //     - sp \u8bbe\u7f6e\u4e3a\u8be5\u7ebf\u7a0b\u7533\u8bf7\u7684\u7269\u7406\u9875\u7684\u9ad8\u5730\u5740\n\n    /* YOUR CODE HERE */\n\n    printk(\"...task_init done!\\n\");\n}\n</code></pre></p> <p>Debug \u63d0\u793a</p> <ol> <li>\u4fee\u6539 <code>proc.h</code> \u4e2d\u7684 <code>NR_TASKS</code> \u4e3a\u4e00\u4e2a\u6bd4\u8f83\u5c0f\u7684\u503c\uff0c\u6bd4\u5982 5\uff0c\u8fd9\u6837\u9664\u53bb <code>task[0]</code>\uff08idle\uff09\uff0c\u53ea\u9700\u8981\u521d\u59cb\u5316 4 \u4e2a\u7ebf\u7a0b\uff0c\u65b9\u4fbf\u8c03\u8bd5\uff1b</li> <li>\u6ce8\u610f\u4ee5\u4e0a\u7684\u4fee\u6539\u53ea\u662f\u4e3a\u4e86\u5728\u505a\u5b9e\u9a8c\u7684\u8fc7\u7a0b\u4e2d\u65b9\u4fbf\u8c03\u8bd5\uff0c\u6700\u540e\u4e00\u5b9a\u8bb0\u4f4f\u8981\u4fee\u6539\u56de\u53bb\uff01\uff01\uff01</li> </ol> </li> <li> <p>\u5728 <code>arch/riscv/kernel/head.S</code> \u4e2d\u5408\u9002\u4f4d\u7f6e\u5904\u8c03\u7528 <code>task_init()</code> \u8fdb\u884c\u7ebf\u7a0b\u521d\u59cb\u5316\u3002</p> </li> </ul>"},{"location":"lab2/#__dummy-dummy","title":"<code>__dummy</code> \u4e0e <code>dummy</code> \u7684\u5b9e\u73b0","text":"<ul> <li> <p><code>task[1]</code> ~ <code>task[NR_TASKS - 1]</code> \u90fd\u8fd0\u884c\u540c\u4e00\u6bb5\u4ee3\u7801 <code>dummy()</code> \u6211\u4eec\u5728 <code>proc.c</code> \u4e2d\u5b9a\u4e49\u4e86\u8fd9\u4e2a\u51fd\u6570\uff1a     arch/riscv/kernel/proc.c\uff08\u9664\u53bb TEST_SCHED \u4e4b\u5916\u7684\u90e8\u5206\uff09<pre><code>void dummy() {\n    uint64_t MOD = 1000000007;\n    uint64_t auto_inc_local_var = 0;\n    int last_counter = -1;\n    while (1) {\n        if ((last_counter == -1 || current-&gt;counter != last_counter) &amp;&amp; current-&gt;counter &gt; 0) {\n            if (current-&gt;counter == 1) {\n                --(current-&gt;counter);   // forced the counter to be zero if this thread is going to be scheduled\n            }                           // in case that the new counter is also 1, leading the information not printed.\n            last_counter = current-&gt;counter;\n            auto_inc_local_var = (auto_inc_local_var + 1) % MOD;\n            printk(\"[PID = %d] is running. auto_inc_local_var = %d\\n\", current-&gt;pid, auto_inc_local_var);\n        }\n    }\n}\n</code></pre></p> <p>Debug \u63d0\u793a\uff1a\u53ef\u4ee5\u7528 printk \u6253\u5370\u66f4\u591a\u7684\u4fe1\u606f</p> </li> <li> <p>\u5f53\u7ebf\u7a0b\u5728\u8fd0\u884c\u65f6\uff0c\u7531\u4e8e\u65f6\u949f\u4e2d\u65ad\u7684\u89e6\u53d1\uff0c\u4f1a\u5c06\u5f53\u524d\u8fd0\u884c\u7ebf\u7a0b\u7684\u4e0a\u4e0b\u6587\u73af\u5883\u4fdd\u5b58\u5728\u6808\u4e0a\uff1b\u5f53\u7ebf\u7a0b\u518d\u6b21\u88ab\u8c03\u5ea6\u65f6\uff0c\u4f1a\u5c06\u4e0a\u4e0b\u6587\u4ece\u6808\u4e0a\u6062\u590d\uff0c\u4f46\u662f\u5f53\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u7ebf\u7a0b\uff0c\u6b64\u65f6\u7ebf\u7a0b\u7684\u6808\u4e3a\u7a7a\uff0c\u5f53\u8fd9\u4e2a\u7ebf\u7a0b\u88ab\u8c03\u5ea6\u65f6\uff0c\u662f\u6ca1\u6709\u4e0a\u4e0b\u6587\u9700\u8981\u88ab\u6062\u590d\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e3a\u7ebf\u7a0b\u7b2c\u4e00\u6b21\u8c03\u5ea6\u63d0\u4f9b\u4e00\u4e2a\u7279\u6b8a\u7684\u8fd4\u56de\u51fd\u6570 <code>__dummy</code>\uff1a</p> <ul> <li>\u5728 <code>arch/riscv/kernel/entry.S</code> \u4e2d\u6dfb\u52a0\u51fd\u6570 <code>__dummy</code>\uff1a<ul> <li>\u5728 <code>__dummy</code> \u4e2d\u5c06 sepc \u8bbe\u7f6e\u4e3a <code>dummy()</code> \u7684\u5730\u5740\uff0c\u5e76\u4f7f\u7528 <code>sret</code> \u4ece S \u6a21\u5f0f\u4e2d\u8fd4\u56de\uff1b arch/riscv/kernel/entry.S<pre><code>    .extern dummy\n    .globl __dummy\n__dummy:\n    # YOUR CODE HERE\n</code></pre></li> </ul> </li> </ul> </li> </ul>"},{"location":"lab2/#_12","title":"\u5b9e\u73b0\u7ebf\u7a0b\u5207\u6362","text":"<ul> <li>\u5224\u65ad\u4e0b\u4e00\u4e2a\u6267\u884c\u7684\u7ebf\u7a0b <code>next</code> \u4e0e\u5f53\u524d\u7684\u7ebf\u7a0b <code>current</code> \u662f\u5426\u4e3a\u540c\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u5982\u679c\u662f\u540c\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u5219\u65e0\u9700\u505a\u4efb\u4f55\u5904\u7406\uff0c\u5426\u5219\u8c03\u7528 <code>__switch_to</code> \u8fdb\u884c\u7ebf\u7a0b\u5207\u6362\uff1a     arch/riscv/kernel/proc.c<pre><code>extern void __switch_to(struct task_struct *prev, struct task_struct *next);\n\nvoid switch_to(struct task_struct *next) {\n    // YOUR CODE HERE\n}\n</code></pre></li> <li> <p>\u5728 <code>entry.S</code> \u4e2d\u5b9e\u73b0\u7ebf\u7a0b\u4e0a\u4e0b\u6587\u5207\u6362 <code>__switch_to</code>\uff1a</p> <ul> <li><code>__switch_to</code> \u63a5\u53d7\u4e24\u4e2a <code>task_struct</code> \u6307\u9488\u4f5c\u4e3a\u53c2\u6570\uff1b</li> <li>\u4fdd\u5b58\u5f53\u524d\u7ebf\u7a0b\u7684 <code>ra</code>\uff0c<code>sp</code>\uff0c<code>s0~s11</code> \u5230\u5f53\u524d\u7ebf\u7a0b\u7684 <code>thread_struct</code> \u4e2d\uff1b</li> <li>\u5c06\u4e0b\u4e00\u4e2a\u7ebf\u7a0b\u7684 <code>thread_struct</code> \u4e2d\u7684\u76f8\u5173\u6570\u636e\u8f7d\u5165\u5230 <code>ra</code>\uff0c<code>sp</code>\uff0c<code>s0~s11</code> \u4e2d\u8fdb\u884c\u6062\u590d\uff1a arch/riscv/kernel/entry.S<pre><code>    .globl __switch_to\n__switch_to:\n    # save state to prev process\n    # YOUR CODE HERE\n\n    # restore state from next process\n    # YOUR CODE HERE\n\n    ret\n</code></pre></li> </ul> <p>Debug \u63d0\u793a</p> <ul> <li>\u5728 <code>NR_TASKS = 1+1</code> \u65f6\uff0c\u53ef\u4ee5\u5c1d\u8bd5\u662f\u5426\u53ef\u4ee5\u4ece idle \u6b63\u786e\u5207\u6362\u5230 process 1</li> <li>\u6ce8\u610f\u5728\u5207\u6362\u8fc7\u7a0b\u4e2d\u7684 pc \u53d8\u5316\uff0c\u4e14\u6ce8\u610f <code>current</code> \u7684\u66f4\u65b0</li> </ul> </li> </ul>"},{"location":"lab2/#_13","title":"\u5b9e\u73b0\u8c03\u5ea6\u5165\u53e3\u51fd\u6570","text":"<ul> <li>\u5b9e\u73b0 <code>do_timer()</code> \u51fd\u6570\uff0c\u5e76\u5728 <code>trap.c</code> \u65f6\u949f\u4e2d\u65ad\u5904\u7406\u51fd\u6570\u4e2d\u8c03\u7528\uff1a     arch/riscv/kernel/proc.c<pre><code>void do_timer() {\n    // 1. \u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u662f idle \u7ebf\u7a0b\u6216\u5f53\u524d\u7ebf\u7a0b\u65f6\u95f4\u7247\u8017\u5c3d\u5219\u76f4\u63a5\u8fdb\u884c\u8c03\u5ea6\n    // 2. \u5426\u5219\u5bf9\u5f53\u524d\u7ebf\u7a0b\u7684\u8fd0\u884c\u5269\u4f59\u65f6\u95f4\u51cf 1\uff0c\u82e5\u5269\u4f59\u65f6\u95f4\u4ecd\u7136\u5927\u4e8e 0 \u5219\u76f4\u63a5\u8fd4\u56de\uff0c\u5426\u5219\u8fdb\u884c\u8c03\u5ea6\n\n    // YOUR CODE HERE\n}\n</code></pre></li> </ul>"},{"location":"lab2/#_14","title":"\u7ebf\u7a0b\u8c03\u5ea6\u7b97\u6cd5\u5b9e\u73b0","text":"<p>\u672c\u6b21\u5b9e\u9a8c\u6211\u4eec\u9700\u8981\u53c2\u8003 Linux v0.11 \u8c03\u5ea6\u7b97\u6cd5\u4ee3\u7801\u5b9e\u73b0\u4e00\u4e2a\u4f18\u5148\u7ea7\u8c03\u5ea6\u7b97\u6cd5\uff0c\u5177\u4f53\u903b\u8f91\u5982\u4e0b\uff1a</p> <ul> <li><code>task_init</code> \u7684\u65f6\u5019\u968f\u673a\u4e3a\u5404\u4e2a\u7ebf\u7a0b\u8d4b\u4e88\u4e86\u4f18\u5148\u7ea7</li> <li>\u8c03\u5ea6\u65f6\u9009\u62e9 <code>counter</code> \u6700\u5927\u7684\u7ebf\u7a0b\u8fd0\u884c</li> <li>\u5982\u679c\u6240\u6709\u7ebf\u7a0b <code>counter</code> \u90fd\u4e3a 0\uff0c\u5219\u4ee4\u6240\u6709\u7ebf\u7a0b <code>counter = priority</code><ul> <li>\u5373\u4f18\u5148\u7ea7\u8d8a\u9ad8\uff0c\u8fd0\u884c\u7684\u65f6\u95f4\u8d8a\u957f\uff0c\u4e14\u8d8a\u5148\u8fd0\u884c</li> <li>\u8bbe\u7f6e\u5b8c\u540e\u9700\u8981\u91cd\u65b0\u8fdb\u884c\u8c03\u5ea6</li> </ul> </li> <li>\u6700\u540e\u901a\u8fc7 <code>switch_to</code> \u5207\u6362\u5230\u4e0b\u4e00\u4e2a\u7ebf\u7a0b</li> </ul> arch/riscv/kernel/proc.c<pre><code>void schedule() {\n    // YOUR CODE HERE\n}\n</code></pre> <p>Debug \u63d0\u793a\uff1a\u53ef\u4ee5\u5148\u5c06 <code>NR_TASKS</code> \u6539\u4e3a\u8f83\u5c0f\u7684\u503c\uff0c\u8c03\u7528 <code>printk</code> \u5c06\u6240\u6709\u7ebf\u7a0b\u7684\u4fe1\u606f\u6253\u5370\u51fa\u6765</p>"},{"location":"lab2/#_15","title":"\u7f16\u8bd1\u53ca\u6d4b\u8bd5","text":"<ul> <li>\u7531\u4e8e\u52a0\u5165\u4e86\u4e00\u4e9b\u65b0\u7684 .c \u6587\u4ef6\uff0c\u53ef\u80fd\u9700\u8981\u4fee\u6539\u4e00\u4e9b Makefile \u6587\u4ef6\uff0c\u8bf7\u540c\u5b66\u81ea\u5df1\u5c1d\u8bd5\u4fee\u6539\uff0c\u4f7f\u9879\u76ee\u53ef\u4ee5\u7f16\u8bd1\u5e76\u8fd0\u884c\uff1b</li> <li>\u4e3a\u4e86\u9a8c\u8bc1\u7b97\u6cd5\u6b63\u786e\u6027\uff0c\u672c\u6b21\u5b9e\u9a8c\u52a0\u5165\u4e86\u4e00\u4e2a\u6d4b\u8bd5\u6837\u4f8b\uff08\u5728 4 \u4e2a\u7ebf\u7a0b\u7684\u60c5\u51b5\u4e0b\u7684 pid \u8f93\u51fa\uff09<ul> <li>\u6d4b\u8bd5\u4f1a\u5728\u7f16\u8bd1\u65f6\u5b9a\u4e49\u4e86 <code>TEST_SCHED</code> \u4e14\u503c\u4e0d\u4e3a 0 \u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\uff08Conditional inclusion\uff09\uff0c\u6240\u4ee5\u9700\u8981\u4fee\u6539 Makefile\uff1a     <pre><code>TEST_SCHED  :=  0\nCFLAG   :=  $(CF) $(INCLUDE) -DTEST_SCHED=$(TEST_SCHED)\n</code></pre></li> <li>\u8fd9\u6837 <code>make TEST_SCHED=1 run</code> \u7684\u60c5\u51b5\u4e0b\u5c31\u4f1a\u7ed9\u7f16\u8bd1\u52a0\u4e0a <code>-DTEST_SCHED=1</code> \u7684\u9009\u9879\uff0c\u4ece\u800c\u8fdb\u884c\u6d4b\u8bd5</li> </ul> </li> </ul> <p>\u4e00\u5207\u5747\u6b63\u5e38\u5b9e\u73b0\u540e\u5f97\u5230\u7684\u7ed3\u679c\u5e94\u8be5\u5982\u4e0b\uff1a</p> <code>make TEST_SCHED=1 run</code> \u7684\u6b63\u786e\u8f93\u51fa <pre><code>...mm_init done!\n...task_init done!\n2024 ZJU Operating System\n\nSET [PID = 1 PRIORITY = 7 COUNTER = 7]\nSET [PID = 2 PRIORITY = 10 COUNTER = 10]\nSET [PID = 3 PRIORITY = 4 COUNTER = 4]\nSET [PID = 4 PRIORITY = 1 COUNTER = 1]\n\nswitch to [PID = 2 PRIORITY = 10 COUNTER = 10]\n[PID = 2] is running. auto_inc_local_var = 1\n[PID = 2] is running. auto_inc_local_var = 2\n[PID = 2] is running. auto_inc_local_var = 3\n[PID = 2] is running. auto_inc_local_var = 4\n[PID = 2] is running. auto_inc_local_var = 5\n[PID = 2] is running. auto_inc_local_var = 6\n[PID = 2] is running. auto_inc_local_var = 7\n[PID = 2] is running. auto_inc_local_var = 8\n[PID = 2] is running. auto_inc_local_var = 9\n[PID = 2] is running. auto_inc_local_var = 10\n\nswitch to [PID = 1 PRIORITY = 7 COUNTER = 7]\n[PID = 1] is running. auto_inc_local_var = 1\n[PID = 1] is running. auto_inc_local_var = 2\n[PID = 1] is running. auto_inc_local_var = 3\n[PID = 1] is running. auto_inc_local_var = 4\n[PID = 1] is running. auto_inc_local_var = 5\n[PID = 1] is running. auto_inc_local_var = 6\n[PID = 1] is running. auto_inc_local_var = 7\n\nswitch to [PID = 3 PRIORITY = 4 COUNTER = 4]\n[PID = 3] is running. auto_inc_local_var = 1\n[PID = 3] is running. auto_inc_local_var = 2\n[PID = 3] is running. auto_inc_local_var = 3\n[PID = 3] is running. auto_inc_local_var = 4\n\nswitch to [PID = 4 PRIORITY = 1 COUNTER = 1]\n[PID = 4] is running. auto_inc_local_var = 1\n\nSET [PID = 1 PRIORITY = 7 COUNTER = 7]\nSET [PID = 2 PRIORITY = 10 COUNTER = 10]\nSET [PID = 3 PRIORITY = 4 COUNTER = 4]\nSET [PID = 4 PRIORITY = 1 COUNTER = 1]\n\nswitch to [PID = 2 PRIORITY = 10 COUNTER = 10]\n[PID = 2] is running. auto_inc_local_var = 11\n[PID = 2] is running. auto_inc_local_var = 12\n[PID = 2] is running. auto_inc_local_var = 13\n[PID = 2] is running. auto_inc_local_var = 14\n[PID = 2] is running. auto_inc_local_var = 15\n[PID = 2] is running. auto_inc_local_var = 16\n[PID = 2] is running. auto_inc_local_var = 17\n[PID = 2] is running. auto_inc_local_var = 18\n[PID = 2] is running. auto_inc_local_var = 19\n[PID = 2] is running. auto_inc_local_var = 20\n\nswitch to [PID = 1 PRIORITY = 7 COUNTER = 7]\n[PID = 1] is running. auto_inc_local_var = 8\n[PID = 1] is running. auto_inc_local_var = 9\n[PID = 1] is running. auto_inc_local_var = 10\n[PID = 1] is running. auto_inc_local_var = 11\n[PID = 1] is running. auto_inc_local_var = 12\n[PID = 1] is running. auto_inc_local_var = 13\n[PID = 1] is running. auto_inc_local_var = 14\n\nswitch to [PID = 3 PRIORITY = 4 COUNTER = 4]\n[PID = 3] is running. auto_inc_local_var = 5\nTest passed!\n    Output: 2222222222111111133334222222222211111113\n</code></pre> <p>\u5982\u679c\u6700\u540e\u8f93\u51fa\u4e86 <code>Test failed!</code> \u5219\u8bf4\u660e\u4f60\u7684 <code>counter</code> \u8d4b\u503c\u6216\u8005\u8c03\u5ea6\u7b97\u6cd5\u7684\u5b9e\u73b0\u6709\u95ee\u9898\uff0c<code>Got</code> \u7684\u5b9e\u9645\u8f93\u51fa\u4e3a\u6bcf\u4e2a\u65f6\u949f\u4e2d\u65ad\u95f4\u9694\u5185\u6b63\u5728\u8fd0\u884c\u7684\u7ebf\u7a0b <code>pid</code> \u503c\u3002</p> <code>make run</code> \u7684\u8f93\u51fa\u6837\u4f8b <p>31 \u4e2a\u5185\u6838\u7ebf\u7a0b\u7684\u8f93\u51fa\uff0c\u53ef\u4ee5\u81ea\u884c\u68c0\u67e5\u8fd0\u884c\u903b\u8f91\u662f\u5426\u6b63\u786e\u3002 <pre><code>...mm_init done!\n...task_init done!\n2024 ZJU Operating System\n\nSET [PID = 1 PRIORITY = 7 COUNTER = 7]\nSET [PID = 2 PRIORITY = 10 COUNTER = 10]\nSET [PID = 3 PRIORITY = 4 COUNTER = 4]\nSET [PID = 4 PRIORITY = 1 COUNTER = 1]\nSET [PID = 5 PRIORITY = 4 COUNTER = 4]\nSET [PID = 6 PRIORITY = 7 COUNTER = 7]\nSET [PID = 7 PRIORITY = 5 COUNTER = 5]\nSET [PID = 8 PRIORITY = 10 COUNTER = 10]\nSET [PID = 9 PRIORITY = 1 COUNTER = 1]\nSET [PID = 10 PRIORITY = 9 COUNTER = 9]\nSET [PID = 11 PRIORITY = 6 COUNTER = 6]\nSET [PID = 12 PRIORITY = 9 COUNTER = 9]\nSET [PID = 13 PRIORITY = 6 COUNTER = 6]\nSET [PID = 14 PRIORITY = 6 COUNTER = 6]\nSET [PID = 15 PRIORITY = 5 COUNTER = 5]\nSET [PID = 16 PRIORITY = 8 COUNTER = 8]\nSET [PID = 17 PRIORITY = 1 COUNTER = 1]\nSET [PID = 18 PRIORITY = 5 COUNTER = 5]\nSET [PID = 19 PRIORITY = 3 COUNTER = 3]\nSET [PID = 20 PRIORITY = 7 COUNTER = 7]\nSET [PID = 21 PRIORITY = 7 COUNTER = 7]\nSET [PID = 22 PRIORITY = 3 COUNTER = 3]\nSET [PID = 23 PRIORITY = 3 COUNTER = 3]\nSET [PID = 24 PRIORITY = 3 COUNTER = 3]\nSET [PID = 25 PRIORITY = 4 COUNTER = 4]\nSET [PID = 26 PRIORITY = 3 COUNTER = 3]\nSET [PID = 27 PRIORITY = 9 COUNTER = 9]\nSET [PID = 28 PRIORITY = 1 COUNTER = 1]\nSET [PID = 29 PRIORITY = 9 COUNTER = 9]\nSET [PID = 30 PRIORITY = 10 COUNTER = 10]\nSET [PID = 31 PRIORITY = 3 COUNTER = 3]\n\nswitch to [PID = 2 PRIORITY = 10 COUNTER = 10]\n[PID = 2] is running. auto_inc_local_var = 1\n[PID = 2] is running. auto_inc_local_var = 2\n[PID = 2] is running. auto_inc_local_var = 3\n[PID = 2] is running. auto_inc_local_var = 4\n[PID = 2] is running. auto_inc_local_var = 5\n[PID = 2] is running. auto_inc_local_var = 6\n[PID = 2] is running. auto_inc_local_var = 7\n[PID = 2] is running. auto_inc_local_var = 8\n[PID = 2] is running. auto_inc_local_var = 9\n[PID = 2] is running. auto_inc_local_var = 10\n\nswitch to [PID = 8 PRIORITY = 10 COUNTER = 10]\n[PID = 8] is running. auto_inc_local_var = 1\n[PID = 8] is running. auto_inc_local_var = 2\n[PID = 8] is running. auto_inc_local_var = 3\n[PID = 8] is running. auto_inc_local_var = 4\n[PID = 8] is running. auto_inc_local_var = 5\n[PID = 8] is running. auto_inc_local_var = 6\n[PID = 8] is running. auto_inc_local_var = 7\n[PID = 8] is running. auto_inc_local_var = 8\n[PID = 8] is running. auto_inc_local_var = 9\n[PID = 8] is running. auto_inc_local_var = 10\n\nswitch to [PID = 30 PRIORITY = 10 COUNTER = 10]\n[PID = 30] is running. auto_inc_local_var = 1\n[PID = 30] is running. auto_inc_local_var = 2\n[PID = 30] is running. auto_inc_local_var = 3\n[PID = 30] is running. auto_inc_local_var = 4\n[PID = 30] is running. auto_inc_local_var = 5\n[PID = 30] is running. auto_inc_local_var = 6\n[PID = 30] is running. auto_inc_local_var = 7\n[PID = 30] is running. auto_inc_local_var = 8\n[PID = 30] is running. auto_inc_local_var = 9\n[PID = 30] is running. auto_inc_local_var = 10\n\nswitch to [PID = 10 PRIORITY = 9 COUNTER = 9]\n[PID = 10] is running. auto_inc_local_var = 1\n[PID = 10] is running. auto_inc_local_var = 2\n[PID = 10] is running. auto_inc_local_var = 3\n[PID = 10] is running. auto_inc_local_var = 4\n[PID = 10] is running. auto_inc_local_var = 5\n</code></pre></p>"},{"location":"lab2/#_16","title":"\u66f4\u4e30\u5bcc\u7684\u8f93\u51fa","text":"<p>\u4ece\u672c\u6b21\u5b9e\u9a8c\u5f00\u59cb\uff0c\u5b9e\u9a8c\u4ee3\u7801\u4f1a\u8d8a\u6765\u8d8a\u590d\u6742\u8d77\u6765\uff0ckernel \u7684\u8f93\u51fa\u6216\u8005\u8c03\u8bd5\u4fe1\u606f\u4e5f\u4f1a\u8d8a\u6765\u8d8a\u591a\u3002\u4e3a\u4e86\u65b9\u4fbf\u5927\u5bb6\u6e05\u6670\u5730\u89c2\u5bdf\u7a0b\u5e8f\u8f93\u51fa\u66f4\u65b9\u4fbf\u5730\u8fdb\u884c\u8c03\u8bd5\uff0c\u8fd9\u91cc\u7ed9\u5927\u5bb6\u63d0\u4f9b\u4e00\u4e9b\u8f93\u51fa\u7684\u6280\u5de7\u3002\u5728 <code>printk.h</code> \u4e2d\u53ef\u4ee5\u52a0\u5165\u5982\u4e0b\u7684\u5b8f\u5b9a\u4e49\uff1a</p> include/printk.h<pre><code>#define RED \"\\033[31m\"\n#define GREEN \"\\033[32m\"\n#define YELLOW \"\\033[33m\"\n#define BLUE \"\\033[34m\"\n#define PURPLE \"\\033[35m\"\n#define DEEPGREEN \"\\033[36m\"\n#define CLEAR \"\\033[0m\"\n\n#define Log(format, ...) \\\n    printk(\"\\33[1;35m[%s,%d,%s] \" format \"\\33[0m\\n\", \\\n        __FILE__, __LINE__, __func__, ## __VA_ARGS__)\n</code></pre> <p>\u8fd9\u6837\u6bd4\u5982\u4f7f\u7528 <code>printk(RED \"test: %d\\n\" CLEAR, 1);</code> \u5c31\u53ef\u4ee5\u8f93\u51fa\u7ea2\u8272\u7684 <code>test: 1</code>\u3002\u8fd9\u4e2a\u7528\u6cd5\u662f ANSI \u8f6c\u4e49\u5e8f\u5217\uff0c\u66f4\u591a\u7528\u6cd5\u53ef\u4ee5\u770b wikipedia \u4e2d\u5bf9 ANSI \u8f6c\u4e49\u5e8f\u5217\u7684\u4ecb\u7ecd\u3002</p> <p>\u53e6\u5916\u4f7f\u7528 <code>Log</code> \u5b8f\u6765\u4ee3\u66ff <code>printk</code> \u53ef\u4ee5\u5b9e\u73b0\u5e26\u989c\u8272\u7684\u8f93\u51fa\uff0c\u5e76\u4e14\u5728\u8f93\u51fa\u524d\u9644\u5e26\u8be5 <code>Log</code> \u6240\u5728\u7684\u6587\u4ef6\u540d\u3001\u884c\u53f7\u3001\u51fd\u6570\u540d\uff0c\u66f4\u65b9\u4fbf\u8c03\u8bd5\uff0c\u5e76\u4e14\u4f7f\u7528\u65b9\u6cd5\u548c <code>printk</code> \u5b8c\u5168\u4e00\u81f4\u3002</p> <p>\u6211\u4eec\u5728\u8bc4\u5224\u5b9e\u9a8c\u7684\u65f6\u5019\u4e0d\u4f1a\u5173\u6ce8\u8f93\u51fa\u7684\u683c\u5f0f\uff0c\u6240\u4ee5\u5404\u4f4d\u540c\u5b66\u53ef\u4ee5\u653e\u5fc3\u5927\u80c6\u5730\u5728\u4ee3\u7801\u91cc\u4f7f\u7528\u5e26\u989c\u8272\u7684\u8f93\u51fa\u6216\u8005 <code>Log</code> \u6765\u65b9\u4fbf\u81ea\u5df1\u8c03\u8bd5\u4e0e\u89c2\u5bdf\u3002</p>"},{"location":"lab2/#_17","title":"\u601d\u8003\u9898","text":"<ol> <li>\u5728 RV64 \u4e2d\u4e00\u5171\u6709 32 \u4e2a\u901a\u7528\u5bc4\u5b58\u5668\uff0c\u4e3a\u4ec0\u4e48 <code>__switch_to</code> \u4e2d\u53ea\u4fdd\u5b58\u4e86 14 \u4e2a\uff1f</li> <li>\u9605\u8bfb\u5e76\u7406\u89e3 <code>arch/riscv/kernel/mm.c</code> \u4ee3\u7801\uff0c\u5c1d\u8bd5\u8bf4\u660e <code>mm_init</code> \u51fd\u6570\u90fd\u505a\u4e86\u4ec0\u4e48\uff0c\u4ee5\u53ca\u5728 <code>kalloc</code> \u548c <code>kfree</code> \u7684\u65f6\u5019\u5185\u5b58\u662f\u5982\u4f55\u88ab\u7ba1\u7406\u7684\u3002</li> <li>\u5f53\u7ebf\u7a0b\u7b2c\u4e00\u6b21\u8c03\u7528\u65f6\uff0c\u5176 <code>ra</code> \u6240\u4ee3\u8868\u7684\u8fd4\u56de\u70b9\u662f <code>__dummy</code>\uff0c\u90a3\u4e48\u5728\u4e4b\u540e\u7684\u7ebf\u7a0b\u8c03\u7528\u4e2d <code>__switch_to</code> \u4e2d\uff0c<code>ra</code> \u4fdd\u5b58/\u6062\u590d\u7684\u51fd\u6570\u8fd4\u56de\u70b9\u662f\u4ec0\u4e48\u5462\uff1f\u8bf7\u540c\u5b66\u7528 gdb \u5c1d\u8bd5\u8ffd\u8e2a\u4e00\u6b21\u5b8c\u6574\u7684\u7ebf\u7a0b\u5207\u6362\u6d41\u7a0b\uff0c\u5e76\u5173\u6ce8\u6bcf\u4e00\u6b21 <code>ra</code> \u7684\u53d8\u6362\uff08\u9700\u8981\u622a\u56fe\uff09\u3002</li> <li>\u8bf7\u5c1d\u8bd5\u5206\u6790\u5e76\u753b\u56fe\u8bf4\u660e kernel \u8fd0\u884c\u5230\u8f93\u51fa\u7b2c\u4e24\u6b21 <code>switch to [PID ...</code> \u7684\u65f6\u5019\u5185\u5b58\u4e2d\u5b58\u5728\u7684\u5168\u90e8\u51fd\u6570\u5e27\u6808\u5e03\u5c40\u3002<ul> <li>\u53ef\u901a\u8fc7 gdb \u8c03\u8bd5\u4f7f\u7528 <code>backtrace</code> \u7b49\u6307\u4ee4\u8f85\u52a9\u5206\u6790\uff0c\u6ce8\u610f\u5206\u6790\u7b2c\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u89e6\u53d1\u540e\u7684 <code>pc</code> \u548c <code>sp</code> \u7684\u53d8\u5316\u3002</li> </ul> </li> </ol>"},{"location":"lab2/#_18","title":"\u5b9e\u9a8c\u4efb\u52a1\u4e0e\u8981\u6c42","text":"<ul> <li>\u8bf7\u5404\u4f4d\u540c\u5b66\u72ec\u7acb\u5b8c\u6210\u4f5c\u4e1a\uff0c\u4efb\u4f55\u6284\u88ad\u884c\u4e3a\u90fd\u5c06\u4f7f\u672c\u6b21\u4f5c\u4e1a\u5224\u4e3a 0 \u5206\u3002</li> <li>\u5728\u5b66\u5728\u6d59\u5927\u4e2d\u63d0\u4ea4\uff1a<ul> <li>\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u7684\u538b\u7f29\u5305\uff08\u63d0\u4ea4\u4e4b\u524d\u8bf7\u4f7f\u7528 <code>make clean</code> \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\uff09</li> <li>pdf \u683c\u5f0f\u7684\u5b9e\u9a8c\u62a5\u544a\uff1a<ul> <li>\u8bb0\u5f55\u5b9e\u9a8c\u8fc7\u7a0b\u5e76\u622a\u56fe\uff084.1-4.3\uff09\uff0c\u5e76\u5bf9\u6bcf\u4e00\u6b65\u7684\u547d\u4ee4\u4ee5\u53ca\u7ed3\u679c\u8fdb\u884c\u5fc5\u8981\u7684\u89e3\u91ca\uff1b</li> <li>\u8bb0\u5f55\u9047\u5230\u7684\u95ee\u9898\u548c\u5fc3\u5f97\u4f53\u4f1a\uff1b</li> <li>\u5b8c\u6210\u601d\u8003\u9898\u3002</li> </ul> </li> </ul> </li> </ul> <p>\u5173\u4e8e\u5b9e\u9a8c\u62a5\u544a\u5185\u5bb9\u8981\u6c42\uff0c\u53ef\u89c1\uff1a\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54 - \u5b9e\u9a8c\u63d0\u4ea4\u8981\u6c42</p>"},{"location":"lab3/","title":"Lab 3: RV64 \u865a\u62df\u5185\u5b58\u7ba1\u7406","text":""},{"location":"lab3/#_1","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<ul> <li>\u5b66\u4e60\u865a\u62df\u5185\u5b58\u7684\u76f8\u5173\u77e5\u8bc6\uff0c\u5b9e\u73b0\u7269\u7406\u5730\u5740\u5230\u865a\u62df\u5730\u5740\u7684\u5207\u6362</li> <li>\u4e86\u89e3 RISC-V \u67b6\u6784\u4e2d SV39 \u5206\u9875\u6a21\u5f0f\uff0c\u5b9e\u73b0\u865a\u62df\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u6620\u5c04\uff0c\u5e76\u5bf9\u4e0d\u540c\u7684\u6bb5\u8fdb\u884c\u76f8\u5e94\u7684\u6743\u9650\u8bbe\u7f6e</li> </ul>"},{"location":"lab3/#_2","title":"\u5b9e\u9a8c\u73af\u5883","text":"<ul> <li>Environment in previous labs</li> </ul>"},{"location":"lab3/#_3","title":"\u80cc\u666f\u77e5\u8bc6","text":""},{"location":"lab3/#_4","title":"\u524d\u8a00","text":"<p>\u5728 Lab2 \u4e2d\u6211\u4eec\u8d4b\u4e88\u4e86\u64cd\u4f5c\u7cfb\u7edf\u5bf9\u591a\u4e2a\u7ebf\u7a0b\u8c03\u5ea6\u4ee5\u53ca\u5e76\u53d1\u6267\u884c\u7684\u80fd\u529b\uff0c\u7531\u4e8e\u76ee\u524d\u8fd9\u4e9b\u7ebf\u7a0b\u90fd\u662f\u5185\u6838\u7ebf\u7a0b\uff0c\u56e0\u6b64\u4ed6\u4eec\u53ef\u4ee5\u5171\u4eab\u8fd0\u884c\u7a7a\u95f4\uff0c\u5373\u8fd0\u884c\u4e0d\u540c\u7ebf\u7a0b\u5bf9\u7a7a\u95f4\u7684\u4fee\u6539\u662f\u76f8\u4e92\u53ef\u89c1\u7684\u3002\u4f46\u662f\u5982\u679c\u6211\u4eec\u9700\u8981\u7ebf\u7a0b\u76f8\u4e92\u9694\u79bb\uff0c\u4ee5\u53ca\u5728\u591a\u7ebf\u7a0b\u7684\u60c5\u51b5\u4e0b\u66f4\u52a0\u9ad8\u6548\u7684\u4f7f\u7528\u5185\u5b58\uff0c\u5c31\u5fc5\u987b\u5f15\u5165\u865a\u62df\u5185\u5b58\u8fd9\u4e2a\u6982\u5ff5\u3002</p> <p>\u865a\u62df\u5185\u5b58\u53ef\u4ee5\u4e3a\u6b63\u5728\u8fd0\u884c\u7684\u8fdb\u7a0b\u63d0\u4f9b\u72ec\u7acb\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u5236\u9020\u4e00\u79cd\u6bcf\u4e2a\u8fdb\u7a0b\u7684\u5185\u5b58\u90fd\u662f\u72ec\u7acb\u7684\u5047\u8c61\u3002\u540c\u65f6\u865a\u62df\u5185\u5b58\u5230\u7269\u7406\u5185\u5b58\u7684\u6620\u5c04\u4e5f\u5305\u542b\u4e86\u5bf9\u5185\u5b58\u7684\u8bbf\u95ee\u6743\u9650\uff0c\u65b9\u4fbf\u5185\u6838\u5b8c\u6210\u6743\u9650\u68c0\u67e5\u3002</p> <p>\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u9700\u8981\u5173\u6ce8\u5185\u6838\u5982\u4f55\u5f00\u542f\u865a\u62df\u5730\u5740\u4ee5\u53ca\u901a\u8fc7\u8bbe\u7f6e\u9875\u8868\u6765\u5b9e\u73b0\u5730\u5740\u6620\u5c04\u548c\u6743\u9650\u63a7\u5236\u3002</p>"},{"location":"lab3/#kernel","title":"Kernel \u7684\u865a\u62df\u5185\u5b58\u5e03\u5c40","text":"<p><pre><code>start_address             end_address\n    0x0                  0x3fffffffff\n     \u2502                        \u2502\n\u250c\u2500\u2500\u2500\u2500\u2518                  \u250c\u2500\u2500\u2500\u2500\u2500\u2518\n\u2193        256G           \u2193                                \n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502      User Space       \u2502    ...   \u2502  Kernel Space  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                   \u2191      256G      \u2191\n                      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                \u2502 \n                      \u2502                             \u2502\n              0xffffffc000000000           0xffffffffffffffff\n                start_address                  end_address\n</code></pre> \u901a\u8fc7\u4e0a\u56fe\u6211\u4eec\u53ef\u4ee5\u770b\u5230 RV64 \u5c06 <code>0x0000004000000000</code> \u4ee5\u4e0b\u7684\u865a\u62df\u7a7a\u95f4\u4f5c\u4e3a <code>user space</code>\u3002\u5c06 <code>0xffffffc000000000</code> \u53ca\u4ee5\u4e0a\u7684\u865a\u62df\u7a7a\u95f4\u4f5c\u4e3a <code>kernel space</code>\u3002\u7531\u4e8e\u6211\u4eec\u8fd8\u672a\u5f15\u5165\u7528\u6237\u6001\u7a0b\u5e8f\uff0c\u76ee\u524d\u6211\u4eec\u53ea\u9700\u8981\u5173\u6ce8 <code>kernel space</code>\u3002</p> <p>\u672c\u6b21\u5b9e\u9a8c\u4f7f\u7528\u7684\u865a\u62df\u5185\u5b58\u5e03\u5c40\u4e3a RISC-V Linux Kernel v5.16 \u524d Sv39 \u7684\u5185\u5b58\u5e03\u5c40\uff0c\u5177\u4f53\u7684\u865a\u62df\u5185\u5b58\u5e03\u5c40\u53ef\u4ee5\u53c2\u8003 Linux v5.15 \u6587\u6863\u3002</p> <p>\u5728 <code>RISC-V Linux Kernel Space</code> \u4e2d\u6709\u4e00\u6bb5\u865a\u62df\u5730\u5740\u7a7a\u95f4\u4e2d\u7684\u533a\u57df\u88ab\u79f0\u4e3a <code>direct mapping area</code>\uff0c\u4e3a\u4e86\u65b9\u4fbf\u8bbf\u95ee\u5185\u5b58\uff0c\u5185\u6838\u4f1a\u9884\u5148\u628a\u6240\u6709\u7269\u7406\u5185\u5b58\u90fd\u6620\u5c04\u81f3\u8fd9\u4e00\u5757\u533a\u57df\uff0c\u8fd9\u79cd\u6620\u5c04\u4e5f\u88ab\u79f0\u4e3a <code>linear mapping</code>\uff0c\u56e0\u4e3a\u8be5\u6620\u5c04\u65b9\u5f0f\u5c31\u662f\u5728\u7269\u7406\u5730\u5740\u4e0a\u6dfb\u52a0\u4e00\u4e2a\u504f\u79fb\uff0c\u4f7f\u5f97 <code>VA = PA + PA2VA_OFFSET</code>\u3002\u5728 RISC-V Linux Kernel \u4e2d\u8fd9\u4e00\u6bb5\u533a\u57df\u4e3a <code>0xffffffe000000000 ~ 0xffffffff00000000</code>\uff0c\u5171 124 GB</p>"},{"location":"lab3/#risc-v-sv39","title":"RISC-V Sv39 \u5206\u9875\u6a21\u5f0f","text":"<p>\u540c lab1\uff0c\u5bf9\u4e8e\u672c\u90e8\u5206\u77e5\u8bc6\u7684\u5b66\u4e60\u4e0d\u53ef\u8df3\u8fc7\u9605\u8bfb sepc \u8fd9\u4e00\u6b65\u9aa4</p> <p>RISC-V \u865a\u62df\u5185\u5b58\u76f8\u5173\u7684\u5185\u5bb9\u5728 RISC-V Privileged Spec \u4e2d\u3002</p> <p>\u5176\u4e2d\u7b2c 10.1.11 \u8282\u4ecb\u7ecd\u4e86 satp \u5bc4\u5b58\u5668\uff0c10.2.1 \u8282\u4e2d\u5305\u62ec\u4e86\u672c\u5b9e\u9a8c\u4e2d\u4f1a\u7528\u5230\u7684\u4e00\u6761\u65b0\u6307\u4ee4 sfence.vma \u7684\u4ecb\u7ecd\uff0c10.3-10.6 \u8282\u5206\u522b\u4ecb\u7ecd\u4e86 Sv32\u3001Sv39\u3001Sv48\u3001Sv57\uff0c\u5176\u4e2d Sv32 \u4e3a\u7cbe\u8bb2\uff0c\u540e\u4e09\u8005\u5747\u540c\u7406\u5e26\u8fc7\u3002\u6240\u4ee5\u9700\u8981\u540c\u5b66\u4eec\u8be6\u7ec6\u9605\u8bfb\u7b2c 10.1.11 \u8282\u548c\u7b2c 10.3\u300110.4 \u8282\u3002</p>"},{"location":"lab3/#satp","title":"<code>satp</code> \u5bc4\u5b58\u5668","text":"<p>satp\uff08Supervisor Address Translation and Protection Register\uff09\u662f RISC-V \u4e2d\u63a7\u5236\u865a\u62df\u5185\u5b58\u5206\u9875\u6a21\u5f0f\u7684\u5bc4\u5b58\u5668\uff0c\u5176\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code> 63      60 59                  44 43                                0\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   MODE   \u2502         ASID         \u2502                PPN                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <ul> <li> <p>MODE \u5b57\u6bb5\u7684\u53d6\u503c\u5982\u4e0b\u56fe\uff1a <pre><code>                        RV 64\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Value  \u2502  Name  \u2502  Description                          \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502    0    \u2502 Bare   \u2502 No translation or protection          \u2502\n\u2502  1 - 7  \u2502 ---    \u2502 Reserved for standard use             \u2502\n\u2502    8    \u2502 Sv39   \u2502 Page-based 39 bit virtual addressing  \u2502 &lt;-- \u6211\u4eec\u4f7f\u7528\u7684 mode\n\u2502    9    \u2502 Sv48   \u2502 Page-based 48 bit virtual addressing  \u2502\n\u2502    10   \u2502 Sv57   \u2502 Page-based 57 bit virtual addressing  \u2502\n\u2502    11   \u2502 Sv64   \u2502 Page-based 64 bit virtual addressing  \u2502\n\u2502 12 - 13 \u2502 ---    \u2502 Reserved for standard use             \u2502\n\u2502 14 - 15 \u2502 ---    \u2502 Reserved for standard use             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre></p> </li> <li> <p>ASID (Address Space Identifier)\uff1a\u6b64\u6b21\u5b9e\u9a8c\u4e2d\u76f4\u63a5\u7f6e 0 \u5373\u53ef</p> </li> <li>PPN (Physical Page Number)\uff1a\u9876\u7ea7\u9875\u8868\u7684\u7269\u7406\u9875\u53f7\u3002\u6211\u4eec\u7684\u7269\u7406\u9875\u7684\u5927\u5c0f\u4e3a 4KB\uff0c <code>PA &gt;&gt; 12 == PPN</code></li> </ul> <p>\u5177\u4f53\u4ecb\u7ecd\u8bf7\u9605\u8bfb RISC-V Privileged Spec \u7684\u7b2c 10.1.11 \u8282</p>"},{"location":"lab3/#sv39","title":"Sv39 \u865a\u62df\u5730\u5740\u548c\u7269\u7406\u5730\u5740","text":"<pre><code> 38        30 29        21 20        12 11                           0\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   VPN[2]   \u2502   VPN[1]   \u2502   VPN[0]   \u2502          page offset         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                        Sv39 virtual address\n</code></pre> <pre><code> 55                30 29        21 20        12 11                           0\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502       PPN[2]       \u2502   PPN[1]   \u2502   PPN[0]   \u2502          page offset         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                            Sv39 physical address\n</code></pre> <ul> <li>Sv39 \u6a21\u5f0f\u5b9a\u4e49\u7269\u7406\u5730\u5740\u6709 56 \u4f4d\uff0c\u865a\u62df\u5730\u5740\u6709 64 \u4f4d<ul> <li>\u865a\u62df\u5730\u5740\u7684 64 \u4f4d\u53ea\u6709\u4f4e 39 \u4f4d\u6709\u6548\uff0c\u5176 63-39 \u4f4d\u4e3a 0 \u65f6\u4ee3\u8868 user space address\uff0c\u4e3a 1 \u65f6\u4ee3\u8868 kernel space address</li> </ul> </li> <li>Sv39 \u652f\u6301\u4e09\u7ea7\u9875\u8868\u7ed3\u6784\uff0c<code>VPN[2] VPN[1] VPN[0]</code> (Virtual Page Number) \u5206\u522b\u4ee3\u8868\u6bcf\u7ea7\u9875\u8868\u7684\u865a\u62df\u9875\u53f7\uff0c<code>PPN[2] PPN[1] PPN[0]</code> (Physical Page Number) \u5206\u522b\u4ee3\u8868\u6bcf\u7ea7\u9875\u8868\u7684\u7269\u7406\u9875\u53f7\uff0c\u7269\u7406\u5730\u5740\u548c\u865a\u62df\u5730\u5740\u7684\u4f4e 12 \u4f4d\u8868\u793a\u9875\u5185\u504f\u79fb\uff08page offset\uff09</li> </ul> <p>\u5177\u4f53\u4ecb\u7ecd\u8bf7\u9605\u8bfb RISC-V Privileged Spec \u7684\u7b2c 10.4.1 \u8282</p>"},{"location":"lab3/#sv39_1","title":"Sv39 \u9875\u8868\u9879","text":"<pre><code> 63      54 53        28 27        19 18        10 9   8 7 6 5 4 3 2 1 0\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u252c\u2500\u252c\u2500\u252c\u2500\u252c\u2500\u252c\u2500\u252c\u2500\u252c\u2500\u2510\n\u2502 Reserved \u2502   PPN[2]   \u2502   PPN[1]   \u2502   PPN[0]   \u2502 RSW \u2502D\u2502A\u2502G\u2502U\u2502X\u2502W\u2502R\u2502V\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2534\u2500\u2534\u2500\u2534\u2500\u2534\u2500\u2534\u2500\u2534\u2500\u2534\u2500\u2518\n                                                     \u2502   \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502\n                                                     \u2502   \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500 V - Valid\n                                                     \u2502   \u2502 \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500 R - Readable\n                                                     \u2502   \u2502 \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 W - Writable\n                                                     \u2502   \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 X - Executable\n                                                     \u2502   \u2502 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 U - User\n                                                     \u2502   \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 G - Global\n                                                     \u2502   \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 A - Accessed\n                                                     \u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 D - Dirty (0 in page directory)\n                                                     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Reserved for supervisor software\n</code></pre> <p>\u4e00\u4e9b\u5e38\u7528\u7684\u4f4d\u7684\u542b\u4e49\u5982\u4e0b\uff1a</p> <ul> <li>V\uff1a\u6709\u6548\u4f4d\uff0c\u5f53 V = 0\uff0c\u8bbf\u95ee\u8be5 PTE \u4f1a\u4ea7\u751f Page Fault</li> <li>R\uff1aR = 1 \u8be5\u9875\u53ef\u8bfb</li> <li>W\uff1aW = 1 \u8be5\u9875\u53ef\u5199</li> <li>X\uff1aX = 1 \u8be5\u9875\u53ef\u6267\u884c</li> <li>U\uff0cG\uff0cA\uff0cD\uff0cRSW \u672c\u6b21\u5b9e\u9a8c\u4e2d\u8bbe\u7f6e\u4e3a 0 \u5373\u53ef</li> </ul> <p>\u6b64\u5916\uff0c\u9700\u8981\u6ce8\u610f\uff0c\u5f53 RWX \u4e09\u4f4d\u5747\u4e3a 0 \u65f6\uff0c\u8be5\u9875\u8868\u9879\u4e0d\u4e3a\u53f6\u5b50\u8282\u70b9\uff0c\u800c\u662f\u6307\u5411\u4e0b\u4e00\u7ea7\u9875\u8868\u7684\u9875\u8868\u9879\u3002\u5177\u4f53\u53ef\u89c1 RISC-V Privileged Spec \u7684\u7b2c 10.3.1 \u8282</p> <p>\u5177\u4f53\u4ecb\u7ecd\u8bf7\u9605\u8bfb RISC-V Privileged Spec \u7684\u7b2c 10.4.1 \u8282</p> <p>\u5982\u679c\u4f60\u5728\u4f7f\u7528 spike \u5de5\u5177\u94fe\uff0c\u7531\u4e8e spike \u5bf9\u4e8e\u9875\u8868\u9879\u7684\u68c0\u67e5\u66f4\u4e3a\u4e25\u683c\uff0c\u6240\u4ee5\u9700\u8981\u4f60\u4ed4\u7ec6\u9605\u8bfb spec \u7684\u7b2c 10.3.1 \u8282\u5b8c\u6210\u5bf9 A \u548c D \u4e24\u4f4d\u7684\u8bbe\u7f6e\u624d\u80fd\u6b63\u5e38\u8fd0\u884c</p>"},{"location":"lab3/#sv39_2","title":"Sv39 \u865a\u62df\u5730\u5740\u8f6c\u6362","text":"<p>\u865a\u62df\u5730\u5740\u8f6c\u5316\u4e3a\u7269\u7406\u5730\u5740\u6d41\u7a0b\u56fe\u5982\u4e0b\uff0c\u5177\u4f53\u63cf\u8ff0\u89c1 RISC-V Privileged Spec \u7684\u7b2c 10.3.2 \u8282\u5bf9\u4e8e Sv32 \u6a21\u5f0f\u7684\u63cf\u8ff0\u5e76\u7c7b\u63a8\u81f3 Sv39\uff1a</p> <pre><code>                                Virtual Address                                     Physical Address\n\n                          9             9            9              12          55        12 11       0\n   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2502                \u2502   VPN[2]   \u2502   VPN[1]   \u2502   VPN[0]    \u2502     OFFSET     \u2502 \u2502     PPN    \u2502  OFFSET  \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                         \u2502             \u2502             \u2502              \u2502                 \u25b2          \u25b2\n                         \u2502             \u2502             \u2502              \u2502                 \u2502          \u2502\n                         \u2502             \u2502             \u2502              \u2502                 \u2502          \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2502             \u2502              \u2502                 \u2502          \u2502\n\u2502                                      \u2502             \u2502              \u2502                 \u2502          \u2502\n\u2502                                      \u2502             \u2502              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u2502    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510               \u2502             \u2502                                \u2502\n\u2502511 \u2502                 \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2502                                \u2502\n\u2502    \u2502                 \u2502  \u2502                          \u2502                                \u2502\n\u2502    \u2502                 \u2502  \u2502     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502                                \u2502\n\u2502    \u2502                 \u2502  \u2502 511 \u2502                 \u2502  \u2502                                \u2502\n\u2502    \u2502                 \u2502  \u2502     \u2502                 \u2502  \u2502                                \u2502\n\u2502    \u2502                 \u2502  \u2502     \u2502                 \u2502  \u2502     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u2502\n\u2502    \u2502   44       10   \u2502  \u2502     \u2502                 \u2502  \u2502 511 \u2502                 \u2502        \u2502\n\u2502    \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524  \u2502     \u2502                 \u2502  \u2502     \u2502                 \u2502        \u2502\n\u2514\u2500\u2500\u2500\u25ba\u2502   PPN  \u2502  flags \u2502  \u2502     \u2502                 \u2502  \u2502     \u2502                 \u2502        \u2502\n     \u251c\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524  \u2502     \u2502   44       10   \u2502  \u2502     \u2502                 \u2502        \u2502\n     \u2502    \u2502            \u2502  \u2502     \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524  \u2502     \u2502                 \u2502        \u2502\n     \u2502    \u2502            \u2502  \u2514\u2500\u2500\u2500\u2500\u25ba\u2502   PPN  \u2502  flags \u2502  \u2502     \u2502                 \u2502        \u2502\n     \u2502    \u2502            \u2502        \u251c\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524  \u2502     \u2502   44       10   \u2502        \u2502\n     \u2502    \u2502            \u2502        \u2502    \u2502            \u2502  \u2502     \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524        \u2502\n   1 \u2502    \u2502            \u2502        \u2502    \u2502            \u2502  \u2514\u2500\u2500\u2500\u2500\u25ba\u2502   PPN  \u2502  flags \u2502        \u2502\n     \u2502    \u2502            \u2502        \u2502    \u2502            \u2502        \u251c\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524        \u2502\n   0 \u2502    \u2502            \u2502        \u2502    \u2502            \u2502        \u2502    \u2502            \u2502        \u2502\n     \u2514\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      1 \u2502    \u2502            \u2502        \u2502    \u2502            \u2502        \u2502\n     \u25b2    \u2502                     \u2502    \u2502            \u2502        \u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502    \u2502                   0 \u2502    \u2502            \u2502        \u2502                 \u2502\n     \u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2514\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      1 \u2502                 \u2502\n     \u2502                               \u2502                     \u2502                 \u2502\n \u250c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2510                          \u2502                   0 \u2502                 \u2502\n \u2502  satp  \u2502                          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"lab3/#_5","title":"\u5b9e\u9a8c\u6b65\u9aa4","text":""},{"location":"lab3/#_6","title":"\u51c6\u5907\u5de5\u7a0b","text":"<p>\u6b64\u6b21\u5b9e\u9a8c\u57fa\u4e8e lab3 \u540c\u5b66\u6240\u5b9e\u73b0\u7684\u4ee3\u7801\u8fdb\u884c\u3002</p> <ul> <li>\u9700\u8981\u4fee\u6539 <code>defs.h</code>\uff0c\u5728 <code>defs.h</code> \u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a     <pre><code>#define OPENSBI_SIZE (0x200000)\n\n#define VM_START (0xffffffe000000000)\n#define VM_END (0xffffffff00000000)\n#define VM_SIZE (VM_END - VM_START)\n\n#define PA2VA_OFFSET (VM_START - PHY_START)\n</code></pre></li> <li>\u4ece\u672c\u4ed3\u5e93\u540c\u6b65 <code>vmlinux.lds</code> \u4ee3\u7801\uff0c\u5e76\u6309\u7167\u4ee5\u4e0b\u6b65\u9aa4\u5c06\u8fd9\u4e9b\u6587\u4ef6\u6b63\u786e\u653e\u7f6e\u3002     <pre><code>.\n\u2514\u2500\u2500 arch\n    \u2514\u2500\u2500 riscv\n        \u2514\u2500\u2500 kernel\n            \u2514\u2500\u2500 vmlinux.lds\n</code></pre><ul> <li>\u65b0\u7684\u94fe\u63a5\u811a\u672c\u4e2d\u7684 <code>ramv</code> \u4ee3\u8868 <code>VMA</code> (Virtual Memory Address) \u5373\u865a\u62df\u5730\u5740\uff0c<code>ram</code> \u5219\u4ee3\u8868 <code>LMA</code> (Load Memory Address)\uff0c\u5373\u6211\u4eec OS image \u88ab load \u7684\u5730\u5740\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u7269\u7406\u5730\u5740</li> <li>\u4f7f\u7528\u4ee5\u4e0a\u7684 vmlinux.lds \u8fdb\u884c\u7f16\u8bd1\u4e4b\u540e\uff0c\u5f97\u5230\u7684 <code>System.map</code> \u4ee5\u53ca <code>vmlinux</code> \u4e2d\u7684\u7b26\u53f7\u91c7\u7528\u7684\u90fd\u662f\u865a\u62df\u5730\u5740\uff0c\u65b9\u4fbf\u4e4b\u540e debug</li> </ul> </li> </ul>"},{"location":"lab3/#pie","title":"\u5173\u4e8e PIE","text":"<p>\u5728\u5f00\u59cb\u5b9e\u9a8c\u5f00\u542f\u865a\u62df\u5730\u5740\u4e4b\u524d\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u5bf9 Makefile \u8fdb\u884c\u4e00\u4e9b\u4fee\u6539\u6765\u9632\u6b62\u540e\u9762\u8fd0\u884c/\u8c03\u8bd5\u51fa\u73b0\u95ee\u9898\u3002\u5982\u679c\u5927\u5bb6\u89c2\u5bdf\u8fc7\u4e4b\u524d\u7684 lab \u7f16\u8bd1\u540e\u518d\u7ecf\u8fc7 objdump \u53cd\u6c47\u7f16\u7684\u7ed3\u679c\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0 head.S \u7684\u7b2c\u4e00\u53e5\u8bbe\u7f6e\u6808\u7684\u6c47\u7f16\u4ee3\u7801\u88ab\u7ffb\u8bd1\u6210\u4e86\u201c\u5947\u602a\u201d\u7684\u4e1c\u897f\uff1a</p> <pre><code>    la sp, boot_stack_top\n    80200000:   00003117            auipc   sp,0x3\n    80200004:   02013103            ld  sp,32(sp) # 80203020 &lt;_GLOBAL_OFFSET_TABLE_+0x18&gt;\n</code></pre> <p>\u4f60\u53ef\u80fd\u597d\u5947\u8fc7\u8fd9\u91cc\u4e3a\u4ec0\u4e48\u8981\u5427 <code>boot_stack_top</code> \u7684\u5730\u5740 ld \u51fa\u6765\uff0c\u800c\u4e14\u662f\u4ece\u54ea\u91cc ld \u51fa\u6765\u7684\u3002\u7b54\u6848 objdump \u7684\u6ce8\u91ca\u5df2\u7ecf\u7ed9\u51fa\u4e86\uff0c\u662f\u4ece\u4e00\u4e2a\u53eb <code>_GLOBAL_OFFSET_TABLE_</code> \u7684\u5730\u65b9\u53d6\u51fa\u6765\u7684\uff0c\u8fd9\u4e5f\u5c31\u662f\u4f60\u53ef\u80fd\u542c\u8bf4\u8fc7\u7684 GOT \u8868\uff08\u5168\u5c40\u504f\u79fb\u8868\uff09\uff0c\u6709\u4e86\u5b83\u5c31\u53ef\u4ee5\u5b9e\u73b0 PIE\uff08\u4f4d\u7f6e\u65e0\u5173\u6267\u884c\uff09\u4e86\uff0c\u5728\u6bcf\u6b21\u53d6\u5730\u5740\u7684\u65f6\u5019\uff0c\u53ea\u8981\u901a\u8fc7 GOT \u8868\u6765\u53d6\uff0c\u5c31\u53ef\u4ee5\u4f7f\u5f97\u5373\u4f7f\u4ee3\u7801\u88ab\u653e\u5728\u4e0d\u540c\u5730\u5740\u6267\u884c\uff0c\u4e5f\u53ef\u4ee5\u53d6\u5230\u6b63\u786e\u7684\u5730\u5740\u3002</p> <p>\u5f53\u7136\uff0c\u5728\u6211\u4eec\u5b9e\u73b0 kernel \u7684\u65f6\u5019\uff0c\u6240\u6709\u7684\u5730\u5740\u90fd\u662f\u4e0d\u53d8\u7684\uff0c\u4ee3\u7801\u4e5f\u59cb\u7ec8\u4f1a\u88ab load \u5230 0x80200000 \u7684\u5730\u65b9\uff0c\u56e0\u6b64\u8fd9\u4e2a PIE \u5bf9\u6211\u4eec\u5e76\u6ca1\u6709\u4f5c\u7528\u3002\u76f8\u53cd\uff0c\u5728\u672c\u6b21\u8bd5\u9a8c\u4e2d\u5b83\u8fd8\u4f1a\u6709\u526f\u4f5c\u7528\uff0c\u56e0\u4e3a GOT \u8868\u91cc\u7684\u5730\u5740\u90fd\u662f\u6700\u7ec8\u7684\u865a\u62df\u5730\u5740\uff0c\u6240\u4ee5\u5728 kernel \u542f\u7528\u865a\u62df\u5730\u5740\u4e4b\u524d\uff0c\u4e00\u5207\u4ece GOT \u8868\u53d6\u51fa\u7684\u5730\u5740\u90fd\u662f\u9519\u7684\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\u9700\u8981\u624b\u52a8\u7ed9 <code>la</code> \u5f97\u5230\u7684\u5730\u5740\u51cf\u53bb <code>PA2VA_OFFSET</code> \u624d\u80fd\u5f97\u5230\u6b63\u786e\u7684\u7269\u7406\u5730\u5740\u3002</p> <p>\u4e3a\u4e86\u907f\u514d\u8fd9\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5173\u6389 PIE\uff0c\u53ea\u9700\u8981\u5728 Makefile \u7684 <code>CF</code> \u4e2d\u52a0\u4e00\u4e2a <code>-fno-pie</code> \u5c31\u53ef\u4ee5\u5f3a\u5236\u4e0d\u7f16\u8bd1\u51fa PIE \u7684\u4ee3\u7801\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u7b2c\u4e00\u53e5\u7684\u6c47\u7f16\u4ee3\u7801\u4f1a\u88ab\u7f16\u8bd1\u6210\uff1a</p> <pre><code>    la sp, boot_stack_top\n    80200000:   00005117            auipc   sp,0x5\n    80200004:   00010113            mv  sp,sp\n</code></pre> <p>\u5b83\u76f4\u63a5\u4f7f\u7528 <code>auipc</code> \u6839\u636e\u76ee\u6807\u57fa\u4e8e\u5f53\u524d pc \u7684\u504f\u79fb\u5c31\u80fd\u8ba1\u7b97\u51fa\u6b63\u786e\u7684\u5730\u5740\uff0c\u800c\u4e14\u8fd9\u79cd\u4ee3\u7801\u4e0d\u7ba1\u662f\u5426\u542f\u7528\u4e86\u865a\u62df\u5730\u5740\uff0c\u90fd\u662f\u6709\u6548\u7684\u3002\u56e0\u6b64\u5728\u5b9e\u9a8c\u5f00\u59cb\u524d\uff0c\u8bf7\u540c\u5b66\u4eec\u5728 Makefile \u4e2d\u52a0\u4e0a <code>-fno-pie</code>\u3002</p>"},{"location":"lab3/#_7","title":"\u5f00\u542f\u865a\u62df\u5185\u5b58\u6620\u5c04","text":"<p>\u5728 RISC-V \u4e2d\u5f00\u542f\u865a\u62df\u5730\u5740\u88ab\u5206\u4e3a\u4e86\u4e24\u6b65\uff1a<code>setup_vm</code> \u4ee5\u53ca <code>setup_vm_final</code>\uff0c\u4e0b\u9762\u5c06\u4ecb\u7ecd\u76f8\u5173\u7684\u5177\u4f53\u5b9e\u73b0\u3002</p>"},{"location":"lab3/#setup_vm","title":"<code>setup_vm</code> \u7684\u5b9e\u73b0","text":"<ul> <li>\u5c06 0x80000000 \u5f00\u59cb\u7684 1GB \u533a\u57df\u8fdb\u884c\u4e24\u6b21\u6620\u5c04\uff0c\u5176\u4e2d\u4e00\u6b21\u662f\u7b49\u503c\u6620\u5c04\uff08PA == VA\uff09\uff0c\u53e6\u4e00\u6b21\u662f\u5c06\u5176\u6620\u5c04\u5230 <code>direct mapping area</code>\uff08\u4f7f\u5f97 <code>PA + PV2VA_OFFSET == VA</code>\uff09\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a   <pre><code>Physical Address\n-------------------------------------------\n                     | OpenSBI | Kernel |\n-------------------------------------------\n                     \u2191\n                0x80000000\n                     \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                     |                                                   |\nVirtual Address      \u2193                                                   \u2193\n-----------------------------------------------------------------------------------------------\n                     | OpenSBI | Kernel |                                | OpenSBI | Kernel |\n-----------------------------------------------------------------------------------------------\n                     \u2191                                                   \u2191\n                0x80000000                                       0xffffffe000000000\n</code></pre></li> <li>\u5b8c\u6210\u4e0a\u8ff0\u6620\u5c04\u4e4b\u540e\uff0c\u901a\u8fc7 <code>relocate</code> \u51fd\u6570\uff0c\u5b8c\u6210\u5bf9 <code>satp</code> \u7684\u8bbe\u7f6e\uff0c\u4ee5\u53ca\u8df3\u8f6c\u5230\u5bf9\u5e94\u7684\u865a\u62df\u5730\u5740</li> <li>\u81f3\u6b64\u6211\u4eec\u5df2\u7ecf\u5b8c\u6210\u4e86\u865a\u62df\u5730\u5740\u7684\u5f00\u542f\uff0c\u4e4b\u540e\u6211\u4eec\u8fd0\u884c\u7684\u4ee3\u7801\u4e5f\u90fd\u5c06\u5728\u865a\u62df\u5730\u5740\u4e0a\u8fd0\u884c</li> </ul> arch/riscv/kernel/vm.c<pre><code>/* early_pgtbl: \u7528\u4e8e setup_vm \u8fdb\u884c 1GiB \u7684\u6620\u5c04 */\nuint64_t early_pgtbl[512] __attribute__((__aligned__(0x1000)));\n\nvoid setup_vm() {\n    /* \n     * 1. \u7531\u4e8e\u662f\u8fdb\u884c 1GiB \u7684\u6620\u5c04\uff0c\u8fd9\u91cc\u4e0d\u9700\u8981\u4f7f\u7528\u591a\u7ea7\u9875\u8868 \n     * 2. \u5c06 va \u7684 64bit \u4f5c\u4e3a\u5982\u4e0b\u5212\u5206\uff1a | high bit | 9 bit | 30 bit |\n     *     high bit \u53ef\u4ee5\u5ffd\u7565\n     *     \u4e2d\u95f4 9 bit \u4f5c\u4e3a early_pgtbl \u7684 index\n     *     \u4f4e 30 bit \u4f5c\u4e3a\u9875\u5185\u504f\u79fb\uff0c\u8fd9\u91cc\u6ce8\u610f\u5230 30 = 9 + 9 + 12\uff0c\u5373\u6211\u4eec\u53ea\u4f7f\u7528\u6839\u9875\u8868\uff0c\u6839\u9875\u8868\u7684\u6bcf\u4e2a entry \u90fd\u5bf9\u5e94 1GiB \u7684\u533a\u57df\n     * 3. Page Table Entry \u7684\u6743\u9650 V | R | W | X \u4f4d\u8bbe\u7f6e\u4e3a 1\n    **/\n}\n</code></pre> arch/riscv/kernel/head.S<pre><code>_start:\n    ...\n    call setup_vm\n    call relocate\n    ...\n\n\nrelocate:\n    # set ra = ra + PA2VA_OFFSET\n    # set sp = sp + PA2VA_OFFSET (If you have set the sp before)\n\n    ###################### \n    #   YOUR CODE HERE   #\n    ######################\n\n    # need a fence to ensure the new translations are in use\n    sfence.vma zero, zero\n\n    # set satp with early_pgtbl\n\n    ###################### \n    #   YOUR CODE HERE   #\n    ######################\n\n    ret\n\n    .section .bss.stack\n    .globl boot_stack\nboot_stack:\n    ...\n</code></pre> <p>\u7ecf\u8fc7 <code>setup_vm</code> \u8bbe\u7f6e\u4e86\u4e00\u7ea7\u9875\u8868\u4e4b\u540e\uff0c\u6574\u4e2a kernel \u542f\u52a8\u540e\u5e94\u8be5\u53ef\u4ee5\u76f4\u63a5\u8fd0\u884c\u5728\u865a\u62df\u5730\u5740\u4e0a\u4e86\uff0c\u4e0d\u8fc7\u5728 <code>task_init</code> \u4e2d <code>kalloc</code> \u7684\u65f6\u5019\u53ef\u80fd\u4f1a\u51fa\u73b0\u9519\u8bef\uff0c\u56e0\u4e3a <code>mm_init</code> \u4e2d\u6211\u4eec\u91ca\u653e\u7684\u5185\u5b58\u662f <code>_ekernel ~ PHY_END</code>\uff0c\u5728\u8fdb\u5165\u865a\u62df\u5730\u5740\u540e <code>PHY_END</code> \u8fd8\u662f\u7269\u7406\u5730\u5740\uff0c\u4f1a\u5bfc\u81f4\u5b9e\u9645\u4e0a\u6ca1\u6709\u5185\u5b58\u88ab\u91ca\u653e\uff0c<code>kalloc</code> \u6ca1\u6709\u53ef\u7528\u7684\u7a7a\u95f4\u3002\u56e0\u6b64\u9700\u8981\u4fee\u6539 <code>arch/riscv/kernel/mm.c</code> \u7684 <code>mm_init</code> \u51fd\u6570\uff0c\u5c06\u7ed3\u675f\u5730\u5740\u8c03\u6574\u4e3a\u865a\u62df\u5730\u5740\uff0c\u624d\u80fd\u6b63\u5e38\u8fd0\u884c\u3002</p> \u5bf9 <code>sfence.vma</code> \u548c <code>fence.i</code> \u8bed\u4e49\u7684\u8be6\u7ec6\u8bf4\u660e <p>\u5728 10 \u6708 30 \u65e5\u7684 commit \u4e2d\uff0c\u53bb\u9664\u4e86 <code>fence.i</code>\uff0c\u5e76\u8c03\u6574\u4e86 <code>sfence.vma</code> \u7684\u987a\u5e8f\uff0c\u4e0e Linux \u5185\u6838\u6e90\u7801\u4fdd\u6301\u4e00\u81f4\uff0c\u4ee5\u907f\u514d\u540c\u5b66\u4eec\u9605\u8bfb\u5185\u6838\u6e90\u7801\u65f6\u4ea7\u751f\u56f0\u60d1\u3002\u540c\u5b66\u4eec\u53ef\u80fd\u4f1a\u597d\u5947\u5176\u4e2d\u7684\u5177\u4f53\u539f\u7406\uff0c\u8fd9\u91cc\u7b80\u5355\u8bf4\u660e\u4e00\u4e0b\u3002</p> <p>\u9996\u5148\u770b RISC-V Privileged Spec \u4e2d\u5bf9 <code>sfence.vma</code> \u7684\u63cf\u8ff0\uff1a</p> <p>It is specified as a fence rather than a TLB flush to provide cleaner semantics with respect to which instructions are affected by the flush operation and to support a wider variety of dynamic caching structures and memory-management schemes.</p> <p>\u63a5\u4e0b\u6765\u770b Linux \u5185\u6838\u6e90\u7801\uff08v5.2.21\uff09\uff1a</p> <pre><code>/*\n * Load trampoline page directory, which will cause us to trap to\n * stvec if VA != PA, or simply fall through if VA == PA.  We need a\n * full fence here because setup_vm() just wrote these PTEs and we need\n * to ensure the new translations are in use.\n */\nsfence.vma\ncsrw CSR_SATP, a0\n</code></pre> <p>\u4e0e\u5b9e\u9a8c\u6307\u5bfc\u7684\u521d\u7248\u4ee3\u7801\u76f8\u6bd4\uff0c\u8fd9\u91cc\u6709\u4e09\u4e2a\u95ee\u9898\uff1a\u4e3a\u4ec0\u4e48\u8981\u5728 <code>csrw satp</code> \u4e4b\u524d\u52a0\u4e00\u4e2a <code>sfence.vma</code>\uff1f\u4e3a\u4ec0\u4e48\u540e\u9762\u4e0d\u9700\u8981\u52a0 <code>sfence.vma</code>\uff1f\u4e3a\u4ec0\u4e48\u4e0d\u9700\u8981 <code>fence.i</code>\uff1f</p> <ol> <li>\u7b2c\u4e00\u4e2a\u95ee\u9898\u7531\u4e0a\u9762\u4ee3\u7801\u6bb5\u7684\u6ce8\u91ca\u89e3\u7b54\uff1a<code>csrw satp</code> \u524d\u7684 <code>sfence.vma</code> \u4e3b\u8981\u662f\u4e3a\u4e86\u4fdd\u8bc1\u65b0\u7684\u9875\u8868\u9879\u751f\u6548\u800c\u8bbe\u7f6e\u7684\u4e00\u4e2a fence\uff0c\u800c\u6ca1\u6709\u7528\u5230\u5176\u5237\u65b0 TLB \u7684\u529f\u80fd\uff0c\u6bd5\u7adf\u8fd9\u91cc\u624d\u521a\u521a\u542f\u7528 MMU\u3002\u90a3\u4e48\u4e3a\u4ec0\u4e48\u8981\u4fdd\u8bc1\u9875\u8868\u9879\u751f\u6548\u5462\uff1f\u8fd9\u6d89\u53ca\u601d\u8003\u9898 2 \u7684\u7b54\u6848\uff0c\u5728\u6b64\u6309\u4e0b\u4e0d\u8868\u3002</li> <li> <p>\u7b2c\u4e8c\u4e2a\u95ee\u9898\u7531 RISC-V Privileged Spec 10.3 \u8282\u4e2d\u7684\u4e00\u6bb5\u8bdd\u89e3\u7b54\uff1a</p> <p>Changing <code>satp.MODE</code> from <code>Bare</code> to other modes and vice versa also takes effect immediately, without the need to execute an <code>sfence.vma</code> instruction.</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u542f\u7528\u6216\u5173\u95ed\u5206\u9875\u6a21\u5f0f\u65f6\u7684\u64cd\u4f5c\u7acb\u5373\u751f\u6548\uff0c\u4e0d\u9700\u8981\u989d\u5916\u7684 <code>sfence.vma</code>\u3002</p> </li> <li> <p>\u7b2c\u4e09\u4e2a\u95ee\u9898\u7531 Linux \u5185\u6838\u6e90\u7801 <code>local_flush_tlb_all</code> \u4e2d\u7684\u6ce8\u91ca\u89e3\u7b54\uff1a</p> <pre><code>/*\n* Flush entire local TLB.  'sfence.vma' implicitly fences with the instruction\n* cache as well, so a 'fence.i' is not necessary.\n*/\nstatic inline void local_flush_tlb_all(void)\n{\n    __asm__ __volatile__ (\"sfence.vma\" : : : \"memory\");\n}\n</code></pre> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c<code>sfence.vma</code> \u4f1a\u9690\u5f0f\u5730\u5237\u65b0\u6307\u4ee4\u7f13\u5b58\uff0c\u56e0\u6b64\u4e0d\u9700\u8981\u989d\u5916\u7684 <code>fence.i</code>\u3002</p> <p>\u4f60\u53ef\u80fd\u4f1a\u597d\u5947\u4ec0\u4e48\u65f6\u5019\u624d\u4f1a\u4f7f\u7528 <code>fence.i</code>\u3002\u5728 Linux \u6e90\u7801\u4e2d\u641c\u7d22\uff0c\u53ef\u4ee5\u53d1\u73b0\u4e3b\u8981\u7528\u5728\u8fdb\u7a0b\u8c03\u5ea6\u3002\u56e0\u4e3a\u9700\u8981\u8ba9\u65b0\u8fdb\u7a0b\u7684\u6307\u4ee4\u66ff\u6362\u6389\u65e7\u8fdb\u7a0b\u7684\u7f13\u5b58\uff0c\u6b64\u65f6\u4f1a\u663e\u5f0f\u4f7f\u7528 <code>fence.i</code>\u3002</p> </li> </ol> <p>SFENCE.VMA Before or After SATP Write \u00b7 Issue #226 \u00b7 riscv/riscv-isa-manual \u4e2d RISC-V \u5f00\u53d1\u8005\u5bf9 <code>sfence.vma</code> \u548c <code>csrw satp</code> \u987a\u5e8f\u505a\u4e86\u4e00\u4e9b\u8ba8\u8bba\uff1a</p> <ul> <li><code>sfence.vma</code> before <code>csrw satp</code> may be necessary: The concern is, what if the mapping for the instruction immediately after SFENCE.VMA has been modified? In the Linux kernel, this mapping is fixed (regardless of address space) so the concern does not apply.</li> <li><code>sfence.vma</code> after <code>csrw satp</code> is definitely necessary: In general, you need to SFENCE after you've recycled an ASID. Since we don't use ASIDs in the Linux kernel yet, every context switch is effectively an ASID reuse, hence the full TLB flush.</li> </ul> <p>\u6839\u636e\u4e0a\u8ff0\u89e3\u91ca\uff0c\u5728 <code>setup_vm_final</code> \u4e2d\u7b2c\u4e8c\u6b21\u5207\u6362 satp \u65f6\uff0c\u5176\u540e\u5fc5\u987b\u8981\u8bbe\u7f6e <code>sfence.vma</code>\uff0c\u5426\u5219\u53ef\u80fd\u547d\u4e2d\u65e7\u9875\u8868\u3002\u4f46\u662f\u4f60\u4f1a\u53d1\u73b0\uff0c\u5373\u4f7f\u53bb\u6389 <code>sfence.vma</code>\uff0c\u5b9e\u9a8c\u4f9d\u7136\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\u3002\u66f4\u8fdb\u4e00\u6b65\u5730\uff0c\u6211\u4eec\u53ef\u4ee5\u8bbe\u8ba1\u4e0b\u9762\u7684\u4ee3\u7801\uff1a</p> <pre><code>void setup_vm_final() {\n    ...\n    // create old TLB entry\n    asm volatile(\"li t0, 0x80200000\");\n    asm volatile(\"ld t1, 0(t0)\");\n    // set satp with swapper_pg_dir\n    csr_write(satp, ...); // your code\n    // try to hit old TLB entry\n    asm volatile(\"li t0, 0x80200000\");\n    asm volatile(\"ld t1, 0(t0)\");\n    ...\n}\n</code></pre> <p>\u7b2c\u4e8c\u4e2a <code>ld</code> \u5c06\u5931\u8d25\uff0c\u8bf4\u660e TLB \u5df2\u7ecf\u88ab\u5237\u65b0\u4e86\uff0c\u5e76\u4e0d\u7b26\u5408\u9884\u671f\u3002\u539f\u56e0\u662f QEMU\u3001spike \u8fd9\u7c7b\u6a21\u62df\u5668\u4f1a\u5728\u5199 SATP \u65f6\u7acb\u5373\u5237\u65b0 TLB \u6765\u907f\u514d\u6cc4\u6f0f\u65e0\u6548\u7684\u7f13\u5b58\u6620\u5c04\u3002\u4e0d\u8fc7 RISC-V \u7684\u6807\u51c6\u4e2d\u5e76\u672a\u5f3a\u5236\u89c4\u5b9a\u8fd9\u4e00\u70b9\uff0c\u6240\u4ee5\u4e3a\u4e86\u517c\u5bb9\u6027\u8003\u8651\uff0c\u6211\u4eec\u8fd8\u662f\u9700\u8981\u5728\u5199 <code>satp</code> \u540e\u4f7f\u7528 <code>sfence.vma</code> \u6765\u4fdd\u8bc1\u5728\u4efb\u4f55\u5e73\u53f0\u4e0a\u90fd\u53ef\u4ee5\u6b63\u786e\u8fd0\u884c\u3002</p> <p>\u8c03\u8bd5\u5c0f\u5bc4\u5de7</p> <ul> <li>\u5728\u8bbe\u7f6e\u597d <code>satp</code> \u5bc4\u5b58\u5668\u4e4b\u524d\uff0c\u6211\u4eec\u53ea\u53ef\u4ee5\u4f7f\u7528\u7269\u7406\u5730\u5740\u6765\u6253\u65ad\u70b9<ul> <li>\u56e0\u4e3a\u7b26\u53f7\u8868\u3001<code>vmlinux.lds</code> \u91cc\u9762\u8bb0\u5f55\u7684\u51fd\u6570\u540d\u7684\u5730\u5740\u90fd\u662f\u865a\u62df\u5730\u5740</li> <li>\u5728\u8bbe\u7f6e\u597d <code>satp</code> \u4e4b\u524d\uff0c\u8fd9\u6837\u5b50\u6253\u65ad\u70b9\uff0c\u4f1a\u4e0e\u771f\u5b9e\u7684\u5730\u5740\u76f8\u5dee\u4e00\u4e2a <code>PA2VA_OFFSET</code></li> <li>\u4f60\u53ef\u4ee5\u5728\u76ee\u5f55\u4e0b\u7f16\u8bd1\u751f\u6210\u7684 <code>vmlinux.asm</code> \u4e2d\u627e\u5230\u6240\u6709\u4ee3\u7801\u7684\u865a\u62df\u5730\u5740\uff0c\u7136\u540e\u5c06\u5176\u8f6c\u6362\u6210\u7269\u7406\u5730\u5740\uff0c\u518d\u4f7f\u7528 <code>b *&lt;addr&gt;</code> \u547d\u4ee4\u8bbe\u7f6e\u65ad\u70b9</li> </ul> </li> <li>\u8bbe\u7f6e satp \u4e4b\u540e\uff0c\u624d\u53ef\u4ee5\u4f7f\u7528\u865a\u62df\u5730\u5740\u6253\u65ad\u70b9\uff0c\u540c\u65f6\u4e4b\u524d\u8bbe\u7f6e\u7684\u7269\u7406\u5730\u5740\u65ad\u70b9\u4e5f\u4f1a\u5931\u6548\uff0c\u9700\u8981\u5220\u9664</li> </ul> <p>\u65e7\u7248\u672c QEMU\uff087.0 \u4ee5\u524d\uff09\u5bf9\u4e8e\u6307\u4ee4\u7f13\u5b58\u7b49\u5904\u7406\u6709 bug\uff0c\u4f1a\u5bfc\u81f4\u5237\u65b0\u4e86\u7f13\u5b58\u4f46\u5b9e\u9645\u4e0a\u5e76\u6ca1\u6709\u4f5c\u7528\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u8c03\u8bd5\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u56f0\u60d1\uff0c\u6216\u8005\u4f7f\u5f97\u4ee3\u7801\u4ee5\u7075\u8f66\u7684\u65b9\u5f0f\u8dd1\u4e86\u8d77\u6765\uff0c\u56e0\u6b64\u8bf7\u540c\u5b66\u4eec\u52a1\u5fc5\u4fdd\u8bc1\u81ea\u5df1\u4f7f\u7528\u7684 QEMU \u8db3\u591f\u65b0\uff088.2.2 \u53ca\u4ee5\u4e0a\uff09\uff0c\u5426\u5219\u8bf7\u53c2\u8003 lab0/lab1 \u6587\u6863\u8fdb\u884c\u66f4\u65b0</p>"},{"location":"lab3/#setup_vm_final","title":"<code>setup_vm_final</code> \u7684\u5b9e\u73b0","text":"<p>\u7531\u4e8e <code>setup_vm_final</code> \u4e2d\u9700\u8981\u7533\u8bf7\u9875\u9762\u6765\u5efa\u7acb\u591a\u7ea7\u9875\u8868\uff0c\u6211\u4eec\u9700\u8981\u5148\u8c03\u7528 <code>mm_init</code> \u6765\u5b8c\u6210\u5185\u5b58\u7ba1\u7406\u521d\u59cb\u5316\uff0c\u540c\u65f6\u5982\u4e0a\u4e00\u8282\u6240\u8bb2\uff0c\u9700\u8981\u6ce8\u610f\u5c06 <code>mm_init</code> \u4e2d <code>kfreerange</code> \u7684\u7ed3\u675f\u5730\u5740\u8c03\u6574\u4e3a\u865a\u62df\u5730\u5740\u3002</p> <p>\u63a5\u4e0b\u6765 <code>setup_vm_final</code> \u9700\u8981\u5b8c\u6210\u5bf9\u6240\u6709\u7269\u7406\u5185\u5b58 (128M) \u7684\u6620\u5c04\uff0c\u5e76\u8bbe\u7f6e\u6b63\u786e\u7684\u6743\u9650\uff0c\u5177\u4f53\u7684\u6620\u5c04\u5173\u7cfb\u5982\u4e0b\uff1a</p> <pre><code>Physical Address\n     PHY_START                           PHY_END\n         \u2193                                  \u2193\n--------------------------------------------------------\n         | OpenSBI | Kernel |               |\n--------------------------------------------------------\n         \u2191                                  \u2191\n    0x80000000                              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                  |\n                                  |                                  |\n                               VM_START                              |\nVirtual Address                   \u2193                                  \u2193\n-------------------------------------------------------------------------\n                                  |         | Kernel |               |\n-------------------------------------------------------------------------\n                                  \u2191\n                          0xffffffe000000000\n</code></pre> <ul> <li>\u4e0d\u518d\u9700\u8981\u8fdb\u884c\u7b49\u503c\u6620\u5c04</li> <li>\u4e0d\u518d\u9700\u8981\u4e3a OpenSBI \u521b\u5efa\u6620\u5c04\uff0c\u56e0\u4e3a OpenSBI \u8fd0\u884c\u5728 M \u6001\uff0c\u76f4\u63a5\u4f7f\u7528\u7269\u7406\u5730\u5740</li> <li>\u91c7\u7528\u4e09\u7ea7\u9875\u8868\u6620\u5c04</li> <li>\u5728 head.S \u4e2d \u9002\u5f53\u7684\u4f4d\u7f6e\u8c03\u7528 <code>setup_vm_final</code></li> <li>\u8bf7\u4e0d\u8981\u4fee\u6539 create_mapping \u7684\u51fd\u6570\u58f0\u660e\uff0c\u5e76\u6ce8\u610f\u9605\u8bfb\u4e0b\u65b9\u5bf9\u53c2\u6570\u7684\u63cf\u8ff0\u3002\u8be5\u51fd\u6570\u4f1a\u88ab\u7528\u4e8e\u6d4b\u8bd5\u5b9e\u9a8c\u7684\u6b63\u786e\u6027\u3002</li> </ul> arch/riscv/kernel/vm.c<pre><code>/* swapper_pg_dir: kernel pagetable \u6839\u76ee\u5f55\uff0c\u5728 setup_vm_final \u8fdb\u884c\u6620\u5c04 */\nuint64_t swapper_pg_dir[512] __attribute__((__aligned__(0x1000)));\n\nvoid setup_vm_final() {\n    memset(swapper_pg_dir, 0x0, PGSIZE);\n\n    // No OpenSBI mapping required\n\n    // mapping kernel text X|-|R|V\n    create_mapping(...);\n\n    // mapping kernel rodata -|-|R|V\n    create_mapping(...);\n\n    // mapping other memory -|W|R|V\n    create_mapping(...);\n\n    // set satp with swapper_pg_dir\n\n    // YOUR CODE HERE\n\n    // flush TLB\n    asm volatile(\"sfence.vma zero, zero\");\n    return;\n}\n\n\n/* \u521b\u5efa\u591a\u7ea7\u9875\u8868\u6620\u5c04\u5173\u7cfb */\n/* \u4e0d\u8981\u4fee\u6539\u8be5\u63a5\u53e3\u7684\u53c2\u6570\u548c\u8fd4\u56de\u503c */\nvoid create_mapping(uint64_t *pgtbl, uint64_t va, uint64_t pa, uint64_t sz, uint64_t perm) {\n    /*\n     * pgtbl \u4e3a\u6839\u9875\u8868\u7684\u57fa\u5730\u5740\n     * va, pa \u4e3a\u9700\u8981\u6620\u5c04\u7684\u865a\u62df\u5730\u5740\u3001\u7269\u7406\u5730\u5740\n     * sz \u4e3a\u6620\u5c04\u7684\u5927\u5c0f\uff0c\u5355\u4f4d\u4e3a\u5b57\u8282\n     * perm \u4e3a\u6620\u5c04\u7684\u6743\u9650\uff08\u5373\u9875\u8868\u9879\u7684\u4f4e 8 \u4f4d\uff09\n     * \n     * \u521b\u5efa\u591a\u7ea7\u9875\u8868\u7684\u65f6\u5019\u53ef\u4ee5\u4f7f\u7528 kalloc() \u6765\u83b7\u53d6\u4e00\u9875\u4f5c\u4e3a\u9875\u8868\u76ee\u5f55\n     * \u53ef\u4ee5\u4f7f\u7528 V bit \u6765\u5224\u65ad\u9875\u8868\u9879\u662f\u5426\u5b58\u5728\n    **/\n}\n</code></pre>"},{"location":"lab3/#_8","title":"\u7f16\u8bd1\u53ca\u6d4b\u8bd5","text":"<p>\u7531\u4e8e\u52a0\u5165\u4e86\u4e00\u4e9b\u65b0\u7684 .c \u6587\u4ef6\uff0c\u53ef\u80fd\u9700\u8981\u4fee\u6539\u4e00\u4e9bMakefile\u6587\u4ef6\uff0c\u8bf7\u540c\u5b66\u81ea\u5df1\u5c1d\u8bd5\u4fee\u6539\uff0c\u4f7f\u9879\u76ee\u53ef\u4ee5\u7f16\u8bd1\u5e76\u8fd0\u884c</p> \u8f93\u51fa\u793a\u4f8b <pre><code>...mm_init done!\n...task_init done!\n2024 ZJU Operating System\n\nSET [PID = 1 PRIORITY = 7 COUNTER = 7]\nSET [PID = 2 PRIORITY = 10 COUNTER = 10]\nSET [PID = 3 PRIORITY = 4 COUNTER = 4]\nSET [PID = 4 PRIORITY = 1 COUNTER = 1]\n\nswitch to [PID = 2 PRIORITY = 10 COUNTER = 10]\n[PID = 2] is running. auto_inc_local_var = 1\n[PID = 2] is running. auto_inc_local_var = 2\n[PID = 2] is running. auto_inc_local_var = 3\n[PID = 2] is running. auto_inc_local_var = 4\n[PID = 2] is running. auto_inc_local_var = 5\n[PID = 2] is running. auto_inc_local_var = 6\n[PID = 2] is running. auto_inc_local_var = 7\n[PID = 2] is running. auto_inc_local_var = 8\n[PID = 2] is running. auto_inc_local_var = 9\n[PID = 2] is running. auto_inc_local_var = 10\n\nswitch to [PID = 1 PRIORITY = 7 COUNTER = 7]\n[PID = 1] is running. auto_inc_local_var = 1\n[PID = 1] is running. auto_inc_local_var = 2\n[PID = 1] is running. auto_inc_local_var = 3\n[PID = 1] is running. auto_inc_local_var = 4\n[PID = 1] is running. auto_inc_local_var = 5\n[PID = 1] is running. auto_inc_local_var = 6\n[PID = 1] is running. auto_inc_local_var = 7\n\nswitch to [PID = 3 PRIORITY = 4 COUNTER = 4]\n[PID = 3] is running. auto_inc_local_var = 1\n[PID = 3] is running. auto_inc_local_var = 2\n[PID = 3] is running. auto_inc_local_var = 3\n[PID = 3] is running. auto_inc_local_var = 4\n\nswitch to [PID = 4 PRIORITY = 1 COUNTER = 1]\n[PID = 4] is running. auto_inc_local_var = 1\n\nSET [PID = 1 PRIORITY = 7 COUNTER = 7]\nSET [PID = 2 PRIORITY = 10 COUNTER = 10]\nSET [PID = 3 PRIORITY = 4 COUNTER = 4]\nSET [PID = 4 PRIORITY = 1 COUNTER = 1]\n\nswitch to [PID = 2 PRIORITY = 10 COUNTER = 10]\n...\n</code></pre>"},{"location":"lab3/#_9","title":"\u601d\u8003\u9898","text":"<ol> <li>\u9a8c\u8bc1 <code>.text</code>\uff0c<code>.rodata</code> \u6bb5\u7684\u5c5e\u6027\u662f\u5426\u6210\u529f\u8bbe\u7f6e\uff0c\u7ed9\u51fa\u622a\u56fe\u3002</li> <li> <p>\u4e3a\u4ec0\u4e48\u6211\u4eec\u5728 <code>setup_vm</code> \u4e2d\u9700\u8981\u505a\u7b49\u503c\u6620\u5c04\uff1f\u5728 Linux \u4e2d\uff0c\u662f\u4e0d\u9700\u8981\u505a\u7b49\u503c\u6620\u5c04\u7684\uff0c\u8bf7\u63a2\u7d22\u4e00\u4e0b\u4e0d\u5728 <code>setup_vm</code> \u4e2d\u505a\u7b49\u503c\u6620\u5c04\u7684\u65b9\u6cd5\u3002\u4f60\u9700\u8981\u56de\u7b54\u4ee5\u4e0b\u95ee\u9898\uff1a</p> <ul> <li>\u672c\u6b21\u5b9e\u9a8c\u4e2d\u5982\u679c\u4e0d\u505a\u7b49\u503c\u6620\u5c04\uff0c\u4f1a\u51fa\u73b0\u4ec0\u4e48\u95ee\u9898\uff0c\u539f\u56e0\u662f\u4ec0\u4e48\uff1b</li> <li>\u7b80\u8981\u5206\u6790 Linux v5.2.21 \u6216\u4e4b\u540e\u7684\u7248\u672c\u4e2d\u7684\u5185\u6838\u542f\u52a8\u90e8\u5206\uff08\u76f4\u81f3 <code>init/main.c</code> \u4e2d <code>start_kernel</code> \u5f00\u59cb\u4e4b\u524d\uff09\uff0c\u7279\u522b\u662f\u8bbe\u7f6e satp \u5207\u6362\u9875\u8868\u9644\u8fd1\u7684\u903b\u8f91\uff1b</li> <li>\u56de\u7b54 Linux \u4e3a\u4ec0\u4e48\u53ef\u4ee5\u4e0d\u8fdb\u884c\u7b49\u503c\u6620\u5c04\uff0c\u5b83\u662f\u5982\u4f55\u5728\u65e0\u7b49\u503c\u6620\u5c04\u7684\u60c5\u51b5\u4e0b\u8ba9 pc \u4ece\u7269\u7406\u5730\u5740\u8df3\u5230\u865a\u62df\u5730\u5740\uff1b</li> <li>Linux v5.2.21 \u4e2d\u7684 <code>trampoline_pg_dir</code> \u548c <code>swapper_pg_dir</code> \u6709\u4ec0\u4e48\u533a\u522b\uff0c\u5b83\u4eec\u5206\u522b\u662f\u5728\u54ea\u91cc\u901a\u8fc7 satp \u8bbe\u4e3a\u6240\u4f7f\u7528\u7684\u9875\u8868\u7684\uff1b</li> <li>\u5c1d\u8bd5\u4fee\u6539\u4f60\u7684 kernel\uff0c\u4f7f\u5f97\u5176\u53ef\u4ee5\u50cf Linux \u4e00\u6837\u4e0d\u9700\u8981\u7b49\u503c\u6620\u5c04\u3002</li> </ul> <p>Hint</p> <p>\u4f60\u9700\u8981\u7279\u522b\u5173\u6ce8 pc \u7684\u53d8\u5316\u4ee5\u53ca\u67d0\u4e9b\u6307\u4ee4\u5bf9\u4e8e pc \u7684\u5f71\u54cd\u7b49\u3002</p> <p>\u867d\u7136 Linux \u662f\u4e00\u4e2a\u975e\u5e38\u5e9e\u5927\u7684\u9879\u76ee\uff0c\u4f46\u662f\u540c\u5b66\u4eec\u4e5f\u4e0d\u9700\u8981\u6709\u754f\u96be\u60c5\u7eea\uff0c\u542f\u52a8\u90e8\u5206\u7684\u7ed3\u6784\u548c\u6211\u4eec\u81ea\u5df1\u5b9e\u73b0\u7684\u7ed3\u6784\u5176\u5b9e\u975e\u5e38\u7c7b\u4f3c\uff08arch/riscv/kernel/head.S \u4e4b\u7c7b\u7684\uff09\uff0c\u5982\u679c\u9047\u5230\u5b8c\u5168\u6ca1\u542c\u8bf4\u8fc7\u7684\u6307\u4ee4\u6216\u8005\u4ee3\u7801\uff08\u6bd4\u5982 setup_vm \u4e2d\u7684 pmd \u76f8\u5173\u7684\u4e1c\u897f\u7b49\uff09\u53ef\u4ee5\u6682\u65f6\u8df3\u8fc7\uff0c\u4e0d\u8ba4\u8bc6\u7684\u5730\u65b9\u5bf9\u4e8e\u6211\u4eec\u8981\u5206\u6790\u7684\u4e3b\u8981\u903b\u8f91\u4e5f\u57fa\u672c\u6ca1\u6709\u4ec0\u4e48\u5927\u5f71\u54cd\u3002</p> </li> </ol>"},{"location":"lab3/#_10","title":"\u5b9e\u9a8c\u4efb\u52a1\u4e0e\u8981\u6c42","text":"<ul> <li>\u8bf7\u5404\u4f4d\u540c\u5b66\u72ec\u7acb\u5b8c\u6210\u4f5c\u4e1a\uff0c\u4efb\u4f55\u6284\u88ad\u884c\u4e3a\u90fd\u5c06\u4f7f\u672c\u6b21\u4f5c\u4e1a\u5224\u4e3a 0 \u5206\u3002</li> <li>\u5728\u5b66\u5728\u6d59\u5927\u4e2d\u63d0\u4ea4\uff1a<ul> <li>\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u7684\u538b\u7f29\u5305\uff08\u63d0\u4ea4\u4e4b\u524d\u8bf7\u4f7f\u7528 <code>make clean</code> \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\uff09</li> <li>pdf \u683c\u5f0f\u7684\u5b9e\u9a8c\u62a5\u544a\uff1a<ul> <li>\u8bb0\u5f55\u5b9e\u9a8c\u8fc7\u7a0b\u5e76\u622a\u56fe\uff084.1-4.3\uff09\uff0c\u5e76\u5bf9\u6bcf\u4e00\u6b65\u7684\u547d\u4ee4\u4ee5\u53ca\u7ed3\u679c\u8fdb\u884c\u5fc5\u8981\u7684\u89e3\u91ca\uff1b</li> <li>\u8bb0\u5f55\u9047\u5230\u7684\u95ee\u9898\u548c\u5fc3\u5f97\u4f53\u4f1a\uff1b</li> <li>\u5b8c\u6210\u601d\u8003\u9898\u3002</li> </ul> </li> </ul> </li> </ul> <p>\u5173\u4e8e\u5b9e\u9a8c\u62a5\u544a\u5185\u5bb9\u8981\u6c42\uff0c\u53ef\u89c1\uff1a\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54 - \u5b9e\u9a8c\u63d0\u4ea4\u8981\u6c42</p>"},{"location":"lab4/","title":"Lab 4: RV64 \u7528\u6237\u6001\u7a0b\u5e8f","text":""},{"location":"lab4/#_1","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<ul> <li>\u521b\u5efa\u7528\u6237\u6001\u8fdb\u7a0b\uff0c\u5e76\u5b8c\u6210\u5185\u6838\u6001\u4e0e\u7528\u6237\u6001\u7684\u8f6c\u6362</li> <li>\u6b63\u786e\u8bbe\u7f6e\u7528\u6237\u8fdb\u7a0b\u7684\u7528\u6237\u6001\u6808\u548c\u5185\u6838\u6001\u6808\uff0c\u5e76\u5728\u5f02\u5e38\u5904\u7406\u65f6\u6b63\u786e\u5207\u6362</li> <li>\u8865\u5145\u5f02\u5e38\u5904\u7406\u903b\u8f91\uff0c\u5b8c\u6210\u6307\u5b9a\u7684\u7cfb\u7edf\u8c03\u7528\uff08SYS_WRITE, SYS_GETPID\uff09\u529f\u80fd</li> <li>\u5b9e\u73b0\u7528\u6237\u6001 ELF \u7a0b\u5e8f\u7684\u89e3\u6790\u548c\u52a0\u8f7d</li> </ul>"},{"location":"lab4/#_2","title":"\u5b9e\u9a8c\u73af\u5883","text":"<ul> <li>Environment in previous labs</li> </ul>"},{"location":"lab4/#_3","title":"\u80cc\u666f\u77e5\u8bc6","text":""},{"location":"lab4/#_4","title":"\u7528\u6237\u6a21\u5f0f\u548c\u5185\u6838\u6a21\u5f0f","text":"<p>\u5904\u7406\u5668\u5b58\u5728\u4e24\u79cd\u4e0d\u540c\u7684\u6a21\u5f0f\uff1a\u7528\u6237\u6a21\u5f0f\uff08U-Mode\uff09\u548c\u5185\u6838\u6a21\u5f0f\uff08S-Mode\uff09\u3002</p> <ul> <li>\u5728\u7528\u6237\u6a21\u5f0f\u4e0b\uff0c\u6267\u884c\u4ee3\u7801\u65e0\u6cd5\u76f4\u63a5\u8bbf\u95ee\u786c\u4ef6\uff0c\u5fc5\u987b\u59d4\u6258\u7ed9\u7cfb\u7edf\u63d0\u4f9b\u7684\u63a5\u53e3\u624d\u80fd\u8bbf\u95ee\u786c\u4ef6\u6216\u5185\u5b58\uff1b</li> <li>\u5728\u5185\u6838\u6a21\u5f0f\u4e0b\uff0c\u6267\u884c\u4ee3\u7801\u5bf9\u5e95\u5c42\u786c\u4ef6\u5177\u6709\u5b8c\u6574\u4e14\u4e0d\u53d7\u9650\u5236\u7684\u8bbf\u95ee\u6743\u9650\uff0c\u5b83\u53ef\u4ee5\u6267\u884c\u4efb\u4f55 CPU \u6307\u4ee4\u5e76\u5f15\u7528\u4efb\u4f55\u5185\u5b58\u5730\u5740\u3002</li> </ul> <p>\u5904\u7406\u5668\u6839\u636e\u5904\u7406\u5668\u4e0a\u8fd0\u884c\u7684\u4ee3\u7801\u7c7b\u578b\u5728\u8fd9\u4e24\u79cd\u6a21\u5f0f\u4e4b\u95f4\u5207\u6362\u3002\u5e94\u7528\u7a0b\u5e8f\u4ee5\u7528\u6237\u6a21\u5f0f\u8fd0\u884c\uff0c\u800c\u6838\u5fc3\u64cd\u4f5c\u7cfb\u7edf\u7ec4\u4ef6\u4ee5\u5185\u6838\u6a21\u5f0f\u8fd0\u884c\u3002</p>"},{"location":"lab4/#_5","title":"\u76ee\u6807","text":"<p>\u5728 Lab3 \u4e2d\uff0c\u6211\u4eec\u542f\u7528\u4e86\u865a\u62df\u5185\u5b58\uff0c\u8fd9\u4e3a\u8fdb\u7a0b\u95f4\u5730\u5740\u7a7a\u95f4\u76f8\u4e92\u9694\u79bb\u6253\u4e0b\u4e86\u57fa\u7840\u3002\u7136\u800c\uff0c\u6211\u4eec\u5f53\u65f6\u53ea\u521b\u5efa\u4e86\u5185\u6838\u7ebf\u7a0b\uff0c\u5b83\u4eec\u5171\u7528\u4e86\u5730\u5740\u7a7a\u95f4\uff08\u5171\u7528\u4e00\u4e2a\u5185\u6838\u9875\u8868 <code>swapper_pg_dir</code>\uff09\u3002\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5f15\u5165\u7528\u6237\u6001\u8fdb\u7a0b\uff1a</p> <ul> <li>\u5f53\u542f\u52a8\u7528\u6237\u6001\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0c\u5185\u6838\u5c06\u4e3a\u8be5\u5e94\u7528\u7a0b\u5e8f\u521b\u5efa\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u5e76\u63d0\u4f9b\u4e86\u4e13\u7528\u865a\u62df\u5730\u5740\u7a7a\u95f4\u7b49\u8d44\u6e90<ul> <li>\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u662f\u79c1\u6709\u7684\uff0c\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u65e0\u6cd5\u66f4\u6539\u5c5e\u4e8e\u53e6\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684\u6570\u636e</li> <li>\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u90fd\u662f\u72ec\u7acb\u8fd0\u884c\u7684\uff0c\u5982\u679c\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u5d29\u6e83\uff0c\u5176\u4ed6\u5e94\u7528\u7a0b\u5e8f\u548c\u64cd\u4f5c\u7cfb\u7edf\u5c06\u4e0d\u4f1a\u53d7\u5230\u5f71\u54cd</li> </ul> </li> <li>\u7528\u6237\u6001\u5e94\u7528\u7a0b\u5e8f\u53ef\u8bbf\u95ee\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u662f\u53d7\u9650\u7684<ul> <li>\u5728\u7528\u6237\u6001\u4e0b\uff0c\u5e94\u7528\u7a0b\u5e8f\u65e0\u6cd5\u8bbf\u95ee\u5185\u6838\u7684\u865a\u62df\u5730\u5740\uff0c\u9632\u6b62\u5176\u4fee\u6539\u5173\u952e\u64cd\u4f5c\u7cfb\u7edf\u6570\u636e</li> <li>\u5f53\u7528\u6237\u6001\u7a0b\u5e8f\u9700\u8981\u8bbf\u95ee\u5173\u952e\u8d44\u6e90\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u6765\u5b8c\u6210\u7528\u6237\u6001\u7a0b\u5e8f\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u4e4b\u95f4\u7684\u4e92\u52a8</li> </ul> </li> </ul>"},{"location":"lab4/#_6","title":"\u7cfb\u7edf\u8c03\u7528\u7ea6\u5b9a","text":"<p>\u7cfb\u7edf\u8c03\u7528\u662f\u7528\u6237\u6001\u5e94\u7528\u7a0b\u5e8f\u8bf7\u6c42\u5185\u6838\u670d\u52a1\u7684\u4e00\u79cd\u65b9\u5f0f\u3002\u5728 RISC-V \u4e2d\uff0c\u6211\u4eec\u4f7f\u7528 <code>ecall</code> \u6307\u4ee4\u8fdb\u884c\u7cfb\u7edf\u8c03\u7528\uff0c\u5f53\u6267\u884c\u8fd9\u6761\u6307\u4ee4\u65f6\uff0c\u5904\u7406\u5668\u4f1a\u63d0\u5347\u7279\u6743\u6a21\u5f0f\uff0c\u8df3\u8f6c\u5230\u5f02\u5e38\u5904\u7406\u51fd\u6570\uff0c\u5904\u7406\u8fd9\u6761\u7cfb\u7edf\u8c03\u7528\u3002</p> <p>Linux \u4e2d RISC-V \u76f8\u5173\u7684\u7cfb\u7edf\u8c03\u7528\u53ef\u4ee5\u5728 <code>include/uapi/asm-generic/unistd.h</code> \u4e2d\u627e\u5230\uff0csyscall(2) \u624b\u518c\u9875\u4e0a\u5bf9 RISC-V \u67b6\u6784\u4e0a\u7684\u8c03\u7528\u8bf4\u660e\u8fdb\u884c\u4e86\u603b\u7ed3\uff0c\u7cfb\u7edf\u8c03\u7528\u53c2\u6570\u4f7f\u7528 a0 - a5\uff0c\u7cfb\u7edf\u8c03\u7528\u53f7\u4f7f\u7528 a7\uff0c\u7cfb\u7edf\u8c03\u7528\u7684\u8fd4\u56de\u503c\u4f1a\u88ab\u4fdd\u5b58\u5230 a0, a1 \u4e2d\u3002</p>"},{"location":"lab4/#sstatussum-pteu","title":"<code>sstatus[SUM]</code> \u4e0e <code>PTE[U]</code>","text":"<ul> <li>\u5f53\u9875\u8868\u9879 <code>PTE[U]</code> \u7f6e 0 \u65f6\uff0c\u8be5\u9875\u8868\u9879\u5bf9\u5e94\u7684\u5185\u5b58\u9875\u4e3a\u5185\u6838\u9875\uff0cU-Mode \u4e0b\u7684\u4ee3\u7801\u65e0\u6cd5\u8bbf\u95ee</li> <li>\u5f53\u9875\u8868\u9879 <code>PTE[U]</code> \u7f6e 1 \u65f6\uff0c\u8be5\u9875\u8868\u9879\u5bf9\u5e94\u7684\u5185\u5b58\u9875\u4e3a\u7528\u6237\u9875\uff0cS-Mode \u4e0b\u7684\u4ee3\u7801\u65e0\u6cd5\u8bbf\u95ee</li> </ul> <p>\u5982\u679c\u60f3\u8ba9 S \u7279\u6743\u7ea7\u4e0b\u7684\u7a0b\u5e8f\u80fd\u591f\u8bbf\u95ee\u7528\u6237\u9875\uff0c\u9700\u8981\u5bf9 <code>sstatus[SUM]</code> \u4f4d\u7f6e 1\u3002</p> <p>\u4f46\u662f\u65e0\u8bba\u4ec0\u4e48\u6837\u7684\u60c5\u51b5\u4e0b\uff0c\u7528\u6237\u9875\u4e2d\u7684\u6307\u4ee4\u5bf9\u4e8e S-Mode \u800c\u8a00\u90fd\u662f\u65e0\u6cd5\u6267\u884c\u7684</p>"},{"location":"lab4/#_7","title":"\u7528\u6237\u6001\u6808\u4e0e\u5185\u6838\u6001\u6808","text":"<p>\u5f53\u7528\u6237\u6001\u7a0b\u5e8f\u8fdb\u884c\u7cfb\u7edf\u8c03\u7528\u9677\u5165\u5185\u6838\u5904\u7406\u65f6\uff0c\u5185\u6838\u6001\u7a0b\u5e8f\u4e5f\u9700\u8981\u4f7f\u7528\u6808\u7a7a\u95f4\uff0c\u800c\u8fd9\u80af\u5b9a\u4e0d\u80fd\u548c\u7528\u6237\u6001\u4f7f\u7528\u540c\u4e00\u4e2a\u6808\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e3a\u7528\u6237\u6001\u7a0b\u5e8f\u548c\u5185\u6838\u6001\u7a0b\u5e8f\u5206\u522b\u5206\u914d\u6808\u7a7a\u95f4\uff0c\u5e76\u5728\u5f02\u5e38\u5904\u7406\u7684\u8fc7\u7a0b\u4e2d\u5bf9\u6808\u8fdb\u884c\u5207\u6362\u3002</p>"},{"location":"lab4/#elf","title":"ELF \u7a0b\u5e8f","text":"<p>ELF\uff08Executable and Linkable Format\uff09\u662f\u5f53\u4eca\u88ab\u5e7f\u6cdb\u4f7f\u7528\u7684\u5e94\u7528\u7a0b\u5e8f\u683c\u5f0f\u3002\u4f8b\u5982\u5f53\u6211\u4eec\u8fd0\u884c <code>gcc &lt;some-name&gt;.c</code> \u540e\u4ea7\u751f\u7684 <code>a.out</code> \u8f93\u51fa\u6587\u4ef6\u7684\u683c\u5f0f\u5c31\u662f ELF\u3002</p> <pre><code>$ cat hello.c\n#include &lt;stdio.h&gt;\n\nint main() {\n    printf(\"hello, world\\n\");\n    return 0;\n}\n$ gcc hello.c\n$ file a.out\na.out: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, \ninterpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=dd33139196142abd22542134c20d85c571a78b0c, \nfor GNU/Linux 3.2.0, not stripped\n</code></pre> <p>\u5c06\u7a0b\u5e8f\u5c01\u88c5\u6210 ELF \u683c\u5f0f\u7684\u610f\u4e49\u5305\u62ec\u4ee5\u4e0b\u51e0\u70b9\uff1a</p> <ul> <li>ELF \u6587\u4ef6\u53ef\u4ee5\u5305\u542b\u5c06\u7a0b\u5e8f\u6b63\u786e\u52a0\u8f7d\u5165\u5185\u5b58\u7684\u5143\u6570\u636e\uff08metadata\uff09</li> <li>ELF \u6587\u4ef6\u5728\u8fd0\u884c\u65f6\u53ef\u4ee5\u7531\u52a0\u8f7d\u5668\uff08loader\uff09\u5c06\u52a8\u6001\u94fe\u63a5\u5728\u7a0b\u5e8f\u4e0a\u7684\u52a8\u6001\u94fe\u63a5\u5e93\uff08shared library\uff09\u6b63\u786e\u5730\u4ece\u786c\u76d8\u6216\u5185\u5b58\u4e2d\u52a0\u8f7d</li> <li>ELF \u6587\u4ef6\u5305\u542b\u7684\u91cd\u5b9a\u4f4d\u4fe1\u606f\u53ef\u4ee5\u8ba9\u8be5\u7a0b\u5e8f\u7ee7\u7eed\u548c\u5176\u4ed6\u53ef\u91cd\u5b9a\u4f4d\u6587\u4ef6\u548c\u5e93\u518d\u6b21\u94fe\u63a5\uff0c\u6784\u6210\u65b0\u7684\u53ef\u6267\u884c\u6587\u4ef6</li> </ul> <p>\u4e3a\u4e86\u7b80\u5316\u5b9e\u9a8c\u6b65\u9aa4\uff0c\u6211\u4eec\u4f7f\u7528\u7684\u662f\u9759\u6001\u94fe\u63a5\u7684\u7a0b\u5e8f\uff0c\u4e0d\u4f1a\u6d89\u53ca\u94fe\u63a5\u52a8\u6001\u94fe\u63a5\u5e93\u7684\u5185\u5bb9\u3002</p>"},{"location":"lab4/#_8","title":"\u5b9e\u9a8c\u6b65\u9aa4","text":""},{"location":"lab4/#_9","title":"\u51c6\u5907\u5de5\u7a0b","text":"<p>\u6b64\u6b21\u5b9e\u9a8c\u57fa\u4e8e lab3 \u540c\u5b66\u6240\u5b9e\u73b0\u7684\u4ee3\u7801\u8fdb\u884c\u3002</p> <ul> <li>\u9700\u8981\u4fee\u6539 <code>vmlinux.lds</code>\uff0c\u5c06\u7528\u6237\u6001\u7a0b\u5e8f <code>uapp</code> \u52a0\u8f7d\u81f3 <code>.data</code> \u6bb5\uff1a     arch/riscv/kernel/vmlinux.lds<pre><code>    .data : ALIGN(0x1000) {\n        _sdata = .;\n\n        *(.sdata .sdata*)\n        *(.data .data.*)\n\n        _edata = .;\n\n        . = ALIGN(0x1000);\n        _sramdisk = .;\n        *(.uapp .uapp*)\n        _eramdisk = .;\n        . = ALIGN(0x1000);\n    } &gt;ramv AT&gt;ram\n</code></pre></li> </ul> <p>Tip</p> <p>\u5982\u679c\u4f60\u8981\u4f7f\u7528 <code>_sramdisk</code> \u8fd9\u4e2a\u7b26\u53f7\uff0c\u53ef\u4ee5\u5728\u4ee3\u7801\u91cc\u8fd9\u6837\u6765\u58f0\u660e\u5b83\uff1a<code>extern char _sramdisk[]</code>\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u50cf\u4e00\u4e2a\u5b57\u7b26\u6570\u7ec4\u4e00\u6837\u6765\u8bbf\u95ee\u8fd9\u5757\u5185\u5b58\u7684\u5185\u5bb9\uff0c\u4f8b\u5982\uff0c\u7a0b\u5e8f\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u5c31\u662f <code>_sramdisk[0]</code>\u3002</p> <ul> <li> <p>\u9700\u8981\u4fee\u6539 <code>defs.h</code>\uff0c\u5728 <code>defs.h</code> \u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a     <pre><code>#define USER_START (0x0000000000000000) // user space start virtual address\n#define USER_END (0x0000004000000000) // user space end virtual address\n</code></pre></p> </li> <li> <p>\u4ece\u672c\u4ed3\u5e93\u540c\u6b65\u4ee5\u4e0b\u6587\u4ef6\u548c\u6587\u4ef6\u5939\uff0c\u5e76\u6309\u7167\u4e0b\u9762\u7684\u4f4d\u7f6e\u6765\u653e\u7f6e\u8fd9\u4e9b\u65b0\u6587\u4ef6\uff1a     <pre><code>.\n\u251c\u2500\u2500 arch\n\u2502   \u2514\u2500\u2500 riscv\n\u2502       \u251c\u2500\u2500 Makefile    # \u6dfb\u52a0\u4e86\u94fe\u63a5 uapp \u7684\u90e8\u5206\n\u2502       \u251c\u2500\u2500 include\n\u2502       \u2502   \u2514\u2500\u2500 mm.h    # \u4fee\u6539\u4e3a\u4e86 buddy system\n\u2502       \u2514\u2500\u2500 kernel\n\u2502           \u2514\u2500\u2500 mm.c    # \u4fee\u6539\u4e3a\u4e86 buddy system\n\u251c\u2500\u2500 include\n\u2502   \u2514\u2500\u2500 elf.h           # \u6765\u81ea musl libc\n\u2514\u2500\u2500 user\n    \u251c\u2500\u2500 Makefile\n    \u251c\u2500\u2500 getpid.c        # \u7528\u6237\u6001\u7a0b\u5e8f\n    \u251c\u2500\u2500 link.lds\n    \u251c\u2500\u2500 printf.c        # \u7c7b\u4f3c printk\n    \u251c\u2500\u2500 start.S         # \u7528\u6237\u6001\u7a0b\u5e8f\u5165\u53e3\n    \u251c\u2500\u2500 stddef.h\n    \u251c\u2500\u2500 stdio.h\n    \u251c\u2500\u2500 syscall.h\n    \u2514\u2500\u2500 uapp.S          # \u63d0\u53d6\u4e8c\u8fdb\u5236\u5185\u5bb9\n</code></pre></p> <p>\u5173\u4e8e buddy system</p> <p>\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u6211\u4eec\u5728 <code>mm</code> \u4e2d\u6dfb\u52a0\u4e86 buddy system\uff0c\u4f46\u662f\u4e5f\u4fdd\u8bc1\u4e86\u539f\u6765\u8c03\u7528\u7684 <code>kalloc</code> \u548c <code>kfree</code> \u7684\u517c\u5bb9\u3002\u4f60\u5e94\u8be5\u65e0\u9700\u4fee\u6539\u539f\u5148\u4f7f\u7528\u4e86 <code>kalloc</code> \u7684\u76f8\u5173\u4ee3\u7801\uff0c\u5982\u679c\u51fa\u73b0\u517c\u5bb9\u6027\u95ee\u9898\u53ef\u4ee5\u8054\u7cfb\u52a9\u6559\u3002\u4e3a\u4e86\u51cf\u5c0f\u5927\u5bb6\u7684\u5de5\u4f5c\u91cf\uff0c\u6211\u4eec\u66ff\u5927\u5bb6\u5b9e\u73b0\u4e86 buddy system\uff0c\u5927\u5bb6\u4e5f\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e9b\u51fd\u6570\u6765\u7ba1\u7406\u5185\u5b58\uff1a</p> <pre><code>void *alloc_pages(uint64_t nrpages);    // \u5206\u914d nrpages \u4e2a\u9875\nvoid *alloc_page();         // \u5206\u914d\u4e00\u4e2a\u9875\uff0c\u5373 alloc_pages(1)\nvoid free_pages(void *va);  // \u91ca\u653e va \u5f00\u59cb\u7684\u5185\u5b58\n</code></pre> </li> <li> <p>\u4fee\u6539\u6839\u76ee\u5f55\u4e0b\u7684 Makefile, \u5c06 <code>user</code> \u6587\u4ef6\u5939\u4e0b\u7684\u5185\u5bb9\u7eb3\u5165\u5de5\u7a0b\u7ba1\u7406</p> <p>Note</p> <p>\u5728\u6839\u76ee\u5f55\u4e0b <code>make</code> \u4f1a\u751f\u6210 <code>user/uapp.o</code>\uff08\u8fd9\u4e2a\u4f1a\u88ab\u94fe\u63a5\u5230 vmlinux \u4e2d\uff09<code>user/uapp.elf</code> <code>user/uapp.bin</code>\uff0c\u4ee5\u53ca\u6211\u4eec\u6700\u7ec8\u6d4b\u8bd5\u4f7f\u7528\u7684 ELF \u53ef\u6267\u884c\u6587\u4ef6 <code>user/uapp</code>\u3002</p> <p>\u901a\u8fc7 <code>objdump</code> \u6211\u4eec\u53ef\u4ee5\u770b\u5230 uapp \u4f7f\u7528 ecall \u6765\u8c03\u7528 SYSCALL\uff08\u5728 U-Mode \u4e0b\u4f7f\u7528 ecall \u4f1a\u89e6\u53d1 <code>environment-call-from-U-mode</code> \u5f02\u5e38\uff09\uff0c\u4ece\u800c\u5c06\u63a7\u5236\u6743\u4ea4\u7ed9\u5904\u5728 S-Mode \u7684 OS\uff0c\u7531\u5185\u6838\u6765\u5904\u7406\u76f8\u5173\u5f02\u5e38\uff1a</p> <pre><code>0000000000000004 &lt;getpid&gt;:\n   4:   fe010113            add sp,sp,-32\n   8:   00813c23            sd  s0,24(sp)\n   c:   02010413            add s0,sp,32\n  10:   fe843783            ld  a5,-24(s0)\n  14:   0ac00893            li  a7,172\n  18:   00000073            ecall               &lt;- SYS_GETPID                        \n...\n\n0000000000000f70 &lt;printf&gt;:\n...\n1030:   00070513            mv  a0,a4\n1034:   00068593            mv  a1,a3\n1038:   00060613            mv  a2,a2\n103c:   00000073            ecall               &lt;- SYS_WRITE\n...\n</code></pre> </li> </ul> <p>\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u9996\u5148\u4f1a\u5c06\u7528\u6237\u6001\u7a0b\u5e8f strip \u6210\u7eaf\u4e8c\u8fdb\u5236\u6587\u4ef6\u6765\u8fd0\u884c\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u7528\u6237\u7a0b\u5e8f\u8fd0\u884c\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u4f4d\u4e8e\u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u5f00\u59cb\u4f4d\u7f6e, \u4e5f\u5c31\u662f\u8bf4 <code>_sramdisk</code> \u5904\u7684\u6307\u4ee4\u5c31\u662f\u6211\u4eec\u8981\u6267\u884c\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u3002\u6211\u4eec\u5c06\u8fd0\u884c\u7eaf\u4e8c\u8fdb\u5236\u6587\u4ef6\u4f5c\u4e3a\u7b2c\u4e00\u6b65\uff0c\u5728\u786e\u8ba4\u7528\u6237\u6001\u7684\u7eaf\u4e8c\u8fdb\u5236\u6587\u4ef6\u80fd\u591f\u8fd0\u884c\u540e\uff0c\u6211\u4eec\u518d\u5c06\u5b58\u50a8\u5230\u5185\u5b58\u4e2d\u7684\u7528\u6237\u7a0b\u5e8f\u6587\u4ef6\u6362\u4e3a ELF \u6765\u8fdb\u884c\u6267\u884c\u3002</p>"},{"location":"lab4/#_10","title":"\u521b\u5efa\u7528\u6237\u6001\u8fdb\u7a0b","text":""},{"location":"lab4/#_11","title":"\u7ed3\u6784\u4f53\u66f4\u65b0","text":"<ul> <li>\u672c\u6b21\u5b9e\u9a8c\u53ea\u9700\u8981\u521b\u5efa 4 \u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\uff0c\u4fee\u6539 <code>proc.h</code> \u4e2d\u7684 <code>NR_TASKS</code> \u5373\u53ef</li> <li>\u7531\u4e8e\u521b\u5efa\u7528\u6237\u6001\u8fdb\u7a0b\u8981\u5bf9 <code>sepc</code>, <code>sstatus</code>, <code>sscratch</code> \u505a\u8bbe\u7f6e\uff0c\u6211\u4eec\u9700\u8981\u5c06\u5176\u52a0\u5165 <code>thread_struct</code> \u4e2d</li> <li>\u7531\u4e8e\u591a\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u9700\u8981\u4fdd\u8bc1\u76f8\u5bf9\u9694\u79bb\uff0c\u56e0\u6b64\u4e0d\u53ef\u4ee5\u5171\u7528\u9875\u8868\uff0c\u6211\u4eec\u9700\u8981\u4e3a\u6bcf\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u90fd\u521b\u5efa\u4e00\u4e2a\u9875\u8868\u5e76\u8bb0\u5f55\u5728 <code>task_struct</code> \u4e2d\uff0c\u53ef\u4ee5\u53c2\u8003\u7684\u4fee\u6539\u5982\u4e0b\uff1a     arch/riscv/kernel/proc.c<pre><code>struct thread_struct {\n    uint64_t ra;\n    uint64_t sp;                     \n    uint64_t s[12];\n    uint64_t sepc, sstatus, sscratch; \n};\n\nstruct task_struct {\n    uint64_t state;\n    uint64_t counter;\n    uint64_t priority;\n    uint64_t pid;\n\n    struct thread_struct thread;\n    uint64_t *pgd;  // \u7528\u6237\u6001\u9875\u8868\n};\n</code></pre></li> </ul>"},{"location":"lab4/#task_init","title":"\u4fee\u6539 <code>task_init()</code>","text":"<ul> <li>\u5bf9\u4e8e\u6bcf\u4e2a\u8fdb\u7a0b\uff0c\u521d\u59cb\u5316\u6211\u4eec\u521a\u521a\u5728 <code>thread_struct</code> \u4e2d\u6dfb\u52a0\u7684\u4e09\u4e2a\u53d8\u91cf\uff0c\u5177\u4f53\u800c\u8a00\uff1a<ul> <li>\u5c06 <code>sepc</code> \u8bbe\u7f6e\u4e3a <code>USER_START</code></li> <li>\u914d\u7f6e <code>sstatus</code> \u4e2d\u7684 <code>SPP</code>\uff08\u4f7f\u5f97 sret \u8fd4\u56de\u81f3 U-Mode\uff09\u3001<code>SUM</code>\uff08S-Mode \u53ef\u4ee5\u8bbf\u95ee User \u9875\u9762\uff09</li> <li>\u5c06 <code>sscratch</code> \u8bbe\u7f6e\u4e3a U-Mode \u7684 sp\uff0c\u5176\u503c\u4e3a <code>USER_END</code> \uff08\u5c06\u7528\u6237\u6001\u6808\u653e\u7f6e\u5728 user space \u7684\u6700\u540e\u4e00\u4e2a\u9875\u9762\uff09</li> </ul> </li> <li> <p>\u5bf9\u4e8e\u6bcf\u4e2a\u8fdb\u7a0b\uff0c\u521b\u5efa\u5c5e\u4e8e\u5b83\u81ea\u5df1\u7684\u9875\u8868\uff1a</p> <ul> <li>\u4e3a\u4e86\u907f\u514d U-Mode \u548c S-Mode \u5207\u6362\u7684\u65f6\u5019\u5207\u6362\u9875\u8868\uff0c\u6211\u4eec\u5c06\u5185\u6838\u9875\u8868 <code>swapper_pg_dir</code> \u590d\u5236\u5230\u6bcf\u4e2a\u8fdb\u7a0b\u7684\u9875\u8868\u4e2d</li> <li>\u5bf9\u4e8e\u6bcf\u4e2a\u8fdb\u7a0b\uff0c\u5206\u914d\u4e00\u5757\u65b0\u7684\u5185\u5b58\u5730\u5740\uff0c\u5c06 <code>uapp</code> \u4e8c\u8fdb\u5236\u6587\u4ef6\u5185\u5bb9\u62f7\u8d1d\u8fc7\u53bb\uff0c\u4e4b\u540e\u518d\u5c06\u5176\u6240\u5728\u7684\u9875\u9762\u6620\u5c04\u5230\u5bf9\u5e94\u8fdb\u7a0b\u7684\u9875\u8868\u4e2d</li> </ul> <p>Tip</p> <p>\u5728\u7a0b\u5e8f\u8fd0\u884c\u8fc7\u7a0b\u4e2d\uff0c\u6709\u90e8\u5206\u6570\u636e\u4e0d\u5728\u6808\u4e0a\uff0c\u800c\u5728\u521d\u59cb\u5316\u7684\u8fc7\u7a0b\u4e2d\u5c31\u5df2\u7ecf\u88ab\u5206\u914d\u4e86\u7a7a\u95f4\uff08\u6bd4\u5982\u6211\u4eec\u7684 <code>uapp</code> \u4e2d\u7684\u5168\u5c40\u53d8\u91cf <code>counter</code>\uff09\u3002\u6240\u4ee5\uff0c\u4e8c\u8fdb\u5236\u6587\u4ef6\u9700\u8981\u5148\u88ab\u62f7\u8d1d\u5230\u4e00\u5757\u65b0\u7684\u3001\u4f9b\u67d0\u4e2a\u8fdb\u7a0b\u4e13\u7528\u7684\u5185\u5b58\u4e4b\u540e\u518d\u8fdb\u884c\u6620\u5c04\uff0c\u6765\u9632\u6b62\u6240\u6709\u7684\u8fdb\u7a0b\u5171\u4eab\u6570\u636e\uff0c\u9020\u6210\u9884\u671f\u5916\u7684\u8fdb\u7a0b\u95f4\u76f8\u4e92\u5f71\u54cd\u3002</p> <p>\u90a3\u4e48\u5e94\u8be5\u5982\u4f55\u8fdb\u884c\u62f7\u8d1d\u5462\uff1f\u5f88\u7b80\u5355\uff0c\u5148\u8ba1\u7b97\u6240\u9700\u7684\u9875\u6570\uff08<code>uapp</code> \u7684\u5927\u5c0f\u9664\u4ee5 PGSIZE \u540e\u5411\u4e0a\u53d6\u6574\uff09\uff0c\u8c03\u7528 <code>alloc_pages()</code> \u51fd\u6570\uff0c\u518d\u5c06 <code>uapp</code> memcpy \u8fc7\u53bb\u3002</p> </li> <li> <p>\u8bbe\u7f6e\u7528\u6237\u6001\u6808\uff0c\u5bf9\u6bcf\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\uff0c\u5176\u62e5\u6709\u4e24\u4e2a\u6808\uff1a</p> <ul> <li>\u7528\u6237\u6001\u6808\uff1a\u6211\u4eec\u53ef\u4ee5\u7533\u8bf7\u4e00\u4e2a\u7a7a\u7684\u9875\u9762\u6765\u4f5c\u4e3a\u7528\u6237\u6001\u6808\uff0c\u5e76\u6620\u5c04\u5230\u8fdb\u7a0b\u7684\u9875\u8868\u4e2d</li> <li>\u5185\u6838\u6001\u6808\uff1b\u5728 lab3 \u4e2d\u5df2\u7ecf\u8bbe\u7f6e\u597d\u4e86\uff0c\u5c31\u662f <code>thread.sp</code></li> </ul> </li> </ul> <pre><code>                PHY_START                                                                PHY_END\n                     new allocated memory            allocated space end\n                   \u2502         \u2502                                \u2502                                                 \u2502\n                   \u25bc         \u25bc                                \u25bc                                                 \u25bc\n       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n PA    \u2502           \u2502         \u2502 uapp (copied from _sramdisk)   \u2502                                                 \u2502\n       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                             \u25b2                                \u25b2\n       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                \u2502\n       \u2502            (map)                                     \u2502\n       \u2502                        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502                        \u2502\n       \u2502                        \u2502\n       \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n VA    \u2502           UAPP         \u2502                                                                   \u2502u mode stack\u2502\n       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u25b2                                                                                                         \u25b2\n       \u2502                                                                                                         \u2502\n\n   USER_START                                                                                                USER_END\n</code></pre>"},{"location":"lab4/#__switch_to","title":"\u4fee\u6539 <code>__switch_to</code>","text":"<p>\u5728\u524d\u9762\u65b0\u589e\u4e86 sepc\u3001sstatus\u3001sscratch \u4e4b\u540e\uff0c\u9700\u8981\u5c06\u8fd9\u4e9b\u53d8\u91cf\u5728\u5207\u6362\u8fdb\u7a0b\u65f6\u4fdd\u5b58\u5728\u6808\u4e0a\uff0c\u56e0\u6b64\u9700\u8981\u66f4\u65b0 <code>__switch_to</code> \u4e2d\u7684\u903b\u8f91\uff0c\u540c\u65f6\u9700\u8981\u589e\u52a0\u5207\u6362\u9875\u8868\u7684\u903b\u8f91\u3002\u5728\u5207\u6362\u4e86\u9875\u8868\u4e4b\u540e\uff0c\u9700\u8981\u901a\u8fc7 <code>sfence.vma</code> \u6765\u5237\u65b0 TLB \u548c ICache\u3002</p> <p>\u5173\u4e8e\u5207\u6362\u9875\u8868</p> <p>\u5207\u6362\u9875\u8868\u7684\u903b\u8f91\u5206\u4e3a\u4e24\u6b65\uff0c\u4e00\u4e2a\u662f\u5199 <code>satp</code>\uff0c\u4e00\u4e2a\u662f\u5237\u65b0 TLB\uff0c\u6211\u4eec\u7528 <code>task_struct</code> \u4e0a\u7684 <code>pgd</code> \u4fdd\u5b58\u4e86\u4e0b\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u7684\u9875\u8868\u7684\u865a\u62df\u5730\u5740\uff0c\u9700\u8981\u901a\u8fc7\u4e00\u4e9b\u53d8\u6362\u5f97\u5230 PPN\uff0c\u52a0\u4e0a MODE \u5199\u5165 <code>satp</code>\u3002</p> <p>\u53ef\u4ee5\u53c2\u8003 lab3 \u4e2d satp \u5bc4\u5b58\u5668\u90e8\u5206\u3002</p>"},{"location":"lab4/#_12","title":"\u66f4\u65b0\u4e2d\u65ad\u5904\u7406\u903b\u8f91","text":"<p>\u4e0e ARM \u67b6\u6784\u4e0d\u540c\u7684\u662f\uff0cRISC-V \u4e2d\u53ea\u6709\u4e00\u4e2a\u6808\u6307\u9488\u5bc4\u5b58\u5668 <code>sp</code>\uff0c\u56e0\u6b64\u9700\u8981\u6211\u4eec\u6765\u5b8c\u6210\u7528\u6237\u6808\u4e0e\u5185\u6838\u6808\u7684\u5207\u6362\u3002</p> <p>\u7531\u4e8e\u6211\u4eec\u7684\u7528\u6237\u6001\u8fdb\u7a0b\u8fd0\u884c\u5728 U-Mode \u4e0b\uff0c\u4f7f\u7528\u7684\u8fd0\u884c\u6808\u4e5f\u662f\u7528\u6237\u6808\uff0c\u56e0\u6b64\u5f53\u89e6\u53d1\u5f02\u5e38\u65f6\uff0c\u6211\u4eec\u9996\u5148\u8981\u5bf9\u6808\u8fdb\u884c\u5207\u6362\uff08\u4ece\u7528\u6237\u6808\u5207\u6362\u5230\u5185\u6838\u6808\uff09\u3002\u540c\u7406\uff0c\u5f53\u6211\u4eec\u5b8c\u6210\u4e86\u5f02\u5e38\u5904\u7406\uff0c\u4ece S-Mode \u8fd4\u56de\u81f3 U-Mode \u65f6\uff0c\u4e5f\u9700\u8981\u8fdb\u884c\u6808\u5207\u6362\uff08\u4ece\u5185\u6838\u6808\u5207\u6362\u5230\u7528\u6237\u6808\uff09\u3002</p>"},{"location":"lab4/#__dummy","title":"\u4fee\u6539 <code>__dummy</code>","text":"<p>\u5728\u6211\u4eec\u521d\u59cb\u5316\u7ebf\u7a0b\u65f6\uff0c<code>thread_struct.sp</code> \u4fdd\u5b58\u4e86\u5185\u6838\u6001\u6808 sp\uff0c<code>thread_struct.sscratch</code> \u4fdd\u5b58\u4e86\u7528\u6237\u6001\u6808 sp\uff0c\u56e0\u6b64\u5728 <code>__dummy</code> \u8fdb\u5165\u7528\u6237\u6001\u6a21\u5f0f\u7684\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u5207\u6362\u8fd9\u4e24\u4e2a\u6808\uff0c\u53ea\u9700\u8981\u4ea4\u6362\u5bf9\u5e94\u7684\u5bc4\u5b58\u5668\u7684\u503c\u5373\u53ef\u3002</p>"},{"location":"lab4/#_traps","title":"\u4fee\u6539 <code>_traps</code>","text":"<p>\u540c\u7406\uff0c\u5728 <code>_traps</code> \u7684\u9996\u5c3e\u6211\u4eec\u90fd\u9700\u8981\u505a\u7c7b\u4f3c\u7684\u64cd\u4f5c\uff0c\u8fdb\u5165 trap \u7684\u65f6\u5019\u9700\u8981\u5207\u6362\u5230\u5185\u6838\u6808\uff0c\u5904\u7406\u5b8c\u6210\u540e\u9700\u8981\u518d\u5207\u6362\u56de\u6765\u3002</p> <p>\u6ce8\u610f\u5982\u679c\u662f\u5185\u6838\u7ebf\u7a0b\uff08\u6ca1\u6709\u7528\u6237\u6808\uff09\u89e6\u53d1\u4e86\u5f02\u5e38\uff0c\u5219\u4e0d\u9700\u8981\u8fdb\u884c\u5207\u6362\u3002\uff08\u5185\u6838\u7ebf\u7a0b\u7684 <code>sp</code> \u6c38\u8fdc\u6307\u5411\u7684\u5185\u6838\u6808\uff0c\u4e14 <code>sscratch</code> \u4e3a 0\uff09</p>"},{"location":"lab4/#trap_handler","title":"\u4fee\u6539 <code>trap_handler</code>","text":"<p><code>uapp</code> \u4f7f\u7528 <code>ecall</code> \u4f1a\u4ea7\u751f Environment Call from U-mode\uff0c\u800c\u4e14\u5904\u7406\u7cfb\u7edf\u8c03\u7528\u7684\u65f6\u5019\u8fd8\u9700\u8981\u5bc4\u5b58\u5668\u7684\u503c\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5728 <code>trap_handler()</code> \u91cc\u9762\u8fdb\u884c\u6355\u83b7\u3002\u4fee\u6539 <code>trap_handler()</code> \u5982\u4e0b\uff1a</p> <pre><code>void trap_handler(uint64_t scause, uint64_t sepc, struct pt_regs *regs) {\n    ...\n}\n</code></pre> <p>\u5728 <code>_traps</code> \u4e2d\u6211\u4eec\u5c06\u5bc4\u5b58\u5668\u7684\u5185\u5bb9\u8fde\u7eed\u7684\u4fdd\u5b58\u5728\u5185\u6838\u6808\u4e0a\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u5c06\u8fd9\u4e00\u6bb5\u770b\u505a\u4e00\u4e2a\u53eb\u505a <code>pt_regs</code> \u7684\u7ed3\u6784\u4f53\u3002\u6211\u4eec\u53ef\u4ee5\u4ece\u8fd9\u4e2a\u7ed3\u6784\u4f53\u4e2d\u53d6\u5230\u76f8\u5e94\u7684\u5bc4\u5b58\u5668\u7684\u503c\uff08\u6bd4\u5982 <code>syscall</code> \u4e2d\u6211\u4eec\u9700\u8981\u4ece a0 ~ a7 \u5bc4\u5b58\u5668\u4e2d\u53d6\u5230\u53c2\u6570\uff09\u3002\u8fd9\u4e2a\u7ed3\u6784\u4f53\u4e2d\u7684\u503c\u4e5f\u53ef\u4ee5\u6309\u9700\u6dfb\u52a0\uff0c\u540c\u65f6\u9700\u8981\u5728 <code>_traps</code> \u4e2d\u5b58\u5165\u5bf9\u5e94\u7684\u5bc4\u5b58\u5668\u503c\u4ee5\u4f9b\u4f7f\u7528\uff0c\u793a\u4f8b\u5982\u4e0b\u56fe\uff1a</p> <pre><code>    High Addr \u2500\u2500\u2500\u25ba  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502   sstatus   \u2502\n                    \u2502             \u2502\n                    \u2502     sepc    \u2502\n                    \u2502             \u2502\n                    \u2502     x31     \u2502\n                    \u2502             \u2502\n                    \u2502      .      \u2502\n                    \u2502      .      \u2502\n                    \u2502      .      \u2502\n                    \u2502             \u2502\n                    \u2502     x1      \u2502\n                    \u2502             \u2502\n                    \u2502     x0      \u2502\n sp (pt_regs)  \u2500\u2500\u25ba  \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n                    \u2502             \u2502\n                    \u2502             \u2502\n                    \u2502             \u2502\n                    \u2502             \u2502\n                    \u2502             \u2502\n                    \u2502             \u2502\n                    \u2502             \u2502\n                    \u2502             \u2502\n                    \u2502             \u2502\n    Low  Addr \u2500\u2500\u2500\u25ba  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>\u8bf7\u540c\u5b66\u81ea\u5df1\u8865\u5145 <code>struct pt_regs</code>\u7684\u5b9a\u4e49\uff0c\u4ee5\u53ca\u5728 <code>trap_handler</code> \u4e2d\u8865\u5145\u5904\u7406 syscall \u7684\u903b\u8f91\u3002</p>"},{"location":"lab4/#_13","title":"\u6dfb\u52a0\u7cfb\u7edf\u8c03\u7528","text":"<p>\u672c\u6b21\u5b9e\u9a8c\u8981\u6c42\u7684\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u539f\u578b\u4ee5\u53ca\u5177\u4f53\u529f\u80fd\u5982\u4e0b\uff1a</p> <ul> <li>64 \u53f7\u7cfb\u7edf\u8c03\u7528 <code>sys_write(unsigned int fd, const char* buf, size_t count)</code> \u8be5\u8c03\u7528\u5c06\u7528\u6237\u6001\u4f20\u9012\u7684\u5b57\u7b26\u4e32\u6253\u5370\u5230\u5c4f\u5e55\u4e0a\uff0c\u6b64\u5904 <code>fd</code> \u4e3a\u6807\u51c6\u8f93\u51fa\u5373 <code>1</code>\uff0c<code>buf</code> \u4e3a\u7528\u6237\u9700\u8981\u6253\u5370\u7684\u8d77\u59cb\u5730\u5740\uff0c<code>count</code> \u4e3a\u5b57\u7b26\u4e32\u957f\u5ea6\uff0c\u8fd4\u56de\u6253\u5370\u7684\u5b57\u7b26\u6570\uff1b</li> <li>172 \u53f7\u7cfb\u7edf\u8c03\u7528 <code>sys_getpid()</code> \u8be5\u8c03\u7528\u4ece <code>current</code> \u4e2d\u83b7\u53d6\u5f53\u524d\u7684 pid \u653e\u5165 a0 \u4e2d\u8fd4\u56de\uff0c\u65e0\u53c2\u6570</li> </ul> <p>\u540c\u5b66\u4eec\u9700\u8981\uff1a</p> <ul> <li>\u589e\u52a0 <code>syscall.c</code>, <code>syscall.h</code> \u6587\u4ef6\uff0c\u5e76\u5728\u5176\u4e2d\u5b9e\u73b0 <code>getpid()</code> \u4ee5\u53ca <code>write()</code> \u903b\u8f91</li> <li>\u7cfb\u7edf\u8c03\u7528\u7684\u8fd4\u56de\u53c2\u6570\u653e\u7f6e\u5728 <code>a0</code> \u4e2d\uff08\u4e0d\u53ef\u4ee5\u76f4\u63a5\u4fee\u6539\u5bc4\u5b58\u5668\uff0c\u5e94\u8be5\u4fee\u6539 regs \u4e2d\u4fdd\u5b58\u7684\u5185\u5bb9\uff09</li> <li>\u9488\u5bf9\u7cfb\u7edf\u8c03\u7528\u8fd9\u4e00\u7c7b\u5f02\u5e38\uff0c\u6211\u4eec\u9700\u8981\u624b\u52a8\u5b8c\u6210 <code>sepc + 4</code></li> </ul>"},{"location":"lab4/#_14","title":"\u8c03\u6574\u65f6\u949f\u4e2d\u65ad","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u4fee\u6539 head.S \u4ee5\u53ca start_kernel\uff1a</p> <ul> <li>\u5728\u4e4b\u524d\u7684 lab \u4e2d\uff0c\u5728 OS boot \u4e4b\u540e\uff0c\u6211\u4eec\u9700\u8981\u7b49\u5f85\u4e00\u4e2a\u65f6\u95f4\u7247\uff0c\u624d\u4f1a\u8fdb\u884c\u8c03\u5ea6\uff0c\u6211\u4eec\u73b0\u5728\u66f4\u6539\u4e3a OS boot \u5b8c\u6210\u4e4b\u540e\u7acb\u5373\u8c03\u5ea6 uapp \u8fd0\u884c<ul> <li>\u5373\u5728 <code>start_kernel()</code> \u4e2d\uff0c<code>test()</code> \u4e4b\u524d\u8c03\u7528 <code>schedule()</code></li> </ul> </li> <li>\u5c06 <code>head.S</code> \u4e2d\u8bbe\u7f6e sstatus.SIE \u7684\u903b\u8f91\u6ce8\u91ca\u6389\uff0c\u786e\u4fdd schedule \u8fc7\u7a0b\u4e0d\u53d7\u4e2d\u65ad\u5f71\u54cd</li> </ul> <p>\u5173\u4e8e SIE \u4e0e SPIE</p> <p>\u8fd9\u91cc\u4fdd\u6301 sstatus.SIE \u4e3a 0 \u53ef\u4ee5\u5728 S \u6001\u7981\u7528\u4e2d\u65ad\u6765\u9632\u6b62\u88ab\u65f6\u949f\u4e2d\u65ad\u6253\u65ad\u3002\u66fe\u7ecf\u6211\u4eec\u8ba9\u5927\u5bb6\u5728\u7528\u6237\u6001\u8fdb\u7a0b\u521d\u59cb\u5316\u7684\u65f6\u5019\u8bbe\u7f6e sstatus.SPIE \u4f7f\u5f97\u8fdb\u5165\u7528\u6237\u6001\u8fdb\u7a0b\u540e sstatus.SIE \u81ea\u52a8\u88ab\u7f6e\u4e3a sstatus.SPIE \u7684\u503c\uff08\u5373 1\uff09\uff0c\u8fd9\u6837\u5728\u7528\u6237\u6001\u8fdb\u7a0b\u4e2d\u53ef\u4ee5\u63a5\u6536\u5230\u65f6\u949f\u4e2d\u65ad\u3002\u4f46\u662f RISC-V Privileged Spec \u7b2c 3.1.6.1 \u8282\u5199\u9053\uff1a</p> <p>When a hart is executing in privilege mode x, interrupts are globally enabled when xIE=1 and globally disabled when xIE=0. ... Interrupts for higher-privilege modes, y&gt;x, are always globally enabled regardless of the setting of the global yIE bit for the higher-privilege mode.</p> <p>\u4e5f\u5c31\u662f\u8bf4 CPU \u5728\u7528\u6237\u6001 x=U \u8fd0\u884c\u7684\u65f6\u5019\uff0c\u4e0d\u8bba\u9ad8\u7279\u6743\u7ea7\uff08y=S\uff09\u7684 SIE \u4f4d\u662f\u5426\u4e3a 1\uff0c\u90fd\u4f1a\u5168\u5c40\u5f00\u542f\u9ad8\u7279\u6743\u7ea7\u7684\u4e2d\u65ad\u3002\u6240\u4ee5\u5728\u7528\u6237\u6001\u4e0d\u7ba1 sstatus.SIE \u5982\u4f55\u8bbe\u7f6e\uff0c\u90fd\u4f1a\u59cb\u7ec8\u63a5\u6536\u5230 S \u6001\u7684\u65f6\u949f\u4e2d\u65ad\uff0c\u56e0\u6b64\u4e4b\u524d\u5bf9\u4e8e sstatus.SPIE \u7684\u8bbe\u7f6e\u5e76\u65e0\u5fc5\u8981\u3002</p>"},{"location":"lab4/#_15","title":"\u6d4b\u8bd5\u7eaf\u4e8c\u8fdb\u5236\u6587\u4ef6","text":"<p>\u7531\u4e8e\u52a0\u5165\u4e86\u4e00\u4e9b\u65b0\u7684 .c \u6587\u4ef6\uff0c\u53ef\u80fd\u9700\u8981\u4fee\u6539\u4e00\u4e9b Makefile \u6587\u4ef6\uff0c\u8bf7\u540c\u5b66\u81ea\u5df1\u5c1d\u8bd5\u4fee\u6539\uff0c\u4f7f\u9879\u76ee\u53ef\u4ee5\u7f16\u8bd1\u5e76\u8fd0\u884c\u3002</p> \u8f93\u51fa\u793a\u4f8b <pre><code>...buddy_init done!\n...mm_init done!\n...task_init done!\n2024 ZJU Operating System\nSET [PID = 1 PRIORITY = 7 COUNTER = 7]\nSET [PID = 2 PRIORITY = 10 COUNTER = 10]\nSET [PID = 3 PRIORITY = 4 COUNTER = 4]\nSET [PID = 4 PRIORITY = 1 COUNTER = 1]\n\nswitch to [PID = 2 COUNTER = 10]\n[U-MODE] pid: 2, sp is 0000003fffffffe0, this is print No.1\n[U-MODE] pid: 2, sp is 0000003fffffffe0, this is print No.2\n\nswitch to [PID = 1 COUNTER = 7]\n[U-MODE] pid: 1, sp is 0000003fffffffe0, this is print No.1\n\nswitch to [PID = 3 COUNTER = 4]\n[U-MODE] pid: 3, sp is 0000003fffffffe0, this is print No.1\n\nswitch to [PID = 4 COUNTER = 1]\n[U-MODE] pid: 4, sp is 0000003fffffffe0, this is print No.1\nSET [PID = 1 PRIORITY = 7 COUNTER = 7]\nSET [PID = 2 PRIORITY = 10 COUNTER = 10]\nSET [PID = 3 PRIORITY = 4 COUNTER = 4]\nSET [PID = 4 PRIORITY = 1 COUNTER = 1]\n\nswitch to [PID = 2 COUNTER = 10]\n[U-MODE] pid: 2, sp is 0000003fffffffe0, this is print No.3\n\nswitch to [PID = 1 COUNTER = 7]\n[U-MODE] pid: 1, sp is 0000003fffffffe0, this is print No.2\n\nswitch to [PID = 3 COUNTER = 4]\n[U-MODE] pid: 3, sp is 0000003fffffffe0, this is print No.2\n...\n</code></pre>"},{"location":"lab4/#elf_1","title":"\u6dfb\u52a0 ELF \u89e3\u6790\u4e0e\u52a0\u8f7d","text":""},{"location":"lab4/#elf_2","title":"ELF \u683c\u5f0f","text":"<p>ELF \u6587\u4ef6\u4e2d\u5305\u542b\u4e86\u5c06\u7a0b\u5e8f\u52a0\u8f7d\u5230\u5185\u5b58\u6240\u9700\u7684\u4fe1\u606f\uff0c\u53ef\u4ee5\u53c2\u8003\u8fd9\u4e2a\u94fe\u63a5</p> <p>\u5f53\u6211\u4eec\u901a\u8fc7 <code>readelf</code> \u6765\u67e5\u770b\u4e00\u4e2a ELF \u53ef\u6267\u884c\u6587\u4ef6\u7684\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u4ee5\u8bfb\u5230\u88ab\u5305\u542b\u5728 ELF Header \u4e2d\u7684\u4fe1\u606f\uff1a</p> <code>readelf -a -W uapp</code> <pre><code>$ readelf -a -W uapp\nELF Header:\nMagic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 \nClass:                             ELF64\nData:                              2's complement, little endian\nVersion:                           1 (current)\nOS/ABI:                            UNIX - System V\nABI Version:                       0\nType:                              EXEC (Executable file)\nMachine:                           RISC-V\nVersion:                           0x1\nEntry point address:               0x100e8\nStart of program headers:          64 (bytes into file)\nStart of section headers:          6040 (bytes into file)\nFlags:                             0x0\nSize of this header:               64 (bytes)\nSize of program headers:           56 (bytes)\nNumber of program headers:         3\nSize of section headers:           64 (bytes)\nNumber of section headers:         9\nSection header string table index: 8\n\nSection Headers:\n[Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al\n[ 0]                   NULL            0000000000000000 000000 000000 00      0   0  0\n[ 1] .text             PROGBITS        00000000000100e8 0000e8 00106c 00  AX  0   0  4\n[ 2] .rodata           PROGBITS        0000000000011158 001158 000081 00   A  0   0  8\n[ 3] .bss              NOBITS          00000000000121e0 0011d9 0003f0 00  WA  0   0  8\n[ 4] .comment          PROGBITS        0000000000000000 0011d9 00001f 01  MS  0   0  1\n[ 5] .riscv.attributes RISCV_ATTRIBUTES 0000000000000000 0011f8 00004e 00      0   0  1\n[ 6] .symtab           SYMTAB          0000000000000000 001248 0003d8 18      7  24  8\n[ 7] .strtab           STRTAB          0000000000000000 001620 000129 00      0   0  1\n[ 8] .shstrtab         STRTAB          0000000000000000 001749 000049 00      0   0  1\nKey to Flags:\nW (write), A (alloc), X (execute), M (merge), S (strings), I (info),\nL (link order), O (extra OS processing required), G (group), T (TLS),\nC (compressed), x (unknown), o (OS specific), E (exclude),\nD (mbind), p (processor specific)\n\nThere are no section groups in this file.\n\nProgram Headers:\nType           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align\nRISCV_ATTRIBUT 0x0011f8 0x0000000000000000 0x0000000000000000 0x00004e 0x000000 R   0x1\nLOAD           0x0000e8 0x00000000000100e8 0x00000000000100e8 0x0010f1 0x0024e8 RWE 0x8\nGNU_STACK      0x000000 0x0000000000000000 0x0000000000000000 0x000000 0x000000 RW  0x10\n\nSection to Segment mapping:\nSegment Sections...\n00     .riscv.attributes \n01     .text .rodata .bss \n02     \n\nThere is no dynamic section in this file.\n\nThere are no relocations in this file.\n\nThe decoding of unwind sections for machine type RISC-V is not currently supported.\n\nSymbol table '.symtab' contains 41 entries:\nNum:    Value          Size Type    Bind   Vis      Ndx Name\n    0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND \n    1: 00000000000100e8     0 SECTION LOCAL  DEFAULT    1 .text\n    2: 0000000000011158     0 SECTION LOCAL  DEFAULT    2 .rodata\n    3: 00000000000121e0     0 SECTION LOCAL  DEFAULT    3 .bss\n    4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4 .comment\n    5: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 .riscv.attributes\n    6: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS start.o\n    7: 00000000000100e8     0 NOTYPE  LOCAL  DEFAULT    1 $xrv64i2p1_m2p0_a2p1_f2p2_d2p2_zicsr2p0_zifencei2p0_zmmul1p0\n    8: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS getpid.c\n    9: 00000000000100ec    52 FUNC    LOCAL  DEFAULT    1 getpid\n    10: 00000000000100ec     0 NOTYPE  LOCAL  DEFAULT    1 $xrv64i2p1_m2p0_a2p1_f2p2_d2p2_zicsr2p0_zifencei2p0_zmmul1p0\n    11: 0000000000010120     0 NOTYPE  LOCAL  DEFAULT    1 $xrv64i2p1_m2p0_a2p1_f2p2_d2p2_zicsr2p0_zifencei2p0_zmmul1p0\n    12: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS printf.c\n    13: 00000000000101a4     0 NOTYPE  LOCAL  DEFAULT    1 $xrv64i2p1_m2p0_a2p1_f2p2_d2p2_zicsr2p0_zifencei2p0_zmmul1p0\n    14: 000000000001020c     0 NOTYPE  LOCAL  DEFAULT    1 $xrv64i2p1_m2p0_a2p1_f2p2_d2p2_zicsr2p0_zifencei2p0_zmmul1p0\n    15: 000000000001026c     0 NOTYPE  LOCAL  DEFAULT    1 $xrv64i2p1_m2p0_a2p1_f2p2_d2p2_zicsr2p0_zifencei2p0_zmmul1p0\n    16: 00000000000104d8   136 FUNC    LOCAL  DEFAULT    1 puts_wo_nl\n    17: 00000000000104d8     0 NOTYPE  LOCAL  DEFAULT    1 $xrv64i2p1_m2p0_a2p1_f2p2_d2p2_zicsr2p0_zifencei2p0_zmmul1p0\n    18: 0000000000010560   776 FUNC    LOCAL  DEFAULT    1 print_dec_int\n    19: 0000000000010560     0 NOTYPE  LOCAL  DEFAULT    1 $xrv64i2p1_m2p0_a2p1_f2p2_d2p2_zicsr2p0_zifencei2p0_zmmul1p0\n    20: 0000000000010868     0 NOTYPE  LOCAL  DEFAULT    1 $xrv64i2p1_m2p0_a2p1_f2p2_d2p2_zicsr2p0_zifencei2p0_zmmul1p0\n    21: 00000000000111b0    17 OBJECT  LOCAL  DEFAULT    2 upperxdigits.1\n    22: 00000000000111c8    17 OBJECT  LOCAL  DEFAULT    2 lowerxdigits.0\n    23: 0000000000011058     0 NOTYPE  LOCAL  DEFAULT    1 $xrv64i2p1_m2p0_a2p1_f2p2_d2p2_zicsr2p0_zifencei2p0_zmmul1p0\n    24: 0000000000011058   252 FUNC    GLOBAL DEFAULT    1 printf\n    25: 00000000000129d9     0 NOTYPE  GLOBAL DEFAULT  ABS __global_pointer$\n    26: 0000000000010868  2032 FUNC    GLOBAL DEFAULT    1 vprintfmt\n    27: 00000000000121d9     0 NOTYPE  GLOBAL DEFAULT    2 __SDATA_BEGIN__\n    28: 000000000001020c    96 FUNC    GLOBAL DEFAULT    1 isspace\n    29: 000000000001026c   620 FUNC    GLOBAL DEFAULT    1 strtol\n    30: 00000000000121e4     4 OBJECT  GLOBAL DEFAULT    3 tail\n    31: 00000000000100e8     0 NOTYPE  GLOBAL DEFAULT    1 _start\n    32: 00000000000121e8  1000 OBJECT  GLOBAL DEFAULT    3 buffer\n    33: 00000000000125d0     0 NOTYPE  GLOBAL DEFAULT    3 __BSS_END__\n    34: 00000000000121e0     4 OBJECT  GLOBAL DEFAULT    3 counter\n    35: 00000000000121d9     0 NOTYPE  GLOBAL DEFAULT    3 __bss_start\n    36: 0000000000010120   132 FUNC    GLOBAL DEFAULT    1 main\n    37: 00000000000101a4   104 FUNC    GLOBAL DEFAULT    1 putc\n    38: 00000000000121d9     0 NOTYPE  GLOBAL DEFAULT    2 __DATA_BEGIN__\n    39: 00000000000121d9     0 NOTYPE  GLOBAL DEFAULT    2 _edata\n    40: 00000000000125d0     0 NOTYPE  GLOBAL DEFAULT    3 _end\n\nNo version information found in this file.\nAttribute Section: riscv\nFile Attributes\nTag_RISCV_stack_align: 16-bytes\nTag_RISCV_arch: \"rv64i2p1_m2p0_a2p1_f2p2_d2p2_zicsr2p0_zifencei2p0_zmmul1p0\"\n</code></pre> <p>\u5176\u4e2d\u5305\u542b\u4e86\u4e24\u79cd\u5c06\u7a0b\u5e8f\u5206\u5757\u7684\u7c92\u5ea6\uff0cSegment \u548c Section\uff0c\u6211\u4eec\u4ee5 segment \u4e3a\u7c92\u5ea6\u5c06\u7a0b\u5e8f\u52a0\u8f7d\u8fdb\u5185\u5b58\u4e2d\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u7ed9\u51fa\u7684\u6837\u4f8b\u7a0b\u5e8f\u5305\u542b\u4e86\u4e09\u4e2a segment\uff0c\u8fd9\u91cc\u6211\u4eec\u53ea\u5173\u6ce8 Type \u4e3a LOAD \u7684 segment\uff0cLOAD \u8868\u793a\u5b83\u4eec\u9700\u8981\u5728\u5f00\u59cb\u8fd0\u884c\u524d\u88ab\u52a0\u8f7d\u8fdb\u5185\u5b58\u4e2d\uff0c\u8fd9\u662f\u6211\u4eec\u5728\u521d\u59cb\u5316\u8fdb\u7a0b\u7684\u65f6\u5019\u9700\u8981\u6267\u884c\u7684\u5de5\u4f5c\u3002</p> <p>\u800c section \u4ee3\u8868\u4e86\u66f4\u7ec6\u5206\u7684\u8bed\u4e49\uff0c\u6bd4\u5982 <code>.text</code> \u4e00\u822c\u5305\u542b\u4e86\u7a0b\u5e8f\u7684\u6307\u4ee4\uff0c<code>.rodata</code> \u662f\u53ea\u8bfb\u7684\u5168\u5c40\u53d8\u91cf\u7b49\uff0c\u5927\u5bb6\u53ef\u4ee5\u81ea\u884c Google \u6765\u5b66\u4e60\u66f4\u591a\u76f8\u5173\u5185\u5bb9\u3002</p>"},{"location":"lab4/#elf_3","title":"ELF \u6587\u4ef6\u89e3\u6790","text":"<p>\u9996\u5148\u6211\u4eec\u9700\u8981\u5c06 <code>uapp.S</code> \u4e2d\u7684 payload \u7ed9\u6362\u6210\u6211\u4eec\u7684 ELF \u6587\u4ef6\uff1a</p> <p>user/uapp.S<pre><code>.section .uapp\n\n.incbin \"uapp\"\n</code></pre> \u8fd9\u65f6\u5019\u4ece <code>_sramdisk</code> \u5f00\u59cb\u7684\u6570\u636e\u5c31\u53d8\u6210\u4e86\u540d\u4e3a <code>uapp</code> \u7684 ELF \u6587\u4ef6\uff0c\u4e5f\u5c31\u662f\u8bf4 <code>_sramdisk</code> \u5904 32-bit \u7684\u6570\u636e\u4e0d\u518d\u662f\u6211\u4eec\u9700\u8981\u6267\u884c\u7b2c\u4e00\u6761\u6307\u4ee4\u4e86\uff0c\u800c\u662f ELF Header \u7684\u5f00\u59cb\u3002</p> <p>\u8fd9\u65f6\u5019\u5c31\u9700\u8981\u4f60\u5bf9 <code>task_init</code> \u4e2d\u7684\u521d\u59cb\u5316\u6b65\u9aa4\u8fdb\u884c\u4fee\u6539\u3002\u6211\u4eec\u7ed9\u51fa\u4e86 ELF \u76f8\u5173\u7684\u7ed3\u6784\u4f53\u5b9a\u4e49\uff08\u89c1 <code>elf.h</code>\uff09\uff0c\u5927\u5bb6\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u3002\u4f60\u53ef\u80fd\u4f1a\u4f7f\u7528\u5230\u7684\u7ed3\u6784\u4f53\u6216\u8005\u57df\u5982\u4e0b\uff1a</p> <pre><code>typedef struct {\n  unsigned char e_ident[EI_NIDENT]; // magic number\uff0c\u5224\u65ad\u662f\u5426\u662f Ehdr\uff0c\u56fa\u5b9a\u4e3a 7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00\n  Elf64_Half    e_type;\n  Elf64_Half    e_machine;\n  Elf64_Word    e_version;\n  Elf64_Addr    e_entry;        // \u7a0b\u5e8f\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u88ab\u5b58\u50a8\u7684\u7528\u6237\u6001\u865a\u62df\u5730\u5740\n  Elf64_Off e_phoff;            // ELF \u6587\u4ef6\u5305\u542b\u7684 Segment \u6570\u7ec4\uff08Phdr\uff09\u76f8\u5bf9\u4e8e Ehdr \u7684\u504f\u79fb\u91cf\n  Elf64_Off e_shoff;\n  Elf64_Word    e_flags;\n  Elf64_Half    e_ehsize;\n  Elf64_Half    e_phentsize;\n  Elf64_Half    e_phnum;        // ELF \u6587\u4ef6\u5305\u542b\u7684 Segment \u7684\u6570\u91cf\n  Elf64_Half    e_shentsize;\n  Elf64_Half    e_shnum;\n  Elf64_Half    e_shstrndx;\n} Elf64_Ehdr;\n\ntypedef struct {\n  Elf64_Word    p_type;     // Segment \u7684\u7c7b\u578b\n  Elf64_Word    p_flags;    // Segment \u7684\u6743\u9650\uff08\u5305\u62ec\u4e86\u8bfb\u3001\u5199\u548c\u6267\u884c\uff09\n  Elf64_Off p_offset;       // Segment \u5728\u6587\u4ef6\u4e2d\u76f8\u5bf9\u4e8e Ehdr \u7684\u504f\u79fb\u91cf\n  Elf64_Addr    p_vaddr;    // Segment \u8d77\u59cb\u7684\u7528\u6237\u6001\u865a\u62df\u5730\u5740\n  Elf64_Addr    p_paddr;\n  Elf64_Xword   p_filesz;   // Segment \u5728\u6587\u4ef6\u4e2d\u5360\u7684\u5927\u5c0f\n  Elf64_Xword   p_memsz;    // Segment \u5728\u5185\u5b58\u4e2d\u5360\u7684\u5927\u5c0f\n  Elf64_Xword   p_align;\n} Elf64_Phdr;   // \u5b58\u50a8\u4e86\u7a0b\u5e8f\u5404\u4e2a Segment \u76f8\u5173\u7684 metadata\n                // \u4f60\u53ef\u4ee5\u5c06 _sramdisk + e_phoff \u5f3a\u5236\u8f6c\u5316\u4e3a\u6b64\u7c7b\u578b\uff0c\u5c31\u4f1a\u6307\u5411\u7b2c\u4e00\u4e2a Phdr\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u6309\u7167\u8fd9\u4e9b\u4fe1\u606f\uff0c\u4ece _sramdisk \u5f00\u59cb\u7684 ELF \u6587\u4ef6\u4e2d\u62f7\u8d1d\u5185\u5bb9\u5230\u6211\u4eec\u5f00\u8f9f\u7684\u5185\u5b58\u4e2d\u3002</p> <p>\u5176\u4e2d\u76f8\u5bf9\u6587\u4ef6\u504f\u79fb <code>p_offset</code> \u6307\u51fa\u76f8\u5e94 segment \u7684\u5185\u5bb9\u4ece ELF \u6587\u4ef6\u7684\u7b2c <code>p_offset</code> \u5b57\u8282\u5f00\u59cb\uff0c\u5728\u6587\u4ef6\u4e2d\u7684\u5927\u5c0f\u4e3a <code>p_filesz</code>\uff0c\u5b83\u9700\u8981\u88ab\u5206\u914d\u5230\u4ee5 <code>p_vaddr</code> \u4e3a\u9996\u5730\u5740\u7684\u865a\u62df\u5185\u5b58\u4f4d\u7f6e\uff0c\u5728\u5185\u5b58\u4e2d\u5b83\u5360\u7528\u5927\u5c0f\u4e3a <code>p_memsz</code>\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a segment \u4f7f\u7528\u7684\u5185\u5b58\u5c31\u662f <code>[p_vaddr, p_vaddr + p_memsz)</code> \u8fd9\u4e00\u8fde\u7eed\u533a\u95f4\uff0c\u7136\u540e\u5c06 segment \u7684\u5185\u5bb9\u4eceELF\u6587\u4ef6\u4e2d\u8bfb\u5165\u5230\u8fd9\u4e00\u5185\u5b58\u533a\u95f4\uff0c\u5e76\u5c06 <code>[p_vaddr + p_filesz, p_vaddr + p_memsz)</code> \u5bf9\u5e94\u7684\u7269\u7406\u533a\u95f4\u6e05\u96f6\u3002\uff08\u672c\u6bb5\u5185\u5bb9\u5f15\u7528\u81ea\u5357\u4eac\u5927\u5b66 PA\uff09</p> <p>\u4f60\u4e5f\u53ef\u4ee5\u53c2\u8003\u8fd9\u7bc7 blog \u4e2d\u5173\u4e8e\u9759\u6001\u94fe\u63a5\u7a0b\u5e8f\u7684\u8f7d\u5165\u8fc7\u7a0b\u6765\u8fdb\u884c\u4f60\u7684\u8f7d\u5165\u3002</p> <p>\u8fd9\u91cc\u6709\u4e0d\u5c11\u4f8b\u5b50\u53ef\u4ee5\u4e3e\uff0c\u4e3a\u4e86\u907f\u514d\u540c\u5b66\u4eec\u5728\u5b9e\u9a8c\u4e2d\u82b1\u592a\u591a\u65f6\u95f4\uff0c\u6211\u4eec\u544a\u8bc9\u5927\u5bb6\u53ef\u4ee5\u600e\u4e48\u627e\u5230\u5b9e\u9a8c\u4e2d\u8fd9\u4e9b\u76f8\u5173\u53d8\u91cf\uff1a\uff08\u6ce8\u610f\u4ee5\u4e0b\u7684 <code>_sramdisk</code> \u7c7b\u578b\u4f7f\u7528\u7684\u662f <code>char*</code>\uff0c\u5982\u679c\u4f60\u5728\u4f7f\u7528\u5176\u4ed6\u7c7b\u578b\uff0c\u9700\u8981\u6839\u636e\u4f60\u4f7f\u7528\u7684\u7c7b\u578b\u53bb\u8c03\u6574\u9488\u5bf9\u6307\u9488\u7684\u7b97\u6570\u8fd0\u7b97\uff09</p> <ul> <li><code>Elf64_Ehdr *ehdr = (Elf64_Ehdr *)_sramdisk</code>\uff0c\u4ece\u5730\u5740 _sramdisk \u5f00\u59cb\uff0c\u4fbf\u662f\u6211\u4eec\u8981\u627e\u7684 Ehdr</li> <li><code>Elf64_Phdr *phdrs = (Elf64_Phdr *)(_sramdisk + ehdr-&gt;phoff)</code>\uff0c\u662f\u4e00\u4e2a Phdr \u6570\u7ec4\uff0c\u5176\u4e2d\u7684\u6bcf\u4e2a\u5143\u7d20\u90fd\u662f\u4e00\u4e2a <code>Elf64_Phdr</code></li> <li><code>phdrs + 1</code> \u662f\u6307\u5411\u7b2c\u4e8c\u4e2a Phdr \u7684\u6307\u9488</li> <li><code>phdrs-&gt;p_type == PT_LOAD</code>\uff0c\u8bf4\u660e\u8fd9\u4e2a Segment \u7684\u7c7b\u578b\u662f LOAD\uff0c\u9700\u8981\u5728\u521d\u59cb\u5316\u65f6\u88ab\u52a0\u8f7d\u8fdb\u5185\u5b58</li> </ul> <p>\u5269\u4e0b\u7684\u57df\u7684\u7528\u6cd5\u6211\u4eec\u5e0c\u671b\u540c\u5b66\u4eec\u901a\u8fc7\u9605\u8bfb <code>man elf</code> \u547d\u4ee4\u6216\u5728\u7f51\u4e0a\u641c\u7d22\u3002\u5927\u5bb6\u53ef\u4ee5\u53c2\u8003\u4ee5\u4e0b\u7684\u4ee3\u7801\u6765\u5c06\u7a0b\u5e8f load \u8fdb\u5165\u5185\u5b58\u3002</p> <pre><code>void load_program(struct task_struct *task) {\n    Elf64_Ehdr *ehdr = (Elf64_Ehdr *)_sramdisk;\n    Elf64_Phdr *phdrs = (Elf64_Phdr *)(_sramdisk + ehdr-&gt;e_phoff);\n    for (int i = 0; i &lt; ehdr-&gt;e_phnum; ++i) {\n        Elf64_Phdr *phdr = phdrs + i;\n        if (phdr-&gt;p_type == PT_LOAD) {\n            // alloc space and copy content\n            // do mapping\n            // code...\n        }\n    }\n    task-&gt;thread.sepc = ehdr-&gt;e_entry;\n}\n</code></pre> <p>Tip</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u56e0\u4e3a\u865a\u62df\u5185\u5b58\u548c\u7269\u7406\u5185\u5b58\u7684\u6620\u5c04\u662f\u6309\u9875\u4e3a\u5355\u4f4d\u7684\uff0c\u5982\u679c <code>e_entry</code> \u5e76\u6ca1\u6709\u6309\u9875\u5bf9\u9f50\u7684\u8bdd\uff0c\u9700\u8981\u5728\u62f7\u8d1d\u7684\u65f6\u5019\u8003\u8651 offset \u7684\u95ee\u9898\u3002</p>"},{"location":"lab4/#_16","title":"\u601d\u8003\u9898","text":"<ol> <li>\u6211\u4eec\u5728\u5b9e\u9a8c\u4e2d\u4f7f\u7528\u7684\u7528\u6237\u6001\u7ebf\u7a0b\u548c\u5185\u6838\u6001\u7ebf\u7a0b\u7684\u5bf9\u5e94\u5173\u7cfb\u662f\u600e\u6837\u7684\uff1f\uff08\u4e00\u5bf9\u4e00\uff0c\u4e00\u5bf9\u591a\uff0c\u591a\u5bf9\u4e00\u8fd8\u662f\u591a\u5bf9\u591a\uff09</li> <li>\u7cfb\u7edf\u8c03\u7528\u8fd4\u56de\u4e3a\u4ec0\u4e48\u4e0d\u80fd\u76f4\u63a5\u4fee\u6539\u5bc4\u5b58\u5668\uff1f</li> <li>\u9488\u5bf9\u7cfb\u7edf\u8c03\u7528\uff0c\u4e3a\u4ec0\u4e48\u8981\u624b\u52a8\u5c06 sepc + 4\uff1f</li> <li>\u4e3a\u4ec0\u4e48 Phdr \u4e2d\uff0c<code>p_filesz</code> \u548c <code>p_memsz</code> \u662f\u4e0d\u4e00\u6837\u5927\u7684\uff0c\u5b83\u4eec\u5206\u522b\u8868\u793a\u4ec0\u4e48\uff1f</li> <li>\u4e3a\u4ec0\u4e48\u591a\u4e2a\u8fdb\u7a0b\u7684\u6808\u865a\u62df\u5730\u5740\u53ef\u4ee5\u662f\u76f8\u540c\u7684\uff1f\u7528\u6237\u6709\u6ca1\u6709\u5e38\u89c4\u7684\u65b9\u6cd5\u77e5\u9053\u81ea\u5df1\u6808\u6240\u5728\u7684\u7269\u7406\u5730\u5740\uff1f</li> </ol>"},{"location":"lab4/#_17","title":"\u5b9e\u9a8c\u4efb\u52a1\u4e0e\u8981\u6c42","text":"<ul> <li>\u8bf7\u5404\u4f4d\u540c\u5b66\u72ec\u7acb\u5b8c\u6210\u4f5c\u4e1a\uff0c\u4efb\u4f55\u6284\u88ad\u884c\u4e3a\u90fd\u5c06\u4f7f\u672c\u6b21\u4f5c\u4e1a\u5224\u4e3a 0 \u5206\u3002</li> <li>\u5728\u5b66\u5728\u6d59\u5927\u4e2d\u63d0\u4ea4\uff1a<ul> <li>\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u7684\u538b\u7f29\u5305\uff08\u63d0\u4ea4\u4e4b\u524d\u8bf7\u4f7f\u7528 <code>make clean</code> \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\uff09</li> <li>pdf \u683c\u5f0f\u7684\u5b9e\u9a8c\u62a5\u544a\uff1a<ul> <li>\u8bb0\u5f55\u5b9e\u9a8c\u8fc7\u7a0b\u5e76\u622a\u56fe\uff084.1-4.3\uff09\uff0c\u5e76\u5bf9\u6bcf\u4e00\u6b65\u7684\u547d\u4ee4\u4ee5\u53ca\u7ed3\u679c\u8fdb\u884c\u5fc5\u8981\u7684\u89e3\u91ca\uff1b</li> <li>\u8bb0\u5f55\u9047\u5230\u7684\u95ee\u9898\u548c\u5fc3\u5f97\u4f53\u4f1a\uff1b</li> <li>\u5b8c\u6210\u601d\u8003\u9898\u3002</li> </ul> </li> </ul> </li> </ul> <p>\u5173\u4e8e\u5b9e\u9a8c\u62a5\u544a\u5185\u5bb9\u8981\u6c42\uff0c\u53ef\u89c1\uff1a\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54 - \u5b9e\u9a8c\u63d0\u4ea4\u8981\u6c42</p>"},{"location":"lab5/","title":"Lab 5: RV64 \u7f3a\u9875\u5f02\u5e38\u5904\u7406\u4e0e fork \u673a\u5236","text":""},{"location":"lab5/#_1","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<ul> <li>\u901a\u8fc7 vm_area_struct \u6570\u636e\u7ed3\u6784\u5b9e\u73b0\u5bf9\u8fdb\u7a0b\u591a\u533a\u57df\u865a\u62df\u5185\u5b58\u7684\u7ba1\u7406</li> <li>\u5728 Lab4 \u5b9e\u73b0\u7528\u6237\u6001\u7a0b\u5e8f\u7684\u57fa\u7840\u4e0a\uff0c\u6dfb\u52a0\u7f3a\u9875\u5f02\u5e38\u5904\u7406 page fault handler</li> <li>\u4e3a\u8fdb\u7a0b\u52a0\u5165 fork \u673a\u5236\uff0c\u80fd\u591f\u652f\u6301\u901a\u8fc7 fork \u521b\u5efa\u65b0\u7684\u7528\u6237\u6001\u8fdb\u7a0b</li> </ul>"},{"location":"lab5/#_2","title":"\u5b9e\u9a8c\u73af\u5883","text":"<ul> <li>Environment in previous labs</li> </ul>"},{"location":"lab5/#_3","title":"\u80cc\u666f\u77e5\u8bc6","text":"<p>\u4e0b\u9762\u662f Linux \u4e2d\u5bf9\u4e8e VMA\uff08virtual memory area\uff09\u548c page fault handler \u7684\u4ecb\u7ecd\uff08\u987a\u4fbf\u5e2e\u5927\u5bb6\u590d\u4e60\u4e0b\u671f\u672b\u8003\uff09\u3002\u7531\u4e8e Linux \u5de8\u5927\u7684\u4f53\u91cf\uff0c\u65e0\u8bba\u662f VMA \u8fd8\u662f page fault \u7684\u903b\u8f91\u90fd\u8f83\u4e3a\u590d\u6742\uff0c\u8fd9\u91cc\u53ea\u8981\u6c42\u5927\u5bb6\u5b9e\u73b0\u7b80\u5316\u7248\u672c\u7684\uff0c\u6240\u4ee5\u4e0d\u8981\u5728\u9605\u8bfb\u80cc\u666f\u4ecb\u7ecd\u7684\u65f6\u5019\u6709\u592a\u5927\u7684\u538b\u529b\u3002</p>"},{"location":"lab5/#vm_area_struct","title":"vm_area_struct \u4ecb\u7ecd","text":"<p>\u5728 Linux \u7cfb\u7edf\u4e2d\uff0c<code>vm_area_struct</code> \u662f\u865a\u62df\u5185\u5b58\u7ba1\u7406\u7684\u57fa\u672c\u5355\u5143\uff0c<code>vm_area_struct</code> \u4fdd\u5b58\u4e86\u6709\u5173\u8fde\u7eed\u865a\u62df\u5185\u5b58\u533a\u57df\uff08\u7b80\u79f0 vma\uff09\u7684\u4fe1\u606f\u3002Linux \u5177\u4f53\u67d0\u4e00\u8fdb\u7a0b\u7684\u865a\u62df\u5185\u5b58\u533a\u57df\u6620\u5c04\u5173\u7cfb\u53ef\u4ee5\u901a\u8fc7 procfs \u8bfb\u53d6 <code>/proc/&lt;pid&gt;/maps</code> \u7684\u5185\u5bb9\u6765\u83b7\u53d6:</p> <p>\u6bd4\u5982\uff0c\u5982\u4e0b\u9762\u4e00\u4e2a\u5e38\u89c4\u7684 <code>bash</code> \u8fdb\u7a0b\uff0c\u5047\u8bbe\u5b83\u7684 pid \u4e3a <code>7884</code>\uff0c\u5219\u901a\u8fc7\u8f93\u5165\u5982\u4e0b\u547d\u4ee4\uff0c\u5c31\u53ef\u4ee5\u67e5\u770b\u8be5\u8fdb\u7a0b\u5177\u4f53\u7684\u865a\u62df\u5730\u5740\u5185\u5b58\u6620\u5c04\u60c5\u51b5\uff08\u90e8\u5206\u4fe1\u606f\u5df2\u7701\u7565\uff09\uff1a</p> <pre><code>$ cat /proc/7884/maps\n556f22759000-556f22786000 r--p 00000000 08:05 16515165                   /usr/bin/bash\n556f22786000-556f22837000 r-xp 0002d000 08:05 16515165                   /usr/bin/bash\n556f22837000-556f2286e000 r--p 000de000 08:05 16515165                   /usr/bin/bash\n556f2286e000-556f22872000 r--p 00114000 08:05 16515165                   /usr/bin/bash\n556f22872000-556f2287b000 rw-p 00118000 08:05 16515165                   /usr/bin/bash\n556f22fa5000-556f2312c000 rw-p 00000000 00:00 0                          [heap]\n7fb9edb0f000-7fb9edb12000 r--p 00000000 08:05 16517264                   /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so\n7fb9edb12000-7fb9edb19000 r-xp 00003000 08:05 16517264                   /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so                 \n...\n7ffee5cdc000-7ffee5cfd000 rw-p 00000000 00:00 0                          [stack]\n7ffee5dce000-7ffee5dd1000 r--p 00000000 00:00 0                          [vvar]\n7ffee5dd1000-7ffee5dd2000 r-xp 00000000 00:00 0                          [vdso]\nffffffffff600000-ffffffffff601000 --xp 00000000 00:00 0                  [vsyscall]\n</code></pre> <p>\u4ece\u4e2d\u6211\u4eec\u53ef\u4ee5\u8bfb\u53d6\u5982\u4e0b\u4e00\u4e9b\u6709\u5173\u8be5\u8fdb\u7a0b\u5185\u865a\u62df\u5185\u5b58\u6620\u5c04\u7684\u5173\u952e\u4fe1\u606f\uff1a</p> <ul> <li><code>vm_start</code>\uff1a\uff08\u7b2c1\u5217\uff09\u8be5\u6bb5\u865a\u62df\u5185\u5b58\u533a\u57df\u7684\u5f00\u59cb\u5730\u5740</li> <li><code>vm_end</code>\uff1a\uff08\u7b2c2\u5217\uff09\u8be5\u6bb5\u865a\u62df\u5185\u5b58\u533a\u57df\u7684\u7ed3\u675f\u5730\u5740</li> <li><code>vm_flags</code>\uff1a\uff08\u7b2c3\u5217\uff09\u8be5\u6bb5\u865a\u62df\u5185\u5b58\u533a\u57df\u7684\u4e00\u7ec4\u6743\u9650 (rwx) \u6807\u5fd7\uff0c<code>vm_flags</code> \u7684\u5177\u4f53\u53d6\u503c\u5b9a\u4e49\u53ef\u53c2\u8003 Linux \u6e90\u4ee3\u7801\u7684 linux/mm.h</li> <li><code>vm_pgoff</code>\uff1a\uff08\u7b2c4\u5217\uff09\u865a\u62df\u5185\u5b58\u6620\u5c04\u533a\u57df\u5728\u6587\u4ef6\u5185\u7684\u504f\u79fb\u91cf</li> <li><code>vm_file</code>\uff1a\uff08\u7b2c5/6/7\u5217\uff09\u5206\u522b\u8868\u793a\uff1a\u6620\u5c04\u6587\u4ef6\u6240\u5c5e\u8bbe\u5907\u53f7/\u4ee5\u53ca\u6307\u5411\u5173\u8054\u6587\u4ef6\u7ed3\u6784\u7684\u6307\u9488/\u4ee5\u53ca\u6587\u4ef6\u540d</li> </ul> <p>\u5173\u4e8e\u865a\u62df\u5185\u5b58\u533a\u57df</p> <p>\u6ce8\u610f\u8fd9\u91cc\u8bb0\u5f55\u7684 <code>vm_start</code> \u548c <code>vm_end</code> \u90fd\u662f\u7528\u6237\u6001\u7684\u865a\u62df\u5730\u5740\uff0c\u5e76\u4e14\u5185\u6838\u5e76\u4e0d\u4f1a\u5c06\u9664\u4e86\u7528\u6237\u7a0b\u5e8f\u4f1a\u7528\u5230\u7684\u5185\u5b58\u533a\u57df\u4ee5\u5916\u7684\u90e8\u5206\u6dfb\u52a0\u6210\u4e3a VMA\u3002</p> <p>\u6211\u4eec\u6ce8\u610f\u5230\uff0c\u4e00\u6bb5\u5185\u5b58\u4e2d\u7684\u5185\u5bb9\u53ef\u80fd\u662f\u7531\u78c1\u76d8\u4e2d\u7684\u6587\u4ef6\u6620\u5c04\u7684\u3002\u5982\u679c\u8fd9\u6837\u7684\u5185\u5b58\u7684 VMA \u4ea7\u751f\u4e86\u7f3a\u9875\u5f02\u5e38\uff0c\u8bf4\u660e\u6587\u4ef6\u4e2d\u5bf9\u5e94\u7684\u9875\u4e0d\u5728\u64cd\u4f5c\u7cfb\u7edf\u7684 buffer pool \u4e2d\uff0c\u6216\u8005\u662f\u7531\u4e8e buffer pool \u7684\u8c03\u5ea6\u7b56\u7565\u88ab\u6362\u51fa\u5230\u78c1\u76d8\u4e0a\u4e86\u3002\u8fd9\u65f6\u5019\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u7528\u9a71\u52a8\u8bfb\u53d6\u786c\u76d8\u4e0a\u7684\u5185\u5bb9\uff0c\u653e\u5165 buffer pool\uff0c\u7136\u540e\u4fee\u6539\u5f53\u524d\u8fdb\u7a0b\u7684\u9875\u8868\u6765\u8ba9\u5176\u80fd\u591f\u7528\u539f\u6765\u7684\u5730\u5740\u8bbf\u95ee\u6587\u4ef6\u5185\u5bb9\uff0c\u800c\u8fd9\u4e00\u5207\u5bf9\u7528\u6237\u7a0b\u5e8f\u6765\u8bf4\u662f\u5b8c\u5168\u900f\u660e\u7684\uff0c\u9664\u4e86\u8bbf\u95ee\u5ef6\u8fdf\u3002</p> <p>\u9664\u4e86\u8ddf\u6587\u4ef6\u5efa\u7acb\u8054\u7cfb\u4ee5\u5916\uff0cVMA \u8fd8\u53ef\u80fd\u662f\u4e00\u5757\u533f\u540d\uff08anonymous\uff09\u7684\u533a\u57df\u3002\u4f8b\u5982\u88ab\u6807\u6210 <code>[stack]</code> \u7684\u8fd9\u4e00\u5757\u533a\u57df\uff0c\u5e76\u6ca1\u6709\u5bf9\u5e94\u7684\u6587\u4ef6\u3002</p> <p>\u5176\u5b83\u4fdd\u5b58\u5728 <code>vm_area_struct</code> \u4e2d\u7684\u4fe1\u606f\u8fd8\u6709\uff1a</p> <ul> <li><code>vm_ops</code>\uff1a\u8be5 <code>vm_area</code> \u4e2d\u7684\u4e00\u7ec4\u5de5\u4f5c\u51fd\u6570\uff0c\u5176\u4e2d\u662f\u4e00\u7cfb\u5217\u51fd\u6570\u6307\u9488\uff0c\u53ef\u4ee5\u6839\u636e\u9700\u8981\u8fdb\u884c\u5b9a\u5236</li> <li><code>vm_next/vm_prev</code>\uff1a\u540c\u4e00\u8fdb\u7a0b\u7684\u6240\u6709\u865a\u62df\u5185\u5b58\u533a\u57df\u7531\u94fe\u8868\u7ed3\u6784\u94fe\u63a5\u8d77\u6765\uff0c\u8fd9\u662f\u5206\u522b\u6307\u5411\u524d\u540e\u4e24\u4e2a <code>vm_area_struct</code> \u7ed3\u6784\u4f53\u7684\u6307\u9488</li> </ul> <p>\u53ef\u4ee5\u53d1\u73b0\uff0c\u539f\u672c\u7684 Linux \u4f7f\u7528\u94fe\u8868\u5bf9\u4e00\u4e2a\u8fdb\u7a0b\u5185\u7684 VMA \u8fdb\u884c\u7ba1\u7406\u3002\u4f46\u662f\u7531\u4e8e\u5982\u4eca\u4e00\u4e2a\u7a0b\u5e8f\u53ef\u80fd\u4f53\u91cf\u975e\u5e38\u5de8\u5927\uff0c\u6240\u4ee5\u73b0\u5728\u7684 Linux \u5df2\u7ecf\u7528\u865a\u62df\u5730\u5740\u4e3a\u7d22\u5f15\u6765\u5efa\u7acb\u7ea2\u9ed1\u6811\u4e86\u3002</p>"},{"location":"lab5/#page-fault","title":"\u7f3a\u9875\u5f02\u5e38 page fault","text":"<p>\u5728\u4e00\u4e2a\u542f\u7528\u4e86\u865a\u62df\u5185\u5b58\u7684\u7cfb\u7edf\u4e0a\uff0c\u82e5\u6b63\u5728\u8fd0\u884c\u7684\u7a0b\u5e8f\u8bbf\u95ee\u5f53\u524d\u672a\u7531\u5185\u5b58\u7ba1\u7406\u5355\u5143\uff08MMU\uff09\u6620\u5c04\u5230\u865a\u62df\u5185\u5b58\u7684\u9875\u9762\uff0c\u6216\u8bbf\u95ee\u6743\u9650\u4e0d\u8db3\uff0c\u5219\u4f1a\u7531\u8ba1\u7b97\u673a\u786c\u4ef6\u5f15\u53d1\u7684\u7f3a\u9875\u5f02\u5e38\uff08page fault\uff09\u3002</p> <p>\u5904\u7406\u7f3a\u9875\u5f02\u5e38\u901a\u5e38\u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7684\u4e00\u90e8\u5206\uff0c\u5f53\u5904\u7406\u7f3a\u9875\u5f02\u5e38\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5c06\u5c1d\u8bd5\u4f7f\u6240\u9700\u9875\u9762\u5728\u7269\u7406\u5185\u5b58\u4e2d\u7684\u4f4d\u7f6e\u53d8\u5f97\u53ef\u8bbf\u95ee\uff08\u5efa\u7acb\u65b0\u7684\u6620\u5c04\u5173\u7cfb\u5230\u865a\u62df\u5185\u5b58\uff09\u3002\u800c\u5982\u679c\u5728\u975e\u6cd5\u8bbf\u95ee\u5185\u5b58\u7684\u60c5\u51b5\u4e0b\uff0c\u5373\u53d1\u73b0\u89e6\u53d1 page fault \u7684\u865a\u62df\u5185\u5b58\u5730\u5740\uff08Bad Address\uff09\u4e0d\u5728\u5f53\u524d\u8fdb\u7a0b\u7684 <code>vm_area_struct</code> \u94fe\u8868\u4e2d\u6240\u5b9a\u4e49\u7684\u5141\u8bb8\u8bbf\u95ee\u7684\u865a\u62df\u5185\u5b58\u5730\u5740\u8303\u56f4\u5185\uff0c\u6216\u8bbf\u95ee\u4f4d\u7f6e\u7684\u6743\u9650\u6761\u4ef6\u4e0d\u6ee1\u8db3\u65f6\uff0c\u7f3a\u9875\u5f02\u5e38\u5904\u7406\u5c06\u7ec8\u6b62\u8be5\u7a0b\u5e8f\u7684\u7ee7\u7eed\u8fd0\u884c\u3002</p>"},{"location":"lab5/#demand-paging","title":"Demand Paging","text":"<p>Demand paging \u9075\u5faa\u7684\u539f\u5219\u662f\uff0c\u53ea\u6709\u5728\u6267\u884c\u8fdb\u7a0b\u9700\u8981\u65f6\uff0c\u624d\u5e94\u5c06\u9875\u9762\u653e\u5165\u5185\u5b58\u4e2d\u3002\u8fd9\u6837\u505a\u7684\u597d\u5904\u662f\uff0c\u4ec5\u52a0\u8f7d\u6267\u884c\u8fdb\u7a0b\u6240\u9700\u7684\u9875\u9762\uff0c\u4ece\u800c\u8282\u7701\u5185\u5b58\u7a7a\u95f4\u3002\u4f8b\u5982\uff0c\u82e5\u4e00\u4e2a\u9875\u9762\u4ece\u672a\u88ab\u8bbf\u95ee\u8fc7\uff0c\u90a3\u4e48\u5b83\u5c31\u4e0d\u9700\u8981\u88ab\u653e\u5165\u5185\u5b58\u4e2d\u3002</p> <p>\u5728 Lab4 \u7684\u4ee3\u7801\u4e2d\uff0c\u6211\u4eec\u5728 <code>task_init</code> \u7684\u65f6\u5019\u521b\u5efa\u4e86\u7528\u6237\u6808\uff0c<code>load_program</code> \u7684\u65f6\u5019\u62f7\u8d1d\u4e86 load segment\uff0c\u5e76\u901a\u8fc7 <code>create_mapping</code> \u5728\u9875\u8868\u4e2d\u521b\u5efa\u4e86\u6620\u5c04\u3002\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u4fee\u6539\u4e3a demand paging \u7684\u65b9\u5f0f\uff0c\u4e5f\u5c31\u662f\u5728\u521d\u59cb\u5316 task \u7684\u65f6\u5019\u4e0d\u8fdb\u884c\u4efb\u4f55\u7684\u6620\u5c04\uff08\u9664\u4e86\u5185\u6838\u6808\u4ee5\u53ca\u9875\u8868\u4ee5\u5916\u4e5f\u4e0d\u9700\u8981\u5f00\u8f9f\u5176\u4ed6\u7a7a\u95f4\uff09\uff0c\u800c\u662f\u5728\u53d1\u751f\u7f3a\u9875\u5f02\u5e38\u7684\u65f6\u5019\u68c0\u6d4b\u5230\u662f\u8bb0\u5f55\u5728 vma \u4e2d\u7684\u5408\u6cd5\u5730\u5740\u540e\uff0c\u518d\u5206\u914d\u9875\u9762\u5e76\u8fdb\u884c\u6620\u5c04\u3002</p>"},{"location":"lab5/#risc-v-page-faults","title":"RISC-V Page Faults","text":"<p>\u5728 RISC-V \u4e2d\uff0c\u5f53\u7cfb\u7edf\u8fd0\u884c\u53d1\u751f\u5f02\u5e38\u65f6\uff0c\u53ef\u901a\u8fc7\u89e3\u6790 <code>scause</code> \u5bc4\u5b58\u5668\u7684\u503c\uff0c\u8bc6\u522b\u5982\u4e0b\u4e09\u79cd\u4e0d\u540c\u7684 page fault\uff1a</p> Interrupt Exception Code Description 0 12 Instruction Page Fault 0 13 Load Page Fault 0 15 Store/AMO Page Fault"},{"location":"lab5/#page-fault_1","title":"\u5904\u7406 page fault \u7684\u65b9\u5f0f","text":"<p>\u5904\u7406\u7f3a\u9875\u5f02\u5e38\u65f6\u53ef\u80fd\u6240\u9700\u7684\u4fe1\u606f\u5982\u4e0b\uff1a</p> <ul> <li>\u89e6\u53d1 page fault \u65f6\u8bbf\u95ee\u7684\u865a\u62df\u5185\u5b58\u5730\u5740\u3002\u5f53\u89e6\u53d1 page fault \u65f6\uff0c<code>stval</code> \u5bc4\u5b58\u5668\u88ab\u88ab\u786c\u4ef6\u81ea\u52a8\u8bbe\u7f6e\u4e3a\u8be5\u51fa\u9519\u7684 VA \u5730\u5740</li> <li>\u5bfc\u81f4 page fault \u7684\u7c7b\u578b\uff0c\u4fdd\u5b58\u5728 <code>scause</code> \u5bc4\u5b58\u5668\u4e2d<ul> <li>Exception Code = 12: page fault caused by an instruction fetch </li> <li>Exception Code = 13: page fault caused by a read  </li> <li>Exception Code = 15: page fault caused by a write </li> </ul> </li> <li>\u53d1\u751f page fault \u65f6\u7684\u6307\u4ee4\u6267\u884c\u4f4d\u7f6e\uff0c\u4fdd\u5b58\u5728 <code>sepc</code> \u4e2d</li> <li>\u5f53\u524d\u8fdb\u7a0b\u5408\u6cd5\u7684 VMA \u6620\u5c04\u5173\u7cfb\uff0c\u4fdd\u5b58\u5728 <code>vm_area_struct</code> \u94fe\u8868\u4e2d</li> <li>\u53d1\u751f\u5f02\u5e38\u7684\u865a\u62df\u5730\u5740\u5bf9\u5e94\u7684 PTE (page table entry) \u4e2d\u8bb0\u5f55\u7684\u4fe1\u606f</li> </ul> <p>\u603b\u7684\u8bf4\u6765\uff0c\u5904\u7406\u7f3a\u9875\u5f02\u5e38\u9700\u8981\u8fdb\u884c\u4ee5\u4e0b\u6b65\u9aa4\uff1a</p> <ul> <li>\u6355\u83b7\u5f02\u5e38</li> <li>\u5bfb\u627e\u5f53\u524d task \u4e2d\u5bfc\u81f4\u4ea7\u751f\u4e86\u5f02\u5e38\u7684\u5730\u5740\u5bf9\u5e94\u7684 VMA<ul> <li>\u5982\u679c\u5f53\u524d\u8bbf\u95ee\u7684\u865a\u62df\u5730\u5740\u5728 VMA \u4e2d\u6ca1\u6709\u8bb0\u5f55\uff0c\u5373\u662f\u4e0d\u5408\u6cd5\u7684\u5730\u5740\uff0c\u5219\u8fd0\u884c\u51fa\u9519\uff08\u672c\u5b9e\u9a8c\u4e0d\u6d89\u53ca\uff09</li> <li>\u5982\u679c\u5f53\u524d\u8bbf\u95ee\u7684\u865a\u62df\u5730\u5740\u5728 VMA \u4e2d\u5b58\u5728\u8bb0\u5f55\uff0c\u5219\u9700\u8981\u5224\u65ad\u4ea7\u751f\u5f02\u5e38\u7684\u539f\u56e0\uff1a<ul> <li>\u5982\u679c\u662f\u533f\u540d\u533a\u57df\uff0c\u90a3\u4e48\u5f00\u8f9f\u4e00\u9875\u5185\u5b58\uff0c\u7136\u540e\u628a\u8fd9\u4e00\u9875\u6620\u5c04\u5230\u4ea7\u751f\u5f02\u5e38\u7684 task \u7684\u9875\u8868\u4e2d</li> <li>\u5982\u679c\u4e0d\u662f\uff0c\u5219\u8bbf\u95ee\u7684\u9875\u662f\u5b58\u5728\u6570\u636e\u7684\uff08\u5982\u4ee3\u7801\uff09\uff0c\u9700\u8981\u4ece\u76f8\u5e94\u4f4d\u7f6e\u8bfb\u53d6\u51fa\u5185\u5bb9\uff0c\u7136\u540e\u6620\u5c04\u5230\u9875\u8868\u4e2d</li> </ul> </li> </ul> </li> <li>\u8fd4\u56de\u5230\u4ea7\u751f\u4e86\u8be5\u7f3a\u9875\u5f02\u5e38\u7684\u90a3\u6761\u6307\u4ee4\uff0c\u5e76\u7ee7\u7eed\u6267\u884c\u7a0b\u5e8f</li> </ul>"},{"location":"lab5/#fork","title":"Fork \u7cfb\u7edf\u8c03\u7528","text":"<p>Fork \u662f Linux \u4e2d\u7684\u91cd\u8981\u7cfb\u7edf\u8c03\u7528\uff0c\u5b83\u7684\u4f5c\u7528\u662f\u5c06\u8fdb\u884c\u4e86\u8be5\u7cfb\u7edf\u8c03\u7528\u7684 task \u5b8c\u6574\u5730\u590d\u5236\u4e00\u4efd\uff0c\u5e76\u52a0\u5165 Ready Queue\u3002\u8fd9\u6837\u5728\u4e0b\u4e00\u6b21\u8c03\u5ea6\u53d1\u751f\u65f6\uff0c\u8c03\u5ea6\u5668\u5c31\u80fd\u591f\u53d1\u73b0\u591a\u4e86\u4e00\u4e2a task\u3002\u4ece\u8fd9\u65f6\u5019\u5f00\u59cb\uff0c\u65b0\u7684 task \u5c31\u53ef\u80fd\u88ab\u6b63\u5f0f\u4ece Ready \u8c03\u5ea6\u5230 Running\uff0c\u800c\u5f00\u59cb\u6267\u884c\u4e86\u3002\u9700\u7559\u610f\uff0cfork \u5177\u6709\u4ee5\u4e0b\u7279\u70b9\uff1a</p> <ul> <li>Fork \u901a\u8fc7\u590d\u5236\u5f53\u524d\u8fdb\u7a0b\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8fdb\u7a0b\uff0c\u65b0\u8fdb\u7a0b\u79f0\u4e3a\u5b50\u8fdb\u7a0b\uff0c\u800c\u539f\u8fdb\u7a0b\u79f0\u4e3a\u7236\u8fdb\u7a0b</li> <li>\u5b50\u8fdb\u7a0b\u548c\u7236\u8fdb\u7a0b\u5728\u4e0d\u540c\u7684\u5185\u5b58\u7a7a\u95f4\u4e0a\u8fd0\u884c</li> <li>Fork \u6210\u529f\u65f6\uff0c\u7236\u8fdb\u7a0b\u8fd4\u56de\u5b50\u8fdb\u7a0b\u7684 PID\uff0c\u5b50\u8fdb\u7a0b\u8fd4\u56de <code>0</code>\uff1b\u5931\u8d25\u65f6\uff0c\u7236\u8fdb\u7a0b\u8fd4\u56de <code>-1</code></li> <li>\u521b\u5efa\u7684\u5b50 task \u9700\u8981\u6df1\u62f7\u8d1d <code>task_struct</code>\uff0c\u8c03\u6574\u81ea\u5df1\u7684\u9875\u8868\u3001\u6808\u548c CSR \u5bc4\u5b58\u5668\u7b49\u4fe1\u606f\uff0c\u590d\u5236\u4e00\u4efd\u5728\u7528\u6237\u6001\u4f1a\u7528\u5230\u7684\u5185\u5b58\u4fe1\u606f\uff08\u7528\u6237\u6001\u7684\u6808\u3001\u7a0b\u5e8f\u7684\u4ee3\u7801\u548c\u6570\u636e\u7b49\uff09\uff0c\u5e76\u4e14\u5c06\u81ea\u5df1\u4f2a\u88c5\u6210\u662f\u4e00\u4e2a\u56e0\u4e3a\u8c03\u5ea6\u800c\u52a0\u5165\u4e86 Ready Queue \u7684\u666e\u901a\u7a0b\u5e8f\u6765\u7b49\u5f85\u8c03\u5ea6\u3002\u5728\u8c03\u5ea6\u53d1\u751f\u65f6\uff0c\u8fd9\u4e2a\u65b0 task \u5c31\u50cf\u662f\u539f\u672c\u5c31\u5728\u7b49\u5f85\u8c03\u5ea6\u4e00\u6837\uff0c\u88ab\u8c03\u5ea6\u5668\u9009\u62e9\u5e76\u8c03\u5ea6\u3002</li> </ul> <p>\u5173\u4e8e copy-on-write</p> <p>Linux \u4e2d\u4f7f\u7528\u4e86 copy-on-write \u5199\u65f6\u590d\u5236\u673a\u5236\uff0cfork \u521b\u5efa\u7684\u5b50\u8fdb\u7a0b\u9996\u5148\u4e0e\u7236\u8fdb\u7a0b\u5171\u4eab\u7269\u7406\u5185\u5b58\u7a7a\u95f4\uff0c\u76f4\u5230\u7236\u5b50\u8fdb\u7a0b\u6709\u4fee\u6539\u5185\u5b58\u7684\u64cd\u4f5c\u53d1\u751f\u65f6\u518d\u4e3a\u5b50\u8fdb\u7a0b\u5206\u914d\u7269\u7406\u5185\u5b58\u3002</p> <p>\u56e0\u4e3a\u672c\u5b9e\u9a8c\u5176\u4ed6\u90e8\u5206\u5de5\u4f5c\u91cf\u5df2\u7ecf\u8db3\u591f\uff0c\u4e0d\u8981\u6c42\u6240\u6709\u540c\u5b66\u90fd\u5b9e\u73b0\uff0c\u5982\u679c\u4f60\u89c9\u5f97\u8fd9\u4e2a\u673a\u5236\u5f88\u6709\u8da3\uff0c\u53ef\u4ee5\u5728\u5b9e\u9a8c\u4e2d\u5b8c\u6210 COW \u673a\u5236\uff0c\u76f8\u5e94\u4ee3\u7801\u5e76\u4e0d\u590d\u6742\u3002</p>"},{"location":"lab5/#fork-linux","title":"Fork \u5728 Linux \u4e2d\u7684\u5b9e\u9645\u5e94\u7528","text":"<p>Linux \u7684\u53e6\u4e00\u4e2a\u91cd\u8981\u7cfb\u7edf\u8c03\u7528\u662f <code>exec</code>\uff0c\u5b83\u7684\u4f5c\u7528\u662f\u5c06\u8fdb\u884c\u4e86\u8be5\u7cfb\u7edf\u8c03\u7528\u7684 task \u6362\u6210\u53e6\u4e00\u4e2a task \u3002\u8fd9\u4e24\u4e2a\u7cfb\u7edf\u8c03\u7528\u4e00\u8d77\uff0c\u652f\u6491\u8d77\u4e86 Linux \u5904\u7406\u591a\u4efb\u52a1\u7684\u57fa\u7840\u3002\u5f53\u6211\u4eec\u5728 shell \u91cc\u952e\u5165\u4e00\u4e2a\u7a0b\u5e8f\u7684\u76ee\u5f55\u65f6\uff0cshell\uff08\u6bd4\u5982 zsh \u6216 bash\uff09\u4f1a\u5148\u8fdb\u884c\u4e00\u6b21 fork\uff0c\u8fd9\u65f6\u5019\u76f8\u5f53\u4e8e\u6709\u4e24\u4e2a shell \u6b63\u5728\u8fd0\u884c\u3002\u7136\u540e\u5176\u4e2d\u7684\u4e00\u4e2a shell \u6839\u636e fork \u7684\u8fd4\u56de\u503c\uff08\u662f\u5426\u4e3a 0\uff09\uff0c\u53d1\u73b0\u81ea\u5df1\u548c\u539f\u672c\u7684 shell \u4e0d\u540c\uff0c\u518d\u8c03\u7528 exec \u6765\u628a\u81ea\u5df1\u7ed9\u6362\u6210\u53e6\u4e00\u4e2a\u7a0b\u5e8f\uff0c\u8fd9\u6837 shell \u5916\u7684\u7a0b\u5e8f\u5c31\u5f97\u4ee5\u6267\u884c\u4e86\u3002</p>"},{"location":"lab5/#_4","title":"\u5b9e\u9a8c\u6b65\u9aa4","text":""},{"location":"lab5/#_5","title":"\u51c6\u5907\u5de5\u4f5c","text":"<p>\u4ee3\u7801\u4e0e\u8c03\u8bd5\u5efa\u8bae</p> <p>\u7531\u4e8e\u672c\u6b21\u5b9e\u9a8c\u4e2d\u8c03\u8bd5\u8fc7\u7a0b\u53ef\u80fd\u6bd4\u8f83\u590d\u6742\uff0c\u5728\u5b9e\u9a8c\u5f00\u59cb\u524d\u5efa\u8bae\u540c\u5b66\u4eec\u5148\u56de\u987e\u4e00\u4e0b\u524d\u9762\u7684 lab \u5199\u8fc7\u7684\u4ee3\u7801\uff0c\u5c06\u81ea\u5df1\u5199\u7684\u65f6\u5019\u53ef\u80fd\u8fd8\u6ca1\u6765\u5f97\u53ca\u6574\u7406\u7684\u4ee3\u7801\u68b3\u7406\u4e00\u4e0b\uff0c\u4ee5\u4fbf\u540e\u7eed\u8c03\u8bd5\u3002</p> <p>\u8fd9\u91cc\u5efa\u8bae\u5927\u5bb6\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\u591a\u4f7f\u7528 Lab2 \u4e2d\u4ecb\u7ecd\u7684\u5f69\u8272\u8f93\u51fa\uff0c\u4ee5\u53ca <code>Log</code> \u5b8f\uff0c\u65b9\u4fbf\u8c03\u8bd5\u3002\u9664\u6b64\u4e4b\u5916\u4e5f\u53ef\u4ee5\u81ea\u5b9a\u4e49\u4e00\u4e2a <code>Err</code> \u5b8f\uff0c\u5e76\u4f9d\u9760 <code>while(1)</code> \u5361\u4f4f\u7a0b\u5e8f\u4ee5\u4fbf\u67e5\u627e\u95ee\u9898\uff0c\u9632\u6b62\u56e0\u4e3a\u5f02\u5e38\u672a\u89e3\u51b3\u800c\u53cd\u590d\u51fa\u73b0 trap \u5bfc\u81f4\u7ec8\u7aef\u5237\u5c4f\uff1a</p> <pre><code>#define Err(format, ...) {                              \\\n    printk(\"\\33[1;31m[%s,%d,%s] \" format \"\\33[0m\\n\",    \\\n        __FILE__, __LINE__, __func__, ## __VA_ARGS__);  \\\n    while(1);                                           \\\n}\n</code></pre> <p>\u5efa\u8bae\u5927\u5bb6\u5c06\u4ee3\u7801\u4e2d\u6240\u6709\u51fa\u73b0\u975e\u9884\u671f\u7684\u5f02\u5e38\uff08\u6bd4\u5982\u6682\u672a\u5b9e\u73b0\u7684 trap \u5904\u7406\u3001\u6682\u672a\u5b9e\u73b0\u7684\u7cfb\u7edf\u8c03\u7528\u7b49\uff09\u90fd\u4f7f\u7528 <code>Err</code> \u5b8f\u6765\u8f93\u51fa\u3002</p> <p>\u6b64\u6b21\u5b9e\u9a8c\u57fa\u4e8e lab4 \u540c\u5b66\u6240\u5b9e\u73b0\u7684\u4ee3\u7801\u8fdb\u884c\u3002</p> <ul> <li>\u4ece\u4ed3\u5e93\u540c\u6b65 <code>user/main.c</code> \u6587\u4ef6\u5e76\u5220\u9664\u539f\u6765\u7684 <code>getpid.c</code></li> <li> <p>\u4fee\u6539 <code>user/Makefile</code>\uff1a</p> user/Makefile<pre><code>TEST        = PFH1\n\nCFLAG       = ...\u672b\u5c3e\u6dfb\u52a0 -D$(TEST)\n</code></pre> </li> </ul> <p>\u5173\u4e8e user/main.c \u7684\u8bf4\u660e</p> <p>\u5728 <code>user/main.c</code> \u4e2d\u6211\u4eec\u5b9a\u4e49\u4e86\u4e94\u4e2a <code>main</code> \u51fd\u6570\uff0c\u4e24\u4e2a\u7528\u6765\u6d4b\u8bd5 page fault handler\uff0c\u4e09\u4e2a\u7528\u6765\u6d4b\u8bd5 fork\u3002</p> <ul> <li><code>make run</code> \u9ed8\u8ba4\u8fd0\u884c PFH1 \u4e5f\u5c31\u662f\u7b2c\u4e00\u4e2a main \u51fd\u6570\uff08\u548c lab4 \u7684 getpid \u4e00\u81f4\uff09</li> <li><code>make run TEST=PFH2</code> \u8fd0\u884c\u7b2c\u4e8c\u4e2a main \u51fd\u6570</li> <li><code>make run TEST=FORK1</code> \u8fd0\u884c\u7b2c\u4e09\u4e2a main \u51fd\u6570\uff0c\u68c0\u6d4b\u5355\u4e2a fork \u4e0e\u5168\u5c40\u53d8\u91cf</li> <li><code>make run TEST=FORK2</code> \u8fd0\u884c\u7b2c\u56db\u4e2a main \u51fd\u6570\uff0c\u68c0\u6d4b\u5355\u4e2a fork \u4e0e\u7528\u6237\u6808\u590d\u5236</li> <li><code>make run TEST=FORK3</code> \u8fd0\u884c\u7b2c\u4e94\u4e2a main \u51fd\u6570\uff0c\u68c0\u6d4b\u591a\u4e2a fork</li> </ul> <p>\u5177\u4f53\u6d4b\u8bd5\u8868\u73b0\u548c\u9884\u671f\u89c1\u540e\u6587\u3002\u540c\u65f6 main.c \u4e2d\u6211\u4eec\u901a\u8fc7 <code>wait</code> \u51fd\u6570\u5fd9\u7b49\u5f85\uff0c\u53c2\u6570\u4e3a <code>WAIT_TIME</code> \u5b8f\u5b9a\u4e49\uff0c\u540c\u5b66\u4eec\u53ef\u4ee5\u81ea\u884c\u4fee\u6539\u8fd9\u4e2a\u6570\u503c\u6765\u6539\u53d8\u8f93\u51fa\u901f\u5ea6\u65b9\u4fbf\u8c03\u8bd5\u3002\u4e3a\u4e86\u52a0\u5feb\u5b9e\u9a8c\u8868\u73b0\uff0c\u4e5f\u53ef\u4ee5\u4fee\u6539\u65f6\u949f\u4e2d\u65ad\u95f4\u9694\u3002</p>"},{"location":"lab5/#_6","title":"\u7f3a\u9875\u5f02\u5e38\u5904\u7406","text":""},{"location":"lab5/#_7","title":"\u5b9e\u73b0\u865a\u62df\u5185\u5b58\u7ba1\u7406\u529f\u80fd","text":"<p>\u6bcf\u5757 vma \u90fd\u6709\u81ea\u5df1\u7684 flag \u6765\u5b9a\u4e49\u6743\u9650\u4ee5\u53ca\u5206\u7c7b\uff08\u662f\u5426\u533f\u540d\uff09\uff0c\u9700\u8981\u5927\u5bb6\u5728\u9002\u5f53\u7684\u5730\u65b9\u6dfb\u52a0\u4ee5\u4e0b\u5b8f\u5b9a\u4e49\uff1a</p> <pre><code>#define VM_ANON 0x1\n#define VM_READ 0x2\n#define VM_WRITE 0x4\n#define VM_EXEC 0x8\n</code></pre> <p>\u8fd9\u91cc R/W/X \u7684\u4f4d\u7f6e\u548c PTE \u9879\u7684 R/W/X \u4f4d\u662f\u4e00\u6837\u7684\uff0c\u53ef\u4ee5\u7b80\u5316\u8bbe\u8ba1\u3002\u4f46\u4e00\u5b9a\u6ce8\u610f vma \u7684 flags \u548c pte \u7684 flags \u662f\u4e0d\u4e00\u6837\u7684\uff0c\u540e\u9762\u5728\u5b9e\u73b0\u7684\u65f6\u5019\u6ce8\u610f\u4e0d\u8981\u628a vma \u7684 flags \u76f4\u63a5\u586b\u5230 pte \u4e2d\u3002</p> <p>\u63a5\u4e0b\u6765\u8981\u6dfb\u52a0 vma \u7684\u6570\u636e\u7ed3\u6784\uff0c\u6211\u4eec\u91c7\u7528\u94fe\u8868\u7684\u5b9e\u73b0\uff08\u5176\u5b9e\u5e76\u4e0d\u590d\u6742\uff0c\u56e0\u4e3a\u53ea\u7528\u8003\u8651\u63d2\u5165\u548c\u904d\u5386\uff09\uff1a</p> <pre><code>struct vm_area_struct {\n    struct mm_struct *vm_mm;    // \u6240\u5c5e\u7684 mm_struct\n    uint64_t vm_start;          // VMA \u5bf9\u5e94\u7684\u7528\u6237\u6001\u865a\u62df\u5730\u5740\u7684\u5f00\u59cb\n    uint64_t vm_end;            // VMA \u5bf9\u5e94\u7684\u7528\u6237\u6001\u865a\u62df\u5730\u5740\u7684\u7ed3\u675f\n    struct vm_area_struct *vm_next, *vm_prev;   // \u94fe\u8868\u6307\u9488\n    uint64_t vm_flags;          // VMA \u5bf9\u5e94\u7684 flags\n    // struct file *vm_file;    // \u5bf9\u5e94\u7684\u6587\u4ef6\uff08\u76ee\u524d\u8fd8\u6ca1\u5b9e\u73b0\uff0c\u800c\u4e14\u6211\u4eec\u53ea\u6709\u4e00\u4e2a uapp \u6240\u4ee5\u6682\u4e0d\u9700\u8981\uff09\n    uint64_t vm_pgoff;          // \u5982\u679c\u5bf9\u5e94\u4e86\u4e00\u4e2a\u6587\u4ef6\uff0c\u90a3\u4e48\u8fd9\u5757 VMA \u8d77\u59cb\u5730\u5740\u5bf9\u5e94\u7684\u6587\u4ef6\u5185\u5bb9\u76f8\u5bf9\u6587\u4ef6\u8d77\u59cb\u4f4d\u7f6e\u7684\u504f\u79fb\u91cf\n    uint64_t vm_filesz;         // \u5bf9\u5e94\u7684\u6587\u4ef6\u5185\u5bb9\u7684\u957f\u5ea6\n};\n\nstruct mm_struct {\n    struct vm_area_struct *mmap;\n};\n\nstruct task_struct {\n    uint64_t state;    \n    uint64_t counter; \n    uint64_t priority; \n    uint64_t pid;    \n\n    struct thread_struct thread;\n    uint64_t *pgd;\n    struct mm_struct mm;\n};\n</code></pre> <p>\u5173\u4e8e <code>vm_pgoff</code> \u548c <code>vm_filesz</code></p> <p>\u8fd9\u4e24\u4e2a\u53d8\u91cf\u9700\u8981\u8bb0\u5f55\u5728\u8fd9\u91cc\u662f\u56e0\u4e3a\u6211\u4eec\u5728 <code>load_program</code> \u91cc\u52a0\u8f7d ELF \u65f6\u505a\u7684 memcpy \u7b49\u4e00\u7cfb\u5217\u64cd\u4f5c\u90fd\u8981\u540e\u79fb\u5230\u53d1\u751f\u7f3a\u9875\u7684\u65f6\u5019\u518d\u5904\u7406\uff0c\u6240\u4ee5\u9700\u8981\u8bb0\u5f55\u8fd9\u4e9b\u503c\u3002<code>vm_pgoff</code> \u5373\u4ee3\u8868\u539f\u6765\u7684 <code>phdr-&gt;p_offset</code>\uff0c<code>vm_filesz</code> \u4ee3\u8868\u539f\u6765\u7684 <code>phdr-&gt;p_filesz</code>\uff0c\u800c\u539f\u6765\u7684 <code>phdr-&gt;p_memsz</code> \u5219\u7531 <code>vm_end - vm_start</code> \u6765\u8868\u793a\uff08\u5176\u4e2d <code>vm_start</code> \u662f <code>phdr-&gt;p_vaddr</code>\uff09\u3002</p> <p>\u8fd9\u6837\u6211\u4eec\u9700\u8981\u7684\u4fe1\u606f\u5c31\u90fd\u53ef\u4ee5\u901a\u8fc7 <code>vm_area_struct</code> \u6765\u83b7\u53d6\u4e86\u3002\u540c\u65f6\u540c\u5b66\u4eec\u4e5f\u8981\u6ce8\u610f <code>vm_filesz</code> \u548c <code>vm_end - vm_start</code> \u7684\u533a\u522b\u3002</p> <p>\u6bcf\u4e00\u4e2a <code>vm_area_struct</code> \u90fd\u5bf9\u5e94\u4e8e task \u5730\u5740\u7a7a\u95f4\u7684\u552f\u4e00\u8fde\u7eed\u533a\u95f4\u3002</p> <p>\u4e3a\u4e86\u652f\u6301 demand paging\uff0c\u6211\u4eec\u9700\u8981\u652f\u6301\u5bf9 <code>vm_area_struct</code> \u7684\u6dfb\u52a0\u548c\u67e5\u627e\uff1a</p> <ul> <li><code>find_vma</code> \u51fd\u6570\uff1a\u5b9e\u73b0\u5bf9 <code>vm_area_struct</code> \u7684\u67e5\u627e<ul> <li>\u6839\u636e\u4f20\u5165\u7684\u5730\u5740 <code>addr</code>\uff0c\u904d\u5386\u94fe\u8868 <code>mm</code> \u5305\u542b\u7684 VMA \u94fe\u8868\uff0c\u627e\u5230\u8be5\u5730\u5740\u6240\u5728\u7684 <code>vm_area_struct</code></li> <li>\u5982\u679c\u94fe\u8868\u4e2d\u6240\u6709\u7684 <code>vm_area_struct</code> \u90fd\u4e0d\u5305\u542b\u8be5\u5730\u5740\uff0c\u5219\u8fd4\u56de <code>NULL</code> <pre><code>/*\n* @mm       : current thread's mm_struct\n* @addr     : the va to look up\n*\n* @return   : the VMA if found or NULL if not found\n*/\nstruct vm_area_struct *find_vma(struct mm_struct *mm, uint64_t addr);\n</code></pre></li> </ul> </li> <li><code>do_mmap</code> \u51fd\u6570\uff1a\u5b9e\u73b0 <code>vm_area_struct</code> \u7684\u6dfb\u52a0<ul> <li>\u65b0\u5efa <code>vm_area_struct</code> \u7ed3\u6784\u4f53\uff0c\u6839\u636e\u4f20\u5165\u7684\u53c2\u6570\u5bf9\u7ed3\u6784\u4f53\u8d4b\u503c\uff0c\u5e76\u6dfb\u52a0\u5230 <code>mm</code> \u6307\u5411\u7684 VMA \u94fe\u8868\u4e2d <pre><code>/*\n* @mm       : current thread's mm_struct\n* @addr     : the va to map\n* @len      : memory size to map\n* @vm_pgoff : phdr-&gt;p_offset\n* @vm_filesz: phdr-&gt;p_filesz\n* @flags    : flags for the new VMA\n*\n* @return   : start va\n*/\nuint64_t do_mmap(struct mm_struct *mm, uint64_t addr, uint64_t len, uint64_t vm_pgoff, uint64_t vm_filesz, uint64_t flags);\n</code></pre></li> </ul> </li> </ul>"},{"location":"lab5/#task_init","title":"\u4fee\u6539 task_init","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u8981\u4fee\u6539 <code>task_init</code> \u6765\u5b9e\u73b0 demand paging\u3002</p> <p>Linux \u5728 page fault handler \u4e2d\u9700\u8981\u8003\u8651\u591a\u79cd\u60c5\u51b5\u3002\u6211\u4eec\u7684\u5b9e\u9a8c\u7ecf\u8fc7\u7b80\u5316\uff0c\u53ea\u9700\u8981\u6839\u636e <code>vm_area_struct</code> \u4e2d\u7684 <code>vm_flags</code> \u6765\u786e\u5b9a\u5f53\u524d\u53d1\u751f\u4e86\u4ec0\u4e48\u6837\u7684\u9519\u8bef\uff0c\u5e76\u4e14\u9700\u8981\u5982\u4f55\u5904\u7406\u3002\u5728\u521d\u59cb\u5316\u4e00\u4e2a task \u65f6\u6211\u4eec\u65e2\u4e0d\u5206\u914d\u5185\u5b58\uff0c\u53c8\u4e0d\u66f4\u6539\u9875\u8868\u9879\u6765\u5efa\u7acb\u6620\u5c04\u3002\u56de\u9000\u5230\u7528\u6237\u6001\u8fdb\u884c\u7a0b\u5e8f\u6267\u884c\u7684\u65f6\u5019\u5c31\u4f1a\u56e0\u4e3a\u6ca1\u6709\u6620\u5c04\u800c\u53d1\u751f page fault\uff0c\u8fdb\u5165\u6211\u4eec\u7684 page fault handler \u540e\uff0c\u6211\u4eec\u518d\u5206\u914d\u7a7a\u95f4\uff08\u6309\u9700\u8981\u62f7\u8d1d\u5185\u5bb9\uff09\u8fdb\u884c\u6620\u5c04\u3002</p> <p>\u4f8b\u5982\uff0c\u6211\u4eec\u539f\u672c\u8981\u4e3a\u7528\u6237\u6001\u865a\u62df\u5730\u5740\u6620\u5c04\u4e00\u4e2a\u9875\uff0c\u9700\u8981\u8fdb\u884c\u5982\u4e0b\u64cd\u4f5c\uff1a</p> <ol> <li>\u4f7f\u7528 <code>kalloc</code> \u6216\u8005 <code>alloc_page</code> \u5206\u914d\u4e00\u4e2a\u9875\u7684\u7a7a\u95f4</li> <li>\u5bf9\u8fd9\u4e2a\u9875\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u586b\u5145</li> <li>\u5c06\u8fd9\u4e2a\u9875\u6620\u5c04\u5230\u7528\u6237\u7a7a\u95f4\uff0c\u4f9b\u7528\u6237\u7a0b\u5e8f\u8bbf\u95ee\u3002\u5e76\u8bbe\u7f6e\u597d\u5bf9\u5e94\u7684 U, W, X, R \u6743\u9650\uff0c\u6700\u540e\u5c06 V \u7f6e\u4e3a 1\uff0c\u4ee3\u8868\u5176\u6709\u6548\u3002</li> </ol> <p>\u800c\u4e3a\u4e86\u51cf\u5c11 task \u521d\u59cb\u5316\u65f6\u7684\u5f00\u9500\uff0c\u6211\u4eec\u8fd9\u6837\u5bf9\u4e00\u4e2a Segment \u6216\u8005\u7528\u6237\u6001\u7684\u6808\u5efa\u7acb\u6620\u5c04\u7684\u64cd\u4f5c\u53ea\u9700\u6539\u6210\u5206\u522b\u5efa\u7acb\u4e00\u4e2a VMA \u5373\u53ef\uff0c\u5177\u4f53\u7684\u5206\u914d\u7a7a\u95f4\u3001\u586b\u5145\u6570\u636e\u7684\u64cd\u4f5c\u7b49\u540e\u9762\u518d\u6765\u5b8c\u6210\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4fee\u6539 <code>task_init</code> \u51fd\u6570\u4ee3\u7801\uff0c\u66f4\u6539\u4e3a demand paging\uff1a</p> <ul> <li>\u5220\u9664\uff08\u6ce8\u91ca\uff09\u6389\u4e4b\u524d\u5b9e\u9a8c\u4e2d\u5bf9\u7528\u6237\u6808\u3001\u4ee3\u7801 load segment \u7684\u6620\u5c04\u64cd\u4f5c\uff08alloc \u548c create_mapping\uff09</li> <li>\u8c03\u7528 <code>do_mmap</code> \u51fd\u6570\uff0c\u5efa\u7acb\u7528\u6237 task \u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u4fe1\u606f\uff0c\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\u4ec5\u5305\u62ec\u4e24\u4e2a\u533a\u57df:<ul> <li>\u4ee3\u7801\u548c\u6570\u636e\u533a\u57df\uff1a\u8be5\u533a\u57df\u4ece ELF \u7ed9\u51fa\u7684 Segment \u8d77\u59cb\u7528\u6237\u6001\u865a\u62df\u5730\u5740 <code>phdr-&gt;p_vaddr</code> \u5f00\u59cb\uff0c\u5bf9\u5e94\u6587\u4ef6\u4e2d\u504f\u79fb\u91cf\u4e3a <code>phdr-&gt;p_offset</code> \u5f00\u59cb\u7684\u90e8\u5206</li> <li>\u7528\u6237\u6808\uff1a\u8303\u56f4\u4e3a <code>[USER_END - PGSIZE, USER_END)</code>\uff0c\u6743\u9650\u4e3a <code>VM_READ | VM_WRITE</code>\uff0c\u5e76\u4e14\u662f\u533f\u540d\u7684\u533a\u57df\uff08<code>VM_ANON</code>\uff09</li> </ul> </li> </ul> <p>\u5728\u5b8c\u6210\u4e0a\u8ff0\u4fee\u6539\u4e4b\u540e\uff0c\u5982\u679c\u8fd0\u884c\u4ee3\u7801\u6211\u4eec\u5c31\u53ef\u4ee5\u622a\u83b7\u4e00\u4e2a page fault\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>SET [PID = 1 PRIORITY = 7 COUNTER = 7]\n\nswitch to [PID = 1 PRIORITY = 7 COUNTER = 7]\n[trap.c,129,trap_handler] [S] Unhandled Exception: scause=12, sepc=0x100e8, stval=0x100e8\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u53d1\u751f\u4e86\u7f3a\u9875\u5f02\u5e38\u7684 <code>sepc</code> \u662f <code>0x100e8</code>\uff0c\u8bf4\u660e\u6211\u4eec\u5728 <code>sret</code> \u6765\u6267\u884c\u7528\u6237\u6001\u7a0b\u5e8f\u7684\u65f6\u5019\uff0c\u7b2c\u4e00\u6761\u6307\u4ee4\u5c31\u56e0\u4e3a <code>V-bit</code> \u4e3a 0 \u8868\u5f81\u5176\u6620\u5c04\u7684\u5730\u5740\u65e0\u6548\u800c\u53d1\u751f\u4e86\u5f02\u5e38\uff0c\u5e76\u4e14\u53d1\u751f\u7684\u5f02\u5e38\u662f 12 \u53f7 Insturction Page Fault\u3002</p>"},{"location":"lab5/#page-fault-handler","title":"\u5b9e\u73b0 page fault handler","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u4fee\u6539 <code>trap.c</code>\uff0c\u4e3a <code>trap_handler</code> \u6dfb\u52a0\u6355\u83b7 page fault \u7684\u903b\u8f91\uff0c\u5206\u522b\u9700\u8981\u6355\u83b7 12, 13, 15 \u53f7\u5f02\u5e38\u3002</p> <p>\u5f53\u6355\u83b7\u4e86 page fault \u4e4b\u540e\uff0c\u9700\u8981\u5b9e\u73b0\u7f3a\u9875\u5f02\u5e38\u7684\u5904\u7406\u51fd\u6570 <code>do_page_fault</code>\uff0c\u5b83\u53ef\u4ee5\u540c\u65f6\u5904\u7406\u4e09\u79cd\u4e0d\u540c\u7684 page fault\u3002</p> <pre><code>void do_page_fault(struct pt_regs *regs) {\n    #error Unimplemented\n}\n</code></pre> <p>\u51fd\u6570\u7684\u5177\u4f53\u903b\u8f91\u4e3a\uff1a</p> <ol> <li>\u901a\u8fc7 <code>stval</code> \u83b7\u5f97\u8bbf\u95ee\u51fa\u9519\u7684\u865a\u62df\u5185\u5b58\u5730\u5740\uff08Bad Address\uff09</li> <li>\u901a\u8fc7 <code>find_vma()</code> \u67e5\u627e bad address \u662f\u5426\u5728\u67d0\u4e2a vma \u4e2d<ul> <li>\u5982\u679c\u4e0d\u5728\uff0c\u5219\u51fa\u73b0\u975e\u9884\u671f\u9519\u8bef\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>Err</code> \u5b8f\u8f93\u51fa\u9519\u8bef\u4fe1\u606f</li> <li>\u5982\u679c\u5728\uff0c\u5219\u6839\u636e vma \u7684 flags \u6743\u9650\u5224\u65ad\u5f53\u524d page fault \u662f\u5426\u5408\u6cd5<ul> <li>\u5982\u679c\u975e\u6cd5\uff08\u6bd4\u5982\u89e6\u53d1\u7684\u662f instruction page fault \u4f46 vma \u6743\u9650\u4e0d\u5141\u8bb8\u6267\u884c\uff09\uff0c\u5219 <code>Err</code> \u8f93\u51fa\u9519\u8bef\u4fe1\u606f</li> <li>\u5176\u4ed6\u60c5\u51b5\u5408\u6cd5\uff0c\u9700\u8981\u6211\u4eec\u6309\u63a5\u4e0b\u6765\u7684\u6d41\u7a0b\u521b\u5efa\u6620\u5c04</li> </ul> </li> </ul> </li> <li>\u5206\u914d\u4e00\u4e2a\u9875\uff0c\u63a5\u4e0b\u6765\u8981\u5c06\u8fd9\u4e2a\u9875\u6620\u5c04\u5230\u5bf9\u5e94\u7684\u7528\u6237\u5730\u5740\u7a7a\u95f4</li> <li>\u901a\u8fc7 <code>(vma-&gt;vm_flags &amp; VM_ANON)</code> \u83b7\u5f97\u5f53\u524d\u7684 VMA \u662f\u5426\u662f\u533f\u540d\u7a7a\u95f4<ul> <li>\u5982\u679c\u662f\u533f\u540d\u7a7a\u95f4\uff0c\u5219\u76f4\u63a5\u6620\u5c04\u5373\u53ef</li> <li>\u5982\u679c\u4e0d\u662f\uff0c\u5219\u9700\u8981\u6839\u636e <code>vma-&gt;vm_pgoff</code> \u7b49\u4fe1\u606f\u4ece ELF \u4e2d\u8bfb\u53d6\u6570\u636e\uff0c\u586b\u5145\u540e\u6620\u5c04\u5230\u7528\u6237\u7a7a\u95f4</li> </ul> </li> </ol> <p>\u9700\u8981\u6ce8\u610f bad address \u5e76\u4e0d\u4e00\u5b9a\u662f\u9875\u5bf9\u9f50\u7684\uff0c\u4f46\u5728\u6620\u5c04\u7684\u65f6\u5019 pa va \u9700\u8981\u662f\u9875\u5bf9\u9f50\u7684\uff0c\u8981\u5584\u7528 <code>PGROUNDUP</code> \u548c <code>PGROUNDDOWN</code> \u5b8f\u3002</p> <p>\u56e0\u4e3a\u6211\u4eec\u4ece <code>load_program</code> \u4e00\u6b21\u6027\u62f7\u8d1d\u7a7a\u95f4\u53d8\u6210\u4e86\u4e00\u6b21\u53ea\u62f7\u8d1d\u4e00\u9875\uff0c\u6240\u4ee5\u540c\u5b66\u4eec\u9700\u8981\u4ed4\u7ec6\u533a\u5206\u586b\u5145\u9875\u6570\u636e\u7684\u60c5\u51b5\uff0c\u5fc5\u8981\u7684\u65f6\u5019\u753b\u4e2a\u56fe\u4f1a\u6709\u5f88\u5927\u5e2e\u52a9\u3002</p>"},{"location":"lab5/#_8","title":"\u6d4b\u8bd5\u7f3a\u9875\u5904\u7406","text":"<p>\u6b63\u786e\u5b8c\u6210\u4e0a\u8ff0\u7684\u4fee\u6539\u540e\uff0c\u5e94\u8be5\u5c31\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c <code>PFH1</code> \u548c <code>PFH2</code> \u4e24\u4e2a\u6d4b\u8bd5\u4e86\uff0c\u8fd9\u91cc\u7ed9\u5927\u5bb6\u4e00\u4e9b\u8f93\u51fa\u793a\u4f8b\u4f9b\u53c2\u8003\uff1a</p> <code>make run TEST=PFH1</code> <p>\u53ef\u4ee5\u770b\u5230\u76f4\u5230 <code>task_init</code> \u5b8c\u6210\uff0c\u90fd\u53ea\u6709 <code>setup_vm_final</code> \u7684\u65f6\u5019\u521b\u5efa\u4e86\u6620\u5c04\uff0c\u7528\u6237\u6001\u8fdb\u7a0b\u7684\u62f7\u8d1d\u548c\u6620\u5c04\u90fd\u5728\u8c03\u5ea6\u4e4b\u540e\u9047\u5230 page fault \u624d\u89e6\u53d1\uff0c\u5e76\u4e14\u53ea\u6709\u7b2c\u4e00\u6b21\u89e6\u53d1\u4e86\uff1a</p> <pre><code>...buddy_init done!\n...mm_init done!\n[vm.c,52,create_mapping] root: ffffffe00020b000, [80200000, 80204000) -&gt; [ffffffe000200000, ffffffe000204000), perm: cb\n[vm.c,52,create_mapping] root: ffffffe00020b000, [80204000, 80205000) -&gt; [ffffffe000204000, ffffffe000205000), perm: c3\n[vm.c,52,create_mapping] root: ffffffe00020b000, [80205000, 88000000) -&gt; [ffffffe000205000, ffffffe008000000), perm: c7\n...task_init done!\n2024 ZJU Operating System\n\nSET [PID = 1 PRIORITY = 7 COUNTER = 7]\nSET [PID = 2 PRIORITY = 10 COUNTER = 10]\nSET [PID = 3 PRIORITY = 4 COUNTER = 4]\nSET [PID = 4 PRIORITY = 1 COUNTER = 1]\n\nswitch to [PID = 2 PRIORITY = 10 COUNTER = 10]\n[trap.c,59,do_page_fault] [PID = 2 PC = 0x100e8] valid page fault at `0x100e8` with cause 12\n[vm.c,52,create_mapping] root: ffffffe0002d2000, [802dd000, 802de000) -&gt; [10000, 11000), perm: df\n[trap.c,59,do_page_fault] [PID = 2 PC = 0x10178] valid page fault at `0x3ffffffff8` with cause 15\n[vm.c,52,create_mapping] root: ffffffe0002d2000, [802e0000, 802e1000) -&gt; [3ffffff000, 4000000000), perm: d7\n[trap.c,59,do_page_fault] [PID = 2 PC = 0x10198] valid page fault at `0x12230` with cause 13\n[vm.c,52,create_mapping] root: ffffffe0002d2000, [802e3000, 802e4000) -&gt; [12000, 13000), perm: df\n[trap.c,59,do_page_fault] [PID = 2 PC = 0x110ac] valid page fault at `0x110ac` with cause 12\n[vm.c,52,create_mapping] root: ffffffe0002d2000, [802e4000, 802e5000) -&gt; [11000, 12000), perm: df\n[U-MODE] pid: 2, sp is 0x3fffffffe0, this is print No.1\n[U-MODE] pid: 2, sp is 0x3fffffffe0, this is print No.2\n[U-MODE] pid: 2, sp is 0x3fffffffe0, this is print No.3\n\nswitch to [PID = 1 PRIORITY = 7 COUNTER = 7]\n[trap.c,59,do_page_fault] [PID = 1 PC = 0x100e8] valid page fault at `0x100e8` with cause 12\n[vm.c,52,create_mapping] root: ffffffe0002ce000, [802e5000, 802e6000) -&gt; [10000, 11000), perm: df\n[trap.c,59,do_page_fault] [PID = 1 PC = 0x10178] valid page fault at `0x3ffffffff8` with cause 15\n[vm.c,52,create_mapping] root: ffffffe0002ce000, [802e8000, 802e9000) -&gt; [3ffffff000, 4000000000), perm: d7\n[trap.c,59,do_page_fault] [PID = 1 PC = 0x10198] valid page fault at `0x12230` with cause 13\n[vm.c,52,create_mapping] root: ffffffe0002ce000, [802eb000, 802ec000) -&gt; [12000, 13000), perm: df\n[trap.c,59,do_page_fault] [PID = 1 PC = 0x110ac] valid page fault at `0x110ac` with cause 12\n[vm.c,52,create_mapping] root: ffffffe0002ce000, [802ec000, 802ed000) -&gt; [11000, 12000), perm: df\n[U-MODE] pid: 1, sp is 0x3fffffffe0, this is print No.1\n[U-MODE] pid: 1, sp is 0x3fffffffe0, this is print No.2\n\nswitch to [PID = 3 PRIORITY = 4 COUNTER = 4]\n[trap.c,59,do_page_fault] [PID = 3 PC = 0x100e8] valid page fault at `0x100e8` with cause 12\n[vm.c,52,create_mapping] root: ffffffe0002d6000, [802ed000, 802ee000) -&gt; [10000, 11000), perm: df\n[trap.c,59,do_page_fault] [PID = 3 PC = 0x10178] valid page fault at `0x3ffffffff8` with cause 15\n[vm.c,52,create_mapping] root: ffffffe0002d6000, [802f0000, 802f1000) -&gt; [3ffffff000, 4000000000), perm: d7\n[trap.c,59,do_page_fault] [PID = 3 PC = 0x10198] valid page fault at `0x12230` with cause 13\n[vm.c,52,create_mapping] root: ffffffe0002d6000, [802f3000, 802f4000) -&gt; [12000, 13000), perm: df\n[trap.c,59,do_page_fault] [PID = 3 PC = 0x110ac] valid page fault at `0x110ac` with cause 12\n[vm.c,52,create_mapping] root: ffffffe0002d6000, [802f4000, 802f5000) -&gt; [11000, 12000), perm: df\n[U-MODE] pid: 3, sp is 0x3fffffffe0, this is print No.1\n\nswitch to [PID = 4 PRIORITY = 1 COUNTER = 1]\n[trap.c,59,do_page_fault] [PID = 4 PC = 0x100e8] valid page fault at `0x100e8` with cause 12\n[vm.c,52,create_mapping] root: ffffffe0002da000, [802f5000, 802f6000) -&gt; [10000, 11000), perm: df\n[trap.c,59,do_page_fault] [PID = 4 PC = 0x10178] valid page fault at `0x3ffffffff8` with cause 15\n[vm.c,52,create_mapping] root: ffffffe0002da000, [802f8000, 802f9000) -&gt; [3ffffff000, 4000000000), perm: d7\n[trap.c,59,do_page_fault] [PID = 4 PC = 0x10198] valid page fault at `0x12230` with cause 13\n[vm.c,52,create_mapping] root: ffffffe0002da000, [802fb000, 802fc000) -&gt; [12000, 13000), perm: df\n[trap.c,59,do_page_fault] [PID = 4 PC = 0x110ac] valid page fault at `0x110ac` with cause 12\n[vm.c,52,create_mapping] root: ffffffe0002da000, [802fc000, 802fd000) -&gt; [11000, 12000), perm: df\n[U-MODE] pid: 4, sp is 0x3fffffffe0, this is print No.1\n\nSET [PID = 1 PRIORITY = 7 COUNTER = 7]\nSET [PID = 2 PRIORITY = 10 COUNTER = 10]\nSET [PID = 3 PRIORITY = 4 COUNTER = 4]\nSET [PID = 4 PRIORITY = 1 COUNTER = 1]\n\nswitch to [PID = 2 PRIORITY = 10 COUNTER = 10]\n[U-MODE] pid: 2, sp is 0x3fffffffe0, this is print No.4\n[U-MODE] pid: 2, sp is 0x3fffffffe0, this is print No.5\n</code></pre> <p><code>make run TEST=PFH2</code> \u7684\u6548\u679c\u4e0e\u524d\u9762\u7c7b\u4f3c\uff0c\u53ea\u4e0d\u8fc7\u5b83\u901a\u8fc7\u5168\u5c40\u53d8\u91cf\u7a7a\u51fa\u4e86\u4e00\u6574\u9875\u5927\u5c0f\u7684\u672a\u4f7f\u7528 <code>.data</code> \u533a\u57df\uff0c\u8fd9\u6bb5\u533a\u57df\u5728\u8fd0\u884c\u7684\u65f6\u5019\u4e5f\u4e0d\u4f1a\u89e6\u53d1 page fault\uff0c\u6240\u4ee5\u5728 log \u4e2d\u5e94\u8be5\u53ef\u4ee5\u53d1\u73b0 <code>create_mapping</code> \u6620\u5c04\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u4f1a\u7f3a\u5c11\u4e00\u9875\u3002</p> <p>\u548c\u4e4b\u524d\u7684\u5b9e\u9a8c\u4e00\u6837\uff0c\u8fd9\u91cc\u7684\u8f93\u51fa\u53ea\u8981\u80fd\u786e\u5b9a\u662f\u6b63\u786e\u7684\u5c31\u53ef\u4ee5\uff0c\u5177\u4f53\u6bcf\u4e2a\u8fdb\u7a0b\u6253\u5370\u51e0\u6b21\u3001log \u8f93\u51fa\u4e86\u4ec0\u4e48\u90fd\u4e0d\u91cd\u8981</p>"},{"location":"lab5/#fork_1","title":"\u5b9e\u73b0 fork \u7cfb\u7edf\u8c03\u7528","text":""},{"location":"lab5/#_9","title":"\u8868\u9762\u7684\u51c6\u5907\u5de5\u4f5c","text":"<p>\u5728\u5b9e\u73b0\u8f83\u4e3a\u590d\u6742\u7684 fork \u6d41\u7a0b\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u5c06\u6846\u67b6\u642d\u597d\uff0c\u5177\u4f53\u8981\u505a\u7684\u6709\u4ee5\u4e0b\u4e24\u4ef6\u4e8b\uff1a</p> <ul> <li> <p>\u4fee\u6539 proc \u76f8\u5173\u4ee3\u7801\uff0c\u4f7f\u5176\u53ea\u521d\u59cb\u5316\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u5176\u4ed6\u8fdb\u7a0b\u4fdd\u7559\u4e3a NULL \u7b49\u5f85 fork \u521b\u5efa</p> <p>\u5982\u4f55\u5b9e\u73b0\uff1f</p> <p>\u56e0\u4e3a\u6211\u4eec\u7684\u5b9e\u9a8c\u4e2d\u4e0d\u8003\u8651\u8fdb\u7a0b\u7684\u7ed3\u675f\u6216\u8005\u56e0\u4e3a\u5f02\u5e38\u5bfc\u81f4\u7684\u9000\u51fa\uff0c\u6240\u4ee5\u53ef\u4ee5\u53ea\u8003\u8651\u589e\u52a0\u8fdb\u7a0b\u4e0d\u8003\u8651\u5220\u9664\u8fdb\u7a0b\u3002\u8fd9\u6837\u7684\u8bdd\u6211\u4eec\u4fdd\u7559\u539f\u6765\u7684 <code>tasks</code> \u6570\u7ec4\u5c31\u53ef\u4ee5\u4e86\u3002</p> <p><code>NR_TASKS</code> \u8868\u793a\u6700\u591a\u53ef\u5bb9\u7eb3\u7684\u8fdb\u7a0b\u6570\uff08\u4e3a\u4e86\u5b8c\u6210 FORK3 \u6d4b\u8bd5\uff0c\u5b83\u81f3\u5c11\u662f <code>1+8</code>\uff09\uff0c\u7136\u540e\u751f\u6210\u4e00\u4e2a <code>tasks[NR_TASKS]</code> \u6570\u7ec4\u3002\u6700\u540e\u6dfb\u52a0\u4e00\u4e2a <code>nr_tasks</code> \u53d8\u91cf\u6765\u8bb0\u5f55\u5f53\u524d\u8fdb\u7a0b\u6570\uff0c\u5e76\u4f5c\u4e3a <code>tasks</code> \u7684\u6808\u9876\u6307\u9488\u6765\u4f7f\u7528\uff0c\u8fd9\u6837 <code>tasks</code> \u5c31\u662f\u4e00\u4e2a\u53ea\u8003\u8651\u538b\u6808\u64cd\u4f5c\u7684\u6808\u7ed3\u6784\u4e86\u3002</p> <p>\u5269\u4e0b\u7684\u66f4\u6539\u5c31\u662f\u628a <code>task_init</code> <code>schedule</code> \u7b49\u7528\u5230 <code>NR_TASKS</code> \u8868\u793a\u8fdb\u7a0b\u4e2a\u6570\u7684\u5730\u65b9\u6539\u6210 <code>nr_tasks</code> \u5c31\u597d\u4e86\u3002</p> </li> <li> <p>\u6dfb\u52a0\u7cfb\u7edf\u8c03\u7528\u5904\u7406</p> <p>\u5982\u4f55\u5b9e\u73b0\uff1f</p> <p>Fork \u5728 Linux \u4e2d\u7684\u7cfb\u7edf\u8c03\u7528\u662f <code>SYS_CLONE</code>\uff0c\u5176\u8c03\u7528\u53f7\u4e3a 220\uff0c\u6240\u4ee5\u9700\u8981\u5728\u5408\u9002\u7684\u4f4d\u7f6e\u52a0\u4e0a <code>#define SYS_CLONE 220</code>\uff08\u5305\u62ec <code>user/</code> \u4e0b\u7684 <code>syscall.h</code>\uff09\u3002</p> <p>\u7136\u540e\u5728\u7cfb\u7edf\u8c03\u7528\u7684\u5904\u7406\u51fd\u6570\u4e2d\uff0c\u68c0\u6d4b\u5230 <code>regs-&gt;a7 == SYS_CLONE</code> \u65f6\uff0c\u8c03\u7528 <code>do_fork</code> \u51fd\u6570\u6765\u5b8c\u6210 fork \u7684\u5de5\u4f5c\u3002</p> <pre><code>uint64_t do_fork(struct pt_regs *regs);\n</code></pre> <p>\u8fd9\u4e2a <code>do_fork</code> \u51fd\u6570\u5c31\u662f\u6211\u4eec\u6700\u540e\u5269\u4e0b\u7684\u91cd\u70b9\u4e86\u3002</p> </li> </ul>"},{"location":"lab5/#do_fork","title":"\u601d\u8003 do_fork \u8981\u505a\u4ec0\u4e48","text":"<p>\u5728\u4e86\u89e3\u4e86 fork \u7684\u539f\u7406\u4e4b\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u68b3\u7406\u4e00\u4e0b fork \u7684\u5de5\u4f5c\uff1a</p> <ul> <li>\u521b\u5efa\u4e00\u4e2a\u65b0\u8fdb\u7a0b\uff1a<ul> <li>\u62f7\u8d1d\u5185\u6838\u6808\uff08\u5305\u62ec\u4e86 <code>task_struct</code> \u7b49\u4fe1\u606f\uff09</li> <li>\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u9875\u8868<ul> <li>\u62f7\u8d1d\u5185\u6838\u9875\u8868 <code>swapper_pg_dir</code></li> <li>\u904d\u5386\u7236\u8fdb\u7a0b vma\uff0c\u5e76\u904d\u5386\u7236\u8fdb\u7a0b\u9875\u8868<ul> <li>\u5c06\u8fd9\u4e2a vma \u4e5f\u6dfb\u52a0\u5230\u65b0\u8fdb\u7a0b\u7684 vma \u94fe\u8868\u4e2d</li> <li>\u5982\u679c\u8be5 vma \u9879\u6709\u5bf9\u5e94\u7684\u9875\u8868\u9879\u5b58\u5728\uff08\u8bf4\u660e\u5df2\u7ecf\u521b\u5efa\u4e86\u6620\u5c04\uff09\uff0c\u5219\u9700\u8981\u6df1\u62f7\u8d1d\u4e00\u6574\u9875\u7684\u5185\u5bb9\u5e76\u6620\u5c04\u5230\u65b0\u9875\u8868\u4e2d</li> </ul> </li> </ul> </li> </ul> </li> <li>\u5c06\u65b0\u8fdb\u7a0b\u52a0\u5165\u8c03\u5ea6\u961f\u5217</li> <li>\u5904\u7406\u7236\u5b50\u8fdb\u7a0b\u7684\u8fd4\u56de\u503c<ul> <li>\u7236\u8fdb\u7a0b\u901a\u8fc7 <code>do_fork</code> \u51fd\u6570\u76f4\u63a5\u8fd4\u56de\u5b50\u8fdb\u7a0b\u7684 pid\uff0c\u5e76\u56de\u5230\u81ea\u8eab\u8fd0\u884c</li> <li>\u5b50\u8fdb\u7a0b\u901a\u8fc7\u88ab\u8c03\u5ea6\u5668\u8c03\u5ea6\u540e\uff08\u8df3\u5230 <code>thread.ra</code>\uff09\uff0c\u5f00\u59cb\u6267\u884c\u5e76\u8fd4\u56de 0</li> </ul> </li> </ul>"},{"location":"lab5/#_10","title":"\u62f7\u8d1d\u5185\u6838\u6808","text":"<p>\u56e0\u4e3a\u5185\u6838\u6808\u548c <code>task_struct</code> \u5728\u540c\u4e00\u4e2a\u9875\u7684\u9ad8\u4f4e\u5730\u5740\u4e0a\uff0c\u6240\u4ee5\u6211\u4eec\u76f4\u63a5 <code>memcpy</code> \u6df1\u62f7\u8d1d\u8fd9\u4e2a\u9875\u5c31\u53ef\u4ee5\u5f97\u5230\u6211\u4eec\u9700\u8981\u7684\u6240\u6709\u4fe1\u606f\u4e86\u3002</p> <p>\u4f46\u9664\u6b64\u4e4b\u5916\u8fd8\u8981\u7565\u5fae\u4fee\u6539 <code>task_struct</code> \u5185\u5bb9\uff0c\u5047\u8bbe\u65b0\u7684\u4e00\u9875\u4e3a\u6307\u9488 <code>_task</code>\uff0c\u5219\u9700\u8981\u4fee\u6539\uff1a</p> <ul> <li><code>_task-&gt;pid</code> \u6839\u636e <code>nr_tasks</code> \u6765\u8d4b\u503c</li> <li><code>_task-&gt;thread.ra/sp/sscratch</code> \u6839\u636e\u540e\u9762\u7684\u6307\u5bfc\u8d4b\u503c</li> <li><code>_task-&gt;pgd</code> \u4e3a\u65b0\u5206\u914d\u7684\u9875\u8868\u5730\u5740</li> <li><code>_task-&gt;mm.mmap</code> \u4e3a <code>NULL</code>\uff0c\u56e0\u4e3a\u65b0\u8fdb\u7a0b\u8fd8\u6ca1\u6709\u4efb\u4f55\u6620\u5c04</li> </ul>"},{"location":"lab5/#_11","title":"\u521b\u5efa\u5b50\u8fdb\u7a0b\u9875\u8868","text":"<p>\u6839\u636e\u524d\u9762\u6240\u8bf4\uff0c\u6d41\u7a0b\u4e3a\uff1a</p> <ul> <li>\u62f7\u8d1d\u5185\u6838\u9875\u8868 <code>swapper_pg_dir</code></li> <li>\u904d\u5386\u7236\u8fdb\u7a0b vma\uff0c\u5e76\u904d\u5386\u7236\u8fdb\u7a0b\u9875\u8868<ul> <li>\u5c06\u8fd9\u4e2a vma \u4e5f\u6dfb\u52a0\u5230\u65b0\u8fdb\u7a0b\u7684 vma \u94fe\u8868\u4e2d</li> <li>\u5982\u679c\u8be5 vma \u9879\u6709\u5bf9\u5e94\u7684\u9875\u8868\u9879\u5b58\u5728\uff08\u8bf4\u660e\u5df2\u7ecf\u521b\u5efa\u4e86\u6620\u5c04\uff09\uff0c\u5219\u9700\u8981\u6df1\u62f7\u8d1d\u4e00\u6574\u9875\u7684\u5185\u5bb9\u5e76\u6620\u5c04\u5230\u65b0\u9875\u8868\u4e2d</li> </ul> </li> </ul> <p>\u7f16\u5199\u63d0\u793a</p> <p>\u8fd9\u91cc\u9700\u8981\u6839\u636e vma \u4e00\u5927\u7247\u533a\u57df\u91cc\u9762\u6bcf\u4e00\u9875\u7684\u865a\u62df\u5730\u5740\u5bfb\u627e\u5176\u5bf9\u5e94\u7684\u7269\u7406\u5730\u5740\uff08\u901a\u8fc7\u904d\u5386\u9875\u8868\uff09\uff0c\u5982\u679c\u627e\u4e0d\u5230\uff08PTE V \u4e3a 0\uff09\u5219\u4e0d\u9700\u8981\u62f7\u8d1d\uff0c\u5982\u679c\u627e\u5230\u5219\u9700\u8981\u62f7\u8d1d\u4e00\u6574\u9875\u7684\u5185\u5bb9\u3002</p> <p>\u540c\u65f6\u9700\u8981\u6ce8\u610f\uff0c\u5728\u5185\u6838\u6001\u62f7\u8d1d\u5185\u5bb9\u4e5f\u9700\u8981\u4f7f\u7528\u865a\u62df\u5730\u5740\uff08\u56e0\u4e3a\u5185\u6838\u6001\u5728 S \u6a21\u5f0f\uff0c\u53ea\u6709 M \u6a21\u5f0f\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\u7269\u7406\u5730\u5740\uff0c\u5185\u6838\u6001\u8bbf\u95ee\u7269\u7406\u5730\u5740\u4f1a\u89e6\u53d1 page fault\uff09\u3002\u4f46\u6211\u4eec\u7684\u5b9e\u73b0\u4e2d\u5185\u6838\u6001\u7684\u7269\u7406\u5730\u5740\u548c\u865a\u62df\u5730\u5740\u662f\u53ea\u5dee\u4e86 <code>PA2VA_OFFSET</code> \u7684\uff0c\u53ef\u4ee5\u4f9d\u6b64\u6765\u7b80\u5316\u5b9e\u73b0\u3002</p>"},{"location":"lab5/#_12","title":"\u5904\u7406\u8fdb\u7a0b\u8fd4\u56de\u903b\u8f91","text":"<p>\u7236\u8fdb\u7a0b\u7684\u8fd4\u56de\u903b\u8f91\u975e\u5e38\u7b80\u5355\uff0c\u76f4\u63a5\u4e3a <code>do_fork</code> \u51fd\u6570\u8fd4\u56de\u5b50\u8fdb\u7a0b\u7684 pid \u5373\u53ef\u3002\u9ebb\u70e6\u7684\u662f\u5b50\u8fdb\u7a0b\u5f00\u59cb\u6267\u884c\u7684\u903b\u8f91\uff0c\u4e5f\u662f\u8fd9\u90e8\u5206\u7684\u91cd\u70b9\u548c\u6700\u540e\u4e00\u90e8\u5206\u3002</p> <p>\u7236\u8fdb\u7a0b\u7684\u8fd4\u56de\u8def\u5f84\u4e3a\uff1a<code>do_fork</code> -&gt; <code>do_syscall</code> -&gt; <code>trap_handler</code> -&gt; <code>_traps</code> -&gt; \u7528\u6237\u7a0b\u5e8f\uff1b\u800c\u5b50\u8fdb\u7a0b\u8981\u901a\u8fc7\u88ab\u8c03\u5ea6\u4e86\u624d\u80fd\u5f00\u59cb\u6267\u884c\uff1a<code>schedule</code> -&gt; <code>switch_to</code> -&gt; <code>__switch_to</code> -&gt; \"<code>thread.ra</code>\" -&gt; \u7528\u6237\u7a0b\u5e8f\u3002</p> <p>\u90a3\u4e48\u5f88\u663e\u7136\uff0c\u6211\u4eec\u8981\u8fd4\u56de\u5230\u7684 <code>thread.ra</code> \u8fd9\u4e2a\u4f4d\u7f6e\u7684\u4f5c\u7528\u548c <code>_traps</code> \u5e94\u8be5\u662f\u7c7b\u4f3c\u7684\u3002\u518d\u4ed4\u7ec6\u60f3\u60f3\uff0c\u5b50\u8fdb\u7a0b\u65e2\u7136\u662f\u7236\u8fdb\u7a0b\u72b6\u6001\u7684\u590d\u5236\uff0c\u90a3\u4e48\u5bf9\u4e8e\u5b50\u8fdb\u7a0b\u800c\u8a00\uff0c\u5b83\u662f\u4e0d\u662f\u4e5f\u50cf\u7236\u8fdb\u7a0b\u4ece <code>trap_handler</code> \u4e2d\u8fd4\u56de\u4e00\u6837\uff0c\u8ba4\u4e3a\u81ea\u5df1\u662f\u521a\u6267\u884c\u5b8c\u4e00\u4e2a\u7cfb\u7edf\u8c03\u7528\u5462\uff1f</p> <p>\u8fd9\u6837\u7684\u8bdd\uff0c\u9700\u8981\u8fdb\u884c\u7684\u5de5\u4f5c\u5c31\u6bd4\u8f83\u663e\u7136\u4e86\u3002\u5229\u7528 <code>__switch_to</code> \u65f6\u6062\u590d\u7684 ra \u4e0e sp\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u8df3\u8f6c\u5230 _traps \u4e2d\u4ece trap_handler \u8fd4\u56de\u7684\u4f4d\u7f6e\uff0c\u53ea\u9700\u8981\u52a0\u4e00\u4e2a\u6807\u53f7\uff1a</p> arch/riscv/kernel/entry.S<pre><code>_traps:\n    ...\n    jal trap_handler\n\n    .globl __ret_from_fork\n__ret_from_fork:\n\n    ...\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u7684 <code>_task-&gt;thread.ra</code> \u5c31\u5f88\u663e\u7136\u662f <code>__ret_from_fork</code> \u7684\u5730\u5740\u4e86\u3002</p> <p>\u5269\u4e0b\u7684\u5c31\u662f\u5904\u7406\u51e0\u4e2a\u4e71\u4e03\u516b\u7cdf\u7684 sp \u95ee\u9898\u4e86\uff0c\u5b83\u4eec\u5206\u522b\u662f\uff1a</p> <ul> <li><code>_task-&gt;thread.sp</code></li> <li><code>_task-&gt;thread.sscratch</code></li> <li>\u5f53\u524d\u7684 <code>sscratch</code> \u5bc4\u5b58\u5668\u503c</li> <li>\u5b50\u8fdb\u7a0b\u548c\u7236\u8fdb\u7a0b <code>pt_regs</code> \u4e2d\u7684 <code>regs-&gt;sp</code></li> </ul> <p>\u9996\u5148\u8981\u80af\u5b9a\u7684\u662f\u5b50\u8fdb\u7a0b\u548c\u7236\u8fdb\u7a0b\u7684 <code>pt_regs</code> \u80af\u5b9a\u662f\u4e0d\u4e00\u6837\u7684\u4e86\uff08\u6574\u4e2a\u5185\u6838\u9875\u90fd\u53d1\u751f\u4e86\u62f7\u8d1d\uff09\uff0c\u5728 <code>do_fork</code> \u51fd\u6570\u4e2d\u53c2\u6570\u7684 <code>regs</code> \u662f\u7236\u8fdb\u7a0b\u7684\uff0c\u800c\u5b50\u8fdb\u7a0b\u7684 <code>regs</code> \u5219\u9700\u8981\u5927\u5bb6\u81ea\u5df1\u8ba1\u7b97\u51fa\u6765\u3002</p> <p>\u8fd9\u51e0\u4e2a sp \u4e4b\u6240\u4ee5\u201c\u6df7\u4e71\u201d\u7684\u539f\u56e0\u662f\u5728\u8fdb\u5165 <code>_traps</code> \u548c\u9000\u51fa <code>_traps</code> \u65f6\uff0c\u4f1a\u53d1\u751f\u5185\u6838\u6808\u548c\u7528\u6237\u6808\u7684\u5207\u6362\uff0c\u9700\u8981\u540c\u5b66\u4eec\u81ea\u5df1\u5206\u6790\u5e76\u8fdb\u884c\u8bbe\u7f6e\uff1a</p> <ul> <li>\u5728 <code>do_fork</code> \u4e2d\uff0c\u7236\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u548c\u7528\u6237\u6808\u6307\u9488\u5206\u522b\u662f\u4ec0\u4e48</li> <li>\u5728 <code>do_fork</code> \u4e2d\uff0c\u5b50\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u548c\u7528\u6237\u6808\u6307\u9488\u7684\u503c\u5e94\u8be5\u662f\u4ec0\u4e48</li> <li>\u5728 <code>do_fork</code> \u4e2d\uff0c\u5b50\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u548c\u7528\u6237\u6808\u6307\u9488\u5206\u522b\u5e94\u8be5\u8d4b\u503c\u7ed9\u8c01</li> </ul> <p>\u601d\u8003\u4e4b\u540e\u5c31\u53ef\u4ee5\u5b8c\u6210\u5bf9\u5b50\u8fdb\u7a0b <code>_task-&gt;thread.sp/sscratch</code> \u4ee5\u53ca\u5b50\u8fdb\u7a0b <code>pt_regs</code> \u7684 <code>sp</code> \u7684\u8bbe\u7f6e\u4e86\u3002</p> <p>\u6700\u540e\u5c31\u662f\u4e3a\u5b50\u8fdb\u7a0b <code>pt_regs</code> \u7684 <code>a0</code> \u8bbe\u7f6e\u8fd4\u56de\u503c 0\uff0c\u4e3a <code>sepc</code> \u624b\u52a8\u52a0\u56db\u3002</p>"},{"location":"lab5/#fork_2","title":"\u6d4b\u8bd5 fork","text":"<p>\u81f3\u6b64\uff0c\u6b63\u786e\u5b9e\u73b0\u7684\u8bdd\u5c31\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\u5168\u90e8\u7684\u6d4b\u8bd5\u4e86\uff0c\u63a5\u4e0b\u6765\u7ed9\u51fa\u4e09\u4e2a\u7528\u4e8e fork \u7684\u6d4b\u8bd5\u7684\u793a\u4f8b\u8f93\u51fa\u548c\u6d4b\u8bd5\u76ee\u7684\uff1a</p> <code>make run TEST=FORK1</code> <p>\u53ef\u4ee5\u770b\u5230 PID 1 \u5728 fork \u51fa PID 2 \u65f6\u5c06\u73b0\u6709 <code>create_mapping</code> \u8fc7\u7684\u4e24\u4e2a\u9875\u62f7\u8d1d\u5e76\u5728\u5b50\u8fdb\u7a0b\u7684\u9875\u8868\u4e2d\u521b\u5efa\u4e86\u6620\u5c04\uff0c\u7136\u540e\u8c03\u5ea6\u540e PID 2 \u5f00\u59cb\u8fd0\u884c\uff0c\u800c\u4e14 <code>global_variable</code> \u7684\u503c\u4e92\u4e0d\u5f71\u54cd\uff0c\u540e\u7eed page fault \u4e5f\u662f\u5404\u81ea\u4e3a\u81ea\u5df1\u7684\u9875\u8868\u6dfb\u52a0\u6620\u5c04\u3002</p> <pre><code>...buddy_init done!\n...mm_init done!\n[vm.c,52,create_mapping] root: ffffffe00020b000, [80200000, 80204000) -&gt; [ffffffe000200000, ffffffe000204000), perm: cb\n[vm.c,52,create_mapping] root: ffffffe00020b000, [80204000, 80205000) -&gt; [ffffffe000204000, ffffffe000205000), perm: c3\n[vm.c,52,create_mapping] root: ffffffe00020b000, [80205000, 88000000) -&gt; [ffffffe000205000, ffffffe008000000), perm: c7\n...task_init done!\n2024 ZJU Operating System\n\nSET [PID = 1 PRIORITY = 7 COUNTER = 7]\n\nswitch to [PID = 1 PRIORITY = 7 COUNTER = 7]\n[trap.c,59,do_page_fault] [PID = 1 PC = 0x100e8] valid page fault at `0x100e8` with cause 12\n[vm.c,52,create_mapping] root: ffffffe0002ce000, [802d1000, 802d2000) -&gt; [10000, 11000), perm: df\n[trap.c,59,do_page_fault] [PID = 1 PC = 0x101ac] valid page fault at `0x3ffffffff8` with cause 15\n[vm.c,52,create_mapping] root: ffffffe0002ce000, [802d4000, 802d5000) -&gt; [3ffffff000, 4000000000), perm: d7\n\n[vm.c,52,create_mapping] root: ffffffe0002d8000, [802da000, 802db000) -&gt; [10000, 11000), perm: df\n[vm.c,52,create_mapping] root: ffffffe0002d8000, [802de000, 802df000) -&gt; [3ffffff000, 4000000000), perm: d7\n[PID = 2] forked from [PID = 1]\n\n[trap.c,59,do_page_fault] [PID = 1 PC = 0x10228] valid page fault at `0x122d0` with cause 13\n[vm.c,52,create_mapping] root: ffffffe0002ce000, [802e1000, 802e2000) -&gt; [12000, 13000), perm: df\n[trap.c,59,do_page_fault] [PID = 1 PC = 0x11114] valid page fault at `0x11114` with cause 12\n[vm.c,52,create_mapping] root: ffffffe0002ce000, [802e2000, 802e3000) -&gt; [11000, 12000), perm: df\n[U-PARENT] pid: 1 is running! global_variable: 0\n[U-PARENT] pid: 1 is running! global_variable: 1\n\nswitch to [PID = 2 PRIORITY = 7 COUNTER = 7]\n[trap.c,59,do_page_fault] [PID = 2 PC = 0x101e0] valid page fault at `0x122d0` with cause 13\n[vm.c,52,create_mapping] root: ffffffe0002d8000, [802e3000, 802e4000) -&gt; [12000, 13000), perm: df\n[trap.c,59,do_page_fault] [PID = 2 PC = 0x11114] valid page fault at `0x11114` with cause 12\n[vm.c,52,create_mapping] root: ffffffe0002d8000, [802e4000, 802e5000) -&gt; [11000, 12000), perm: df\n[U-CHILD] pid: 2 is running! global_variable: 0\n[U-CHILD] pid: 2 is running! global_variable: 1\n\nSET [PID = 1 PRIORITY = 7 COUNTER = 7]\nSET [PID = 2 PRIORITY = 7 COUNTER = 7]\n\nswitch to [PID = 1 PRIORITY = 7 COUNTER = 7]\n[U-PARENT] pid: 1 is running! global_variable: 2\n\nswitch to [PID = 2 PRIORITY = 7 COUNTER = 7]\n[U-CHILD] pid: 2 is running! global_variable: 2\n[U-CHILD] pid: 2 is running! global_variable: 3\n\nSET [PID = 1 PRIORITY = 7 COUNTER = 7]\nSET [PID = 2 PRIORITY = 7 COUNTER = 7]\n\nswitch to [PID = 1 PRIORITY = 7 COUNTER = 7]\n[U-PARENT] pid: 1 is running! global_variable: 3\n</code></pre> <code>make run TEST=FORK2</code> <p>\u672c\u6d4b\u8bd5\u7684\u4e3b\u8981\u8f93\u51fa\u73b0\u8c61\u4e3a\uff0c\u7236\u8fdb\u7a0b\u5728\u7ed9 <code>global_variable</code> \u81ea\u589e\u4e86\u4e09\u6b21\uff0c\u4e3a <code>placeholder</code> \u4e2d\u8d4b\u503c\u4e86\u5b57\u7b26\u4e32\u4e4b\u540e\u624d fork \u51fa\u5b50\u8fdb\u7a0b\uff0c\u5b50\u8fdb\u7a0b\u5e94\u8be5\u8981\u901a\u8fc7\u6df1\u62f7\u8d1d\u9875\u8868\u6765\u4fdd\u7559\u8fd9\u4e9b\u4fe1\u606f\u3002PID 2 \u5f00\u59cb\u8fd0\u884c\u65f6\u4e5f\u5e94\u8be5\u6b63\u786e\u8f93\u51fa <code>ZJU OS Lab5</code> \u5b57\u7b26\u4e32\uff0c\u5e76\u4e14 <code>global_variable</code> \u4ece 3 \u5f00\u59cb\u81ea\u589e\uff0c\u4e14\u540e\u7eed\u548c\u7236\u8fdb\u7a0b\u4e92\u4e0d\u5f71\u54cd\u3002</p> <pre><code>...buddy_init done!\n...mm_init done!\n[vm.c,52,create_mapping] root: ffffffe00020b000, [80200000, 80204000) -&gt; [ffffffe000200000, ffffffe000204000), perm: cb\n[vm.c,52,create_mapping] root: ffffffe00020b000, [80204000, 80205000) -&gt; [ffffffe000204000, ffffffe000205000), perm: c3\n[vm.c,52,create_mapping] root: ffffffe00020b000, [80205000, 88000000) -&gt; [ffffffe000205000, ffffffe008000000), perm: c7\n...task_init done!\n2024 ZJU Operating System\n\nSET [PID = 1 PRIORITY = 7 COUNTER = 7]\n\nswitch to [PID = 1 PRIORITY = 7 COUNTER = 7]\n[trap.c,59,do_page_fault] [PID = 1 PC = 0x100e8] valid page fault at `0x100e8` with cause 12\n[vm.c,52,create_mapping] root: ffffffe0002ce000, [802d1000, 802d2000) -&gt; [10000, 11000), perm: df\n[trap.c,59,do_page_fault] [PID = 1 PC = 0x101ac] valid page fault at `0x3ffffffff8` with cause 15\n[vm.c,52,create_mapping] root: ffffffe0002ce000, [802d4000, 802d5000) -&gt; [3ffffff000, 4000000000), perm: d7\n[trap.c,59,do_page_fault] [PID = 1 PC = 0x101d0] valid page fault at `0x12518` with cause 13\n[vm.c,52,create_mapping] root: ffffffe0002ce000, [802d7000, 802d8000) -&gt; [12000, 13000), perm: df\n[trap.c,59,do_page_fault] [PID = 1 PC = 0x112cc] valid page fault at `0x112cc` with cause 12\n[vm.c,52,create_mapping] root: ffffffe0002ce000, [802d8000, 802d9000) -&gt; [11000, 12000), perm: df\n[trap.c,59,do_page_fault] [PID = 1 PC = 0x10434] valid page fault at `0x14520` with cause 13\n[vm.c,52,create_mapping] root: ffffffe0002ce000, [802d9000, 802da000) -&gt; [14000, 15000), perm: df\n[U] pid: 1 is running! global_variable: 0\n[U] pid: 1 is running! global_variable: 1\n[U] pid: 1 is running! global_variable: 2\n[trap.c,59,do_page_fault] [PID = 1 PC = 0x10228] valid page fault at `0x13520` with cause 15\n\n[vm.c,52,create_mapping] root: ffffffe0002ce000, [802da000, 802db000) -&gt; [13000, 14000), perm: df\n[vm.c,52,create_mapping] root: ffffffe0002dc000, [802de000, 802df000) -&gt; [10000, 11000), perm: df\n[vm.c,52,create_mapping] root: ffffffe0002dc000, [802e1000, 802e2000) -&gt; [11000, 12000), perm: df\n[vm.c,52,create_mapping] root: ffffffe0002dc000, [802e2000, 802e3000) -&gt; [12000, 13000), perm: df\n[vm.c,52,create_mapping] root: ffffffe0002dc000, [802e3000, 802e4000) -&gt; [13000, 14000), perm: df\n[vm.c,52,create_mapping] root: ffffffe0002dc000, [802e4000, 802e5000) -&gt; [14000, 15000), perm: df\n[vm.c,52,create_mapping] root: ffffffe0002dc000, [802e6000, 802e7000) -&gt; [3ffffff000, 4000000000), perm: d7\n[PID = 2] forked from [PID = 1]\n\n[U-PARENT] pid: 1 is running! Message: ZJU OS Lab5\n[U-PARENT] pid: 1 is running! global_variable: 3\n[U-PARENT] pid: 1 is running! global_variable: 4\n\nswitch to [PID = 2 PRIORITY = 7 COUNTER = 7]\n[U-CHILD] pid: 2 is running! Message: ZJU OS Lab5\n[U-CHILD] pid: 2 is running! global_variable: 3\n[U-CHILD] pid: 2 is running! global_variable: 4\n\nSET [PID = 1 PRIORITY = 7 COUNTER = 7]\nSET [PID = 2 PRIORITY = 7 COUNTER = 7]\n\nswitch to [PID = 1 PRIORITY = 7 COUNTER = 7]\n[U-PARENT] pid: 1 is running! global_variable: 5\n\nswitch to [PID = 2 PRIORITY = 7 COUNTER = 7]\n[U-CHILD] pid: 2 is running! global_variable: 5\n</code></pre> <p><code>make run TEST=FORK3</code></p> <p>FORK3 \u7684\u4ee3\u7801\u4e2d\u6709\u4e09\u4e2a <code>fork</code>\uff0c\u9884\u671f\u8f93\u51fa\u5e76\u4e0d\u5728\u8fd9\u91cc\u5448\u73b0\uff0c\u9700\u8981\u4f60\u81ea\u5df1\u901a\u8fc7\u5206\u6790\u4ee3\u7801\u7684\u9884\u671f\u7ed3\u679c\u6765\u5224\u65ad\u8f93\u51fa\u662f\u5426\u6b63\u786e\u3002\u540c\u4e00\u4e2a\u7a0b\u5e8f\u91cc\u591a\u4e2a <code>fork</code> \u4e5f\u662f\u5728\u8003\u8bd5\u4e2d\u8f83\u5e38\u89c1\u7684\u9898\u76ee\uff0c\u5e0c\u671b\u540c\u5b66\u4eec\u53ef\u4ee5\u901a\u8fc7\u672c\u6b21\u5b9e\u9a8c\u4ee5\u53ca\u5206\u6790\u8fd9\u4e2a\u6d4b\u8bd5\u66f4\u597d\u638c\u63e1 fork \u7684\u539f\u7406\u3002</p>"},{"location":"lab5/#cow","title":"\u5199\u65f6\u590d\u5236 COW","text":"<p>\u6b64\u90e8\u5206\u4e0d\u8981\u6c42\u5b8c\u6210\uff0c\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u81ea\u884c\u5b9e\u73b0\uff0c\u5b8c\u6210\u672c\u90e8\u5206\u53ef\u4ee5\u514d\u5199\u524d\u56db\u9053\u601d\u8003\u9898</p> <p>COW \u7684\u6838\u5fc3\u662f\uff0c\u518d\u5c06 <code>do_fork</code> \u4e2d\u5206\u914d\u9875\u9762\u3001\u62f7\u8d1d\u5185\u5bb9\u7684\u64cd\u4f5c\u540e\u79fb\uff0c\u79fb\u52a8\u5230\u51fa\u73b0\u5199\u64cd\u4f5c\u7684\u65f6\u5019\u518d\u8fdb\u884c\u62f7\u8d1d\uff0c\u8fd9\u6837\u5982\u679c\u662f\u53ea\u8bfb\u7684\u9875\u9762\u5c31\u53ef\u4ee5\u5728\u7236\u5b50\u8fdb\u7a0b\u4e4b\u95f4\u5171\u4eab\uff0c\u514d\u53bb\u62f7\u8d1d\u7684\u5f00\u9500\u3002</p> <p>\u56e0\u4e3a\u8981\u5171\u4eab\u9875\u9762\uff0c\u6240\u4ee5\u6211\u4eec\u8981\u7a0d\u5fae\u66f4\u6539 <code>mm.c</code> \u4e2d\u7684 buddy system\uff0c\u4e3a\u6bcf\u4e2a\u9875\u6dfb\u52a0\u4e00\u4e2a\u5f15\u7528\u8ba1\u6570 refcnt\uff1a</p> mm.h mm.c \u7684\u5177\u4f53\u4fee\u6539 arch/riscv/include/mm.h<pre><code>struct buddy {\nuint64_t size;\nuint64_t *bitmap; \nuint64_t *ref_cnt;\n};\n\nuint64_t get_page(void *);          // \u589e\u52a0\u8ba1\u6570\nvoid put_page(void *);              // \u51cf\u5c11\u8ba1\u6570\nuint64_t get_page_refcnt(void *);   // \u83b7\u53d6\u8ba1\u6570\n</code></pre> arch/riscv/kernel/mm.c<pre><code>void buddy_init() {\n    ...\n    memset(buddy.bitmap, 0, 2 * buddy.size * sizeof(*buddy.bitmap));\n\n    buddy.ref_cnt = free_page_start;\n    free_page_start += buddy.size * sizeof(*buddy.ref_cnt);\n    memset(buddy.ref_cnt, 0, buddy.size * sizeof(*buddy.ref_cnt));\n    ...\n}\n\nvoid page_ref_inc(uint64_t pfn) {\n    buddy.ref_cnt[pfn]++;\n}\n\nvoid page_ref_dec(uint64_t pfn) {\n    if (buddy.ref_cnt[pfn] &gt; 0) {\n        buddy.ref_cnt[pfn]--;\n    }\n    if (buddy.ref_cnt[pfn] == 0) {\n        Log(\"free page: %p\", PFN2PHYS(pfn));\n        buddy_free(pfn);\n    }\n}\n\nvoid buddy_free(uint64_t pfn) {\n    // if ref_cnt is not zero, do nothing\n    if (buddy.ref_cnt[pfn]) {\n        return;\n    }\n    ...\n}\n\nuint64_t buddy_alloc(uint64_t nrpages) {\n    ...\n    buddy.bitmap[index] = 0;\n    pfn = (index + 1) * node_size - buddy.size;\n    buddy.ref_cnt[pfn] = 1;\n    ...\n}\n\nuint64_t get_page(void *va) {\n    uint64_t pfn = PHYS2PFN(VA2PA((uint64_t)va));\n    // check if the page is already allocated\n    if (buddy.ref_cnt[pfn] == 0) {\n        return 1;\n    }\n    page_ref_inc(pfn);\n    return 0;\n}\n\nuint64_t get_page_refcnt(void *va) {\n    uint64_t pfn = PHYS2PFN(VA2PA((uint64_t)va));\n    return buddy.ref_cnt[pfn];\n}\n\nvoid put_page(void *va) {\n    uint64_t pfn = PHYS2PFN(VA2PA((uint64_t)va));\n    page_ref_dec(pfn);\n}\n</code></pre> <p>\u63a5\u4e0b\u6765\u5728\u6211\u4eec <code>do_fork</code> \u521b\u5efa\u9875\u9762\u3001\u62f7\u8d1d\u5185\u5bb9\u3001\u521b\u5efa\u9875\u8868\u7684\u65f6\u5019\uff0c\u53ea\u9700\u8981\uff1a</p> <ul> <li>\u5c06\u7269\u7406\u9875\u7684\u5f15\u7528\u8ba1\u6570\u52a0\u4e00</li> <li>\u5c06\u7236\u8fdb\u7a0b\u7684\u8be5\u5730\u5740\u5bf9\u5e94\u7684\u9875\u8868\u9879\u7684 <code>PTE_W</code> \u4f4d\u7f6e 0<ul> <li>\u6ce8\u610f\u56e0\u4e3a\u4fee\u6539\u4e86\u9875\u8868\u9879\u6743\u9650\uff0c\u6240\u4ee5\u5168\u90e8\u4fee\u6539\u5b8c\u6210\u540e\u9700\u8981\u901a\u8fc7 <code>sfence.vma</code> \u5237\u65b0 TLB</li> </ul> </li> <li>\u4e3a\u5b50\u8fdb\u7a0b\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u9875\u8868\u9879\uff0c\u6307\u5411\u7236\u8fdb\u7a0b\u7684\u7269\u7406\u9875\uff0c\u4e14\u6743\u9650\u4e0d\u5e26 <code>PTE_W</code></li> </ul> <p>\u8fd9\u6837\u5728\u7236\u5b50\u8fdb\u7a0b\u60f3\u8981\u5199\u5165\u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u89e6\u53d1 page fault\uff0c\u7136\u540e\u518d\u7531\u6211\u4eec\u5728 page fault handler \u4e2d\u8fdb\u884c COW\u3002\u5728 handler \u4e2d\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5224\u65ad\uff0c\u5982\u679c\u53d1\u751f\u4e86\u5199\u9519\u8bef\uff0c\u4e14 vma \u7684 <code>VM_WRITE</code> \u4f4d\u4e3a 1\uff0c\u800c\u4e14\u5bf9\u5e94\u5730\u5740\u6709 pte\uff08\u8fdb\u884c\u4e86\u6620\u5c04\uff09\u4f46 pte \u7684 <code>PTE_W</code> \u4f4d\u4e3a 0\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u65ad\u5b9a\u8fd9\u662f\u4e00\u4e2a\u5199\u65f6\u590d\u5236\u7684\u9875\u9762\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728\u8fd9\u4e2a\u65f6\u5019\u62f7\u8d1d\u4e00\u4efd\u539f\u6765\u7684\u9875\u9762\uff0c\u91cd\u65b0\u521b\u5efa\u4e00\u4e2a\u6620\u5c04\u5373\u53ef\u3002</p> <p>\u5173\u4e8e\u5f15\u7528\u8ba1\u6570</p> <p>\u62f7\u8d1d\u4e86\u9875\u9762\u4e4b\u540e\uff0c\u522b\u5fd8\u4e86\u5c06\u539f\u6765\u7684\u9875\u9762\u5f15\u7528\u8ba1\u6570\u51cf\u4e00\u3002\u8fd9\u6837\u7236\u5b50\u8fdb\u7a0b\u60f3\u8981\u5199\u5165\u7684\u65f6\u5019\uff0c\u90fd\u4f1a\u89e6\u53d1 COW\uff0c\u5e76\u62f7\u8d1d\u4e00\u4e2a\u65b0\u9875\u9762\uff0c\u90fd\u62f7\u8d1d\u5b8c\u6210\u540e\uff0c\u539f\u6765\u7684\u9875\u9762\u5c06\u81ea\u52a8 free \u6389\u3002</p> <p>\u8fdb\u4e00\u6b65\u7684\uff0c\u7236\u8fdb\u7a0b COW \u540e\uff0c\u5b50\u8fdb\u7a0b\u518d\u8fdb\u884c\u5199\u5165\u7684\u65f6\u5019\uff0c\u4e5f\u53ef\u4ee5\u5728\u8fd9\u65f6\u5224\u65ad\u5f15\u7528\u8ba1\u6570\uff0c\u5982\u679c\u8ba1\u6570\u4e3a 1\uff0c\u8bf4\u660e\u8fd9\u4e2a\u9875\u9762\u53ea\u6709\u4e00\u4e2a\u5f15\u7528\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u76f4\u63a5\u5c06 pte \u7684 <code>PTE_W</code> \u4f4d\u518d\u7f6e 1\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u76f4\u63a5\u5199\u5165\u4e86\uff0c\u514d\u53bb\u4e00\u6b21\u989d\u5916\u7684\u590d\u5236\u3002</p> <p>\u6b63\u786e\u5b8c\u6210\u540e\uff0c\u524d\u9762\u7684\u6d4b\u8bd5\u5e94\u8be5\u90fd\u80fd\u6b63\u5e38\u5b8c\u6210\u3002\u540c\u65f6\u5efa\u8bae\u5927\u5bb6\u8f93\u51fa\u4e00\u4e9b COW \u7684\u4fe1\u606f\u6765\u9a8c\u8bc1\u5b9e\u73b0\u662f\u5426\u6b63\u786e\u3002</p>"},{"location":"lab5/#_13","title":"\u601d\u8003\u9898","text":"<ol> <li>\u5448\u73b0\u51fa\u4f60\u5728 page fault \u7684\u65f6\u5019\u62f7\u8d1d ELF \u7a0b\u5e8f\u5185\u5bb9\u7684\u903b\u8f91\u3002</li> <li>\u56de\u7b54 4.3.5 \u4e2d\u7684\u95ee\u9898\uff1a<ul> <li>\u5728 do_fork \u4e2d\uff0c\u7236\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u548c\u7528\u6237\u6808\u6307\u9488\u5206\u522b\u662f\u4ec0\u4e48\uff1f</li> <li>\u5728 do_fork \u4e2d\uff0c\u5b50\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u548c\u7528\u6237\u6808\u6307\u9488\u7684\u503c\u5e94\u8be5\u662f\u4ec0\u4e48\uff1f</li> <li>\u5728 do_fork \u4e2d\uff0c\u5b50\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u548c\u7528\u6237\u6808\u6307\u9488\u5206\u522b\u5e94\u8be5\u8d4b\u503c\u7ed9\u8c01\uff1f</li> </ul> </li> <li>\u4e3a\u4ec0\u4e48\u8981\u4e3a\u5b50\u8fdb\u7a0b <code>pt_regs</code> \u7684 <code>sepc</code> \u624b\u52a8\u52a0\u56db\uff1f</li> <li>\u5bf9\u4e8e <code>Fork main #2</code>\uff08\u5373 <code>FORK2</code>\uff09\uff0c\u5728\u8fd0\u884c\u65f6\uff0c<code>ZJU OS Lab5</code> \u4f4d\u4e8e\u5185\u5b58\u7684\u4ec0\u4e48\u4f4d\u7f6e\uff1f\u662f\u5426\u5728\u8bfb\u53d6\u7684\u65f6\u5019\u4ea7\u751f\u4e86 page fault\uff1f\u8bf7\u7ed9\u51fa\u5fc5\u8981\u7684\u622a\u56fe\u4ee5\u8bf4\u660e\u3002</li> <li>\u753b\u56fe\u5206\u6790 <code>make run TEST=FORK3</code> \u7684\u8fdb\u7a0b fork \u8fc7\u7a0b\uff0c\u5e76\u5448\u73b0\u51fa\u5404\u4e2a\u8fdb\u7a0b\u7684 <code>global_variable</code> \u5e94\u8be5\u4ece\u51e0\u5f00\u59cb\u8f93\u51fa\uff0c\u518d\u4e0e\u4f60\u7684\u8f93\u51fa\u8fdb\u884c\u5bf9\u6bd4\u9a8c\u8bc1\u3002</li> </ol>"},{"location":"lab5/#_14","title":"\u5b9e\u9a8c\u4efb\u52a1\u4e0e\u8981\u6c42","text":"<ul> <li>\u8bf7\u5404\u4f4d\u540c\u5b66\u72ec\u7acb\u5b8c\u6210\u4f5c\u4e1a\uff0c\u4efb\u4f55\u6284\u88ad\u884c\u4e3a\u90fd\u5c06\u4f7f\u672c\u6b21\u4f5c\u4e1a\u5224\u4e3a 0 \u5206\u3002</li> <li> <p>\u5728\u5b66\u5728\u6d59\u5927\u4e2d\u63d0\u4ea4\uff1a</p> <ul> <li> <p>\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u7684\u538b\u7f29\u5305\uff08\u63d0\u4ea4\u4e4b\u524d\u8bf7\u4f7f\u7528 <code>make clean</code> \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\uff09</p> <p>\u5e76\u4e0d\u9700\u8981\u5220\u9664\u6216\u6ce8\u91ca\u6389\u7a0b\u5e8f\u4e2d\u7684 <code>Log</code> \u7b49\u8f93\u51fa\uff0c\u8fd9\u4e5f\u4f1a\u66f4\u597d\u5730\u5e2e\u52a9\u52a9\u6559\u5224\u65ad\u4f60\u7a0b\u5e8f\u7684\u6b63\u786e\u6027 :)</p> </li> <li> <p>pdf \u683c\u5f0f\u7684\u5b9e\u9a8c\u62a5\u544a\uff1a</p> <ul> <li>\u8bb0\u5f55\u5b9e\u9a8c\u8fc7\u7a0b\u5e76\u622a\u56fe\uff084.1-4.3\uff09\uff0c\u5e76\u5bf9\u6bcf\u4e00\u6b65\u7684\u547d\u4ee4\u4ee5\u53ca\u7ed3\u679c\u8fdb\u884c\u5fc5\u8981\u7684\u89e3\u91ca\uff1b</li> <li>\u8bb0\u5f55\u9047\u5230\u7684\u95ee\u9898\u548c\u5fc3\u5f97\u4f53\u4f1a\uff1b</li> <li>\u5b8c\u6210\u601d\u8003\u9898\u3002</li> </ul> </li> </ul> </li> </ul> <p>\u5173\u4e8e\u5b9e\u9a8c\u62a5\u544a\u5185\u5bb9\u8981\u6c42\uff0c\u53ef\u89c1\uff1a\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54 - \u5b9e\u9a8c\u63d0\u4ea4\u8981\u6c42</p>"},{"location":"lab6/","title":"Lab6: VFS &amp; FAT32 \u6587\u4ef6\u7cfb\u7edf","text":"<p>\u672c\u5b9e\u9a8c\u4e3a bonus\uff0c\u4e0d\u505a\u786c\u6027\u8981\u6c42</p>"},{"location":"lab6/#_1","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<ul> <li>\u4e3a\u7528\u6237\u6001\u7684 Shell \u63d0\u4f9b <code>read</code> \u548c <code>write</code> syscall \u7684\u5b9e\u73b0\uff08\u5b8c\u6210\u8be5\u90e8\u5206\u7684\u6240\u6709\u5b9e\u73b0\u65b9\u5f97 60 \u5206\uff09</li> <li>\u5b9e\u73b0 FAT32 \u6587\u4ef6\u7cfb\u7edf\u7684\u57fa\u672c\u529f\u80fd\uff0c\u5e76\u5bf9\u5176\u4e2d\u7684\u6587\u4ef6\u8fdb\u884c\u8bfb\u5199\uff08\u5b8c\u6210\u8be5\u90e8\u5206\u7684\u6240\u6709\u5b9e\u73b0\u65b9\u5f97 40 \u5206\uff09</li> </ul>"},{"location":"lab6/#_2","title":"\u5b9e\u9a8c\u73af\u5883","text":"<ul> <li>Environment in previous labs</li> </ul>"},{"location":"lab6/#_3","title":"\u80cc\u666f\u77e5\u8bc6","text":""},{"location":"lab6/#vfs","title":"VFS","text":"<p>\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\uff08Virtual File System\uff0cVFS\uff09\u6216\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u4ea4\u6362\u673a\u662f\u4f4d\u4e8e\u66f4\u5177\u4f53\u7684\u6587\u4ef6\u7cfb\u7edf\u4e4b\u4e0a\u7684\u62bd\u8c61\u5c42\u3002VFS \u7684\u76ee\u7684\u662f\u5141\u8bb8\u5ba2\u6237\u7aef\u5e94\u7528\u7a0b\u5e8f\u4ee5\u7edf\u4e00\u7684\u65b9\u5f0f\u8bbf\u95ee\u4e0d\u540c\u7c7b\u578b\u7684\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u3002\u4f8b\u5982\uff0c\u53ef\u4ee5\u4f7f\u7528 VFS \u900f\u660e\u5730\u8bbf\u95ee\u672c\u5730\u548c\u7f51\u7edc\u5b58\u50a8\u8bbe\u5907\uff0c\u800c\u5ba2\u6237\u673a\u5e94\u7528\u7a0b\u5e8f\u4e0d\u4f1a\u6ce8\u610f\u5230\u5176\u4e2d\u7684\u5dee\u5f02\u3002\u5b83\u53ef\u4ee5\u7528\u6765\u5f25\u5408 Windows\u3001macOS \u7b49\u4e0d\u540c\u64cd\u4f5c\u7cfb\u7edf\u6240\u4f7f\u7528\u7684\u6587\u4ef6\u7cfb\u7edf\u4e4b\u95f4\u7684\u5dee\u5f02\uff0c\u8fd9\u6837\u5e94\u7528\u7a0b\u5e8f\u5c31\u53ef\u4ee5\u8bbf\u95ee\u8fd9\u4e9b\u7c7b\u578b\u7684\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4e0a\u7684\u6587\u4ef6\uff0c\u800c\u4e0d\u5fc5\u77e5\u9053\u5b83\u4eec\u6b63\u5728\u8bbf\u95ee\u4ec0\u4e48\u7c7b\u578b\u7684\u6587\u4ef6\u7cfb\u7edf\u3002</p> <p>VFS \u6307\u5b9a\u5185\u6838\u548c\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u4e4b\u95f4\u7684\u63a5\u53e3\uff08\u6216\u201c\u534f\u8bae\u201d\uff09\u3002\u56e0\u6b64\uff0c\u53ea\u9700\u5b8c\u6210\u534f\u8bae\uff0c\u5c31\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u5411\u5185\u6838\u6dfb\u52a0\u5bf9\u65b0\u6587\u4ef6\u7cfb\u7edf\u7c7b\u578b\u7684\u652f\u6301\u3002\u534f\u8bae\u53ef\u80fd\u4f1a\u968f\u7740\u7248\u672c\u7684\u4e0d\u540c\u800c\u4e0d\u517c\u5bb9\u5730\u6539\u53d8\uff0c\u8fd9\u5c06\u9700\u8981\u91cd\u65b0\u7f16\u8bd1\u5177\u4f53\u7684\u6587\u4ef6\u7cfb\u7edf\u652f\u6301\uff0c\u5e76\u4e14\u53ef\u80fd\u5728\u91cd\u65b0\u7f16\u8bd1\u4e4b\u524d\u8fdb\u884c\u4fee\u6539\uff0c\u4ee5\u5141\u8bb8\u5b83\u4e0e\u65b0\u7248\u672c\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e00\u8d77\u5de5\u4f5c\uff1b\u6216\u8005\u64cd\u4f5c\u7cfb\u7edf\u7684\u4f9b\u5e94\u5546\u53ef\u80fd\u53ea\u5bf9\u534f\u8bae\u8fdb\u884c\u5411\u540e\u517c\u5bb9\u7684\u66f4\u6539\uff0c\u4ee5\u4fbf\u4e3a\u64cd\u4f5c\u7cfb\u7edf\u7684\u7ed9\u5b9a\u7248\u672c\u6784\u5efa\u7684\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u652f\u6301\u5c06\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u7684\u672a\u6765\u7248\u672c\u4e00\u8d77\u5de5\u4f5c\u3002</p>"},{"location":"lab6/#virtio","title":"VirtIO","text":"<p>VirtIO \u662f\u4e00\u4e2a\u5f00\u653e\u6807\u51c6\uff0c\u5b83\u5b9a\u4e49\u4e86\u4e00\u79cd\u534f\u8bae\uff0c\u7528\u4e8e\u4e0d\u540c\u7c7b\u578b\u7684\u9a71\u52a8\u7a0b\u5e8f\u548c\u8bbe\u5907\u4e4b\u95f4\u7684\u901a\u4fe1\u3002\u5728 QEMU \u4e0a\u6211\u4eec\u53ef\u4ee5\u57fa\u4e8e VirtIO \u4f7f\u7528\u8bb8\u591a\u6a21\u62df\u51fa\u6765\u7684\u5916\u90e8\u8bbe\u5907\uff0c\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\u6211\u4eec\u4f7f\u7528 VirtIO \u6a21\u62df\u5b58\u50a8\u8bbe\u5907\uff0c\u5e76\u5728\u5176\u4e0a\u6784\u5efa\u6587\u4ef6\u7cfb\u7edf\u3002</p> <p>\u672c\u6b21\u5b9e\u9a8c\u4e2d\u6d89\u53ca VirtIO \u7684\u90e8\u5206\u5df2\u7ecf\u4e3a\u5927\u5bb6\u5b9e\u73b0\u597d\u4e86\uff0c\u540c\u5b66\u4eec\u53ea\u9700\u8981\u8c03\u7528\u76f8\u5173\u51fd\u6570\u5373\u53ef</p>"},{"location":"lab6/#mbr","title":"MBR","text":"<p>\u4e3b\u5f15\u5bfc\u8bb0\u5f55\uff08Master Boot Record\uff0cMBR\uff09\uff0c\u53c8\u53eb\u505a\u4e3b\u5f15\u5bfc\u6247\u533a\uff0c\u662f\u8ba1\u7b97\u673a\u5f00\u673a\u540e\u8bbf\u95ee\u786c\u76d8\u65f6\u6240\u5fc5\u987b\u8981\u8bfb\u53d6\u7684\u9996\u4e2a\u6247\u533a\uff0c\u5b83\u5728\u786c\u76d8\u4e0a\u4f4d\u4e8e\u7b2c\u4e00\u4e2a\u6247\u533a\u3002\u5728\u6df1\u5165\u8ba8\u8bba\u4e3b\u5f15\u5bfc\u6247\u533a\u5185\u90e8\u7ed3\u6784\u7684\u65f6\u5019\uff0c\u6709\u65f6\u4e5f\u5c06\u5176\u5f00\u5934\u7684 446 \u5b57\u8282\u5185\u5bb9\u7279\u6307\u4e3a\u201c\u4e3b\u5f15\u5bfc\u8bb0\u5f55\u201d\uff08MBR\uff09\uff0c\u5176\u540e\u662f 4 \u4e2a 16 \u5b57\u8282\u7684\u201c\u78c1\u76d8\u5206\u533a\u8868\u201d\uff08DPT\uff09\uff0c\u4ee5\u53ca 2 \u5b57\u8282\u7684\u7ed3\u675f\u6807\u5fd7\uff0855AA\uff09\u3002\u56e0\u6b64\uff0c\u5728\u4f7f\u7528\u201c\u4e3b\u5f15\u5bfc\u8bb0\u5f55\u201d\uff08MBR\uff09\u8fd9\u4e2a\u672f\u8bed\u7684\u65f6\u5019\uff0c\u9700\u8981\u6839\u636e\u5177\u4f53\u60c5\u51b5\u5224\u65ad\u5176\u5230\u5e95\u662f\u6307\u6574\u4e2a\u4e3b\u5f15\u5bfc\u6247\u533a\uff0c\u8fd8\u662f\u4e3b\u5f15\u5bfc\u6247\u533a\u7684\u524d 446 \u5b57\u8282\u3002</p>"},{"location":"lab6/#fat32","title":"FAT32","text":"<p>\u6587\u4ef6\u5206\u914d\u8868\uff08File Allocation Table\uff0cFAT\uff09\uff0c\u662f\u4e00\u79cd\u7531\u5fae\u8f6f\u53d1\u660e\u5e76\u62e5\u6709\u90e8\u5206\u4e13\u5229\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u4f9b MS-DOS \u4f7f\u7528\uff0c\u4e5f\u662f\u6240\u6709\u975e NT \u6838\u5fc3\u7684 Windows \u7cfb\u7edf\u4f7f\u7528\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u6700\u65e9\u7684 FAT \u6587\u4ef6\u7cfb\u7edf\u76f4\u63a5\u4f7f\u7528\u6247\u533a\u53f7\u6765\u4f5c\u4e3a\u5b58\u50a8\u7684\u7d22\u5f15\uff0c\u4f46\u662f\u8fd9\u6837\u505a\u7684\u7f3a\u70b9\u662f\u663e\u7136\u6613\u89c1\u7684\uff1a\u5f53\u78c1\u76d8\u7684\u5927\u5c0f\u4e0d\u65ad\u6269\u5927\uff0c\u5b58\u50a8\u6247\u533a\u53f7\u7684\u4f4d\u6570\u8d8a\u6765\u8d8a\u591a\uff0c\u8d8a\u53d1\u5360\u7528\u5b58\u50a8\u7a7a\u95f4\u3002\u4ee5 32 \u4f4d\u6247\u533a\u53f7\u7684\u6587\u4ef6\u7cfb\u7edf\u4e3a\u4f8b\uff0c\u5982\u679c\u78c1\u76d8\u7684\u6247\u533a\u5927\u5c0f\u4e3a 512B\uff0c\u90a3\u4e48\u6587\u4ef6\u7cfb\u7edf\u80fd\u652f\u6301\u7684\u6700\u5927\u78c1\u76d8\u5927\u5c0f\u4ec5\u4e3a 2TB\u3002</p> <p>\u6240\u4ee5\u5728 FAT32 \u4e2d\u5f15\u5165\u7684\u65b0\u7684\u5b58\u50a8\u7ba1\u7406\u5355\u4f4d\u201c\u7c07\u201d\uff0c\u4e00\u4e2a\u7c07\u5305\u542b\u4e00\u4e2a\u6216\u591a\u4e2a\u6247\u533a\uff0c\u6587\u4ef6\u7cfb\u7edf\u4e2d\u8bb0\u5f55\u7684\u7d22\u5f15\u4e0d\u518d\u4e3a\u6247\u533a\u53f7\uff0c\u800c\u662f\u7c07\u53f7\uff0c\u4ee5\u6b64\u6765\u652f\u6301\u66f4\u5927\u7684\u5b58\u50a8\u8bbe\u5907\u3002\u4f60\u53ef\u4ee5\u53c2\u8003\u8fd9\u4e9b\u8d44\u6599\u6765\u5b66\u4e60 FAT32 \u6587\u4ef6\u7cfb\u7edf\u7684\u6807\u51c6\u4e0e\u5b9e\u73b0\uff1a</p> <ul> <li>FAT32\u6587\u4ef6\u7cfb\u7edf\uff1f\u76d8\u5b83\uff01</li> <li>Microsoft FAT Specification</li> </ul> <p>\u4e0a\u8ff0\u4e24\u4e2a\u6750\u6599\u5bf9\u4e8e\u5b8c\u6210\u672c\u6b21\u5b9e\u9a8c\u975e\u5e38\u5173\u952e\uff0c\u5e0c\u671b\u540c\u5b66\u4eec\u4ed4\u7ec6\u9605\u8bfb</p> <ul> <li>FAT32\u6587\u4ef6\u7cfb\u7edf\uff1f\u76d8\u5b83\uff01 \u91cc\u63d0\u5230\u7684\u201c\u5757\u201d\u53ef\u4ee5\u5bf9\u6807\u672c\u6b21\u5b9e\u9a8c\u91cc\u7684\u201c\u6247\u533a\u201d\uff08sector\uff09<ul> <li><code>fat32_init</code> \u51fd\u6570\u91cc\u5404\u79cd\u53c2\u6570\u7684\u8ba1\u7b97\u65b9\u5f0f\u53ef\u4ee5\u53c2\u8003\u672c\u89c6\u9891\uff1b</li> </ul> </li> <li>Microsoft FAT Specification \u662f\u672c\u6b21\u5b9e\u9a8c\u53c2\u8003\u7684\u6807\u51c6\uff0c<code>fat32_bpb</code> <code>fat32_dir_entry</code> \u7b49\u7ed3\u6784\u4f53\u5404\u4e2a\u5b57\u6bb5\u7684\u542b\u4e49\uff0c\u53ef\u4ee5\u76f4\u63a5\u53c2\u8003\u672c\u6750\u6599\uff0c\u4f8b\u5982\uff1a<ul> <li>Page 7 \u8bb2\u89e3\u4e86 <code>fat32_bpb</code>\uff0c\u5728 <code>fat32_init</code> \u4e2d\u7528\u5f97\u4e0a\uff1b</li> <li>Page 23 \u5904\u8bb2\u89e3\u4e86 <code>fat32_dir_entry</code>\uff0c\u5728\u6587\u4ef6\u64cd\u4f5c\u51fd\u6570\u4e2d\u7528\u5f97\u4e0a\u3002</li> </ul> </li> </ul>"},{"location":"lab6/#_4","title":"\u5b9e\u9a8c\u6b65\u9aa4","text":"<p>\u672c\u6b21\u5b9e\u9a8c\u7684\u5185\u5bb9\u5206\u4e3a\u4e24\u4e2a\u90e8\u5206\uff1a</p> <ul> <li>Shell\uff1a\u5b9e\u73b0 VFS\uff0c\u7f16\u5199\u865a\u62df\u6587\u4ef6\u8bbe\u5907 stdin, stdout, stderr \u7684\u8bfb\u5199\u64cd\u4f5c\uff1b</li> <li>FAT32\uff1a\u5b9e\u73b0 FAT32 \u6587\u4ef6\u7cfb\u7edf\u7684\u8bfb\u5199\u64cd\u4f5c\u3002</li> </ul> <p>\u672c\u5b9e\u9a8c\u4e2d\u4e0d\u6d89\u53ca fork \u7684\u5b9e\u73b0\u548c\u7f3a\u9875\u5f02\u5e38\uff0c\u53ea\u9700\u8981\u5b8c\u6210 Lab4 \u5373\u53ef\u5f00\u59cb\u672c\u5b9e\u9a8c\uff08\u5f53\u7136\uff0c\u672c\u5b9e\u9a8c\u4e5f\u517c\u5bb9 Lab5\uff09</p>"},{"location":"lab6/#_5","title":"\u51c6\u5907\u5de5\u4f5c","text":"<p>\u4ee3\u7801\u4e0e\u8c03\u8bd5\u5efa\u8bae</p> <p>\u6846\u67b6\u4ee3\u7801\u4e2d\u53ef\u80fd\u4f1a\u4f7f\u7528\u5230 <code>Log</code> <code>Err</code> \u5b8f\u6216\u8005\u5176\u4ed6\u4f60\u53ef\u80fd\u672a\u5b9a\u4e49\u7684\u4e1c\u897f\uff0c\u5982\u679c\u7f16\u8bd1\u65f6\u51fa\u73b0\u62a5\u9519\u53ef\u4ee5\u81ea\u884c\u8865\u5145\uff0c\u5982\u679c\u6709\u4e0d\u6e05\u695a\u7684\u5947\u602a\u62a5\u9519\u53ef\u4ee5\u8be2\u95ee\u52a9\u6559\u3002</p> <p>\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u4ee5\u5f80\u5b9e\u9a8c\u7684\u90e8\u5206\u53ef\u80fd\u4f1a\u53d8\u5f97\u5b8c\u5168\u4e0d\u91cd\u8981\uff0c\u56e0\u4e3a\u672c\u6b21\u5b9e\u9a8c\u4e2d\u53ea\u9700\u8981\u8003\u8651\u6587\u4ef6\u7cfb\u7edf\u548c\u7cfb\u7edf\u8c03\u7528\uff0c\u6240\u4ee5\u4f60\u53ef\u4ee5\u9009\u62e9\u5c06\u539f\u6765\u8c03\u8bd5\u7528\u7684 Log \u5b8f\u7981\u7528\uff0c\u4ee5\u51cf\u5c11\u8f93\u51fa\uff0c\u6bd4\u5982\u5728\u6839\u76ee\u5f55\u4e0b\u7684 Makefile \u4e2d\uff1a</p> <pre><code>LOG     := 1\nCFLAG   := ... -DLOG=$(LOG)\n</code></pre> <p>\u7136\u540e\u5728 <code>include/printk.h</code> \u4e2d\uff1a</p> include/printk.h<pre><code>#if LOG\n#define Log(format, ...) \\\n    printk(\"\\33[1;35m[%s,%d,%s] \" format \"\\33[0m\\n\", \\\n        __FILE__, __LINE__, __func__, ## __VA_ARGS__)\n#else\n#define Log(format, ...);\n#endif\n</code></pre> <p>\u8fd9\u6837\u5728 <code>make run LOG=0</code> \u65f6\u5c31\u4e0d\u4f1a\u8f93\u51fa Log \u4fe1\u606f\u4e86\u3002</p> <p>\u6b64\u6b21\u5b9e\u9a8c\u57fa\u4e8e lab4/5 \u540c\u5b66\u6240\u5b9e\u73b0\u7684\u4ee3\u7801\u8fdb\u884c\u3002</p> <ul> <li>\u4ece\u4ed3\u5e93\u540c\u6b65\u4ee5\u4e0b\u6587\u4ef6\uff1a     <pre><code>src/lab6\n  \u251c\u2500\u2500 disk.img.zip  // FAT32 \u78c1\u76d8\u955c\u50cf\uff0c\u9700\u89e3\u538b\n  \u251c\u2500\u2500 fs\n  \u2502   \u251c\u2500\u2500 Makefile\n  \u2502   \u251c\u2500\u2500 fat32.c   // FAT32 \u6587\u4ef6\u7cfb\u7edf\u5b9e\u73b0\n  \u2502   \u251c\u2500\u2500 fs.c      // \u4f9b\u7cfb\u7edf\u5185\u6838\u4f7f\u7528\u7684\u6587\u4ef6\u7cfb\u7edf\u76f8\u5173\u51fd\u6570\u5b9e\u73b0\n  \u2502   \u251c\u2500\u2500 mbr.c     // MBR \u521d\u59cb\u5316\uff08\u65e0\u9700\u4fee\u6539\uff09\n  \u2502   \u251c\u2500\u2500 vfs.c     // VFS \u5b9e\u73b0\n  \u2502   \u2514\u2500\u2500 virtio.c  // VirtIO \u9a71\u52a8\uff08\u65e0\u9700\u4fee\u6539\uff09\n  \u251c\u2500\u2500 include\n  \u2502   \u251c\u2500\u2500 fat32.h   // FAT32 \u76f8\u5173\u6570\u636e\u7ed3\u6784\u4e0e\u51fd\u6570\u58f0\u660e\n  \u2502   \u251c\u2500\u2500 fs.h      // \u4f9b\u7cfb\u7edf\u5185\u6838\u4f7f\u7528\u7684\u6587\u4ef6\u7cfb\u7edf\u76f8\u5173\u6570\u636e\u7ed3\u6784\u53ca\u51fd\u6570\u58f0\u660e\n  \u2502   \u251c\u2500\u2500 mbr.h     // MBR \u76f8\u5173\u6570\u636e\u7ed3\u6784\u4e0e\u51fd\u6570\u58f0\u660e\uff08\u65e0\u9700\u5173\u6ce8\uff09\n  \u2502   \u251c\u2500\u2500 vfs.h     // VFS \u64cd\u4f5c\u51fd\u6570\u58f0\u660e\n  \u2502   \u2514\u2500\u2500 virtio.h  // VirtIO \u9a71\u52a8\u76f8\u5173\u6570\u636e\u7ed3\u6784\u4e0e\u51fd\u6570\u58f0\u660e\uff08\u65e0\u9700\u5173\u6ce8\uff09\n  \u2514\u2500\u2500 user              // \u7528\u6237\u6001\u7a0b\u5e8f\u90e8\u5206\u4e0d\u9700\u540c\u5b66\u4eec\u4fee\u6539\uff0c\u6240\u4ee5\u8fd9\u91cc\u7ed9\u51fa\u5b8c\u6574\u7684\u4ee3\u7801\n      \u251c\u2500\u2500 Makefile      // \u672a\u4f5c\u4fee\u6539\n      \u251c\u2500\u2500 link.lds      // \u672a\u4f5c\u4fee\u6539\n      \u251c\u2500\u2500 main.c    // nish \u7528\u6237\u6001\u7a0b\u5e8f\uff08\u9700\u8981\u9605\u8bfb\uff09\n      \u251c\u2500\u2500 printf.c      // \u672a\u4f5c\u4fee\u6539\n      \u251c\u2500\u2500 start.S       // \u672a\u4f5c\u4fee\u6539\n      \u251c\u2500\u2500 stddef.h      // \u672a\u4f5c\u4fee\u6539\n      \u251c\u2500\u2500 stdint.h      // \u540c\u6b65\u4e86\u5185\u6838\u7684 stdint.h\n      \u251c\u2500\u2500 stdio.h       // \u672a\u4f5c\u4fee\u6539\n      \u251c\u2500\u2500 string.c      // \u65b0\u6587\u4ef6\uff0c\u6dfb\u52a0\u4e86 strlen\n      \u251c\u2500\u2500 string.h      // \u65b0\u6587\u4ef6\uff0c\u6dfb\u52a0\u4e86 strlen\n      \u251c\u2500\u2500 syscall.h     // \u66f4\u65b0\u4e86\u7cfb\u7edf\u8c03\u7528\u53f7\n      \u251c\u2500\u2500 uapp.S        // \u672a\u4f5c\u4fee\u6539\n      \u251c\u2500\u2500 unistd.c  // \u7cfb\u7edf\u8c03\u7528\u5b9e\u73b0\uff08\u9700\u8981\u9605\u8bfb\uff09\n      \u2514\u2500\u2500 unistd.h\n</code></pre></li> <li>\u540c\u65f6\u9700\u8981\u4fee\u6539 proc.h/c\uff0c\u5728\u521d\u59cb\u5316\u65f6\u53ea\u521b\u5efa\u4e00\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b</li> <li>\u56e0\u4e3a\u52a0\u4e86\u4e00\u4e2a\u6839\u76ee\u5f55\u4e0b\u7684 fs \u6587\u4ef6\u5939\uff0c\u6240\u4ee5\u9700\u8981\u5728 <code>arch/riscv/Makefile</code> \u91cc\u9762\u6dfb\u52a0\u76f8\u5173\u7f16\u8bd1\u4ea7\u7269\u6765\u8fdb\u884c\u94fe\u63a5\uff1a     arch/riscv/Makefile<pre><code>${LD} -T kernel/vmlinux.lds kernel/*.o ../../init/*.o ../../lib/*.o ../../fs/*.o ../../user/uapp.o -o ../../vmlinux \n</code></pre></li> </ul>"},{"location":"lab6/#shell","title":"Shell: \u4e0e\u5185\u6838\u8fdb\u884c\u4ea4\u4e92","text":"<p>\u6211\u4eec\u4e3a\u5927\u5bb6\u63d0\u4f9b\u4e86\u7528\u6237\u6001\u7a0b\u5e8f \"nish\" (Not Implemented SHell) \u6765\u4e0e\u6211\u4eec\u5728\u5b9e\u9a8c\u4e2d\u5b8c\u6210\u7684 kernel \u8fdb\u884c\u4ea4\u4e92\u3002\u5b83\u63d0\u4f9b\u4e86\u7b80\u5355\u7684\u7528\u6237\u4ea4\u4e92\u548c\u6587\u4ef6\u8bfb\u5199\u529f\u80fd\uff0c\u6709\u5982\u4e0b\u7684\u547d\u4ee4\uff1a</p> <pre><code>echo [string]   # \u5c06 string \u8f93\u51fa\u5230 stdout\ncat [path]      # \u5c06\u8def\u5f84\u4e3a path \u7684\u6587\u4ef6\u7684\u5185\u5bb9\u8f93\u51fa\u5230 stdout\nedit [path] [offset] [string] # \u5c06\u8def\u5f84\u4e3a path \u7684\u6587\u4ef6\uff0c\u504f\u79fb\u91cf\u4e3a offset \u7684\u90e8\u5206\u5f00\u59cb\uff0c\u5199\u4e3a string\n</code></pre> <p>\u6211\u4eec\u5728\u542f\u52a8\u4e00\u4e2a\u7528\u6237\u6001\u7a0b\u5e8f\uff08\u5305\u62ec nish\uff09\u65f6\u9ed8\u8ba4\u6253\u5f00\u4e86\u4e09\u4e2a\u6587\u4ef6\uff0c<code>stdin</code>\uff0c<code>stdout</code> \u548c <code>stderr</code>\uff0c\u4ed6\u4eec\u5bf9\u5e94\u7684 file descriptor \u5206\u522b\u4e3a <code>0</code>\uff0c<code>1</code>\uff0c<code>2</code>\u3002\u5728 nish \u542f\u52a8\u65f6\uff0c\u4f1a\u9996\u5148\u5411 <code>stdout</code> \u548c <code>stderr</code> \u5206\u522b\u5199\u5165\u4e00\u6bb5\u5185\u5bb9\u4f5c\u4e3a\u6d4b\u8bd5\uff1a</p> user/main.c<pre><code>write(1, \"hello, stdout!\\n\", 15);\nwrite(2, \"hello, stderr!\\n\", 15);\n</code></pre> <p>\u800c\u5728\u8fd9\u4e4b\u524d\uff0c\u6211\u4eec\u4e5f\u66fe\u5904\u7406\u8fc7 write \u7cfb\u7edf\u8c03\u7528\uff0c\u4e0d\u8fc7\u5f53\u65f6\u662f\u6839\u636e stdin \u7684 fd \u6765\u7279\u5224\u7684\u3002\u63a5\u4e0b\u6765\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\u6211\u4eec\u4f1a\u5c06\u8fd9\u4e00\u64cd\u4f5c\u5305\u88c5\u4e3a\u6587\u4ef6\u7cfb\u7edf\u7684\u64cd\u4f5c\u3002</p>"},{"location":"lab6/#_6","title":"\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61","text":"<p>\u6211\u4eec\u5728 <code>include/fs.h</code> \u4e2d\u5b9a\u4e49\u4e86\u6587\u4ef6\u7cfb\u7edf\u7684\u6570\u636e\u7ed3\u6784\uff1a</p> include/fs.h<pre><code>struct file {   // Opened file in a thread.\n    uint32_t opened;    // \u6587\u4ef6\u662f\u5426\u6253\u5f00\n    uint32_t perms;     // \u6587\u4ef6\u7684\u8bfb\u5199\u6743\u9650\n    int64_t cfo;        // \u5f53\u524d\u6587\u4ef6\u6307\u9488\u504f\u79fb\u91cf\n    uint32_t fs_type;   // \u6587\u4ef6\u7cfb\u7edf\u7c7b\u578b\n\n    union {\n        struct fat32_file fat32_file;   // \u540e\u7eed FAT32 \u6587\u4ef6\u7cfb\u7edf\u7684\u6587\u4ef6\u9700\u8981\u7684\u989d\u5916\u4fe1\u606f\n    };\n\n    int64_t (*lseek) (struct file *file, int64_t offset, uint64_t whence);  // \u6587\u4ef6\u6307\u9488\u64cd\u4f5c\n    int64_t (*write) (struct file *file, const void *buf, uint64_t len);    // \u5199\u6587\u4ef6\n    int64_t (*read)  (struct file *file, void *buf, uint64_t len);          // \u8bfb\u6587\u4ef6\n\n    char path[MAX_PATH_LENGTH]; // \u6587\u4ef6\u8def\u5f84\n};\n\nstruct files_struct {\n    struct file fd_array[MAX_FILE_NUMBER];\n};\n</code></pre> <p>\u53ef\u4ee5\u770b\u51fa\u6211\u4eec\u4e3a\u6bcf\u4e2a\u6587\u4ef6\u90fd\u4fdd\u5b58\u4e86\u4e09\u4e2a\u51fd\u6570\u6307\u9488\uff0c\u8fd9\u6837\u9488\u5bf9\u4e0d\u540c\u6587\u4ef6\u7684\u540c\u4e00\u64cd\u4f5c\u5c31\u53ef\u4ee5\u8c03\u7528\u5230\u4e0d\u540c\u51fd\u6570\u4e86\u3002\u540c\u65f6\u4e3a\u4e86\u65b9\u4fbf\u5b9e\u73b0\uff0c\u6211\u4eec\u76f4\u63a5\u901a\u8fc7\u6570\u7ec4\u6765\u4fdd\u5b58 file \u7ed3\u6784\u4f53\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f1a\u521b\u5efa <code>MAX_FILE_NUMBER=16</code> \u4e2a\u53ef\u7528\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u3002</p> <p>\u63a5\u4e0b\u6765\u9700\u8981\u540c\u5b66\u4eec\u4fee\u6539 proc.h\uff0c\u4e3a\u8fdb\u7a0b task_struct \u7ed3\u6784\u4f53\u6dfb\u52a0\u4e00\u4e2a\u6307\u5411\u6587\u4ef6\u8868\u7684\u6307\u9488\uff1a</p> arch/riscv/include/proc.h<pre><code>struct task_struct {\n    ...\n    struct files_struct *files;\n};\n</code></pre>"},{"location":"lab6/#stdouterrin","title":"stdout/err/in \u521d\u59cb\u5316","text":"<p>\u5728 <code>fs/fs.c</code> \u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u51fd\u6570 <code>file_init</code>\uff1a</p> fs/fs.c<pre><code>struct files_struct *file_init() {\n    // todo: alloc pages for files_struct, and initialize stdin, stdout, stderr\n    struct files_struct *ret = NULL;\n    return ret;\n}\n</code></pre> <p>\u8fd9\u4e2a\u51fd\u6570\u9700\u8981\u5927\u5bb6\u5728 proc.c \u4e2d\u7684 <code>task_init</code> \u51fd\u6570\u4e2d\u4e3a\u6bcf\u4e2a\u8fdb\u7a0b\u8c03\u7528\uff0c\u521b\u5efa\u6587\u4ef6\u8868\u5e76\u4fdd\u5b58\u5728 task struct \u4e2d\u3002</p> <p>\u5728\u8fd9\u4e2a\u51fd\u6570\u4e2d\uff0c\u4f60\u9700\u8981\uff1a</p> <ul> <li>\u6839\u636e <code>files_struct</code> \u7684\u5927\u5c0f\u5206\u914d\u9875\u7a7a\u95f4</li> <li>\u4e3a stdin\u3001stdout\u3001stderr \u8d4b\u503c\uff0c\u6bd4\u5982 stdin \u4f60\u53ef\u4ee5\uff1a     <pre><code>ret-&gt;fd_array[0].opened = 1;\nret-&gt;fd_array[0].perms = FILE_READABLE;\nret-&gt;fd_array[0].cfo = 0;\nret-&gt;fd_array[0].lseek = NULL;\nret-&gt;fd_array[0].write = NULL;\nret-&gt;fd_array[0].read = ...;\n</code></pre><ul> <li>\u8fd9\u91cc\u7684 read / write \u51fd\u6570\u53ef\u4ee5\u7559\u5230\u7b49\u4e0b\u6765\u5b9e\u73b0</li> </ul> </li> <li>\u4fdd\u8bc1\u5176\u4ed6\u672a\u4f7f\u7528\u7684\u6587\u4ef6\u7684 <code>opened</code> \u5b57\u6bb5\u4e3a 0</li> </ul>"},{"location":"lab6/#stdouterr","title":"\u5904\u7406 stdout/err \u7684\u5199\u5165","text":"<p>\u6b63\u5982 4.2 \u5f00\u5934\u6240\u8bf4\uff0c\u7528\u6237\u6001\u7a0b\u5e8f\u5728\u5f00\u59cb\u7684\u65f6\u5019\u4f1a\u901a\u8fc7 <code>write</code> \u51fd\u6570\u6765\u5411\u5185\u6838\u53d1\u8d77 syscall \u8fdb\u884c\u6d4b\u8bd5\u3002\u5728\u6355\u83b7\u5230 write \u7684 syscall \u4e4b\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u627e\u5bf9\u5e94\u7684 fd\uff0c\u5e76\u901a\u8fc7\u5bf9\u5e94\u7684 write \u51fd\u6570\u8c03\u7528\u6765\u8fdb\u884c\u8f93\u51fa\u4e86\u3002\u4e00\u4e2a\u53c2\u8003\u5b9e\u73b0\u5982\u4e0b\uff1a</p> <pre><code>int64_t sys_write(uint64_t fd, const char *buf, uint64_t len) {\n    int64_t ret;\n    struct file *file = &amp;(current-&gt;files-&gt;fd_array[fd]);\n    if (file-&gt;opened == 0) {\n        printk(\"file not opened\\n\");\n        return ERROR_FILE_NOT_OPEN;\n    } else {\n        // check perms and call write function of file\n    }\n    return ret;\n}\n\nvoid do_syscall(struct pt_regs* regs) {\n    switch (regs-&gt;a7) {\n        case SYS_WRITE:\n            regs-&gt;a0 = sys_write(regs-&gt;a0, (const char *)regs-&gt;a1, regs-&gt;a2);\n            break;\n        case SYS_GETPID:\n            regs-&gt;a0 = current-&gt;pid;\n            break;\n        case SYS_CLONE:\n            regs-&gt;a0 = do_fork(regs);\n            break;\n        default:\n            Err(\"not support syscall id = %d\", regs-&gt;a7);\n    }\n    regs-&gt;sepc += 4;\n}\n</code></pre> <p>\u5bf9\u4e8e stdout \u548c stderr \u7684\u8f93\u51fa\uff0c\u6211\u4eec\u76f4\u63a5\u901a\u8fc7 <code>printk</code> \u8fdb\u884c\u4e32\u53e3\u8f93\u51fa\u5373\u53ef\uff1a</p> fs/vfs.c<pre><code>int64_t stdout_write(struct file *file, const void *buf, uint64_t len) {\n    char to_print[len + 1];\n    for (int i = 0; i &lt; len; i++) {\n        to_print[i] = ((const char *)buf)[i];\n    }\n    to_print[len] = 0;\n    return printk(to_print);\n}\n\nint64_t stderr_write(struct file *file, const void *buf, uint64_t len) {\n    // todo\n}\n</code></pre> <p>\u5b9e\u73b0\u597d\u540e\uff0c\u4f60\u5e94\u8be5\u5df2\u7ecf\u80fd\u591f\u6253\u5370\u51fa\u8f93\u51fa\u4e86\uff1a</p> <pre><code>2024 ZJU Operating System\nhello, stdout!\nhello, stderr!\nSHELL &gt;\n</code></pre>"},{"location":"lab6/#stdin","title":"\u5904\u7406 stdin \u7684\u8bfb\u53d6","text":"<p>\u6b64\u65f6 nish \u5df2\u7ecf\u6253\u5370\u51fa\u547d\u4ee4\u884c\u7b49\u5f85\u8f93\u5165\u547d\u4ee4\u4ee5\u8fdb\u884c\u4ea4\u4e92\u4e86\uff0c\u4f46\u662f\u8fd8\u9700\u8981\u8bfb\u5165\u4ece\u7ec8\u7aef\u8f93\u5165\u7684\u547d\u4ee4\u624d\u80fd\u591f\u4e0e\u4eba\u8fdb\u884c\u4ea4\u4e92\uff0c\u6240\u4ee5\u6211\u4eec\u8981\u5b9e\u73b0 <code>stdin</code> \u4ee5\u83b7\u53d6\u952e\u76d8\u952e\u5165\u7684\u5185\u5bb9\u3002</p> <p>\u5bf9\u4e8e\u8f93\u5165\u7684\u8bfb\u53d6\u5c31\u662f\u5bf9\u4e8e fd=0 \u7684 stdin \u6587\u4ef6\u8fdb\u884c read \u64cd\u4f5c\uff0c\u6240\u4ee5\u9700\u8981\u6211\u4eec\u5b9e\u73b0 vfs.c \u4e2d\u7684 stdin_read \u51fd\u6570\u3002\u800c\u5bf9\u4e8e\u7ec8\u7aef\u7684\u8f93\u5165\uff0c\u6211\u4eec\u9700\u8981\u901a\u8fc7 sbi \u6765\u5b8c\u6210\uff0c\u9700\u8981\u5927\u5bb6\u5728 <code>arch/riscv/include/sbi.h</code> \u4e2d\u6dfb\u52a0\u51fd\u6570\uff1a</p> arch/riscv/include/sbi.h<pre><code>struct sbiret sbi_debug_console_read(uint64_t num_bytes, uint64_t base_addr_lo, uint64_t base_addr_hi);\n</code></pre> <p>\u5e76\u5728 sbi.c \u4e2d\u8fdb\u884c\u5b9e\u73b0\uff08eid \u548c <code>console_write_byte</code> \u4e00\u6837\u4e3a <code>0x4442434e</code>\uff0cfid \u4e3a 1\uff09\u3002\u5176\u4e2d\u53c2\u6570 <code>num_bytes</code> \u4e3a\u8bfb\u53d6\u7684\u5b57\u8282\u6570\uff0c<code>base_addr_lo</code> \u548c <code>base_addr_hi</code> \u4e3a\u5199\u5165\u7684\u76ee\u7684\u5730\u5740\uff08<code>base_addr_hi</code> \u5728 64 \u4f4d\u67b6\u6784\u4e2d\u4e0d\u4f1a\u7528\u5230\uff09\u3002</p> <p>\u63a5\u4e0b\u6765\u5728 vfs.c \u4e2d\u6211\u4eec\u4e3a\u5927\u5bb6\u5b9a\u4e49\u4e86\u51fd\u6570 <code>uart_getchar()</code>\uff0c\u56e0\u4e3a <code>sbi_debug_console_read</code> \u662f\u975e\u963b\u585e\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u51fd\u6570\u6765\u4e0d\u65ad\u8fdb\u884c\u8bfb\u53d6\uff0c\u76f4\u5230\u8bfb\u5230\u4e86\u6709\u6548\u5b57\u7b26\uff0c\u7136\u540e\u5728 <code>stdin_read</code> \u4e2d\u53ea\u9700\u8981\u8fd9\u6837\u8bfb\u53d6 <code>len</code> \u4e2a\u5b57\u7b26\u5c31\u597d\u4e86\u3002</p> <p>\u5173\u4e8e read \u963b\u585e\u7684\u8bf4\u660e</p> <p>\u540c\u5b66\u4eec\u53ef\u4ee5\u53d1\u73b0\u6211\u4eec\u8fd9\u91cc\u5b9e\u73b0\u7684 <code>read</code> \u5176\u5b9e\u662f\u5b8c\u5168\u963b\u585e\u7684\uff0c\u5373\u8bfb\u53d6\u5230\u4e86 <code>len</code> \u4e2a\u5b57\u7b26\u624d\u4f1a\u8fd4\u56de\uff0c\u5b9e\u9645\u4e0a\u8fd9\u53ea\u662f\u7b80\u5316\u7684\u64cd\u4f5c\u3002</p> <p>\u5b9e\u9645\u60c5\u51b5\u4e0b <code>read</code> \u53ea\u4f1a\u5728\u6ca1\u6709\u4efb\u4f55\u8f93\u5165\u7684\u60c5\u51b5\u4e0b\u963b\u585e\uff0c\u4e00\u65e6\u53ef\u4ee5\u8bfb\u5230\u6570\u636e\uff0c\u5219\u4e0d\u8bba\u662f\u5426\u8fbe\u5230 <code>len</code> \u90fd\u4f1a\u7acb\u5373\u8fd4\u56de\uff0c\u4f46\u672c\u6b21\u5b9e\u9a8c\u4e2d\u4e0d\u8003\u8651\u8fd9\u79cd\u60c5\u51b5\u5373\u53ef\u3002</p> <p>\u5b8c\u6210\u4e86 <code>stdin_read</code> \u540e\uff0c\u8fd8\u9700\u8981\u6355\u83b7 63 \u53f7\u7cfb\u7edf\u8c03\u7528 read\uff0c\u6765\u548c write \u4e00\u6837\u7c7b\u4f3c\u5904\u7406\u5373\u53ef\u3002</p> <p>\u5168\u90e8\u5b8c\u6210\u540e\uff0c\u4f60\u5e94\u8be5\u5c31\u53ef\u4ee5\u5728 nish \u4e2d\u4f7f\u7528 <code>echo</code> \u547d\u4ee4\u4e86\uff1a</p> <pre><code>SHELL &gt; echo \"test\"\ntest\n</code></pre> \u4e3a\u4ec0\u4e48\u6211\u89c9\u5f97\u5199\u7684\u5b8c\u5168\u6ca1\u95ee\u9898\u4f46\u662f\u6ca1\u6cd5\u8bfb\u5165 <p>\u6709\u4e9b\u540c\u5b66\u53ef\u80fd\u5df2\u7ecf\u987a\u5229\u8fdb\u5165\u4e86 <code>sbi_debug_console_read</code> \u548c <code>sbi_ecall</code> \u4e2d\uff0c\u4f46\u662f\u4f20\u7ed9 <code>sbi_ecall</code> \u7684\u53c2\u6570\u6b63\u786e\u4e5f\u4e0d\u80fd\u83b7\u53d6\u8f93\u5165\u3002\u8fd9\u65f6\u5019\u4f60\u9700\u8981\u68c0\u67e5\u4e00\u4e0b vmlinux.asm \u4e2d\u751f\u6210\u7684 <code>sbi_ecall</code> \u7684\u6c47\u7f16\uff0c\u8fd9\u53ef\u80fd\u662f\u4f60\u7684\u5b9e\u73b0\u957f\u4e45\u4ee5\u6765\u5c31\u6709\u95ee\u9898\u4f46\u4e00\u76f4\u6ca1\u89e6\u53d1\u3002\u6bd4\u5982\u4f60\u53ef\u80fd\u4f1a\u5728 ecall \u524d\u770b\u5230\uff1a</p> <pre><code>00078893            mv  a7,a5\n00070813            mv  a6,a4\n00068513            mv  a0,a3\n00060593            mv  a1,a2\n00058613            mv  a2,a1\n00050693            mv  a3,a0\n00080713            mv  a4,a6\n00088793            mv  a5,a7\n00000073            ecall\n</code></pre> <p>\u4f60\u4f1a\u53d1\u73b0\u5728\u4f60\u7684\u5185\u8054\u6c47\u7f16\u751f\u6210\u51fa\u4e86\u975e\u9884\u671f\u7684\u6307\u4ee4\u5e8f\u5217\uff08\u6bd4\u5982 a5-&gt;a7-&gt;a5\uff0c\u8fd9\u6837 a5 \u7684\u503c\u5c31\u88ab\u8986\u76d6\u4e86\uff09\uff0c\u8fd9\u53ef\u80fd\u662f\u4f60\u5728\u5185\u8054\u6c47\u7f16\u7684\u6700\u540e\u4e00\u4e2a\u7834\u574f\u63cf\u8ff0\u90e8\u5206\u6ca1\u6709\u8bf4\u660e a0-a7 \u662f\u4f1a\u88ab\u7834\u574f\u7684\uff08\u5373\u8ba9\u7f16\u8bd1\u5668\u4e0d\u8981\u4f7f\u7528 a0-a7 \u4f5c\u4e3a\u4e34\u65f6\u53d8\u91cf\uff09\uff0c\u4f60\u9700\u8981\u518d\u53c2\u8003\u76f8\u5173\u6587\u6863\u8fdb\u884c\u4fee\u6539\u3002</p>"},{"location":"lab6/#fat32_1","title":"FAT32\uff1a\u6301\u4e45\u5b58\u50a8","text":"<p>\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\u6211\u4eec\u4ec5\u9700\u5b9e\u73b0 FAT32 \u6587\u4ef6\u7cfb\u7edf\u4e2d\u5f88\u5c0f\u4e00\u90e8\u5206\u529f\u80fd\uff0c\u6211\u4eec\u4e3a\u5b9e\u9a8c\u4e2d\u7684\u6d4b\u8bd5\u505a\u5982\u4e0b\u9650\u5236\uff1a</p> <ul> <li>\u6587\u4ef6\u540d\u957f\u5ea6\u5c0f\u4e8e\u7b49\u4e8e 8 \u4e2a\u5b57\u7b26\uff0c\u5e76\u4e14\u4e0d\u5305\u542b\u540e\u7f00\u540d\u548c\u5b57\u7b26 <code>.</code> .</li> <li>\u4e0d\u5305\u542b\u76ee\u5f55\u7684\u5b9e\u73b0\uff0c\u6240\u6709\u6587\u4ef6\u90fd\u4fdd\u5b58\u5728\u78c1\u76d8\u6839\u76ee\u5f55 <code>/fat32/</code> \u4e0b\u3002</li> <li>\u4e0d\u6d89\u53ca\u78c1\u76d8\u4e0a\u6587\u4ef6\u7684\u521b\u5efa\u548c\u5220\u9664\u3002</li> <li>\u4e0d\u6d89\u53ca\u6587\u4ef6\u5927\u5c0f\u7684\u4fee\u6539\u3002</li> </ul>"},{"location":"lab6/#_7","title":"\u51c6\u5907\u5de5\u4f5c","text":""},{"location":"lab6/#virtio-qemu","title":"\u5229\u7528 VirtIO \u4e3a QEMU \u6dfb\u52a0\u865a\u62df\u5b58\u50a8","text":"<p>\u6211\u4eec\u4e3a\u5927\u5bb6\u51c6\u5907\u4e86\u4e00\u4e2a FAT32 \u7684\u78c1\u76d8\u6620\u50cf\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u4e00\u4e2a MBR \u5206\u533a\u8868\u4ee5\u53ca\u4e00\u4e2a\u5b58\u50a8\u6709\u4e00\u4e9b\u6587\u4ef6\u7684 FAT32 \u5206\u533a\uff0c\u9700\u8981\u5927\u5bb6\u89e3\u538b <code>src/lab6/disk.img.zip</code> \u5f97\u5230 <code>disk.img</code> \u5e76\u653e\u5728\u6839\u76ee\u5f55\u4e0b\u3002</p> <p>\u63a5\u4e0b\u6765\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u7684\u547d\u4ee4\u6765\u542f\u52a8 QEMU\uff0c\u8fd9\u4f1a\u5c06\u78c1\u76d8\u8fde\u63a5\u5230 QEMU \u7684\u4e00\u4e2a VirtIO \u63a5\u53e3\u4e0a\uff0c\u6784\u6210\u4e00\u4e2a <code>virtio-blk-device</code>\uff1a</p> <pre><code>run: all\n    @echo Launch qemu...\n    @qemu-system-riscv64 -nographic -machine virt -kernel vmlinux -bios default \\\n        -global virtio-mmio.force-legacy=false \\\n        -drive file=disk.img,if=none,format=raw,id=hd0 \\\n        -device virtio-blk-device,drive=hd0\n\ndebug: all\n    @echo Launch qemu for debug...\n    @qemu-system-riscv64 -nographic -machine virt -kernel vmlinux -bios default \\\n        -global virtio-mmio.force-legacy=false \\\n        -drive file=disk.img,if=none,format=raw,id=hd0 \\\n        -device virtio-blk-device,drive=hd0 -S -s\n</code></pre> <p>VirtIO \u6240\u9700\u7684\u9a71\u52a8\u6211\u4eec\u5df2\u7ecf\u4e3a\u5927\u5bb6\u7f16\u5199\u5b8c\u6210\u4e86\uff0c\u5728 <code>fs/virtio.c</code> \u4e2d\u7ed9\u51fa\uff0c\u4e3a\u4e86\u6b63\u5e38\u4f7f\u7528\u8fd9\u90e8\u5206\u5916\u8bbe\uff0c\u8fd8\u9700\u8981\u5728 <code>setup_vm_final</code> \u4e2d\u6dfb\u52a0\u5bf9 VritIO \u5916\u8bbe\u7684\u6620\u5c04\uff1a</p> arch/riscv/kernel/vm.c<pre><code>create_mapping(swapper_pg_dir, io_to_virt(VIRTIO_START), VIRTIO_START, VIRTIO_SIZE * VIRTIO_COUNT, PTE_W | PTE_R | PTE_V);\n</code></pre>"},{"location":"lab6/#virtio-mbr","title":"\u521d\u59cb\u5316 VirtIO \u4e0e MBR","text":"<p>\u9664\u4e86 VirtIO\uff0c\u6211\u4eec\u8fd8\u4e3a\u5927\u5bb6\u5b9e\u73b0\u4e86\u8bfb\u53d6 MBR \u8fd9\u4e00\u78c1\u76d8\u521d\u59cb\u5316\u8fc7\u7a0b\u3002\u8be5\u8fc7\u7a0b\u4f1a\u641c\u7d22\u78c1\u76d8\u4e2d\u5b58\u5728\u7684\u5206\u533a\uff0c\u7136\u540e\u5bf9\u5206\u533a\u8fdb\u884c\u521d\u6b65\u7684\u521d\u59cb\u5316\u3002</p> <p>\u8fd9\u4e24\u90e8\u5206\u5206\u522b\u9700\u8981\u4f7f\u7528 <code>virtio_dev_init()</code> \u548c <code>mbr_init()</code> \u8fdb\u884c\u521d\u59cb\u5316\uff0c\u9700\u8981\u5728 <code>head.S</code> \u4e2d <code>task_init</code> \u7ed3\u675f\u540e\u8c03\u7528\u3002</p>"},{"location":"lab6/#fat32_2","title":"\u521d\u59cb\u5316 FAT32 \u5206\u533a","text":"<p>\u5728 FAT32 \u5206\u533a\u7684\u7b2c\u4e00\u4e2a\u6247\u533a\u4e2d\u5b58\u50a8\u4e86\u5173\u4e8e\u8fd9\u4e2a\u5206\u533a\u7684\u5143\u6570\u636e\uff0c\u9996\u5148\u9700\u8981\u8bfb\u53d6\u5e76\u89e3\u6790\u8fd9\u4e9b\u5143\u6570\u636e\u3002\u6211\u4eec\u63d0\u4f9b\u4e86\u4e24\u4e2a\u6570\u636e\u7ed3\u6784\u7684\u5b9a\u4e49\uff0c<code>fat32_bpb</code> \u4e3a FAT32 BIOS Parameter Block \u7684\u7b80\u5199\u3002\u8fd9\u662f\u4e00\u4e2a\u7269\u7406\u6247\u533a\uff0c\u5176\u4e2d\u5bf9\u5e94\u7684\u662f\u8fd9\u4e2a\u5206\u533a\u7684\u5143\u6570\u636e\u3002\u9996\u5148\u9700\u8981\u5c06\u8be5\u6247\u533a\u7684\u5185\u5bb9\u8bfb\u5230\u4e00\u4e2a <code>fat32_bpb</code> \u6570\u636e\u7ed3\u6784\u4e2d\u8fdb\u884c\u89e3\u6790\u3002</p> <p><code>fat32_volume</code> \u662f\u7528\u6765\u5b58\u50a8\u6211\u4eec\u540e\u7eed\u4ee3\u7801\u4e2d\u9700\u8981\u7528\u5230\u7684\u5143\u6570\u636e\u7684\uff0c\u9700\u8981\u6839\u636e <code>fat32_bpb</code> \u4e2d\u7684\u6570\u636e\u6765\u8fdb\u884c\u8ba1\u7b97\u5e76\u521d\u59cb\u5316\u3002</p> <p>\u4e3a\u4e86\u7b80\u5355\u8d77\u89c1\uff0c\u672c\u6b21\u5b9e\u9a8c\u4e2d\u6bcf\u4e2a\u7c07\u90fd\u53ea\u5305\u542b 1 \u4e2a\u6247\u533a\u3002\u6240\u4ee5\u4f60\u7684\u4ee3\u7801\u53ef\u80fd\u4f1a\u4ee5\u5404\u79cd\u7075\u8f66\u7684\u65b9\u5f0f\u8dd1\u8d77\u6765\uff0c\u4f46\u662f\u4f60\u4ecd\u9700\u8981\u5bf9\u7c07\u548c\u6247\u533a\u6709\u6240\u533a\u5206\uff0c\u5e76\u5728\u62a5\u544a\u91cc\u6709\u6240\u4f53\u73b0\u3002</p> fs/fat32.c<pre><code>void fat32_init(uint64_t lba, uint64_t size) {\n    virtio_blk_read_sector(lba, (void*)&amp;fat32_header);  // \u4ece\u7b2c lba \u4e2a\u6247\u533a\u8bfb\u53d6 FAT32 BPB\n    fat32_volume.first_fat_sec = /* to calculate */;    // \u8bb0\u5f55\u7b2c\u4e00\u4e2a FAT \u8868\u6240\u5728\u7684\u6247\u533a\u53f7\n    fat32_volume.sec_per_cluster = /* to calculate */;  // \u6bcf\u4e2a\u7c07\u7684\u6247\u533a\u6570\n    fat32_volume.first_data_sec = /* to calculate */;   // \u8bb0\u5f55\u7b2c\u4e00\u4e2a\u6570\u636e\u7c07\u6240\u5728\u7684\u6247\u533a\u53f7\n    fat32_volume.fat_sz = /* to calculate */;           // \u8bb0\u5f55\u6bcf\u4e2a FAT \u8868\u5360\u7684\u6247\u533a\u6570\uff08\u5e76\u672a\u7528\u5230\uff09\n}\n</code></pre> <p>\u6307\u5bfc\u4e0e\u8c03\u8bd5\u5efa\u8bae</p> <p>\u4e3a\u4e86\u5b8c\u6210\u8fd9\u4e00\u90e8\u5206\uff0c\u4f60\u9700\u8981\u4e86\u89e3 FAT32 \u4e2d\u6247\u533a\u7684\u6392\u5217\u65b9\u5f0f\u4e0e\u7528\u9014\u3002</p> <p>\u5373 <code>lba</code> \u6247\u533a\u4e3a BPB\uff0c\u8fd9\u4e4b\u540e\u7d27\u63a5\u7740\u7684\u662f\u4e00\u4e9b\u4fdd\u7559\u6247\u533a\uff0c\u7136\u540e\u662f\u7b2c\u4e00\u4e2a FAT \u8868\u6240\u5728\u7684\u6247\u533a\uff08\u8fd9\u4e2a\u8868\u4f1a\u5360\u5f88\u591a\u4e2a\u6247\u533a\uff0c\u9700\u8981\u4ece bpb \u8bfb\u53d6\uff09\uff0c\u63a5\u4e0b\u6765\u662f\u7b2c\u4e8c\u4e2a FAT \u8868\u6240\u5728\u7684\u6247\u533a\uff08\u4e3a\u7b2c\u4e00\u4e2a FAT \u8868\u7684\u5907\u4efd\uff09\uff0c\u7136\u540e\u63a5\u4e0b\u6765\u662f\u6570\u636e\u533a\u3002</p> <p>\u5728\u5f97\u5230\u8fd9\u4e9b\u4e4b\u540e\uff0c\u4f60\u53ef\u4ee5\u5c1d\u8bd5\u4ece <code>fat32_volume.first_fat_sec</code> \u8bfb\u53d6\u4e00\u4e2a\u6247\u533a\u5230 <code>fat32_buf</code> \u4e2d\uff0c\u5982\u679c\u6b63\u786e\u7684\u8bdd\uff0c\u5f00\u5934\u56db\u4e2a\u5b57\u8282\u5e94\u8be5\u662f <code>F8FFFF0F</code>\u3002</p> <p>\u7269\u7406\u5c42\u9762\u8bfb\u5199\u6247\u533a\u7684\u539f\u8bed</p> <ul> <li>\u51fa\u4e8e\u5b9e\u9a8c\u96be\u5ea6\u7684\u8003\u8651\uff0c\u7269\u7406\u5c42\u9762\u901a\u8fc7 virtio \u8bfb\u5199\u6247\u533a\u7684\u9a71\u52a8\u51fd\u6570\u5df2\u7ecf\u5199\u597d\uff1b<ul> <li><code>virtio_blk_read_sector</code> \u53ef\u4ee5\u5c06\u6247\u533a\u53f7\u5bf9\u5e94\u7684\u6247\u533a\u8bfb\u5165\u5230\u4e00\u4e2a buffer \u5185\uff1b</li> <li><code>virtio_blk_write_sector</code> \u53ef\u4ee5\u5c06\u4e00\u4e2a buffer \u7684\u5185\u5bb9\u5199\u5165\u5230\u7279\u5b9a\u6247\u533a\u53f7\u7684\u6247\u533a\u91cc\uff1b</li> </ul> </li> <li>\u4e0d\u8bba\u662f <code>openat</code> <code>read</code> <code>write</code> <code>lseek</code>\uff0c\u90fd\u53ef\u80fd\u9700\u8981\u8c03\u7528\u8fd9\u4e24\u4e2a\u51fd\u6570\uff0c\u6765\u5b8c\u6210\u8ddf\u6247\u533a\u5185\u5bb9\u7684\u4ea4\u4e92\uff1b</li> </ul> <p>\u66f4\u591a\u8c03\u8bd5\u5efa\u8bae</p> <p>\u4f60\u53ef\u4ee5\u4f7f\u7528 16 \u8fdb\u5236\u6587\u4ef6\u67e5\u770b\u8f6f\u4ef6\u6253\u5f00 <code>disk.img</code> \u6587\u4ef6\uff0c\u6765\u67e5\u770b\u5176\u4e2d\u7684\u5185\u5bb9\uff0c\u6bcf\u4e2a\u6247\u533a\u7684\u5927\u5c0f\u90fd\u4e3a <code>VIRTIO_BLK_SECTOR_SIZE</code>\u3002</p> <p>\u867d\u7136\u6587\u4ef6\u4e2d\u5927\u90e8\u5206\u5185\u5bb9\u90fd\u4e3a 0\uff0c\u4f46\u662f\u4f60\u53ef\u4ee5\u641c\u7d22\u5f97\u5230\u4e00\u4e9b\u6709\u610f\u4e49\u7684\u90e8\u5206\uff1a</p> <ul> <li>\u5b57\u7b26\u4e32 <code>mkfs.fat</code>\uff0c\u8fd9\u516b\u4e2a\u5b57\u8282\u662f bpb \u4e2d\u7684 oem \u4ee3\u53f7\uff0c\u5373 <code>fat32_bpb-&gt;oem_name</code>\uff1b<ul> <li>\u6839\u636e\u8fd9\u4e2a\u4f4d\u7f6e\uff0c\u4f60\u53ef\u4ee5\u627e\u5230 BPB \u7684\u5f00\u59cb\u4f4d\u7f6e\uff1b</li> </ul> </li> <li>\u5b57\u8282\u5e8f\u5217 <code>F8 FF FF 0F</code>\uff0c\u8fd9\u662f FAT \u8868\u7684\u5f00\u5934\uff0c\u4e5f\u662f\u7b2c\u4e00\u4e2a FAT \u9879\u7684\u5185\u5bb9\uff1b</li> <li>\u5b57\u7b26\u4e32 <code>EMAIL</code>\uff0c\u8fd9\u662f\u6211\u4eec\u8981\u8bfb\u53d6\u7684\u6587\u4ef6\u7684\u540d\u5b57\uff0c\u5b83\u4f1a\u5728\u6570\u636e\u533a\u5f00\u5934\u7684\u6839\u76ee\u5f55\u6247\u533a\u4e2d\u51fa\u73b0\uff0c\u6807\u5fd7\u7740\u4e00\u4e2a\u77ed\u6587\u4ef6\u540d\u76ee\u5f55\u9879\u7684\u5f00\u59cb\uff1b<ul> <li>\u4f60\u53ef\u80fd\u4f1a\u770b\u5230\u6709\u5176\u4ed6\u7684\u76ee\u5f55\u9879\uff0c\u4f60\u53ef\u4ee5\u4e0d\u7528\u7ba1\u5b83\u4eec\uff0c\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\u4e0d\u4f1a\u7528\u5230\uff1b</li> </ul> </li> <li>\u5b57\u7b26\u4e32 <code>From</code>\uff0c\u8fd9\u662f\u8981\u8bfb\u53d6\u7684\u6587\u4ef6\u5185\u5bb9\u7684\u5f00\u5934\uff0c\u5b83\u4e5f\u4f1a\u5904\u4e8e\u4e00\u4e2a\u6247\u533a\u7684\u5f00\u5934\u3002</li> </ul>"},{"location":"lab6/#_8","title":"\u5b8c\u5584\u7cfb\u7edf\u8c03\u7528","text":"<p>\u5728\u8bfb\u53d6\u6587\u4ef6\u4e4b\u524d\uff0c\u9996\u5148\u9700\u8981\u6253\u5f00\u5bf9\u5e94\u7684\u6587\u4ef6\uff0c\u8fd9\u9700\u8981\u5b9e\u73b0 <code>openat</code> syscall\uff0c\u8c03\u7528\u53f7\u4e3a 56\u3002\u4f60\u9700\u8981\u5bfb\u627e\u4e00\u4e2a\u7a7a\u95f2\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u7136\u540e\u8c03\u7528 <code>file_open</code> \u51fd\u6570\u6765\u521d\u59cb\u5316\u8fd9\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\u3002</p> <p>\u5173\u4e8e\u5224\u65ad\u6587\u4ef6\u7cfb\u7edf\u7c7b\u578b</p> <p>\u6211\u4eec\u4f7f\u7528\u6700\u7b80\u5355\u7684\u5224\u522b\u6587\u4ef6\u7cfb\u7edf\u7684\u65b9\u5f0f\uff0c\u6587\u4ef6\u524d\u7f00\u4e3a <code>/fat32/</code> \u7684\u5373\u662f\u672c\u6b21 FAT32 \u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u6587\u4ef6\uff0c\u4f8b\u5982\uff0c\u5728 <code>nish</code> \u4e2d\u6211\u4eec\u5c1d\u8bd5\u8bfb\u53d6\u6587\u4ef6\uff0c\u4f7f\u7528\u7684\u547d\u4ee4\u662f <code>cat /fat32/$FILENAME</code>. <code>file_open</code> \u4f1a\u6839\u636e\u524d\u7f00\u51b3\u5b9a\u662f\u5426\u8c03\u7528 <code>fat32_open_file</code> \u51fd\u6570\uff08\u540e\u9762\u5b9e\u73b0\uff09\u3002</p> <p>\u6ce8\u610f\u56e0\u4e3a\u6211\u4eec\u7684\u6587\u4ef6\u4e00\u5b9a\u5728 FAT32 \u7684\u6839\u76ee\u5f55\u4e0b\uff0c\u4e5f\u5373 <code>/fat32/</code> \u4e0b\uff0c\u6240\u4ee5\u65e0\u9700\u5b9e\u73b0\u4e0e\u76ee\u5f55\u904d\u5386\u76f8\u5173\u7684\u903b\u8f91\u3002\u6b64\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u9700\u8981\u5c06\u6587\u4ef6\u540d\u7edf\u4e00\u8f6c\u6362\u4e3a\u5927\u5199\u6216\u5c0f\u5199\uff0c\u56e0\u4e3a\u6211\u4eec\u7684\u5b9e\u73b0\u662f\u4e0d\u533a\u5206\u5927\u5c0f\u5199\u7684\u3002</p> <p>\u8bfb\u53d6\u5b8c\u6210\u540e nish \u4f1a\u8c03\u7528 close \u6765\u5173\u95ed\u6587\u4ef6\uff0c\u6240\u4ee5\u4f60\u9700\u8981\u5b9e\u73b0 57 \u53f7\u7cfb\u7edf\u8c03\u7528 close\uff0c\u6765\u4e3a\u6307\u5b9a\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u5173\u95ed\u6587\u4ef6\u3002</p> <p>\u6700\u540e\u5728 nish \u5904\u7406 edit \u7684\u65f6\u5019\uff0c\u4f1a\u5148\u8fdb\u884c lseek \u8c03\u6574\u6587\u4ef6\u6307\u9488\uff0c\u7136\u540e\u518d\u8fdb\u884c write\uff0c\u6240\u4ee5\u4f60\u9700\u8981\u53c2\u8003 write \u548c read \u5b9e\u73b0\u7c7b\u4f3c\u7684 62 \u53f7\u7cfb\u7edf\u8c03\u7528 lseek\u3002</p>"},{"location":"lab6/#_9","title":"\u6253\u5f00\u6587\u4ef6","text":"<p>\u63a5\u4e0b\u6765\u5c31\u662f\u672c\u6b21\u5b9e\u9a8c\u4e2d\u6bd4\u8f83\u590d\u6742\u7684\u90e8\u5206\u4e86\uff0c\u9996\u5148\u5728 <code>fat32_open_file</code> \u51fd\u6570\u4e2d\uff0c\u6211\u4eec\u9700\u8981\u8bfb\u53d6\u51fa\u88ab\u6253\u5f00\u7684\u6587\u4ef6\u6240\u5728\u7684\u7c07\u548c\u76ee\u5f55\u9879\u4f4d\u7f6e\u7684\u4fe1\u606f\uff0c\u6765\u4f9b\u540e\u9762 read write lseek \u4f7f\u7528\uff0c\u76ee\u6807\u662f\u83b7\u53d6\u5230\uff1a</p> include/fs.h<pre><code>struct fat32_dir {\n    uint32_t cluster;   // \u6587\u4ef6\u7684\u76ee\u5f55\u9879\u6240\u5728\u7684\u7c07\n    uint32_t index;     // \u6587\u4ef6\u7684\u76ee\u5f55\u9879\u662f\u8be5\u7c07\u4e2d\u7684\u7b2c\u51e0\u4e2a\u76ee\u5f55\u9879\n};\n\nstruct fat32_file {\n    uint32_t cluster;       // \u6587\u4ef6\u5f00\u5934\u6240\u5728\u7684\u7c07\n    struct fat32_dir dir;   // \u6587\u4ef6\u7684\u76ee\u5f55\u9879\u4fe1\u606f\n};\n</code></pre> <p>\u4f60\u9700\u8981\u904d\u5386\u6570\u636e\u533a\u5f00\u5934\u7684\u6839\u76ee\u5f55\u6247\u533a\uff0c\u627e\u5230 name \u548c <code>path</code> \u672b\u5c3e\u7684 <code>filename</code> \u76f8\u5339\u914d\u7684 <code>fat32_dir_entry</code> \u76ee\u5f55\u9879\u7ed3\u6784\u4f53\uff0c\u518d\u4ece\u5176\u4e2d\u5f97\u5230\u8fd9\u4e9b\u4fe1\u606f\u3002</p> <p>\u4e3a\u4ec0\u4e48\u6211\u5339\u914d\u4e0d\u5230\u8981\u6253\u5f00\u7684\u6587\u4ef6</p> <p>\u5982\u679c\u662f\u4f7f\u7528 <code>memcmp</code> \u6765\u9010\u4e00\u6bd4\u8f83 FAT32 \u6587\u4ef6\u7cfb\u7edf\u6839\u76ee\u5f55\u4e0b\u7684\u5404\u4e2a\u6587\u4ef6\u540d\u548c\u60f3\u8981\u6253\u5f00\u7684\u6587\u4ef6\u540d\uff0c\u5219\u9700\u8981 8 \u4e2a\u5b57\u8282\u5b8c\u5168\u5339\u914d\u3002\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cFAT32 \u6587\u4ef6\u7cfb\u7edf\u6839\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u540d\u5e76\u4e0d\u662f\u4ee5 \"\\0\" \u7ed3\u5c3e\u7684\u5b57\u7b26\u4e32\uff0c\u4f60\u9700\u8981\u53c2\u8003 spec \u6216\u8005 <code>disk.img</code> \u4e2d\u7684\u5185\u5bb9\u6765\u4e86\u89e3 FAT32 \u6587\u4ef6\u540d\u7684\u5b58\u50a8\u65b9\u5f0f\u3002</p>"},{"location":"lab6/#_10","title":"\u8bfb\u53d6\u4e0e\u5199\u5165\u6587\u4ef6","text":"<p>\u5bf9\u4e8e FAT32 \u6587\u4ef6\u7cfb\u7edf\u7684\u6587\u4ef6\u8bfb\u53d6\uff0c\u4f1a\u8c03\u7528\u5230 <code>fat32_read</code> \u51fd\u6570\uff0c\u4f60\u9700\u8981\u6839\u636e <code>file-&gt;fat32_file</code> \u4e2d\u7684\u4fe1\u606f\uff08\u5373 open \u7684\u65f6\u5019\u83b7\u53d6\u7684\u4fe1\u606f\uff09\u627e\u5230\u6587\u4ef6\u5185\u5bb9\u6240\u5728\u7684\u7c07\uff0c\u7136\u540e\u8bfb\u53d6\u51fa\u6587\u4ef6\u5185\u5bb9\u5230 <code>buf</code> \u4e2d\u3002</p> <p>Hint</p> <ul> <li>\u901a\u8fc7 <code>cluster_to_sector</code> \u53ef\u4ee5\u5f97\u5230\u7c07\u53f7\u5bf9\u5e94\u7684\u6247\u533a\u53f7\uff1b</li> <li>\u901a\u8fc7 <code>virtio_blk_read_sector</code> \u5bf9\u6247\u533a\u8fdb\u884c\u8bfb\u53d6\uff1b</li> <li>\u4f60\u53ef\u80fd\u9700\u8981\u518d\u901a\u8fc7\u8bfb\u53d6\u76ee\u5f55\u9879\u6765\u83b7\u53d6\u6587\u4ef6\u957f\u5ea6\uff1b</li> <li>\u8bfb\u53d6\u662f\u8981\u4ece <code>file-&gt;cfo</code> \u5f00\u59cb\u7684\uff1b</li> <li>\u8bfb\u53d6\u7684\u957f\u5ea6\u53ef\u80fd\u4f1a\u4f7f\u5f97\u5185\u5bb9\u8de8\u8d8a\u4e86\u4e00\u4e2a\u6216\u51e0\u4e2a\u6247\u533a\uff0c\u4f60\u9700\u8981\u591a\u6b21\u8bfb\u53d6\uff1b</li> <li>\u8bfb\u53d6\u5230\u4e86\u6587\u4ef6\u672b\u5c3e\u5c31\u5e94\u8be5\u622a\u6b62\uff0c\u5e76\u8fd4\u56de\u5b9e\u9645\u8bfb\u53d6\u7684\u957f\u5ea6\uff1b</li> <li>\u5982\u679c read \u8fd4\u56de\u4e86 0\uff0c\u5219\u8bf4\u660e\u5df2\u7ecf\u8bfb\u53d6\u5230\u4e86\u6587\u4ef6\u672b\u5c3e\uff0c\u8fd9\u6837\u7528\u6237\u6001\u7a0b\u5e8f\u5c31\u77e5\u9053\u6587\u4ef6\u5df2\u7ecf\u5b8c\u5168\u8bfb\u53d6\u7ed3\u675f\u4e86\u3002</li> </ul> <p>\u6b63\u786e\u5b9e\u73b0\u540e\uff0c\u4f60\u5e94\u8be5\u53ef\u4ee5\u770b\u5230 <code>cat /fat32/email</code> \u7684\u8f93\u51fa\u4e86\uff1a</p> \u793a\u4f8b\u8f93\u51fa <pre><code>...buddy_init done!\n...mm_init done!\n...proc_init done!\n...virtio_blk_init done!\n...fat32 partition #1 init done!\n2024 ZJU Operating System\nhello, stdout!\nhello, stderr!\nSHELL &gt; cat /fat32/email\nFrom: TORVALDS@klaava.Helsinki.FI (Linus Benedict Torvalds)\nNewsgroups: comp.os.minix\nSubject: What would you like to see most in minix?\nSummary: small poll for my new operating system\nMessage-ID:\nDate: 25 Aug 91 20:57:08 GMT\nOrganization: University of Helsinki\n\nHello everybody out there using minix -\n\nI'm doing a (free) operating system (just a hobby, won't be big and professional like gnu) for 386(486) AT cones. This has been brewing since april, and is starting to get ready. I'd Tike any feedback on things people like/dislike in minix, as my 0S resembles it somewhat (same physical layout of the file-system (due to practical reasons) among other things) .\n\nI've currently ported bash(1.08) and gcc(1.40), and things seem to work. This implies that I'll get something practical within a few months, andI'd like to know what features most people would want. Any suggestions are welcome, but I won't promise I'll implement them :-)\n\n            Linus (torvalds@kruuna.helsinki.fi)\n\nPS. Yes . it's free of any minix code, and it has a multi-threaded fs. It is NOT protable (uses 386 task switching etc), and it probably never will support anything other than AT-hard disks, as that's all I have :-($\nSHELL &gt;\n</code></pre> <p>write \u64cd\u4f5c\u548c read \u975e\u5e38\u76f8\u4f3c\uff0c\u53ea\u9700\u8981\u4fee\u6539\u540e\u518d\u901a\u8fc7 <code>virtio_blk_write_sector</code> \u5199\u56de\u6247\u533a\u5373\u53ef\u3002</p> <p>\u672c\u6b21\u5b9e\u9a8c\u4e0d\u8981\u6c42\u5b9e\u73b0\u6839\u636e\u8bbf\u95ee\u65f6\u95f4\u66f4\u65b0\u76ee\u5f55\u9879\u4fe1\u606f</p>"},{"location":"lab6/#lseek","title":"lseek \u64cd\u4f5c","text":"<p>\u5728 nish \u5904\u7406 edit \u7684\u65f6\u5019\uff0c\u4f1a\u5148\u8fdb\u884c lseek \u8c03\u6574\u6587\u4ef6\u6307\u9488\uff0c\u7136\u540e\u518d\u8fdb\u884c write\u3002\u800c lseek \u5728\u505a\u7684\u5c31\u662f\u8c03\u6574\u6307\u9488 <code>file-&gt;cfo</code> \u7684\u503c\uff0c\u4f60\u9700\u8981\u5b9e\u73b0\uff1a</p> fs/fat32.c<pre><code>int64_t fat32_lseek(struct file* file, int64_t offset, uint64_t whence) {\n    if (whence == SEEK_SET) {\n        file-&gt;cfo = /* to calculate */;\n    } else if (whence == SEEK_CUR) {\n        file-&gt;cfo = /* to calculate */;\n    } else if (whence == SEEK_END) {\n        /* Calculate file length */\n        file-&gt;cfo = /* to calculate */;\n    } else {\n        printk(\"fat32_lseek: whence not implemented\\n\");\n        while (1);\n    }\n    return file-&gt;cfo;\n}\n</code></pre> <p>\u5177\u4f53 <code>whence</code> \u7684\u542b\u4e49\u8bf7\u81ea\u884c\u641c\u7d22 spec\u3002</p>"},{"location":"lab6/#_11","title":"\u6d4b\u8bd5","text":"<p>\u5168\u90e8\u5b9e\u73b0\u5b8c\u6210\u540e\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u6587\u4ef6\u7684\u8bfb\u5199\u64cd\u4f5c\u4e86\uff1a</p> \u793a\u4f8b\u8f93\u51fa <pre><code>...buddy_init done!\n...mm_init done!\n...proc_init done!\n...virtio_blk_init done!\n...fat32 partition #1 init done!\n2024 ZJU Operating System\nhello, stdout!\nhello, stderr!\nSHELL &gt; echo \"test\"\ntest\nSHELL &gt; cat /fat32/email\nFrom: torvalds@klaava.Helsinki.FI (Linus Benedict Torvalds)\n...\nSHELL &gt; edit /fat32/email 6 TORVALDS\nSHELL &gt; cat /fat32/email\nFrom: TORVALDS@klaava.Helsinki.FI (Linus Benedict Torvalds)\n...\nSHELL &gt;\n</code></pre> <p>\u8fd9\u91cc\u901a\u8fc7 <code>edit /fat32/email 6 TORVALDS</code> \u6765\u5c06\u6587\u4ef6 \"From\" \u540e\u9762\u7684 torvalds \u6539\u6210\u4e86\u5927\u5199\u3002\u9664\u6b64\u4e4b\u5916\u4f60\u4e5f\u53ef\u4ee5\u53d1\u73b0\u91cd\u65b0 <code>make run</code> \u8fd0\u884c\uff0c\u5e76\u76f4\u63a5 <code>cat /fat32/email</code>\uff0c\u8f93\u51fa\u7684\u4e5f\u662f\u4fee\u6539\u540e\u7684\u5927\u5199 TORVALDS\uff0c\u56e0\u4e3a\u8fd9\u90e8\u5206\u4fee\u6539\u662f\u6301\u4e45\u4fdd\u5b58\u5728 disk.img \u78c1\u76d8\u4e2d\u7684\u3002</p>"},{"location":"lab6/#_12","title":"\u5b9e\u9a8c\u4efb\u52a1\u4e0e\u8981\u6c42","text":"<p>\u672c\u6b21\u5b9e\u9a8c\u4e3a bonus\uff0c\u65e0\u601d\u8003\u9898</p> <ul> <li>\u8bf7\u5404\u4f4d\u540c\u5b66\u72ec\u7acb\u5b8c\u6210\u4f5c\u4e1a\uff0c\u4efb\u4f55\u6284\u88ad\u884c\u4e3a\u90fd\u5c06\u4f7f\u672c\u6b21\u4f5c\u4e1a\u5224\u4e3a 0 \u5206\u3002</li> <li>\u5728\u5b66\u5728\u6d59\u5927\u4e2d\u63d0\u4ea4\uff1a<ul> <li>\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u7684\u538b\u7f29\u5305\uff08\u63d0\u4ea4\u4e4b\u524d\u8bf7\u4f7f\u7528 <code>make clean</code> \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\uff09</li> <li>pdf \u683c\u5f0f\u7684\u5b9e\u9a8c\u62a5\u544a\uff1a<ul> <li>\u8bb0\u5f55\u5b9e\u9a8c\u8fc7\u7a0b\u5e76\u622a\u56fe\uff084.1-4.3\uff09\uff0c\u5e76\u5bf9\u6bcf\u4e00\u6b65\u7684\u547d\u4ee4\u4ee5\u53ca\u7ed3\u679c\u8fdb\u884c\u5fc5\u8981\u7684\u89e3\u91ca\uff1b</li> <li>\u8bb0\u5f55\u9047\u5230\u7684\u95ee\u9898\u548c\u5fc3\u5f97\u4f53\u4f1a\u3002</li> </ul> </li> </ul> </li> </ul> <p>\u5173\u4e8e\u5b9e\u9a8c\u62a5\u544a\u5185\u5bb9\u8981\u6c42\uff0c\u53ef\u89c1\uff1a\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54 - \u5b9e\u9a8c\u63d0\u4ea4\u8981\u6c42</p>"},{"location":"spike/","title":"\u5173\u4e8e spike \u5de5\u5177\u94fe\u7684\u4f7f\u7528","text":"<p>\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u6839\u636e\u672c\u6587\u6863\u81ea\u884c\u4f7f\u7528 spike \u5de5\u5177\u94fe\u8fd0\u884c RISC-V kernel</p> <p>\u672c\u8bfe\u7a0b\u6240\u6709\u5b9e\u9a8c\u7684\u7ed3\u679c\u6700\u540e\u4ecd\u4ee5 qemu \u4e3a\u51c6\uff0cspike \u4ec5\u4f9b\u6709\u5174\u8da3\u7684\u540c\u5b66\u5c1d\u8bd5</p>"},{"location":"spike/#_1","title":"\u5de5\u5177\u94fe\u7b80\u4ecb","text":""},{"location":"spike/#spike_1","title":"Spike","text":"<p>Spike \u662f\u4e00\u4e2a\u548c QEMU \u7c7b\u4f3c\u7684\u6307\u4ee4\u6a21\u62df\u5668\u3002\u867d\u7136\u5b83\u4e0d\u50cf QEMU \u90a3\u6837\u652f\u6301\u5404\u79cd\u6307\u4ee4\u96c6\u67b6\u6784\uff0c\u53ef\u4ee5\u6a21\u62df\u590d\u6742\u7684\u5916\u8bbe\uff0c\u4f46\u662f\u5728 RISC-V \u7684\u6a21\u62df\u548c\u652f\u6301\u4e0a\uff0cspike \u662f\u9010\u6761\u6307\u4ee4\u8fdb\u884c\u6a21\u62df\uff0c\u4e14\u4e25\u683c\u6309\u7167 RISC-V \u7684\u6307\u4ee4\u96c6\u624b\u518c\uff0c\u5bf9\u4e8e RISC-V \u7a0b\u5e8f\u7684\u68c0\u67e5\u66f4\u4e3a\u4e25\u8c28\u3002</p> <p>\u7279\u522b\u662f\u5728\u9875\u8868\u7684\u5b9e\u9a8c\u4e2d\uff0cspike \u4f1a\u4e25\u8c28\u5f97\u591a\uff0c\u63a8\u8350\u6709\u7cbe\u529b\u7684\u540c\u5b66\u989d\u5916\u7528 spike \u8fd0\u884c\u8fdb\u884c\u6d4b\u8bd5</p> <p>QEMU \u4e3a\u4e86\u8ffd\u6c42\u8fd0\u884c\u7684\u9ad8\u6548\uff0c\u5f80\u5f80\u4f1a\u5c06\u6307\u4ee4\u5206\u5757\u6253\u5305\u7f16\u8bd1\u4e3a\u5bbf\u4e3b\u673a\u6307\u4ee4\u9ad8\u6548\u8fd0\u884c\uff1b\u800c spike \u5219\u9009\u62e9\u4e86\u6839\u636e RISC-V \u6307\u4ee4\u96c6\u5145\u5206\u6a21\u62df RISC-V \u4f53\u7cfb\u7ed3\u6784\u7684\u5404\u79cd\u786c\u4ef6\uff0c\u7136\u540e\u9010\u6761\u8fd0\u884c\u6307\u4ee4\uff0c\u5e76\u4fee\u6539\u5404\u4e2a\u6a21\u62df\u786c\u4ef6\uff0c\u5f53\u7136\u8fd9\u4e5f\u4f1a\u5bfc\u81f4 spike \u8fd0\u884c\u901f\u5ea6\u6bd4 qemu \u6162\u4e00\u4e9b\u3002</p> <p>\u5982\u679c\u540c\u5b66\u4eec\u60f3\u8981\u4e86\u89e3\u4e00\u4e9b RISC-V \u673a\u5236\u7684\u5177\u4f53\u5b9e\u73b0\uff0c\u76f4\u63a5\u9605\u8bfb spike \u7684\u6e90\u7801\u4e5f\u662f\u4e0d\u9519\u7684\u9009\u62e9\u3002</p>"},{"location":"spike/#openocd","title":"OpenOCD","text":"<p>OpenOCD \u662f\u4e00\u4e2a\u8c03\u8bd5\u7684\u4e2d\u95f4\u5de5\u5177\u3002\u4e00\u4e9b RISC-V \u82af\u7247\u4e3a\u4e86\u65b9\u4fbf\u786c\u4ef6\u8c03\u8bd5\u5185\u90e8\u7684\u4fe1\u606f\u4f1a\u5728\u5185\u90e8\u96c6\u6210\u4e00\u4e2a debug module\uff0c\u5e76\u5bf9\u5916\u66b4\u9732\u4e00\u4e2a JTAG \u63a5\u53e3\u3002\u8c03\u8bd5\u8005\u53ef\u4ee5\u7528 JTAG \u7ebf\u7684\u8f93\u5165\u7ebf\u5411 debug module \u8f93\u5165\u547d\u4ee4\uff0c\u5e76\u7528\u8f93\u51fa\u7ebf\u5f97\u5230\u9700\u8981\u8bfb\u53d6\u7684\u7ed3\u679c\u3002\u8fd9\u4e2a\u6307\u4ee4\u4f20\u8f93\u534f\u8bae\u662f\u590d\u6742\u7684\uff0c\u6211\u4eec\u672c\u80fd\u5730\u5e0c\u671b\u53ef\u4ee5\u6709\u4e00\u4e2a\u7b80\u5355\u7684\u547d\u4ee4\u5de5\u5177\uff0c\u6211\u4eec\u5411\u4ed6\u53d1\u9001\u8bf8\u5982 read\u3001write \u7684\u6307\u4ee4\uff0c\u5b83\u518d\u5e2e\u6211\u4eec\u8f6c\u6362\u4e3a\u6666\u6da9\u7684 DMI \u6307\u4ee4\u5e8f\u5217\uff0c\u8fd9\u4e2a\u5de5\u5177\u5c31\u662f OpenOCD\u3002</p> <p>Spike \u76f4\u63a5\u6a21\u62df\u7684\u662f\u786c\u4ef6\u8bbe\u5907\uff0c\u6240\u4ee5\u5b83\u4e5f\u76f4\u63a5\u6a21\u62df\u4e86\u4e00\u4e2a debug module\uff0c\u6307\u5b9a <code>--rbb-port</code> \u9009\u9879\u4e4b\u540e\uff0c\u5b83\u5c31\u53ef\u4ee5\u5f00\u653e\u5bf9\u5e94\u7684\u6a21\u62df JTAG \u7aef\u53e3\u7b49\u5f85\u88ab\u8fde\u63a5\u8c03\u8bd5\u3002OpenOCD \u8fde\u63a5\u8fd9\u4e2a\u7aef\u53e3\u7136\u540e\u5f00\u59cb\u8c03\u8bd5\uff0c\u4e0d\u8fc7\u5b83\u5e76\u4e0d\u77e5\u9053\u6211\u4eec\u7684 spike \u7684\u5e73\u53f0\u7c7b\u578b\u7684\u8fde\u63a5\u7c7b\u578b\uff0c\u56e0\u6b64\u9700\u8981\u6211\u4eec\u989d\u5916\u63d0\u4f9b openocd.cfg \u6587\u4ef6\uff0c\u53ea\u8981\u8fd0\u884c <code>openocd -f openocd.cfg</code>\uff0c\u5c31\u4f1a\u81ea\u52a8\u8fde\u63a5 9824 \u7aef\u53e3\uff0c\u5e76\u51c6\u5907\u8c03\u8bd5\u6211\u4eec\u7684 spike\u3002\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>adapter driver remote_bitbang\nremote_bitbang host localhost\nremote_bitbang port 9824\n\nset _CHIPNAME riscv\njtag newtap $_CHIPNAME cpu -irlen 5 \n\nset _TARGETNAME $_CHIPNAME.cpu\ntarget create $_TARGETNAME riscv -chain-position $_TARGETNAME\n\nbindto 0.0.0.0\ngdb_report_data_abort enable\n\ninit\nreset halt\n</code></pre> <p>\u5b83\u8fde\u63a5\u4e86 remote bitbang \u7684\u7aef\u53e3\uff0c\u7136\u540e\u521b\u5efa\u4e86\u4e00\u4e2a tap \u548c target\uff0c\u5f00\u542f\u4e86 gdb \u540e\u91cd\u7f6e\u7b49\u5f85\u8c03\u8bd5\u3002\u8fd9\u6837 OpenOCD \u4f1a\u9ed8\u8ba4\u5f00\u653e 3333 \u7aef\u53e3\u7ed9 gdb \u8fde\u63a5\uff0c\u901a\u8fc7 <code>target extended-remote localhost:3333</code> \u6216\u8005 <code>tar ext :3333</code> \u5c31\u53ef\u4ee5\u8fde\u63a5\u5230 OpenOCD\u3002</p> <p>\u4e4b\u540e OpenOCD \u53ef\u4ee5\u62c5\u5f53 gdb \u548c spike \u4e4b\u95f4\u7684\u6865\u6881\u3002gdb \u63a5\u6536\u5230\u7684\u6307\u4ee4\u4f1a\u53d1\u9001\u7ed9 OpenOCD\uff0cOpenOCD \u5c06\u5b83\u8f6c\u6362\u4e3a\u5bf9\u5e94\u7684 01 \u4e32\u53d1\u9001\u7ed9 spike \u8fdb\u884c\u8c03\u8bd5\uff0c\u53cd\u4e4b\u4ea6\u7136\u3002\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 gdb-OpenOCD-spike \u7684\u5de5\u5177\u94fe\u5b9e\u73b0\u539f\u6765 gdb-qemu \u7684\u6548\u679c\u3002</p>"},{"location":"spike/#opensbi","title":"OpenSBI","text":"<p>OpenSBI \u5927\u5bb6\u5728 lab1 \u4e2d\u5e94\u8be5\u90fd\u6709\u6240\u4e86\u89e3\uff0c\u5c31\u4e0d\u4ecb\u7ecd\u5b83\u672c\u8eab\u4e86\u3002\u8fd9\u4e2a\u5de5\u5177\u94fe\u4e4b\u6240\u4ee5\u9700\u8981 OpenSBI\uff0c\u662f\u56e0\u4e3a spike \u6a21\u62df\u7684\u662f\u4e00\u53f0\u88f8\u673a\u3002\u6211\u4eec\u7684 kernel \u4e0d\u53ef\u4ee5\u76f4\u63a5\u5728\u88f8\u673a\u4e0a\u8fd0\u884c\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u989d\u5916\u7684 OpenSBI \u7684\u4ee3\u7801\u505a\u524d\u671f\u7684\u542f\u52a8\u3002\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e0b\u8f7d OpenSBI \u4ee3\u7801\u5e76\u5c06\u5b83\u7f16\u8bd1\u5f97\u5230 fw_jump.elf\uff0c\u4f5c\u4e3a M \u6001\u7684\u7ef4\u62a4\u4ee3\u7801\u3002</p>"},{"location":"spike/#_2","title":"\u5de5\u5177\u94fe\u4f7f\u7528","text":""},{"location":"spike/#_3","title":"\u7f16\u8bd1\u5b89\u88c5","text":""},{"location":"spike/#spike_2","title":"Spike","text":"<p>Spike \u9700\u8981\u5927\u5bb6\u4ece\u6e90\u7801\u81ea\u884c\u7f16\u8bd1\u5b89\u88c5\uff1a</p> <pre><code>git clone https://github.com/riscv-software-src/riscv-isa-sim\ncd riscv-isa-sim\nsudo apt install device-tree-compiler libboost-regex-dev libboost-system-dev\nmkdir build\ncd build\n../configure\nmake -j$(nproc)\nsudo make install\n</code></pre>"},{"location":"spike/#openocd_1","title":"OpenOCD","text":"<p>OpenOCD \u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 <code>sudo apt install openocd</code> \u6765\u5b89\u88c5\uff0c\u4e5f\u53ef\u4ee5\u4ece\u6e90\u7801\u7f16\u8bd1\uff1a</p> <pre><code>git clone https://github.com/openocd-org/openocd/\ncd openocd\nsudo apt install libtool\n./bootstrap\n./configure --enable-remote-bitbang\nmake\nsudo make install\n</code></pre>"},{"location":"spike/#opensbi_1","title":"OpenSBI","text":"<p>\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u7f16\u8bd1\u597d\u7684 fw_jump.elf \u5728\u672c\u4ed3\u5e93 <code>src/spike/fw_jump.elf</code> \u4e2d\u3002</p> <p>\u5982\u679c\u9700\u8981\u81ea\u884c\u7f16\u8bd1\u7684\u8bdd\u9700\u8981\u5148\u901a\u8fc7 <code>make PLATFORM=generic menuconfig</code> \u6765\u5173\u6389 Utils and Drivers Support &gt; Serial Device Support &gt; Semihosting support \u8fd9\u4e00\u9009\u9879\u3002\u7136\u540e\u8fdb\u884c\u7f16\u8bd1\uff1a</p> <pre><code>git clone https://github.com/riscv-software-src/opensbi\ncd opensbi\nmkdir build\nmake O=build CROSS_COMPILE=riscv64-linux-gnu- PLATFORM=generic\n# output: build/platform/generic/firmware/fw_jump.elf\n</code></pre>"},{"location":"spike/#_4","title":"\u8fd0\u884c","text":"<p>\u672c\u4ed3\u5e93 <code>src/spike</code> \u4e2d\u63d0\u4f9b\u4e86 <code>Makefile.extra</code>\uff0c\u9700\u8981\u5927\u5bb6\u5c06\u5176\u4e2d\u5185\u5bb9\u590d\u5236\u5230\u81ea\u5df1 kernel \u7684 <code>Makefile</code> \u4e2d\uff0c\u6ce8\u610f\u5176\u4e2d <code>SPIKE_CONFIG</code> \u76ee\u5f55\u7684\u5177\u4f53\u4f4d\u7f6e\u8981\u8fdb\u884c\u4fee\u6539\u3002</p> <p>\u7136\u540e\u6267\u884c <code>make spike_run</code> \u5c31\u53ef\u4ee5\u901a\u8fc7 spike \u8fd0\u884c kernel \u4e86\u3002</p>"},{"location":"spike/#_5","title":"\u8c03\u8bd5","text":"<p>\u8c03\u8bd5\u7684\u8bdd\u4e00\u5171\u9700\u8981\u4e09\u4e2a\u7ec8\u7aef\u7a97\u53e3\uff0c\u4f9d\u6b21\u6267\u884c\uff1a</p> <ol> <li><code>make spike_debug</code>\uff1a\u542f\u52a8 spike \u5e76\u7b49\u5f85\u8c03\u8bd5</li> <li><code>make spike_bridge</code>\uff1a\u542f\u52a8 OpenOCD \u5e76\u8fde\u63a5 spike</li> <li><code>gdb-multiarch vmlinux</code>\uff1a\u542f\u52a8 gdb\uff0c\u7136\u540e\u6267\u884c\uff1a<ul> <li><code>tar ext :3333</code>\uff1a\u8fde\u63a5\u5230 OpenOCD</li> <li>\u5f00\u59cb\u8c03\u8bd5</li> </ul> </li> </ol> <p>\u540e\u7eed\u7684\u8c03\u8bd5\u6d41\u7a0b\u548c qemu \u7c7b\u4f3c\uff0c\u4e0d\u518d\u8d58\u8ff0\u3002</p>"}]}